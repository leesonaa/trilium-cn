"use strict";(global.webpackChunktrilium=global.webpackChunktrilium||[]).push([[586],{2817:(t,e,n)=>{n.r(e),n.d(e,{default:()=>k});var o=n(1412),i=n(394),s=n(8866),a=n(383),r=n(8481),d=n(5489),c=n(7336),l=n(4378),h=n(9046);class u extends s.Z{editReadOnlyNoteCommand(){const t=k.tabManager.getActiveContext();t.viewScope.readOnlyTemporarilyDisabled=!0,k.triggerEvent("readOnlyTemporarilyDisabled",{noteContext:t})}async showSQLConsoleCommand(){const t=await a.Z.createSqlConsole(),e=await k.tabManager.openTabWithNoteWithHoisting(t.noteId,{activate:!0});k.triggerEvent("focusOnDetail",{ntxId:e.ntxId})}async searchNotesCommand({searchString:t,ancestorNoteId:e}){const n=await a.Z.createSearchNote({searchString:t,ancestorNoteId:e});await o.default.loadSearchNote(n.noteId);const i=await k.tabManager.openTabWithNoteWithHoisting(n.noteId,{activate:!0});k.triggerCommand("focusOnSearchDefinition",{ntxId:i.ntxId})}async searchInSubtreeCommand({notePath:t}){const e=r.Z.getNoteIdFromUrl(t);this.searchNotesCommand({ancestorNoteId:e})}openNoteExternallyCommand(){const t=k.tabManager.getActiveContextNoteId(),e=k.tabManager.getActiveContextNoteMime();t&&d.Z.openNoteExternally(t,e)}openNoteCustomCommand(){const t=k.tabManager.getActiveContextNoteId(),e=k.tabManager.getActiveContextNoteMime();t&&d.Z.openNoteCustom(t,e)}enterProtectedSessionCommand(){c.Z.enterProtectedSession()}leaveProtectedSessionCommand(){c.Z.leaveProtectedSession()}hideLeftPaneCommand(){l.Z.save("leftPaneVisible","false")}showLeftPaneCommand(){l.Z.save("leftPaneVisible","true")}toggleLeftPaneCommand(){l.Z.toggle("leftPaneVisible")}async showBackendLogCommand(){await k.tabManager.openTabWithNoteWithHoisting("_backendLog",{activate:!0})}async showLaunchBarSubtreeCommand(){await this.showAndHoistSubtree("_lbRoot")}async showShareSubtreeCommand(){await this.showAndHoistSubtree("_share")}async showHiddenSubtreeCommand(){await this.showAndHoistSubtree("_hidden")}async showOptionsCommand({section:t}){await k.tabManager.openContextWithNote(t||"_options",{activate:!0,hoistedNoteId:"_options"})}async showSQLConsoleHistoryCommand(){await this.showAndHoistSubtree("_sqlConsole")}async showSearchHistoryCommand(){await this.showAndHoistSubtree("_search")}async showAndHoistSubtree(t){await k.tabManager.openContextWithNote(t,{activate:!0,hoistedNoteId:t})}async showNoteSourceCommand(){const t=k.tabManager.getActiveContextNotePath();t&&await k.tabManager.openTabWithNoteWithHoisting(t,{activate:!0,viewScope:{viewMode:"source"}})}async showAttachmentsCommand(){const t=k.tabManager.getActiveContextNotePath();t&&await k.tabManager.openTabWithNoteWithHoisting(t,{activate:!0,viewScope:{viewMode:"attachments"}})}async showAttachmentDetailCommand(){const t=k.tabManager.getActiveContextNotePath();t&&await k.tabManager.openTabWithNoteWithHoisting(t,{activate:!0,viewScope:{viewMode:"attachments"}})}toggleTrayCommand(){if(!h.default.isElectron())return;const{BrowserWindow:t}=h.default.dynamicRequire("@electron/remote"),e=t.getAllWindows(),n=e.every((t=>t.isVisible()))?"hide":"show";for(const t of e)t[n]()}firstTabCommand(){this.#t(1)}secondTabCommand(){this.#t(2)}thirdTabCommand(){this.#t(3)}fourthTabCommand(){this.#t(4)}fifthTabCommand(){this.#t(5)}sixthTabCommand(){this.#t(6)}seventhTabCommand(){this.#t(7)}eigthTabCommand(){this.#t(8)}ninthTabCommand(){this.#t(9)}lastTabCommand(){this.#t(Number.POSITIVE_INFINITY)}#t(t){const e=k.tabManager.getMainNoteContexts(),n=e[t===Number.POSITIVE_INFINITY?e.length-1:t-1];n&&k.tabManager.activateNoteContext(n.ntxId)}}var g=n(2040),p=n(1736),f=n(6885),m=n(4264),w=n(7844);class I extends s.Z{constructor(){super(),jQuery.hotkeys&&(jQuery.hotkeys.options.filterInputAcceptingElements=!1,jQuery.hotkeys.options.filterContentEditable=!1,jQuery.hotkeys.options.filterTextInputs=!1)}openDevToolsCommand(){h.default.isElectron()&&h.default.dynamicRequire("@electron/remote").getCurrentWindow().toggleDevTools()}async createNoteIntoInboxCommand(){const t=await a.Z.getInboxNote(),{note:e}=await p.Z.post(`notes/${t.noteId}/children?target=into`,{content:"",type:"text",isProtected:t.isProtected&&g.Z.isProtectedSessionAvailable()});await m.Z.waitForMaxKnownEntityChangeId(),await k.tabManager.openTabWithNoteWithHoisting(e.noteId,{activate:!0}),k.triggerEvent("focusAndSelectTitle",{isNewNote:!0})}async toggleNoteHoistingCommand({noteId:t=k.tabManager.getActiveContextNoteId()}){const e=await o.default.getNote(t),n=k.tabManager.getActiveContext();e.noteId===n.hoistedNoteId?await n.unhoist():"search"!==e.type&&await n.setHoistedNoteId(t)}async hoistNoteCommand({noteId:t}){const e=k.tabManager.getActiveContext();e.hoistedNoteId!==t&&await e.setHoistedNoteId(t)}async unhoistCommand(){const t=k.tabManager.getActiveContext();t&&t.unhoist()}copyWithoutFormattingCommand(){h.default.copySelectionToClipboard()}toggleFullscreenCommand(){if(h.default.isElectron()){const t=h.default.dynamicRequire("@electron/remote").getCurrentWindow();t.isFullScreenable()&&t.setFullScreen(!t.isFullScreen())}}reloadFrontendAppCommand(){h.default.reloadFrontendApp()}logoutCommand(){const t=$('<form action="logout" method="POST">').append($(`<input type='_hidden' name="_csrf" value="${glob.csrfToken}"/>`));$("body").append(t),t.trigger("submit")}backInNoteHistoryCommand(){if(h.default.isElectron()){const t=h.default.dynamicRequire("@electron/remote").getCurrentWebContents(),e=parseInt(t.getActiveIndex());t.goToIndex(e-1)}else window.history.back()}forwardInNoteHistoryCommand(){if(h.default.isElectron()){const t=h.default.dynamicRequire("@electron/remote").getCurrentWebContents(),e=parseInt(t.getActiveIndex());t.goToIndex(e+1)}else window.history.forward()}async switchToDesktopVersionCommand(){h.default.setCookie("trilium-device","desktop"),h.default.reloadFrontendApp("正在切换到桌面版")}async switchToMobileVersionCommand(){h.default.setCookie("trilium-device","mobile"),h.default.reloadFrontendApp("正在切换到移动版")}async openInWindowCommand({notePath:t,hoistedNoteId:e,viewScope:n}){const o=w.Z.calculateHash({notePath:t,hoistedNoteId:e,viewScope:n});if(h.default.isElectron()){const{ipcRenderer:t}=h.default.dynamicRequire("electron");t.send("create-extra-window",{extraWindowHash:o})}else{const t=`${window.location.protocol}//${window.location.host}${window.location.pathname}?extraWindow=1${o}`;window.open(t,"","width=1000,height=800")}}async openNewWindowCommand(){this.openInWindowCommand({notePath:"",hoistedNoteId:"root"})}async runActiveNoteCommand(){const{ntxId:t,note:e}=k.tabManager.getActiveContext();if(e&&"code"===e.type){if(e.mime.endsWith("env=frontend"))await i.default.getAndExecuteBundle(e.noteId);else if(e.mime.endsWith("env=backend"))await p.Z.post(`script/run/${e.noteId}`);else if("text/x-sqlite;schema=trilium"===e.mime){const n=await p.Z.post(`sql/execute/${e.noteId}`);n.success||f.default.showError(`Error occurred while executing SQL query: ${n.error}`),await k.triggerEvent("sqlQueryResults",{ntxId:t,results:n.results})}f.default.showMessage("笔记已执行")}}hideAllPopups(){h.default.isDesktop()&&$(".aa-input").autocomplete("close")}noteSwitchedEvent(){this.hideAllPopups()}activeContextChangedEvent(){this.hideAllPopups()}async forceSaveRevisionCommand(){const t=k.tabManager.getActiveContextNoteId();await p.Z.post(`notes/${t}/revision`),f.default.showMessage("笔记历史已创建")}}var b=n(9925),y=n(1902),v=n(3968);class N extends s.Z{constructor(t=null,e="root",n=null){super(),this.ntxId=t||this.constructor.generateNtxId(),this.hoistedNoteId=e,this.mainNtxId=n,this.resetViewScope()}static generateNtxId(){return h.default.randomString(6)}setEmpty(){this.notePath=null,this.noteId=null,this.parentNoteId=null,this.triggerEvent("noteSwitched",{noteContext:this,notePath:this.notePath}),this.resetViewScope()}isEmpty(){return!this.noteId}async setNote(t,e={}){e.triggerSwitchEvent=void 0===e.triggerSwitchEvent||e.triggerSwitchEvent,e.viewScope=e.viewScope||{},e.viewScope.viewMode=e.viewScope.viewMode||"default";const n=await this.getResolvedNotePath(t);n&&(this.notePath===n&&h.default.areObjectsEqual(this.viewScope,e.viewScope)||(await this.triggerEvent("beforeNoteSwitch",{noteContext:this}),h.default.closeActiveDialog(),this.notePath=n,this.viewScope=e.viewScope,({noteId:this.noteId,parentNoteId:this.parentNoteId}=r.Z.getNoteIdAndParentIdFromUrl(n)),this.saveToRecentNotes(n),g.Z.touchProtectedSessionIfNecessary(this.note),e.triggerSwitchEvent&&await this.triggerEvent("noteSwitched",{noteContext:this,notePath:this.notePath}),await this.setHoistedNoteIfNeeded(),h.default.isMobile()&&this.triggerCommand("setActiveScreen",{screen:"detail"})))}async setHoistedNoteIfNeeded(){if("root"===this.hoistedNoteId&&this.notePath.startsWith("root/_hidden")&&!this.note.isLabelTruthy("keepCurrentHoisting")){let t="_hidden";this.note.isLaunchBarConfig()?t="_lbRoot":this.note.isOptions()&&(t="_options"),await this.setHoistedNoteId(t)}}getSubContexts(){return k.tabManager.noteContexts.filter((t=>t.ntxId===this.ntxId||t.mainNtxId===this.ntxId))}isMainContext(){return!this.mainNtxId}getMainContext(){if(!this.mainNtxId)return this;try{return k.tabManager.getNoteContextById(this.mainNtxId)}catch(t){return this.mainNtxId=null,this}}saveToRecentNotes(t){setTimeout((async()=>{t&&t===this.notePath&&await p.Z.post("recent-notes",{noteId:this.note.noteId,notePath:this.notePath})}),5e3)}async getResolvedNotePath(t){const e=await r.Z.resolveNotePath(t,this.hoistedNoteId);if(e){if(!1!==await v.Z.checkNoteAccess(e,this))return e}else logError(`Cannot resolve note path ${t}`)}get note(){return this.noteId&&this.noteId in o.default.notes?o.default.notes[this.noteId]:null}get notePathArray(){return this.notePath?this.notePath.split("/"):[]}isActive(){return k.tabManager.activeNtxId===this.ntxId}getPojoState(){return"root"===this.hoistedNoteId||this.notePath||0!==this.getSubContexts().length?{ntxId:this.ntxId,mainNtxId:this.mainNtxId,notePath:this.notePath,hoistedNoteId:this.hoistedNoteId,active:this.isActive(),viewScope:this.viewScope}:null}async unhoist(){await this.setHoistedNoteId("root")}async setHoistedNoteId(t){this.hoistedNoteId!==t&&(this.hoistedNoteId=t,this.notePathArray?.includes(t)||h.default.isMobile()||await this.setNote(t),await this.triggerEvent("hoistedNoteChanged",{noteId:t,ntxId:this.ntxId}))}async isReadOnly(){if(this.viewScope.readOnlyTemporarilyDisabled)return!1;if(!this.note||"text"!==this.note.type&&"code"!==this.note.type)return!1;if(this.note.isLabelTruthy("readOnly"))return!0;if("source"===this.viewScope.viewMode)return!0;const t=await this.note.getBlob(),e="text"===this.note.type?l.Z.getInt("autoReadonlySizeText"):l.Z.getInt("autoReadonlySizeCode");return t.contentLength>e&&!this.note.isLabelTruthy("autoReadOnlyDisabled")}async entitiesReloadedEvent({loadResults:t}){t.isNoteReloaded(this.noteId)&&t.getEntityRow("notes",this.noteId).isDeleted&&(this.noteId=null,this.notePath=null,this.triggerEvent("noteSwitched",{noteContext:this,notePath:this.notePath}))}hasNoteList(){return this.note&&"default"===this.viewScope.viewMode&&this.note.hasChildren()&&["book","text","code"].includes(this.note.type)&&"text/x-sqlite;schema=trilium"!==this.note.mime&&!this.note.isLabelTruthy("hideChildrenOverview")}async getTextEditor(t){return this.timeout(new Promise((e=>k.triggerCommand("executeWithTextEditor",{callback:t,resolve:e,ntxId:this.ntxId}))))}async getCodeEditor(){return this.timeout(new Promise((t=>k.triggerCommand("executeWithCodeEditor",{resolve:t,ntxId:this.ntxId}))))}async getContentElement(){return this.timeout(new Promise((t=>k.triggerCommand("executeWithContentElement",{resolve:t,ntxId:this.ntxId}))))}async getTypeWidget(){return this.timeout(new Promise((t=>k.triggerCommand("executeWithTypeWidget",{resolve:t,ntxId:this.ntxId}))))}timeout(t){return Promise.race([t,new Promise((t=>setTimeout((()=>t(null)),200)))])}resetViewScope(){this.viewScope={}}async getNavigationTitle(){if(!this.note)return null;const{note:t,viewScope:e}=this;let n="default"===e.viewMode?t.title:`${t.title}: ${e.viewMode}`;if(e.attachmentId){const o=await t.getAttachmentById(e.attachmentId);o&&(n+=`: ${o.title}`)}return n}}const x=N;class C{constructor(){this.current=Promise.resolve()}lock(){let t;const e=new Promise((e=>t=()=>e())),n=this.current.then((()=>t));return this.current=e,n}async runExclusively(t){const e=await this.lock();try{return await t()}finally{e()}}}class E extends s.Z{constructor(){super(),this.children=[],this.mutex=new C,this.activeNtxId=null,this.recentlyClosedTabs=[],this.tabsUpdate=new y.Z((async()=>{if(!k.isMainWindow)return;const t=this.noteContexts.map((t=>t.getPojoState())).filter((t=>!!t));await p.Z.put("options",{openNoteContexts:JSON.stringify(t)})})),k.addBeforeUnloadListener(this)}get noteContexts(){return this.children}get mainNoteContexts(){return this.noteContexts.filter((t=>!t.mainNtxId))}async loadTabs(){try{const t=k.isMainWindow&&l.Z.getJson("openNoteContexts")||[];await o.default.getNotes([...t.flatMap((t=>[r.Z.getNoteIdFromUrl(t.notePath),t.hoistedNoteId]))],!0);const e=t.filter((t=>h.default.isMobile()?!!t.active:r.Z.getNoteIdFromUrl(t.notePath)in o.default.notes&&(t.hoistedNoteId in o.default.notes||(t.hoistedNoteId="root"),!0))),n=w.Z.parseNavigationStateFromUrl(window.location.href);0===e.length?(n.ntxId=n.ntxId||x.generateNtxId(),e.push({notePath:n.notePath||"root",ntxId:n.ntxId,active:!0,hoistedNoteId:n.hoistedNoteId||"root",viewScope:n.viewScope||{}})):e.find((t=>t.active))||(e[0].active=!0),await this.tabsUpdate.allowUpdateWithoutChange((async()=>{for(const t of e)await this.openContextWithNote(t.notePath,{activate:t.active,ntxId:t.ntxId,mainNtxId:t.mainNtxId,hoistedNoteId:t.hoistedNoteId,viewScope:t.viewScope})})),n.notePath?await k.tabManager.switchToNoteContext(n.ntxId,n.notePath,n.viewScope,n.hoistedNoteId):n.searchString&&await k.triggerCommand("searchNotes",{searchString:n.searchString})}catch(t){logError(`Loading note contexts '${l.Z.get("openNoteContexts")}' failed: ${t.message} ${t.stack}`),await this.openEmptyTab()}}noteSwitchedEvent({noteContext:t}){t.isActive()&&this.setCurrentNavigationStateToHash(),this.tabsUpdate.scheduleUpdate()}setCurrentNavigationStateToHash(){const t=this.calculateHash();0!==window.history.length&&t===window.location?.hash||window.history.pushState(null,"",t);const e=this.getActiveContext();this.updateDocumentTitle(e),this.triggerEvent("activeNoteChanged")}calculateHash(){const t=this.getActiveContext();return t?w.Z.calculateHash({notePath:t.notePath,ntxId:t.ntxId,hoistedNoteId:t.hoistedNoteId,viewScope:t.viewScope}):""}getNoteContexts(){return this.noteContexts}getMainNoteContexts(){return this.noteContexts.filter((t=>t.isMainContext()))}getNoteContextById(t){const e=this.noteContexts.find((e=>e.ntxId===t));if(!e)throw new Error(`找不到 noteContext id='${t}'`);return e}getActiveContext(){return this.activeNtxId?this.getNoteContextById(this.activeNtxId):null}getActiveMainContext(){return this.activeNtxId?this.getNoteContextById(this.activeNtxId).getMainContext():null}getActiveContextNotePath(){const t=this.getActiveContext();return t?t.notePath:null}getActiveContextNote(){const t=this.getActiveContext();return t?t.note:null}getActiveContextNoteId(){const t=this.getActiveContextNote();return t?t.noteId:null}getActiveContextNoteType(){const t=this.getActiveContextNote();return t?t.type:null}getActiveContextNoteMime(){const t=this.getActiveContextNote();return t?t.mime:null}async switchToNoteContext(t,e,n={},o=null){const i=this.noteContexts.find((e=>e.ntxId===t))||await this.openEmptyTab();await this.activateNoteContext(i.ntxId),o&&await i.setHoistedNoteId(o),e&&await i.setNote(e,{viewScope:n})}async openAndActivateEmptyTab(){const t=await this.openEmptyTab();await this.activateNoteContext(t.ntxId),await t.setEmpty()}async openEmptyTab(t=null,e="root",n=null){const o=new x(t,e,n);let i;return i=h.default.isMobile()?this.getActiveContext():this.children.find((t=>t.ntxId===o.ntxId)),i?(await i.setHoistedNoteId(e),i):(this.child(o),await this.triggerEvent("newNoteContextCreated",{noteContext:o}),o)}async openInNewTab(t,e=null){const n=await this.openEmptyTab(null,e||this.getActiveContext().hoistedNoteId);await n.setNote(t)}async openInSameTab(t,e=null){const n=this.getActiveContext();await n.setHoistedNoteId(e||n.hoistedNoteId),await n.setNote(t)}async openTabWithNoteWithHoisting(t,e={}){const n=this.getActiveContext();let o="root";if(n){const e=await r.Z.resolveNotePath(t,n.hoistedNoteId);(e.includes(n.hoistedNoteId)||e.includes("_hidden"))&&(o=n.hoistedNoteId)}return e.hoistedNoteId=o,this.openContextWithNote(t,e)}async openContextWithNote(t,e={}){const n=!!e.activate,o=e.ntxId||null,i=e.mainNtxId||null,s=e.hoistedNoteId||"root",a=e.viewScope||{viewMode:"default"},r=await this.openEmptyTab(o,s,i);return t&&await r.setNote(t,{triggerSwitchEvent:!n,viewScope:a}),n&&(this.activateNoteContext(r.ntxId,!1),await this.triggerEvent("noteSwitchedAndActivated",{noteContext:r,notePath:r.notePath})),r}async activateOrOpenNote(t){for(const e of this.getNoteContexts())if(e.note&&e.note.noteId===t)return void this.activateNoteContext(e.ntxId);await this.openContextWithNote(t,{activate:!0})}async activateNoteContext(t,e=!0){t!==this.activeNtxId&&(this.activeNtxId=t,e&&await this.triggerEvent("activeContextChanged",{noteContext:this.getNoteContextById(t)}),this.tabsUpdate.scheduleUpdate(),this.setCurrentNavigationStateToHash())}async removeNoteContext(t){return await this.mutex.runExclusively((async()=>{let e;try{e=this.getNoteContextById(t)}catch{return!1}if(e.isMainContext()&&1===this.getNoteContexts().filter((t=>t.isMainContext())).length){if(e.isEmpty())return!1;await this.openEmptyTab()}$(".aa-input").autocomplete("close");const n=e.getSubContexts(),o=n.map((t=>t.ntxId));if(await this.triggerEvent("beforeNoteContextRemove",{ntxIds:o}),e.isMainContext())this.mainNoteContexts.length<=1?await this.openAndActivateEmptyTab():o.includes(this.activeNtxId)&&(this.mainNoteContexts.findIndex((t=>t.ntxId===e.ntxId))===this.mainNoteContexts.length-1?await this.activatePreviousTabCommand():await this.activateNextTabCommand());else{const t=e.getMainContext().getSubContexts(),n=t.findIndex((t=>t.ntxId===e.ntxId)),o=t[n===t.length-1?n-1:n+1];await this.activateNoteContext(o.ntxId)}return this.removeNoteContexts(n),!0}))}removeNoteContexts(t){const e=t.map((t=>t.ntxId)),n=this.noteContexts.findIndex((t=>e.includes(t.ntxId)));this.children=this.children.filter((t=>!e.includes(t.ntxId))),this.addToRecentlyClosedTabs(t,n),this.triggerEvent("noteContextRemoved",{ntxIds:e}),this.tabsUpdate.scheduleUpdate()}addToRecentlyClosedTabs(t,e){1===t.length&&t[0].isEmpty()||this.recentlyClosedTabs.push({contexts:t,position:e})}tabReorderEvent({ntxIdsInOrder:t}){const e={};let n=0;for(const o of t)for(const t of this.getNoteContextById(o).getSubContexts())e[t.ntxId]=n++;this.children.sort(((t,n)=>e[t.ntxId]<e[n.ntxId]?-1:1)),this.tabsUpdate.scheduleUpdate()}noteContextReorderEvent({ntxIdsInOrder:t,oldMainNtxId:e,newMainNtxId:n}){const o=Object.fromEntries(t.map(((t,e)=>[t,e])));this.children.sort(((t,e)=>o[t.ntxId]<o[e.ntxId]?-1:1)),e&&n&&this.children.forEach((t=>{t.ntxId===n?t.mainNtxId=null:t.ntxId!==e&&t.mainNtxId!==e||(t.mainNtxId=n)})),this.tabsUpdate.scheduleUpdate()}async activateNextTabCommand(){const t=this.getActiveMainContext().ntxId,e=this.mainNoteContexts.findIndex((e=>e.ntxId===t)),n=this.mainNoteContexts[e===this.mainNoteContexts.length-1?0:e+1].ntxId;await this.activateNoteContext(n)}async activatePreviousTabCommand(){const t=this.getActiveMainContext().ntxId,e=this.mainNoteContexts.findIndex((e=>e.ntxId===t)),n=this.mainNoteContexts[0===e?this.mainNoteContexts.length-1:e-1].ntxId;await this.activateNoteContext(n)}async closeActiveTabCommand(){await this.removeNoteContext(this.activeNtxId)}beforeUnloadEvent(){return this.tabsUpdate.updateNowIfNecessary(),!0}openNewTabCommand(){this.openAndActivateEmptyTab()}async closeAllTabsCommand(){for(const t of this.mainNoteContexts.map((t=>t.ntxId)))await this.removeNoteContext(t)}async closeOtherTabsCommand({ntxId:t}){for(const e of this.mainNoteContexts.map((t=>t.ntxId)))e!==t&&await this.removeNoteContext(e)}async closeTabCommand({ntxId:t}){await this.removeNoteContext(t)}async moveTabToNewWindowCommand({ntxId:t}){const{notePath:e,hoistedNoteId:n}=this.getNoteContextById(t);await this.removeNoteContext(t)&&this.triggerCommand("openInWindow",{notePath:e,hoistedNoteId:n})}async reopenLastTabCommand(){let t=null;await this.mutex.runExclusively((async()=>{if(0===this.recentlyClosedTabs.length)return;1===this.noteContexts.length&&this.noteContexts[0].isEmpty()&&(t=this.noteContexts[0]);const e=this.recentlyClosedTabs.pop(),n=e.contexts;for(const t of n)this.child(t),await this.triggerEvent("newNoteContextCreated",{noteContext:t});const o=[...this.noteContexts.slice(0,e.position),...this.noteContexts.slice(-n.length),...this.noteContexts.slice(e.position,-n.length)];await this.noteContextReorderEvent({ntxIdsInOrder:o.map((t=>t.ntxId))});let i=n.find((t=>t.isMainContext()));i?await this.triggerEvent("contextsReopened",{mainNtxId:i.ntxId,tabPosition:o.filter((t=>t.isMainContext())).findIndex((t=>t.ntxId===i.ntxId))}):await this.triggerEvent("contextsReopened",{ntxId:o[e.position].ntxId,afterNtxId:o[e.position-1].ntxId});const s=1===n.length?n[0]:n.find((t=>t.isMainContext()));await this.activateNoteContext(s.ntxId),await this.triggerEvent("noteSwitched",{noteContext:s,notePath:s.notePath})})),t&&await this.removeNoteContext(t.ntxId)}hoistedNoteChangedEvent(){this.tabsUpdate.scheduleUpdate()}async updateDocumentTitle(t){const e=[await t.getNavigationTitle(),"Trilium Notes"].filter(Boolean);document.title=e.join(" - ")}async entitiesReloadedEvent({loadResults:t}){const e=this.getActiveContext();e&&t.isNoteReloaded(e.noteId)&&await this.updateDocumentTitle(e)}async frocaReloadedEvent(){const t=this.getActiveContext();t&&await this.updateDocumentTitle(t)}}var A=n(6604);class S extends s.Z{setActiveScreenCommand({screen:t}){t!==this.activeScreen&&(this.activeScreen=t,"tree"===t&&k.tabManager.getActiveContext().setEmpty(),this.triggerEvent("activeScreenChanged",{activeScreen:t}))}}var P=n(8181);class T extends s.Z{get tree(){return k.noteTreeWidget}async cloneNotesToCommand(){const t=this.tree.getSelectedOrActiveNodes().map((t=>t.data.noteId));this.triggerCommand("cloneNoteIdsTo",{noteIds:t})}async moveNotesToCommand(){const t=this.tree.getSelectedOrActiveNodes().map((t=>t.data.branchId));this.triggerCommand("moveBranchIdsTo",{branchIds:t})}async createNoteIntoCommand(){const t=k.tabManager.getActiveContext();t&&await P.Z.createNote(t.notePath,{isProtected:t.note.isProtected,saveSelection:!1})}async createNoteAfterCommand(){const t=this.tree.getActiveNode();if(!t)return;const e=r.Z.getNotePath(t.getParent()),n=r.Z.getParentProtectedStatus(t);"root"!==t.data.noteId&&t.data.noteId!==v.Z.getHoistedNoteId()&&await P.Z.createNote(e,{target:"after",targetBranchId:t.data.branchId,isProtected:n,saveSelection:!1})}}var _=n(1065);class M extends s.Z{constructor(){super(),p.Z.get("keyboard-shortcuts-for-notes").then((t=>{for(const e of t)this.bindNoteShortcutHandler(e)}))}bindNoteShortcutHandler(t){const e=t.attributeId;t.isDeleted?_.Z.removeGlobalShortcut(e):_.Z.bindGlobalShortcut(t.value,(()=>k.tabManager.getActiveContext().setNote(t.noteId)),e)}async entitiesReloadedEvent({loadResults:t}){for(const e of t.getAttributeRows())if("label"===e.type&&"keyboardShortcut"===e.name){const t=await o.default.getNote(e.noteId);t&&"launcher"!==t.type&&this.bindNoteShortcutHandler(e)}}}class Z extends s.Z{constructor(t){super(),this.isMainWindow=t,this.components=[],this.beforeUnloadListeners=[]}setLayout(t){this.layout=t}async start(){this.initComponents(),await l.Z.initializedPromise,this.renderWidgets(),await o.default.initializedPromise,this.tabManager.loadTabs(),setTimeout((()=>i.default.executeStartupBundles()),2e3)}initComponents(){this.tabManager=new E,this.components=[this.tabManager,new u,new I,new T,new M],h.default.isMobile()&&this.components.push(new S);for(const t of this.components)this.child(t);h.default.isElectron()&&this.child(b.Z)}renderWidgets(){const t=this.layout.getRootWidget(this),e=t.render();A.default.updateDisplayedShortcuts(e),$("body").append(e),e.on("click","[data-trigger-command]",(function(){if($(this).hasClass("disabled"))return;const t=$(this).attr("data-trigger-command");$(this).closest(".component").prop("component").triggerCommand(t,{$el:$(this)})})),this.child(t),this.triggerEvent("initialRenderComplete")}triggerEvent(t,e={}){return this.handleEvent(t,e)}triggerCommand(t,e={}){for(const n of this.components){const o=n[`${t}Command`];if(o)return n.callMethod(o,e)}return console.debug(`Unhandled command ${t}, converting to event.`),this.triggerEvent(t,e)}getComponentByEl(t){return $(t).closest(".component").prop("component")}addBeforeUnloadListener(t){"function"==typeof WeakRef&&this.beforeUnloadListeners.push(new WeakRef(t))}}const R=new Z(window.glob.isMainWindow);$(window).on("beforeunload",(()=>{let t=!0;R.beforeUnloadListeners=R.beforeUnloadListeners.filter((t=>!!t.deref()));for(const e of R.beforeUnloadListeners){const n=e.deref();n&&(n.beforeUnloadEvent()||(console.log(`Component ${n.componentId} is not finished saving its state.`),f.default.showMessage("请等待几秒钟以完成保存, 然后可以重试.",1e4),t=!1))}if(!t)return"some string"})),$(window).on("hashchange",(function(){const{notePath:t,ntxId:e,viewScope:n}=w.Z.parseNavigationStateFromUrl(window.location.href);(t||e)&&R.tabManager.switchToNoteContext(e,t,n)}));const k=R},8866:(t,e,n)=>{n.d(e,{Z:()=>i});var o=n(9046);class i{constructor(){this.componentId=`${this.sanitizedClassName}-${o.default.randomString(8)}`,this.children=[],this.initialized=null}get sanitizedClassName(){return this.constructor.name.replace(/[^A-Z0-9]/gi,"_")}setParent(t){return this.parent=t,this}child(...t){for(const e of t)e.setParent(this),this.children.push(e);return this}handleEvent(t,e){try{const n=this.initialized?this.initialized.then((()=>this.callMethod(this[`${t}Event`],e))):this.callMethod(this[`${t}Event`],e),o=this.handleEventInChildren(t,e);return n&&o?Promise.all([n,o]):n||o}catch(e){return console.error(`Handling of event '${t}' failed in ${this.constructor.name} with error ${e.message} ${e.stack}`),null}}triggerEvent(t,e={}){return this.parent.triggerEvent(t,e)}handleEventInChildren(t,e={}){const n=[];for(const o of this.children){const i=o.handleEvent(t,e);i&&n.push(i)}return n.length>0?Promise.all(n):null}triggerCommand(t,e={}){const n=this[`${t}Command`];return n?this.callMethod(n,e):this.parent.triggerCommand(t,e)}callMethod(t,e){if("function"!=typeof t)return;const n=Date.now(),i=t.call(this,e),s=Date.now()-n;return glob.isDev&&s>20&&console.log(`Call to ${t.name} in ${this.componentId} took ${s}ms`),glob.isDev&&i?o.default.timeLimit(i,2e4,`Time limit failed on ${this.constructor.name} with ${t.name}`):i}}},9925:(t,e,n)=>{n.d(e,{Z:()=>r});var o=n(4378),i=n(8866),s=n(9046);class a extends i.Z{constructor(){super(),s.default.isElectron()&&(o.Z.initializedPromise.then((()=>{this.setZoomFactor(o.Z.getFloat("zoomFactor"))})),window.addEventListener("wheel",(t=>{t.ctrlKey&&this.setZoomFactorAndSave(this.getCurrentZoom()+.001*t.deltaY)})))}setZoomFactor(t){t=parseFloat(t),s.default.dynamicRequire("electron").webFrame.setZoomFactor(t)}async setZoomFactorAndSave(t){t>=.5&&t<=2?(t=Math.round(10*t)/10,this.setZoomFactor(t),await o.Z.save("zoomFactor",t)):console.log(`Zoom factor ${t} outside of the range, ignored.`)}getCurrentZoom(){return s.default.dynamicRequire("electron").webFrame.getZoomFactor()}zoomOutEvent(){this.setZoomFactorAndSave(this.getCurrentZoom()-.1)}zoomInEvent(){this.setZoomFactorAndSave(this.getCurrentZoom()+.1)}zoomResetEvent(){this.setZoomFactorAndSave(1)}setZoomFactorAndSaveEvent({zoomFactor:t}){this.setZoomFactorAndSave(t)}}const r=new a},9763:(t,e,n)=>{n.d(e,{Z:()=>o});const o=class{constructor(t,e){this.froca=t,this.update(e)}update(t){this.attachmentId=t.attachmentId,this.ownerId=t.ownerId,this.role=t.role,this.mime=t.mime,this.title=t.title,this.dateModified=t.dateModified,this.utcDateModified=t.utcDateModified,this.utcDateScheduledForErasureSince=t.utcDateScheduledForErasureSince,this.contentLength=t.contentLength,this.froca.attachments[this.attachmentId]=this}getNote(){return this.froca.notes[this.ownerId]}async getBlob(){return await this.froca.getBlob("attachments",this.attachmentId)}}},9673:(t,e,n)=>{n.d(e,{Z:()=>i});var o=n(3847);const i=class{constructor(t,e){this.froca=t,this.update(e)}update(t){this.attributeId=t.attributeId,this.noteId=t.noteId,this.type=t.type,this.name=t.name,this.value=t.value,this.position=t.position,this.isInheritable=!!t.isInheritable}getNote(){return this.froca.notes[this.noteId]}async getTargetNote(){const t=this.targetNoteId;return await this.froca.getNote(t,!0)}get targetNoteId(){if("relation"!==this.type)throw new Error(`Attribute ${this.attributeId} is not a relation`);return this.value}get isAutoLink(){return"relation"===this.type&&["internalLink","imageLink","relationMapLink","includeNoteLink"].includes(this.name)}get toString(){return`FAttribute(attributeId=${this.attributeId}, type=${this.type}, name=${this.name}, value=${this.value})`}isDefinition(){return"label"===this.type&&(this.name.startsWith("label:")||this.name.startsWith("relation:"))}getDefinition(){return o.Z.parse(this.value)}isDefinitionFor(t){return"label"===this.type&&this.name===`${t.type}:${t.name}`}get dto(){const t=Object.assign({},this);return delete t.froca,t}}},8726:(t,e,n)=>{n.d(e,{Z:()=>o});const o=class{constructor(t,e){this.froca=t,this.update(e)}update(t){this.branchId=t.branchId,this.noteId=t.noteId,this.parentNoteId=t.parentNoteId,this.notePosition=t.notePosition,this.prefix=t.prefix,this.isExpanded=!!t.isExpanded,this.fromSearchNote=!!t.fromSearchNote}async getNote(){return this.froca.getNote(this.noteId)}getNoteFromCache(){return this.froca.getNoteFromCache(this.noteId)}async getParentNote(){return this.froca.getNote(this.parentNoteId)}isTopLevel(){return"root"===this.parentNoteId}get toString(){return`FBranch(branchId=${this.branchId})`}get pojo(){const t={...this};return delete t.froca,t}}},2021:(t,e,n)=>{n.d(e,{Z:()=>g});var o=n(1736),i=n(4585),s=n(4264),a=n(1412),r=n(2040);const d=new Set,c=function(t){if(!t?.trim())return"";const e=t.replace(/[^a-z0-9]/gi,"");if(!e.trim())return"";const n=`color-${e}`;return d.has(n)||($("head").append(`<style>.${n}, span.fancytree-active.${n} { color: ${t} !important; }</style>`),d.add(n)),n},l="label",h="relation",u={file:"bx bx-file",image:"bx bx-image",code:"bx bx-code",render:"bx bx-extension",search:"bx bx-file-find",relationMap:"bx bx-map-alt",book:"bx bx-book",noteMap:"bx bx-map-alt",mermaid:"bx bx-selection",canvas:"bx bx-pen",webView:"bx bx-globe-alt",launcher:"bx bx-link",doc:"bx bxs-file-doc",contentWidget:"bx bxs-widget"},g=class{constructor(t,e){this.froca=t,this.attributes=[],this.targetRelations=[],this.parents=[],this.children=[],this.parentToBranch={},this.childToBranch={},this.attachments=null,this.update(e)}update(t){this.noteId=t.noteId,this.title=t.title,this.isProtected=!!t.isProtected,this.type=t.type,this.mime=t.mime,this.blobId=t.blobId}addParent(t,e,n=!0){"none"!==t&&(this.parents.includes(t)||this.parents.push(t),this.parentToBranch[t]=e,n&&this.sortParents())}addChild(t,e,n=!0){t in this.childToBranch||this.children.push(t),this.childToBranch[t]=e,n&&this.sortChildren()}sortChildren(){const t={};for(const e of Object.values(this.childToBranch))t[e]=this.froca.getBranch(e).notePosition;this.children.sort(((e,n)=>t[this.childToBranch[e]]-t[this.childToBranch[n]]))}isJson(){return"application/json"===this.mime}async getContent(){const t=await this.getBlob();return t?.content}async getJsonContent(){const t=await this.getContent();try{return JSON.parse(t)}catch(t){return console.log(`Cannot parse content of note '${this.noteId}': `,t.message),null}}getParentBranchIds(){return Object.values(this.parentToBranch)}getBranchIds(){return this.getParentBranchIds()}getParentBranches(){const t=Object.values(this.parentToBranch);return this.froca.getBranches(t)}getBranches(){return this.getParentBranches()}hasChildren(){return this.children.length>0}getChildBranches(){const t=this.children.map((t=>this.childToBranch[t]));return this.froca.getBranches(t)}getParentNoteIds(){return this.parents}getParentNotes(){return this.froca.getNotesFromCache(this.parents)}sortParents(){this.parents.sort(((t,e)=>{const n=this.parentToBranch[t];if(n&&n.startsWith("virt-"))return 1;const o=this.froca.getNoteFromCache(t);return o.isArchived||o.isHiddenCompletely()?1:t<e?-1:1}))}get isArchived(){return this.hasAttribute("label","archived")}getChildNoteIds(){return this.children}async getChildNotes(){return await this.froca.getNotes(this.children)}async getAttachments(){return this.attachments||(this.attachments=await this.froca.getAttachmentsForNote(this.noteId)),this.attachments}async getAttachmentsByRole(t){return(await this.getAttachments()).filter((e=>e.role===t))}async getAttachmentById(t){return(await this.getAttachments()).find((e=>e.attachmentId===t))}isEligibleForConversionToAttachment(){if("image"!==this.type||!this.isContentAvailable()||this.hasChildren()||1!==this.getParentBranches().length)return!1;const t=this.getTargetRelations().filter((t=>"imageLink"===t.name));if(t.length>1)return!1;const e=this.getParentNotes()[0],n=t[0]?.getNote();return!(n&&n!==e||"text"!==e.type||!e.isContentAvailable())}getOwnedAttributes(t,e){const n=this.attributes.map((t=>this.froca.attributes[t])).filter(Boolean);return this.__filterAttrs(n,t,e)}getAttributes(t,e){return this.__filterAttrs(this.__getCachedAttributes([]),t,e)}__getCachedAttributes(t){if(t.includes(this.noteId))return[];if(!(this.noteId in i.Z.attributes)){const e=[...t,this.noteId],n=[this.getOwnedAttributes()];if("root"!==this.noteId&&"_hidden"!==this.noteId)for(const t of this.getParentNotes())"search"!==t.type&&n.push(t.__getInheritableAttributes(e));for(const t of n.flat().filter((t=>"relation"===t.type&&["template","inherit"].includes(t.name)))){const o=this.froca.notes[t.value];o&&o.noteId!==this.noteId&&n.push(o.__getCachedAttributes(e).filter((t=>!("label"===t.type&&("template"===t.name||"workspacetemplate"===t.name)))))}i.Z.attributes[this.noteId]=[];const o=new Set;for(const t of n.flat())o.has(t.attributeId)||(o.add(t.attributeId),i.Z.attributes[this.noteId].push(t))}return i.Z.attributes[this.noteId]}isRoot(){return"root"===this.noteId}getAllNotePaths(){if("root"===this.noteId)return[["root"]];const t=this.getParentNotes().filter((t=>"search"!==t.type)),e=1===t.length?t[0].getAllNotePaths():t.flatMap((t=>t.getAllNotePaths()));for(const t of e)t.push(this.noteId);return e}getSortedNotePathRecords(t="root"){const e="root"===t,n=this.getAllNotePaths().map((n=>({notePath:n,isInHoistedSubTree:e||n.includes(t),isArchived:n.some((t=>a.default.notes[t].isArchived)),isSearch:n.find((t=>"search"===a.default.notes[t].type)),isHidden:n.includes("_hidden")})));return n.sort(((t,e)=>t.isInHoistedSubTree!==e.isInHoistedSubTree?t.isInHoistedSubTree?-1:1:t.isArchived!==e.isArchived?t.isArchived?1:-1:t.isHidden!==e.isHidden?t.isHidden?1:-1:t.isSearch!==e.isSearch?t.isSearch?1:-1:t.notePath.length-e.notePath.length)),n}getBestNotePath(t="root"){return this.getSortedNotePathRecords(t)[0]?.notePath}getBestNotePathString(t="root"){const e=this.getBestNotePath(t);return e?.join("/")}isHiddenCompletely(){if("_hidden"===this.noteId)return!0;if("root"===this.noteId)return!1;for(const t of this.getParentNotes()){if("root"===t.noteId)return!1;if("_hidden"!==t.noteId&&"search"!==t.type&&!t.isHiddenCompletely())return!1}return!0}__filterAttrs(t,e,n){return this.__validateTypeName(e,n),e||n?e&&n?t.filter((t=>t.name===n&&t.type===e)):e?t.filter((t=>t.type===e)):n?t.filter((t=>t.name===n)):void 0:t}__getInheritableAttributes(t){return this.__getCachedAttributes(t).filter((t=>t.isInheritable))}__validateTypeName(t,e){if(t&&"label"!==t&&"relation"!==t)throw new Error(`Unrecognized attribute type '${t}'. Only 'label' and 'relation' are possible values.`);if(e){const t=e.charAt(0);if("#"===t||"~"===t)throw new Error("Detect '#' or '~' in the attribute's name. In the API, attribute names should be set without these characters.")}}getOwnedLabels(t){return this.getOwnedAttributes(l,t)}getLabels(t){return this.getAttributes(l,t)}getIcon(){const t=this.getLabels("iconClass"),e=this.getWorkspaceIconClass();return t.length>0?t[0].value:e||("root"===this.noteId?"bx bx-chevrons-right":"_share"===this.noteId?"bx bx-share-alt":"text"===this.type?this.isFolder()?"bx bx-folder":"bx bx-note":"code"===this.type&&this.mime.startsWith("text/x-sql")?"bx bx-data":u[this.type])}getColorClass(){const t=this.getLabelValue("color");return c(t)}isFolder(){return"search"===this.type||this.getFilteredChildBranches().length>0}getFilteredChildBranches(){let t=this.getChildBranches();if(t)return t;s.Z.logError(`No children for '${this.noteId}'. This shouldn't happen.`)}getOwnedRelations(t){return this.getOwnedAttributes(h,t)}getRelations(t){return this.getAttributes(h,t)}hasAttribute(t,e){return this.getAttributes().some((n=>n.name===e&&n.type===t))}hasOwnedAttribute(t,e){return!!this.getOwnedAttribute(t,e)}getOwnedAttribute(t,e){return this.getOwnedAttributes().find((n=>n.name===e&&n.type===t))}getAttribute(t,e){return this.getAttributes().find((n=>n.name===e&&n.type===t))}getOwnedAttributeValue(t,e){const n=this.getOwnedAttribute(t,e);return n?n.value:null}getAttributeValue(t,e){const n=this.getAttribute(t,e);return n?n.value:null}hasOwnedLabel(t){return this.hasOwnedAttribute(l,t)}hasLabel(t){return this.hasAttribute(l,t)}isLabelTruthy(t){const e=this.getLabel(t);return!!e&&e&&"false"!==e.value}hasOwnedRelation(t){return this.hasOwnedAttribute(h,t)}hasRelation(t){return this.hasAttribute(h,t)}getOwnedLabel(t){return this.getOwnedAttribute(l,t)}getLabel(t){return this.getAttribute(l,t)}getOwnedRelation(t){return this.getOwnedAttribute(h,t)}getRelation(t){return this.getAttribute(h,t)}getOwnedLabelValue(t){return this.getOwnedAttributeValue(l,t)}getLabelValue(t){return this.getAttributeValue(l,t)}getOwnedRelationValue(t){return this.getOwnedAttributeValue(h,t)}getRelationValue(t){return this.getAttributeValue(h,t)}async getRelationTarget(t){const e=await this.getRelationTargets(t);return e.length>0?e[0]:null}async getRelationTargets(t){const e=this.getRelations(t),n=[];for(const t of e)n.push(await this.froca.getNote(t.value));return n}getNotesToInheritAttributesFrom(){return[...this.getRelations("template"),...this.getRelations("inherit")].map((t=>this.froca.notes[t.value]))}getPromotedDefinitionAttributes(){if(this.isLabelTruthy("hidePromotedAttributes"))return[];const t=this.getAttributes().filter((t=>t.isDefinition())).filter((t=>{const e=t.getDefinition();return e&&e.isPromoted}));return t.sort(((t,e)=>t.noteId===e.noteId?t.position<e.position?-1:1:t.noteId<e.noteId?-1:1)),t}hasAncestor(t,e=!1,n=null){if(this.noteId===t)return!0;if(n){if(n.has(this.noteId))return!1}else n=new Set;if(n.add(this.noteId),e)for(const o of this.getNotesToInheritAttributesFrom())if(o.hasAncestor(t,e,n))return!0;for(const o of this.getParentNotes())if(o.hasAncestor(t,e,n))return!0;return!1}isInHiddenSubtree(){return"_hidden"===this.noteId||this.hasAncestor("_hidden")}invalidateAttributeCache(){}getTargetRelations(){return this.targetRelations.map((t=>this.froca.attributes[t]))}async getTargetRelationSourceNotes(){const t=this.getTargetRelations();return await this.froca.getNotes(t.map((t=>t.noteId)))}async getNoteComplement(){return this.getBlob()}async getBlob(){return await this.froca.getBlob("notes",this.noteId)}toString(){return`Note(noteId=${this.noteId}, title=${this.title})`}get dto(){const t=Object.assign({},this);return delete t.froca,t}getCssClass(){return this.getLabels("cssClass").map((t=>t.value)).join(" ")}getWorkspaceIconClass(){const t=this.getLabels("workspaceIconClass");return t.length>0?t[0].value:""}getWorkspaceTabBackgroundColor(){const t=this.getLabels("workspaceTabBackgroundColor");return t.length>0?t[0].value:""}isJavaScript(){return("code"===this.type||"file"===this.type||"launcher"===this.type)&&(this.mime.startsWith("application/javascript")||"application/x-javascript"===this.mime||"text/javascript"===this.mime)}isHtml(){return("code"===this.type||"file"===this.type||"render"===this.type)&&"text/html"===this.mime}getScriptEnv(){return this.isHtml()||this.isJavaScript()&&this.mime.endsWith("env=frontend")||"render"===this.type?"frontend":this.isJavaScript()&&this.mime.endsWith("env=backend")?"backend":null}async executeScript(){if(!this.isJavaScript())throw new Error(`Note ${this.noteId} is of type ${this.type} and mime ${this.mime} and thus cannot be executed`);const t=this.getScriptEnv();if("frontend"===t){const t=(await Promise.resolve().then(n.bind(n,394))).default;return await t.getAndExecuteBundle(this.noteId)}if("backend"!==t)throw new Error(`Unrecognized env type ${t} for note ${this.noteId}`);await o.Z.post(`script/run/${this.noteId}`)}isShared(){for(const t of this.parents){if("root"===t||"none"===t)continue;const e=a.default.notes[t];if(e&&"search"!==e.type&&("_share"===e.noteId||e.isShared()))return!0}return!1}isContentAvailable(){return!this.isProtected||r.Z.isProtectedSessionAvailable()}isLaunchBarConfig(){return"launcher"===this.type||["_lbRoot","_lbAvailableLaunchers","_lbVisibleLaunchers"].includes(this.noteId)}isOptions(){return this.noteId.startsWith("_options")}async getMetadata(){return await o.Z.get(`notes/${this.noteId}/metadata`)}}},1801:(t,e,n)=>{n.d(e,{Z:()=>i});var o=n(6604);const i=new class{constructor(){this.$widget=$("#context-menu-container"),this.dateContextMenuOpenedMs=0,$(document).on("click",(()=>this.hide()))}async show(t){this.options=t,this.$widget.empty(),this.addItems(this.$widget,t.items),o.default.updateDisplayedShortcuts(this.$widget),this.positionMenu(),this.dateContextMenuOpenedMs=Date.now()}positionMenu(){const t=document.documentElement.clientHeight,e=document.documentElement.clientWidth,n=this.$widget.outerHeight(),o=this.$widget.outerWidth();let i,s;i=this.options.y+n-0>t-5?t-n-5:this.options.y-0<5?5:this.options.y-0,s="left"===this.options.orientation?this.options.x+0>e-5?e-o-0:this.options.x-o+0<5?5:this.options.x-o+0:this.options.x+o-0>e-5?e-o-5:this.options.x-0<5?5:this.options.x-0,this.$widget.css({display:"block",top:i,left:s}).addClass("show")}addItems(t,e){for(const n of e)if(n)if("----"===n.title)t.append($("<div>").addClass("dropdown-divider"));else{const e=$("<span>");n.uiIcon?e.addClass(n.uiIcon):e.append("&nbsp;");const o=$("<span>").append(e).append(" &nbsp; ").append(n.title),i=$("<li>").addClass("dropdown-item").append(o).on("contextmenu",(t=>!1)).on("mousedown",(t=>(t.stopPropagation(),1!==t.which||(this.hide(),n.handler&&n.handler(n,t),this.options.selectMenuItemHandler(n,t)),!1)));if(void 0===n.enabled||n.enabled||i.addClass("disabled"),n.items){i.addClass("dropdown-submenu"),o.addClass("dropdown-toggle");const t=$("<ul>").addClass("dropdown-menu");this.addItems(t,n.items),i.append(t)}t.append(i)}}hide(){Date.now()-this.dateContextMenuOpenedMs>300&&setTimeout((()=>this.$widget.hide()),100)}}},592:(t,e,n)=>{n.d(e,{Z:()=>s});var o=n(1801),i=n(2817);const s={openContextMenu:function(t,e,n={},s=null){o.Z.show({x:e.pageX,y:e.pageY,items:[{title:"在新标签页中打开笔记",command:"openNoteInNewTab",uiIcon:"bx bx-empty"},{title:"在新的拆分中打开笔记",command:"openNoteInNewSplit",uiIcon:"bx bx-dock-right"},{title:"在新窗口中打开笔记",command:"openNoteInNewWindow",uiIcon:"bx bx-window-open"}],selectMenuItemHandler:({command:e})=>{if(s||(s=i.default.tabManager.getActiveContext().hoistedNoteId),"openNoteInNewTab"===e)i.default.tabManager.openContextWithNote(t,{hoistedNoteId:s,viewScope:n});else if("openNoteInNewSplit"===e){const e=i.default.tabManager.getActiveContext().getSubContexts(),{ntxId:o}=e[e.length-1];i.default.triggerCommand("openNewNoteSplit",{ntxId:o,notePath:t,hoistedNoteId:s,viewScope:n})}else"openNoteInNewWindow"===e&&i.default.triggerCommand("openInWindow",{notePath:t,hoistedNoteId:s,viewScope:n})}})}}},1375:(t,e,n)=>{n.d(e,{Z:()=>d});var o=n(4264),i=n(1412);async function s(t,e){const n=e&&t.isInheritable?"(可继承的)":"",s=$("<span>");if("label"===t.type)s.append(document.createTextNode(`#${t.name}${n}`)),t.value&&(s.append("="),s.append(document.createTextNode((a=t.value,/^[\p{L}\p{N}\-_,.]+$/u.test(a)?a:a.includes('"')?a.includes("'")?a.includes("`")?`"${a.replace(/"/g,'\\"')}"`:`\`${a}\``:`'${a}'`:`"${a}"`))));else if("relation"===t.type){if(t.isAutoLink)return s;t.value&&(s.append(document.createTextNode(`~${t.name}${n}=`)),s.append(await async function(t){const e=await i.default.getNote(t);if(e)return $("<a>",{href:`#root/${t}`,class:"reference-link"}).text(e.title)}(t.value)))}else o.Z.logError(`Unknown attr type: ${t.type}`);var a;return s}async function a(t,e){const n=$('<span class="rendered-note-attributes">');for(let o=0;o<t.length;o++){const i=t[o],a=await s(i,e);n.append(a.html()),o<t.length-1&&n.append(" ")}return n}const r=["originalFileName","fileSize","template","inherit","cssClass","iconClass","pageSize","viewType"],d={renderAttribute:s,renderAttributes:a,renderNormalAttributes:async function(t){const e=t.getPromotedDefinitionAttributes();let n=t.getAttributes();n=e.length>0?n.filter((t=>!!e.find((e=>e.isDefinitionFor(t))))):n.filter((e=>!e.isDefinition()&&!e.isAutoLink&&!r.includes(e.name)&&e.noteId===t.noteId));const o=await a(n,!1);return{count:n.length,$renderedAttributes:o}}}},394:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>__WEBPACK_DEFAULT_EXPORT__});var _script_context_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(5574),_server_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1736),_toast_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(6885),_froca_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(1412),_utils_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(9046);async function getAndExecuteBundle(t,e=null,n=null,o=null){const i=await _server_js__WEBPACK_IMPORTED_MODULE_1__.Z.post(`script/bundle/${t}`,{script:n,params:o});return await executeBundle(i,e)}async function executeBundle(bundle,originEntity,$container){const apiContext=await(0,_script_context_js__WEBPACK_IMPORTED_MODULE_0__.Z)(bundle.noteId,bundle.allNoteIds,originEntity,$container);try{return await function(){return eval(`const apiContext = this; (async function() { ${bundle.script}\r\n})()`)}.call(apiContext)}catch(t){const e=await _froca_js__WEBPACK_IMPORTED_MODULE_3__.default.getNote(bundle.noteId);_toast_js__WEBPACK_IMPORTED_MODULE_2__.default.showAndLogError(`执行 ID 为 ${bundle.noteId} 的JS笔记"${e.title}"失败, 错误: ${t.message}`)}}async function executeStartupBundles(){const t=_utils_js__WEBPACK_IMPORTED_MODULE_4__.default.isMobile(),e=await _server_js__WEBPACK_IMPORTED_MODULE_1__.Z.get("script/startup"+(t?"?mobile=true":""));for(const t of e)await executeBundle(t)}class WidgetsByParent{constructor(){this.byParent={}}add(t){t.parentWidget?(this.byParent[t.parentWidget]=this.byParent[t.parentWidget]||[],this.byParent[t.parentWidget].push(t)):console.log("Custom widget does not have mandatory 'parentWidget' property defined")}get(t){return this.byParent[t]?this.byParent[t].map((t=>t.prototype?new t:t)):[]}}async function getWidgetBundlesByParent(){const t=await _server_js__WEBPACK_IMPORTED_MODULE_1__.Z.get("script/widgets"),e=new WidgetsByParent;for(const n of t){let t;try{t=await executeBundle(n),e.add(t)}catch(t){logError("小部件初始化失败: ",t);continue}}return e}const __WEBPACK_DEFAULT_EXPORT__={executeBundle,getAndExecuteBundle,executeStartupBundles,getWidgetBundlesByParent}},5913:(t,e,n)=>{n.d(e,{Z:()=>f});var o=n(5437),i=n(7336),s=n(2040),a=n(6707),r=n(5489),d=n(1412),c=n(9046),l=n(7844),h=n(8481),u=n(2021),g=n(9763);let p=1;const f={getRenderedContent:async function(t,e={}){e=Object.assign({tooltip:!1},e);const n=function(t){let e=t.type||t.role;const n=t.mime;return"file"===e&&"application/pdf"===n?e="pdf":"file"===e&&n.startsWith("audio/")?e="audio":"file"===e&&n.startsWith("video/")&&(e="video"),t.isProtected&&(s.Z.isProtectedSessionAvailable()?s.Z.touchProtectedSession():e="protectedSession"),e}(t),f=$('<div class="rendered-content">');if("text"===n)await async function(t,e){const n=await t.getBlob();if(c.default.isHtmlEmpty(n.content))await async function(t,e){t.css("padding","10px"),t.addClass("text-with-ellipsis");let n=e.getChildNoteIds();n.length>10&&(n=n.slice(0,10));const o=await d.default.getNotes(n);for(const n of o)t.append(await l.Z.createLink(`${e.noteId}/${n.noteId}`,{showTooltip:!1,showNoteIcon:!0})),t.append("<br>")}(e,t);else{e.append($('<div class="ck-content">').html(n.content)),e.find("span.math-tex").length>0&&(await a.Z.requireLibrary(a.Z.KATEX),renderMathInElement(e[0],{trust:!0}));const t=t=>h.Z.getNoteIdFromUrl($(t).attr("href")),o=e.find("a.reference-link"),i=o.map((e=>t(e)));await d.default.getNotes(i);for(const t of o)await l.Z.loadReferenceLinkTitle($(t))}}(t,f);else if("code"===n)await async function(t,e){const n=await t.getBlob();e.append($("<pre>").text(n.content))}(t,f);else if("image"===n||"canvas"===n)!function(t,e,n={}){const o=encodeURIComponent(t.title);let i;t instanceof u.Z?i=`api/images/${t.noteId}/${o}?${Math.random()}`:t instanceof g.Z&&(i=`api/attachments/${t.attachmentId}/image/${o}?${t.utcDateModified}">`),e.css("display","flex").css("align-items","center").css("justify-content","center");const s=$("<img>").attr("src",i).attr("id","attachment-image-"+p++).css("max-width","100%");e.append(s),n.imageHasZoom&&a.Z.requireLibrary(a.Z.WHEEL_ZOOM).then((()=>{WZoom.create(`#${s.attr("id")}`,{maxScale:50,speed:1.3,zoomOnClick:!1})}))}(t,f,e);else if(!e.tooltip&&["file","pdf","audio","video"].includes(n))!function(t,e,n){let o,i;if(t instanceof u.Z)o="notes",i=t.noteId;else{if(!(t instanceof g.Z))throw new Error(`Can't recognize entity type of '${t}'`);o="attachments",i=t.attachmentId}const s=$('<div style="display: flex; flex-direction: column; height: 100%;">');if("pdf"===e){const t=$('<iframe class="pdf-preview" style="width: 100%; flex-grow: 100;"></iframe>');t.attr("src",r.Z.getUrlForDownload(`api/${o}/${i}/open`)),s.append(t)}else if("audio"===e){const e=$("<audio controls></audio>").attr("src",r.Z.getUrlForDownload(`api/${o}/${i}/open-partial`)).attr("type",t.mime).css("width","100%");s.append(e)}else if("video"===e){const e=$("<video controls></video>").attr("src",r.Z.getUrlForDownload(`api/${o}/${i}/open-partial`)).attr("type",t.mime).css("width","100%");s.append(e)}if("notes"===o){const e=$('<button class="file-download btn btn-primary" type="button">下载</button>'),n=$('<button class="file-open btn btn-primary" type="button">打开</button>');e.on("click",(()=>r.Z.downloadFileNote(t.noteId))),n.on("click",(()=>r.Z.openNoteExternally(t.noteId,t.mime))),n.toggle(!t.isProtected),s.append($('<div style="display: flex; justify-content: space-evenly; margin-top: 5px;">').append(e).append(n))}n.append(s)}(t,n,f);else if("mermaid"===n)await async function(t,e){await a.Z.requireLibrary(a.Z.MERMAID);const n=(await t.getBlob()).content||"";e.css("display","flex").css("justify-content","space-around");const o=window.getComputedStyle(document.documentElement).getPropertyValue("--mermaid-theme");mermaid.mermaidAPI.initialize({startOnLoad:!1,theme:o.trim(),securityLevel:"antiscript"});try{const{svg:t}=await mermaid.mermaidAPI.render("in-mermaid-graph-"+p++,n);e.append($(t))}catch(t){const n=$("<p>图表无法显示.</p>");e.append(n)}}(t,f);else if("render"===n){const e=$("<div>");await o.Z.render(t,e,this.ctx),f.append(e)}else if(e.tooltip||"protectedSession"!==n)t instanceof u.Z&&f.append($("<div>").css("display","flex").css("justify-content","space-around").css("align-items","center").css("height","100%").css("font-size","500%").append($("<span>").addClass(t.getIcon())));else{const t=$('<button class="btn btn-sm"><span class="bx bx-log-in"></span>进入受保护的会话</button>').on("click",i.Z.enterProtectedSession);f.append($("<div>").append("<div>此笔记受保护, 您需要输入密码来访问它.</div>").append("<br/>").append(t))}return t instanceof u.Z&&f.addClass(t.getCssClass()),{$renderedContent:f,type:n}}}},383:(t,e,n)=>{n.d(e,{Z:()=>r});var o=n(1412),i=n(1736),s=n(4264);async function a(t){const e=await i.Z.get(`special-notes/days/${t}`,"date-note");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)}const r={getInboxNote:async function(){const t=await i.Z.get(`special-notes/inbox/${dayjs().format("YYYY-MM-DD")}`,"date-note");return await o.default.getNote(t.noteId)},getTodayNote:async function(){return await a(dayjs().format("YYYY-MM-DD"))},getDayNote:a,getWeekNote:async function(t){const e=await i.Z.get(`special-notes/weeks/${t}`,"date-note");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)},getMonthNote:async function(t){const e=await i.Z.get(`special-notes/months/${t}`,"date-note");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)},getYearNote:async function(t){const e=await i.Z.get(`special-notes/years/${t}`,"date-note");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)},createSqlConsole:async function(){const t=await i.Z.post("special-notes/sql-console");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(t.noteId)},createSearchNote:async function(t={}){const e=await i.Z.post("special-notes/search-note",t);return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)}}},3152:(t,e,n)=>{n.d(e,{Z:()=>i});var o=n(2817);const i={info:async function(t){return new Promise((e=>o.default.triggerCommand("showInfoDialog",{message:t,callback:e})))},confirm:async function(t){return new Promise((e=>o.default.triggerCommand("showConfirmDialog",{message:t,callback:t=>e(t.confirmed)})))},confirmDeleteNoteBoxWithNote:async function(t){return new Promise((e=>o.default.triggerCommand("showConfirmDeleteNoteBoxWithNoteDialog",{title:t,callback:e})))},prompt:async function(t){return new Promise((e=>o.default.triggerCommand("showPromptDialog",{...t,callback:e})))}}},1412:(t,e,n)=>{n.r(e),n.d(e,{default:()=>h});var o=n(8726),i=n(2021),s=n(9673),a=n(1736),r=n(2817);class d{constructor(t){this.blobId=t.blobId,this.content=t.content,this.contentLength=t.contentLength,this.dateModified=t.dateModified,this.utcDateModified=t.utcDateModified}getJsonContent(){return this.content&&this.content.trim()?JSON.parse(this.content):null}getJsonContentSafely(){try{return this.getJsonContent()}catch(t){return null}}}var c=n(9763);const l=new class{constructor(){this.initializedPromise=this.loadInitialTree()}async loadInitialTree(){const t=await a.Z.get("tree");this.notes={},this.branches={},this.attributes={},this.attachments={},this.blobPromises={},this.addResp(t)}async loadSubTree(t){const e=await a.Z.get(`tree?subTreeNoteId=${t}`);return this.addResp(e),this.notes[t]}addResp(t){const e=t.notes,n=t.branches,a=t.attributes,r=new Set;for(const t of e){const{noteId:e}=t;let n=this.notes[e];if(n){if(n.update(t),"search"!==n.type){for(const t of n.children){const n=this.notes[t];n&&(n.parents=n.parents.filter((t=>t!==e)),delete this.branches[n.parentToBranch[e]],delete n.parentToBranch[e])}n.children=[],n.childToBranch={}}n.parents=n.parents.filter((t=>{const n=this.notes[t],o=this.branches[n.childToBranch[e]];return!(!n||!o||!o.fromSearchNote&&(n.children=n.children.filter((t=>t!==e)),delete this.branches[n.childToBranch[e]],delete n.childToBranch[e],1))}))}else this.notes[e]=new i.Z(this,t)}for(const t of n){const e=new o.Z(this,t);this.branches[e.branchId]=e;const n=this.notes[e.noteId];n&&n.addParent(e.parentNoteId,e.branchId,!1);const i=this.notes[e.parentNoteId];i&&(i.addChild(e.noteId,e.branchId,!1),r.add(i.noteId))}for(const t of a){const{attributeId:e}=t;this.attributes[e]=new s.Z(this,t);const n=this.notes[t.noteId];if(n&&!n.attributes.includes(e)&&n.attributes.push(e),"relation"===t.type){const n=this.notes[t.value];n&&(n.targetRelations.includes(e)||n.targetRelations.push(e))}}for(const t of r)this.notes[t].sortChildren(),this.notes[t].sortParents()}async reloadNotes(t){if(0===t.length)return;t=Array.from(new Set(t));const e=await a.Z.post("tree/load",{noteIds:t});this.addResp(e),r.default.triggerEvent("notesReloaded",{noteIds:t})}async loadSearchNote(t){const e=await this.getNote(t);if(!e||"search"!==e.type)return;const{searchResultNoteIds:n,highlightedTokens:o,error:i}=await a.Z.get(`search-note/${e.noteId}`);if(!Array.isArray(n))throw new Error(`Search note '${e.noteId}' failed: ${n}`);e.noteId in l.notes&&(l.notes[e.noteId].children=[],l.notes[e.noteId].childToBranch={});const s=[...e.getParentBranches(),...e.getChildBranches()];return n.forEach(((t,n)=>s.push({branchId:`virt-${e.noteId}-${t}`,noteId:t,parentNoteId:e.noteId,notePosition:10*(n+1),fromSearchNote:!0}))),this.addResp({notes:[e],branches:s,attributes:[]}),l.notes[e.noteId].searchResultsLoaded=!0,l.notes[e.noteId].highlightedTokens=o,{error:i}}getNotesFromCache(t,e=!1){return t.map((t=>this.notes[t]||e?this.notes[t]:(console.trace(`Can't find note '${t}'`),null))).filter((t=>!!t))}async getNotes(t,e=!1){const n=(t=Array.from(new Set(t))).filter((t=>!this.notes[t]));return await this.reloadNotes(n),t.map((t=>this.notes[t]||e?this.notes[t]:(console.trace(`Can't find note '${t}'`),null))).filter((t=>!!t))}async noteExists(t){return 1===(await this.getNotes([t],!0)).length}async getNote(t,e=!1){return"none"===t?(console.trace("No 'none' note."),null):t?(await this.getNotes([t],e))[0]:(console.trace(`Falsy noteId '${t}', returning null.`),null)}getNoteFromCache(t){if(!t)throw new Error("空 noteId");return this.notes[t]}getBranches(t,e=!1){return t.map((t=>this.getBranch(t,e))).filter((t=>!!t))}getBranch(t,e=!1){if(t in this.branches)return this.branches[t];e||logError(`Not existing branch '${t}'`)}async getBranchId(t,e){if("root"===e)return"none_root";const n=await this.getNote(e);return n?n.parentToBranch[t]:(logError(`Could not find branchId for parent '${t}', child '${e}' since child does not exist`),null)}async getAttachment(t,e=!1){const n=this.attachments[t];if(n)return n;let o;try{o=await a.Z.getWithSilentNotFound(`attachments/${t}/all`)}catch(n){if(e)return logInfo(`Attachment '${t}' not found, but silentNotFoundError is enabled: `+n.message),null;throw n}const i=this.processAttachmentRows(o);return i.length&&(i[0].getNote().attachments=i),this.attachments[t]}async getAttachmentsForNote(t){const e=await a.Z.get(`notes/${t}/attachments`);return this.processAttachmentRows(e)}processAttachmentRows(t){return t.map((t=>{let e;return t.attachmentId in this.attachments?(e=this.attachments[t.attachmentId],e.update(t)):(e=new c.Z(this,t),this.attachments[e.attachmentId]=e),e}))}async getBlob(t,e){const n=`${t}-${e}`;return this.blobPromises[n]||(this.blobPromises[n]=a.Z.get(`${t}/${e}/blob`).then((t=>new d(t))).catch((n=>console.error(`Cannot get blob for ${t} '${e}'`,n))),this.blobPromises[n].then((()=>setTimeout((()=>this.blobPromises[n]=null),1e3)))),await this.blobPromises[n]}},h=l},3968:(t,e,n)=>{n.d(e,{Z:()=>l});var o=n(2817),i=n(8481),s=n(3152),a=n(1412);function r(){const t=o.default.tabManager.getActiveContext();return t?t.hoistedNoteId:"root"}async function d(){const t=o.default.tabManager.getActiveContext();t&&await t.unhoist()}function c(t){return"root"===t.data.noteId||t.data.noteId===r()}const l={getHoistedNoteId:r,unhoist:d,isTopLevelNode:function(t){return c(t.getParent())},isHoistedNode:c,checkNoteAccess:async function(t,e){const n=await i.Z.resolveNotePath(t,e.hoistedNoteId);if(!n)return console.log(`Cannot activate '${t}'`),!1;const o=e.hoistedNoteId;if(!n.includes(o)&&!n.includes("_hidden")){const t=await a.default.getNote(i.Z.getNoteIdFromUrl(n)),e=await a.default.getNote(o);if(!e.hasAncestor("_hidden")&&!await s.Z.confirm(`Requested note '${t.title}' is outside of hoisted note '${e.title}' subtree and you must unhoist to access the note. Do you want to proceed with unhoisting?`))return!1;await d()}return!0},isHoistedInHiddenSubtree:async function(){const t=r();return"root"!==t&&(await a.default.getNote(t)).isHiddenCompletely()}}},6604:(t,e,n)=>{n.r(e),n.d(e,{default:()=>l});var o=n(1736),i=n(2817),s=n(1065);const a={},r=o.Z.get("keyboard-actions").then((t=>{t=t.filter((t=>!!t.actionName));for(const e of t)e.effectiveShortcuts=e.effectiveShortcuts.filter((t=>!t.startsWith("global:"))),a[e.actionName]=e;return t}));async function d(t){return(await r).filter((e=>e.scope===t))}async function c(t,e=!1){await r;const n=a[t];if(!n){if(!e)throw new Error(`Cannot find action '${t}'`);console.debug(`Cannot find action '${t}'`)}return n}d("window").then((t=>{for(const e of t)for(const t of e.effectiveShortcuts)s.Z.bindGlobalShortcut(t,(()=>i.default.triggerCommand(e.actionName,{ntxId:i.default.tabManager.activeNtxId})))}));const l={updateDisplayedShortcuts:function(t){t.find("kbd[data-command]").each((async(t,e)=>{const n=$(e).attr("data-command"),o=await c(n,!0);if(o){const t=o.effectiveShortcuts.join(", ");(t||"not set"!==$(e).text())&&$(e).text(t)}})),t.find("[data-trigger-command]").each((async(t,e)=>{const n=$(e).attr("data-trigger-command"),o=await c(n,!0);if(o){const t=$(e).attr("title"),n=o.effectiveShortcuts.join(", ");if(t?.includes(n))return;const i=t?.trim()?`${t} (${n})`:n;$(e).attr("title",i)}}))},setupActionsForElement:async function(t,e,n){const o=await d(t);for(const t of o)for(const o of t.effectiveShortcuts)s.Z.bindElShortcut(e,o,(()=>n.triggerCommand(t.actionName,{ntxId:i.default.tabManager.activeNtxId})))},getActions:async function(){return await r},getActionsForScope:d}},6707:(t,e,n)=>{n.d(e,{Z:()=>a});const o={};async function i(t){t=`${window.glob.assetPath}/${t}`,o[t]||(o[t]=$.ajax({url:t,dataType:"script",cache:!0})),await o[t]}async function s(t,e=!0){Array.from(document.querySelectorAll("link")).map((t=>t.href)).some((e=>e.endsWith(t)))||(e&&(t=`${window.glob.assetPath}/${t}`),$("head").append($('<link rel="stylesheet" type="text/css" />').attr("href",t)))}const a={requireCss:s,requireLibrary:async function(t){if(t.css&&t.css.map((t=>s(t))),t.js)for(const e of t.js)await i(e)},CKEDITOR:{js:["libraries/ckeditor/ckeditor.js"]},CODE_MIRROR:{js:["libraries/codemirror/codemirror.js","libraries/codemirror/addon/display/placeholder.js","libraries/codemirror/addon/edit/matchbrackets.js","libraries/codemirror/addon/edit/matchtags.js","libraries/codemirror/addon/fold/xml-fold.js","libraries/codemirror/addon/lint/lint.js","libraries/codemirror/addon/lint/eslint.js","libraries/codemirror/addon/mode/loadmode.js","libraries/codemirror/addon/mode/multiplex.js","libraries/codemirror/addon/mode/overlay.js","libraries/codemirror/addon/mode/simple.js","libraries/codemirror/addon/search/match-highlighter.js","libraries/codemirror/mode/meta.js","libraries/codemirror/keymap/vim.js"],css:["libraries/codemirror/codemirror.css","libraries/codemirror/addon/lint/lint.css"]},ESLINT:{js:["libraries/eslint.js"]},RELATION_MAP:{js:["libraries/jsplumb.js","libraries/panzoom.js"],css:["stylesheets/relation_map.css"]},PRINT_THIS:{js:["libraries/printThis.js"]},CALENDAR_WIDGET:{css:["stylesheets/calendar.css"]},KATEX:{js:["node_modules/katex/dist/katex.min.js","node_modules/katex/dist/contrib/mhchem.min.js","node_modules/katex/dist/contrib/auto-render.min.js"],css:["node_modules/katex/dist/katex.min.css"]},WHEEL_ZOOM:{js:["libraries/wheel-zoom.min.js"]},FORCE_GRAPH:{js:["libraries/force-graph.min.js"]},MERMAID:{js:["libraries/mermaid.min.js"]},EXCALIDRAW:{js:["node_modules/react/umd/react.production.min.js","node_modules/react-dom/umd/react-dom.production.min.js","node_modules/@excalidraw/excalidraw/dist/excalidraw.production.min.js"]},MARKJS:{js:["libraries/jquery.mark.es6.min.js"]}}},7844:(t,e,n)=>{n.d(e,{Z:()=>p});var o=n(8481),i=n(592),s=n(2817),a=n(1412),r=n(9046);async function d(t,e){let n;return"default"===e?n=(await a.default.getNote(t)).getIcon():"source"===e?n="bx bx-code-curly":"attachments"===e&&(n="bx bx-file"),n}function c({notePath:t,ntxId:e,hoistedNoteId:n,viewScope:o={}}){t=t||"";const i=[e?{ntxId:e}:null,n&&"root"!==n?{hoistedNoteId:n}:null,o.viewMode&&"default"!==o.viewMode?{viewMode:o.viewMode}:null,o.attachmentId?{attachmentId:o.attachmentId}:null].filter((t=>!!t)).map((t=>{const e=Object.keys(t)[0],n=t[e];return`${encodeURIComponent(e)}=${encodeURIComponent(n)}`})).join("&");if(!t&&!i)return"";let s=`#${t}`;return i&&(s+=`?${i}`),s}function l(t){if(!t)return{};const e=t.indexOf("#");if(-1===e)return{};const n=t.substr(e+1),[i,s]=n.split("?");if(!i.match(/^[_a-z0-9]{4,}(\/[_a-z0-9]{4,})*$/i))return{};const a={viewMode:"default"};let r=null,d=null,c=null;if(s)for(const t of s.split("&")){let[e,n]=t.split("=");e=decodeURIComponent(e),n=decodeURIComponent(n),"ntxId"===e?r=n:"hoistedNoteId"===e?d=n:"searchString"===e?c=n:["viewMode","attachmentId"].includes(e)?a[e]=n:console.warn(`Unrecognized hash parameter '${e}'.`)}return{notePath:i,noteId:o.Z.getNoteIdFromUrl(i),ntxId:r,hoistedNoteId:d,viewScope:a,searchString:c}}function h(t){const e=$(t.target).closest("a,.block-link");return u(t,e.attr("href")||e.attr("data-href"),e)}function u(t,e,n){if(e?.startsWith("data:"))return!0;t.preventDefault(),t.stopPropagation();const{notePath:o,viewScope:i}=l(e),a=r.default.isCtrlKey(t),d=1===t.which,c=2===t.which,h=d&&a||c,u=1===t.which,g=2===t.which;if(o){if(h)s.default.tabManager.openTabWithNoteWithHoisting(o,{viewScope:i});else if(d){const e=$(t.target).closest("[data-ntx-id]").attr("data-ntx-id"),n=e?s.default.tabManager.getNoteContextById(e):s.default.tabManager.getActiveContext();n.setNote(o,{viewScope:i}).then((()=>{n!==s.default.tabManager.getActiveContext()&&s.default.tabManager.activateNoteContext(n.ntxId)}))}}else if(e){const t=n?.hasClass("ck-link-actions__preview"),o=!n||0===n.closest("[contenteditable]").length;(h||t&&(u||g)||o&&(u||g))&&(e.toLowerCase().startsWith("http")||e.startsWith("api/")?window.open(e,"_blank"):e.toLowerCase().startsWith("file:")&&r.default.isElectron()&&r.default.dynamicRequire("electron").shell.openPath(e))}return!0}async function g(t){const{noteId:e,viewScope:n}=l(t);if(!e)return"[missing note]";const o=await a.default.getNote(e);if(!o)return"[missing note]";if("attachments"===n?.viewMode&&n?.attachmentId){const t=await o.getAttachmentById(n.attachmentId);return t?t.title:"[missing attachment]"}return o.title}$(document).on("click","a",h),$(document).on("auxclick","a",h),$(document).on("contextmenu","a",(function(t){const e=$(t.target).closest("a"),n=e.attr("href")||e.attr("data-href"),{notePath:o,viewScope:s}=l(n);o&&(t.preventDefault(),i.Z.openContextMenu(o,t,s,null))})),$(document).on("dblclick","a",(t=>{t.preventDefault(),t.stopPropagation();const e=$(t.target).closest("a").attr("href");e&&e.startsWith("http")&&window.open(e,"_blank")})),$(document).on("mousedown","a",(t=>{if(2===t.which)return t.preventDefault(),!1}));const p={getNotePathFromUrl:function(t){const e=/#(root[A-Za-z0-9_/]*)$/.exec(t);return null===e?null:e[1]},createLink:async function(t,e={}){if(!t||!t.trim())return logError("缺少笔记路径"),$("<span>").text("[missing note]");t.startsWith("root")||(t=`root/${t}`);const n=void 0===e.showTooltip||e.showTooltip,i=void 0!==e.showNotePath&&e.showNotePath,s=void 0!==e.showNoteIcon&&e.showNoteIcon,r=void 0!==e.referenceLink&&e.referenceLink,l=void 0!==e.autoConvertToImage&&e.autoConvertToImage,{noteId:h,parentNoteId:u}=o.Z.getNoteIdAndParentIdFromUrl(t),g=e.viewScope||{},p=g.viewMode||"default";let f=e.title;if(!f)if("attachments"===p&&g.attachmentId){const t=await a.default.getAttachment(g.attachmentId);f=t?t.title:"[missing attachment]"}else f=await o.Z.getNoteTitle(h,u);const m=await a.default.getNote(h);if(l&&["image","canvas","mermaid"].includes(m.type)&&"default"===p){const t=encodeURIComponent(f);return $("<img>").attr("src",`api/images/${h}/${t}?${Math.random()}`).attr("alt",f)}const w=$("<span>");if(s){let t=await d(h,p);t&&w.append($("<span>").addClass(`bx ${t}`)).append(" ")}const I=c({notePath:t,viewScope:g}),b=$("<a>",{href:I,text:f});if(n||b.addClass("no-tooltip-preview"),r&&b.addClass("reference-link"),w.append(b),i){const e=await o.Z.resolveNotePathToSegments(t);if(e){e.pop();const t=e.join("/").trim();t&&w.append($("<small>").text(` (${await o.Z.getNotePathTitle(t)})`))}}return w},goToLink:h,goToLinkExt:u,loadReferenceLinkTitle:async function(t,e=null){const n="A"===t[0].tagName?t:t.find("a");if(!(e=e||n.attr("href")))return void console.warn("Empty URL for parsing: "+t[0].outerHTML);const{noteId:o,viewScope:i}=l(e),s=await a.default.getNote(o,!0);s&&t.addClass(s.getColorClass());const r=await g(e);if(t.text(r),s){const e=await d(o,i.viewMode);t.prepend($("<span>").addClass(e))}},getReferenceLinkTitle:g,getReferenceLinkTitleSync:function(t){const{noteId:e,viewScope:n}=l(t);if(!e)return"[missing note]";const o=a.default.getNoteFromCache(e);if(!o)return"[missing note]";if("attachments"===n?.viewMode&&n?.attachmentId){if(!o.attachments)return"[loading title...]";const t=o.attachments.find((t=>t.attachmentId===n.attachmentId));return t?t.title:"[missing attachment]"}return o.title},calculateHash:c,parseNavigationStateFromUrl:l}},4585:(t,e,n)=>{n.d(e,{Z:()=>o});const o=new class{constructor(){this.attributes={}}invalidate(){this.attributes={}}}},8181:(t,e,n)=>{n.d(e,{Z:()=>u});var o=n(2817),i=n(2040),s=n(1736),a=n(4264),r=n(1412),d=n(8481),c=n(6885);async function l(t,e={}){(e=Object.assign({activate:!0,focus:"title",target:"into"},e)).isProtected&&i.Z.isProtectedSessionAvailable()||(e.isProtected=!1),"text"!==o.default.tabManager.getActiveContextNoteType()&&(e.saveSelection=!1),e.saveSelection&&([e.title,e.content]=function(t){const e=$.parseHTML(t);return e.length>0&&e[0].tagName&&e[0].tagName.match(/h[1-6]/i)?[$(e[0]).text(),t.replace(e[0].outerHTML,"")]:[null,t]}(e.textEditor.getSelectedHtml()));const n=d.Z.getNoteIdFromUrl(t);"mermaid"!==e.type||e.content||(e.content="graph TD;\n    A--\x3eB;\n    A--\x3eC;\n    B--\x3eD;\n    C--\x3eD;");const{note:c,branch:l}=await s.Z.post(`notes/${n}/children?target=${e.target}&targetBranchId=${e.targetBranchId||""}`,{title:e.title,content:e.content||"",isProtected:e.isProtected,type:e.type,mime:e.mime,templateNoteId:e.templateNoteId});if(e.saveSelection&&e.textEditor.removeSelection(),await a.Z.waitForMaxKnownEntityChangeId(),e.activate){const n=o.default.tabManager.getActiveContext();await n.setNote(`${t}/${c.noteId}`),"title"===e.focus?o.default.triggerEvent("focusAndSelectTitle",{isNewNote:!0}):"content"===e.focus&&o.default.triggerEvent("focusOnDetail",{ntxId:n.ntxId})}return{note:await r.default.getNote(c.noteId),branch:r.default.getBranch(l.branchId)}}async function h(){return new Promise((t=>{o.default.triggerCommand("chooseNoteType",{callback:t})}))}const u={createNote:l,createNoteWithTypePrompt:async function(t,e={}){const{success:n,noteType:o,templateNoteId:i}=await h();if(n)return e.type=o,e.templateNoteId=i,await l(t,e)},duplicateSubtree:async function(t,e){const n=d.Z.getNoteIdFromUrl(e),{note:i}=await s.Z.post(`notes/${t}/duplicate/${n}`);await a.Z.waitForMaxKnownEntityChangeId(),o.default.tabManager.getActiveContext().setNote(`${e}/${i.noteId}`);const l=await r.default.getNote(t);c.default.showMessage(`笔记 "${l.title}" 已被复制`)},chooseNoteType:h}},4716:(t,e,n)=>{n.d(e,{Z:()=>u});var o=n(8481),i=n(7844),s=n(1412),a=n(9046),r=n(1375),d=n(5913),c=n(2817);async function l(){const t=$(this);if(t.hasClass("no-tooltip-preview")||t.hasClass("disabled"))return;if(t.closest(".ck-link-actions").length)return;if(t.closest(".note-tooltip").length)return;const e=t.attr("href")||t.attr("data-href"),{notePath:n,noteId:o,viewScope:r}=i.Z.parseNavigationStateFromUrl(e);if(!n||"default"!==r.viewMode)return;const d=t.attr("data-link-id")||`link-${Math.floor(1e6*Math.random())}`;if(t.attr("data-link-id",d),$(`.${d}`).is(":visible"))return;const c=await s.default.getNote(o),[l]=await Promise.all([h(c),new Promise((t=>setTimeout(t,500)))]);if(a.default.isHtmlEmpty(l))return;const u=`<div class="note-tooltip-content">${l}</div>`,g="tooltip-"+Math.floor(999999999*Math.random());if($(this).filter(":hover").length>0){$(this).tooltip({container:"body",placement:"bottom",trigger:"manual",boundary:"window",title:u,html:!0,template:`<div class="tooltip note-tooltip ${g}" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>`,sanitize:!1,customClass:d}),$(this).tooltip("show");const t=()=>{$(`.${g}`).is(":visible")?$(this).filter(":hover").length||$(`.${d}:hover`).length?setTimeout(t,1e3):$(this).tooltip("dispose"):console.log("Not visible anymore")};setTimeout(t,1e3)}}async function h(t){if(!t)return"<div>笔记已被删除.</div>";const e=c.default.tabManager.getActiveContext()?.hoistedNoteId,n=t.getBestNotePathString(e);if(!n)return;let i=`<h5 class="note-tooltip-title">${(await o.Z.getNoteTitleWithPathAsSuffix(n)).prop("outerHTML")}</h5>`;const{$renderedAttributes:s}=await r.Z.renderNormalAttributes(t),{$renderedContent:a}=await d.Z.getRenderedContent(t,{tooltip:!0,trim:!0});return i=`${i}<div class="note-tooltip-attributes">${s[0].outerHTML}</div>${a[0].outerHTML}`,i}const u={setupGlobalTooltip:function(){$(document).on("mouseenter","a",l),$(document).on("click",(t=>{$(t.target).closest(".note-tooltip").length||$(".note-tooltip").remove()}))},setupElementTooltip:function(t){t.on("mouseenter",l)}}},5489:(t,e,n)=>{n.d(e,{Z:()=>h});var o=n(9046),i=n(1736);function s(t){if("notes"!==t&&"attachments"!==t)throw new Error(`Unrecognized type '${t}', should be 'notes' or 'attachments'`)}function a(t,e){return s(t),c(`api/${t}/${e}/download`)}function r(t){o.default.isElectron()?o.default.dynamicRequire("@electron/remote").getCurrentWebContents().downloadURL(t):window.location.href=t}async function d(t,e,n){if(s(t),!o.default.isElectron()||o.default.isMac())return;let r=(await i.Z.post(`${t}/${e}/save-to-tmp-dir`)).tmpFilePath;const{exec:d}=o.default.dynamicRequire("child_process"),c=process.platform;if("linux"===c){const t=["x-terminal-emulator","gnome-terminal","konsole","xterm","xfce4-terminal","mate-terminal","rxvt","terminator","terminology"],n=e=>{const n=`${e} -e 'mimeopen -d "${r}"'`;console.log(`Open Note custom: ${n} `),d(n,((n,i,s)=>{n?(console.error(`Open Note custom: Failed to open file with ${e}: ${n}`),o(t.indexOf(e)+1)):console.log(`Open Note custom: File opened with ${e}: ${i}`)}))},o=i=>{const s=t[i];if(!s)return console.error("Open Note custom: No terminal found!"),void open(a(e),{url:!0});d(`which ${s}`,((t,e,a)=>{e.trim()?n(s):o(i+1)}))};o(0)}else"win32"===c?(-1!==r.indexOf("/")&&(r=r.replace(/\//g,"\\")),d("rundll32.exe shell32.dll,OpenAs_RunDLL "+r,((t,n,o)=>{if(t)return console.error("Open Note custom: ",t),void open(a(e),{url:!0})}))):(console.log('Currently "Open Note custom" only supports linux and windows systems'),open(a(e),{url:!0}))}function c(t){return o.default.isElectron()?`${function(){const t=new URL(window.location.href);return`${t.protocol}//${t.hostname}:${t.port}`}()}/${t}`:t}async function l(t,e,n){if(s(t),o.default.isElectron()){const n=await i.Z.post(`${t}/${e}/save-to-tmp-dir`),s=o.default.dynamicRequire("electron");await s.shell.openPath(n.tmpFilePath)&&window.open(a(t,e))}else!function(t){return"application/pdf"===t||t.startsWith("image")||t.startsWith("audio")||t.startsWith("video")}(n)?window.location.href=a(t,e):window.open(function(t,e){return s(t),c(`api/${t}/${e}/open`)}(t,e))}const h={download:r,downloadFileNote:function(t){r(`${a("notes",t)}?${Date.now()}`)},downloadRevision:function(t,e){r(c(`api/revisions/${e}/download`))},downloadAttachment:function(t){r(`${a("attachments",t)}?${Date.now()}`)},getUrlForDownload:c,openNoteExternally:async(t,e)=>await l("notes",t,e),openAttachmentExternally:async(t,e)=>await l("attachments",t,e),openNoteCustom:async(t,e)=>await d("notes",t),openAttachmentCustom:async(t,e)=>await d("attachments",t)}},4378:(t,e,n)=>{n.d(e,{Z:()=>i});var o=n(1736);const i=new class{constructor(){this.initializedPromise=o.Z.get("options").then((t=>this.load(t)))}load(t){this.arr=t}get(t){return this.arr[t]}getNames(){return Object.keys(this.arr)}getJson(t){try{return JSON.parse(this.arr[t])}catch(t){return null}}getInt(t){return parseInt(this.arr[t])}getFloat(t){return parseFloat(this.arr[t])}is(t){return"true"===this.arr[t]}set(t,e){this.arr[t]=e}async save(t,e){this.set(t,e);const n={};n[t]=e,await o.Z.put("options",n)}async toggle(t){await this.save(t,(!this.is(t)).toString())}}},3847:(t,e,n)=>{n.d(e,{Z:()=>o});const o={parse:function(t){const e=t.split(",").map((t=>t.trim())),n={};for(const t of e)if("promoted"===t)n.isPromoted=!0;else if(["text","number","boolean","date","datetime","url"].includes(t))n.labelType=t;else if(["single","multi"].includes(t))n.multiplicity=t;else if(t.startsWith("precision")){const e=t.split("=");n.numberPrecision=parseInt(e[1])}else if(t.startsWith("alias")){const e=t.split("=");n.promotedAlias=e[1]}else if(t.startsWith("inverse")){const e=t.split("=");n.inverseRelation=e[1]}else console.log("Unrecognized attribute definition token:",t);return n}}},7336:(t,e,n)=>{n.d(e,{Z:()=>p});var o=n(1736),i=n(2040),s=n(6885),a=n(4264),r=n(2817),d=n(1412),c=n(9046),l=n(4378);let h=null;function u(){const t=$.Deferred();return l.Z.is("isPasswordSet")?(i.Z.isProtectedSessionAvailable()?t.resolve(!1):(h=t,r.default.triggerCommand("showProtectedSessionPasswordDialog")),t.promise()):(r.default.triggerCommand("showPasswordNotSet"),t)}function g(t,e,n){return{id:t.taskId,title:`${e} status`,message:n,icon:t.data.protect?"check-shield":"shield"}}a.Z.subscribeToMessages((async t=>{"protectedSessionLogin"===t.type?(await async function(){const t=Object.keys(d.default.notes);await d.default.loadInitialTree(),await d.default.reloadNotes(t,!0)}(),await r.default.triggerEvent("frocaReloaded"),r.default.triggerEvent("protectedSessionStarted"),r.default.triggerCommand("closeProtectedSessionPasswordDialog"),null!==h&&(h.resolve(!0),h=null),s.default.showMessage("受保护的会话已启动.")):"protectedSessionLogout"===t.type&&c.default.reloadFrontendApp("Protected session logout")})),a.Z.subscribeToMessages((async t=>{if("protectNotes"!==t.taskType)return;const e=t.data.protect?"保护":"取消保护";if("taskError"===t.type)s.default.closePersistent(t.taskId),s.default.showError(t.message);else if("taskProgressCount"===t.type)s.default.showPersistent(g(t,e,`${e} in progress: ${t.progressCount}`));else if("taskSucceeded"===t.type){const n=g(t,e,`${e} finished successfully.`);n.closeAfter=3e3,s.default.showPersistent(n)}}));const p={protectNote:async function(t,e,n){await u(),await o.Z.put(`notes/${t}/protect/${e?1:0}?subtree=${n?1:0}`)},enterProtectedSession:u,leaveProtectedSession:async function(){i.Z.isProtectedSessionAvailable()&&await i.Z.resetProtectedSession()},setupProtectedSession:async function(t){(await o.Z.post("login/protected",{password:t})).success?i.Z.enableProtectedSession():s.default.showError("密码错误.",3e3)}}},2040:(t,e,n)=>{n.d(e,{Z:()=>a});var o=n(1736);function i(){return glob.isProtectedSessionAvailable}async function s(){i()&&await o.Z.post("login/protected/touch")}const a={enableProtectedSession:function(){glob.isProtectedSessionAvailable=!0,s()},resetProtectedSession:async function(){await o.Z.post("logout/protected")},isProtectedSessionAvailable:i,touchProtectedSession:s,touchProtectedSessionIfNecessary:function(t){t&&t.isProtected&&i()&&s()}}},5437:(t,e,n)=>{n.d(e,{Z:()=>s});var o=n(1736),i=n(394);const s={render:async function(t,e){const n=t.getRelations("renderNote").map((t=>t.value)).filter((t=>t));e.empty().toggle(n.length>0);for(const s of n){const n=await o.Z.post(`script/bundle/${s}`),a=$("<div>");e.append(a),a.append(n.html),i.default.executeBundle(n,t,a)}return n.length>0}}},5574:(t,e,n)=>{n.d(e,{Z:()=>v});var o=n(1736),i=n(9046),s=n(6885),a=n(7844),r=n(1412),d=n(4716),c=n(7336),l=n(383),h=n(9692),u=n(1698),g=n(4264),p=n(2817),f=n(2503),m=n(1167),w=n(1902),I=n(1065),b=n(3152);const y=function(t,e,n=null,y=null){function v(t){return t?t.map((t=>"function"==typeof t?`!@#Function: ${t.toString()}`:t)):t}this.$container=y,this.startNote=t,this.currentNote=e,this.originEntity=n,this.dayjs=dayjs,this.RightPanelWidget=u.Z,this.NoteContextAwareWidget=f.Z,this.BasicWidget=m.Z,this.activateNote=async t=>{await p.default.tabManager.getActiveContext().setNote(t)},this.activateNewNote=async t=>{await g.Z.waitForMaxKnownEntityChangeId(),await p.default.tabManager.getActiveContext().setNote(t),await p.default.triggerEvent("focusAndSelectTitle")},this.openTabWithNote=async(t,e)=>{await g.Z.waitForMaxKnownEntityChangeId(),await p.default.tabManager.openTabWithNoteWithHoisting(t,{activate:e}),e&&await p.default.triggerEvent("focusAndSelectTitle")},this.openSplitWithNote=async(t,e)=>{await g.Z.waitForMaxKnownEntityChangeId();const n=p.default.tabManager.getActiveContext().getSubContexts(),{ntxId:o}=n[n.length-1];await p.default.triggerCommand("openNewNoteSplit",{ntxId:o,notePath:t}),e&&await p.default.triggerEvent("focusAndSelectTitle")},this.addButtonToToolbar=async t=>{console.warn("api.addButtonToToolbar() has been deprecated since v0.58 and may be removed in the future. Use  Menu -> Configure Launchbar to create/update launchers instead.");const{action:e,...n}=t;n.action=e.toString(),await o.Z.put("special-notes/api-script-launcher",n)},this.__runOnBackendInner=async(i,s,a)=>{"function"==typeof i&&(i=i.toString());const r=await o.Z.post("script/exec",{script:i,params:v(s),startNoteId:t.noteId,currentNoteId:e.noteId,originEntityName:"notes",originEntityId:n?n.noteId:null,transactional:a},"script");if(r.success)return await g.Z.waitForMaxKnownEntityChangeId(),r.executionResult;throw new Error(`server error: ${r.error}`)},this.runOnBackend=async(t,e=[])=>(("AsyncFunction"===t?.constructor.name||t?.startsWith?.("async "))&&s.default.showError("You're passing an async function to api.runOnBackend() which will likely not work as you intended. Either make the function synchronous (by removing 'async' keyword), or use api.runAsyncOnBackendWithManualTransactionHandling()"),await this.__runOnBackendInner(t,e,!0)),this.runAsyncOnBackendWithManualTransactionHandling=async(t,e=[])=>(("Function"===t?.constructor.name||t?.startsWith?.("function"))&&s.default.showError("You're passing a synchronous function to api.runAsyncOnBackendWithManualTransactionHandling(), while you should likely use api.runOnBackend() instead."),await this.__runOnBackendInner(t,e,!1)),this.searchForNotes=async t=>await h.Z.searchForNotes(t),this.searchForNote=async t=>{const e=await this.searchForNotes(t);return e.length>0?e[0]:null},this.getNote=async t=>await r.default.getNote(t),this.getNotes=async(t,e=!1)=>await r.default.getNotes(t,e),this.reloadNotes=async t=>await r.default.reloadNotes(t),this.getInstanceName=()=>window.glob.instanceName,this.formatDateISO=i.default.formatDateISO,this.parseDate=i.default.parseDate,this.showMessage=s.default.showMessage,this.showError=s.default.showError,this.showInfoDialog=b.Z.info,this.showConfirmDialog=b.Z.confirm,this.showPromptDialog=b.Z.prompt,this.triggerCommand=(t,e)=>p.default.triggerCommand(t,e),this.triggerEvent=(t,e)=>p.default.triggerEvent(t,e),this.createLink=a.Z.createLink,this.createNoteLink=a.Z.createLink,this.addTextToActiveContextEditor=t=>p.default.triggerCommand("addTextToActiveEditor",{text:t}),this.getActiveContextNote=()=>p.default.tabManager.getActiveContextNote(),this.getActiveContext=()=>p.default.tabManager.getActiveContext(),this.getActiveMainContext=()=>p.default.tabManager.getActiveMainContext(),this.getNoteContexts=()=>p.default.tabManager.getNoteContexts(),this.getMainNoteContexts=()=>p.default.tabManager.getMainNoteContexts(),this.getActiveContextTextEditor=()=>p.default.tabManager.getActiveContext()?.getTextEditor(),this.getActiveContextCodeEditor=()=>p.default.tabManager.getActiveContext()?.getCodeEditor(),this.getActiveNoteDetailWidget=()=>new Promise((t=>p.default.triggerCommand("executeInActiveNoteDetailWidget",{callback:t}))),this.getActiveContextNotePath=()=>p.default.tabManager.getActiveContextNotePath(),this.getComponentByEl=t=>p.default.getComponentByEl(t),this.setupElementTooltip=d.Z.setupElementTooltip,this.protectNote=async(t,e)=>{await c.Z.protectNote(t,e,!1)},this.protectSubTree=async(t,e)=>{await c.Z.protectNote(t,e,!0)},this.getTodayNote=l.Z.getTodayNote,this.getDayNote=l.Z.getDayNote,this.getWeekNote=l.Z.getWeekNote,this.getMonthNote=l.Z.getMonthNote,this.getYearNote=l.Z.getYearNote,this.setHoistedNoteId=t=>{const e=p.default.tabManager.getActiveContext();e&&e.setHoistedNoteId(t)},this.bindGlobalShortcut=I.Z.bindGlobalShortcut,this.waitUntilSynced=g.Z.waitForMaxKnownEntityChangeId,this.refreshIncludedNote=t=>p.default.triggerEvent("refreshIncludedNote",{noteId:t}),this.randomString=i.default.randomString,this.formatSize=i.default.formatSize,this.formatNoteSize=i.default.formatSize,this.logMessages={},this.logSpacedUpdates={},this.log=t=>{const{noteId:e}=this.startNote;t=`${i.default.now()}: ${t}`,console.log(`Script ${e}: ${t}`),this.logMessages[e]=this.logMessages[e]||[],this.logSpacedUpdates[e]=this.logSpacedUpdates[e]||new w.Z((()=>{const t=this.logMessages[e];this.logMessages[e]=[],p.default.triggerEvent("apiLogMessages",{noteId:e,messages:t})}),100),this.logMessages[e].push(t),this.logSpacedUpdates[e].scheduleUpdate()}},v=async function(t,e,n=null,o=null){const s={};await r.default.initializedPromise;const a=await r.default.getNote(t),d=await r.default.getNotes(e);return{modules:s,notes:i.default.toObject(d,(t=>[t.noteId,t])),apis:i.default.toObject(d,(t=>[t.noteId,new y(a,t,n,o)])),require:t=>e=>{const n=d.filter((e=>t.includes(e.noteId))),o=n.find((t=>t.title===e));if(!o)throw new Error(`Could not find module note ${e}`);return s[o.noteId].exports}}}},9692:(t,e,n)=>{n.d(e,{Z:()=>a});var o=n(1736),i=n(1412);async function s(t){return await o.Z.get(`search/${encodeURIComponent(t)}`)}const a={searchForNoteIds:s,searchForNotes:async function(t){const e=await s(t);return await i.default.getNotes(e)}}},1736:(t,e,n)=>{n.d(e,{Z:()=>h});var o=n(9046);class i{constructor(t){for(const e in t)this[e]=t[e]}}async function s(t){const e=(await Promise.resolve().then(n.bind(n,2817))).default,i=e.tabManager?e.tabManager.getActiveContext():null,s={"trilium-component-id":glob.componentId,"trilium-local-now-datetime":o.default.localNowDateTime(),"trilium-hoisted-note-id":i?i.hoistedNoteId:null,"x-csrf-token":glob.csrfToken};for(const e in t)t[e]&&(s[e]=t[e]);return o.default.isElectron()&&(s.cookie=document.cookie),s}let a=1;const r={};let d=0;async function c(t,e,n,i={}){let c;const h=await s({"trilium-component-id":n}),{data:u}=i;if(o.default.isElectron()){const n=o.default.dynamicRequire("electron").ipcRenderer,s=a++;c=await new Promise(((o,a)=>{r[s]={resolve:o,reject:a,silentNotFound:!!i.silentNotFound},n.send("server-request",{requestId:s,headers:h,method:t,url:`/${window.glob.baseApiUrl}${e}`,data:u})}))}else c=await function(t,e,n,o,i){return new Promise(((s,a)=>{const r={url:window.glob.baseApiUrl+t,type:e,headers:o,timeout:6e4,success:(t,e,n)=>{const o={};n.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((t=>{const e=t.split(": "),n=e.shift();o[n]=e.join(": ")})),s({body:t,headers:o})},error:async n=>{i&&404===n.status||await l(e,t,n.status,n.responseText),a(n.responseText)}};if(n){try{r.data=JSON.stringify(n)}catch(t){console.log("Can't stringify data: ",n," because of error: ",t)}r.contentType="application/json"}$.ajax(r)}))}(e,t,u,h,!!i.silentNotFound);const g=c.headers["trilium-max-entity-change-id"];return g&&g.trim()&&(d=Math.max(d,parseInt(g))),c.body}if(o.default.isElectron()){function u(t){if("application/json"===t.headers["Content-Type"]&&(t.body=JSON.parse(t.body)),!(t.requestId in r))throw new Error(`Unknown requestId '${t.requestId}'`);r[t.requestId].resolve({body:t.body,headers:t.headers})}o.default.dynamicRequire("electron").ipcRenderer.on("server-response",(async(t,e)=>{e.statusCode>=200&&e.statusCode<300?u(e):(404===e.statusCode&&r[e.requestId]?.silentNotFound||await l(e.method,e.url,e.statusCode,e.body),r[e.requestId].reject(new Error(`Server responded with ${e.statusCode}`))),delete r[e.requestId]}))}async function l(t,e,o,s){let a=s;if("string"==typeof s)try{a=(s=JSON.parse(s)).message}catch(t){}const r=(await Promise.resolve().then(n.bind(n,6885))).default;if([400,404].includes(o)&&s&&"object"==typeof s)throw r.showError(a),new i({requestUrl:e,method:t,statusCode:o,...s});{const n=`${o} ${t} ${e}`;r.showErrorTitleAndMessage(n,a),r.throwError(`${n} - ${a}`)}}const h={get:async function(t,e){return await c("GET",t,e)},getWithSilentNotFound:async function(t,e){return await c("GET",t,e,{silentNotFound:!0})},post:async function(t,e,n){return await c("POST",t,n,{data:e})},put:async function(t,e,n){return await c("PUT",t,n,{data:e})},patch:async function(t,e,n){return await c("PATCH",t,n,{data:e})},remove:async function(t,e){return await c("DELETE",t,e)},upload:async function(t,e){const n=new FormData;return n.append("upload",e),await $.ajax({url:window.glob.baseApiUrl+t,headers:await s(),data:n,type:"PUT",timeout:36e5,contentType:!1,processData:!1})},getHeaders:s,getMaxKnownEntityChangeId:()=>d}},1902:(t,e,n)=>{n.d(e,{Z:()=>o});class o{constructor(t,e=1e3){this.updater=t,this.lastUpdated=Date.now(),this.changed=!1,this.updateInterval=e}scheduleUpdate(){this.changeForbidden||(this.changed=!0,setTimeout((()=>this.triggerUpdate())))}async updateNowIfNecessary(){if(this.changed){this.changed=!1;try{await this.updater()}catch(t){throw this.changed=!0,t}}}isAllSavedAndTriggerUpdate(){const t=!this.changed;return this.updateNowIfNecessary(),t}triggerUpdate(){this.changed&&(Date.now()-this.lastUpdated>this.updateInterval?(this.updater(),this.lastUpdated=Date.now(),this.changed=!1):this.scheduleUpdate())}async allowUpdateWithoutChange(t){this.changeForbidden=!0;try{await t()}finally{this.changeForbidden=!1}}}},6885:(t,e,n)=>{n.r(e),n.d(e,{default:()=>r});var o=n(4264),i=n(9046);function s(t){const e=$(`<div class="toast" role="alert" aria-live="assertive" aria-atomic="true">\n    <div class="toast-header">\n        <strong class="mr-auto"><span class="bx bx-${t.icon}"></span> <span class="toast-title"></span></strong>\n        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">\n            <span aria-hidden="true">&times;</span>\n        </button>\n    </div>\n    <div class="toast-body"></div>\n</div>`);return e.find(".toast-title").text(t.title),e.find(".toast-body").text(t.message),t.id&&e.attr("id",`toast-${t.id}`),$("#toast-container").append(e),e.toast({delay:t.delay||3e3,autohide:!!t.autohide}),e.on("hidden.bs.toast",(t=>t.target.remove())),e.toast("show"),e}function a(t,e=1e4){console.log(i.default.now(),"error: ",t),s({title:"错误",icon:"alert",message:t,autohide:!0,delay:e})}const r={showMessage:function(t,e=2e3){console.debug(i.default.now(),"message:",t),s({title:"信息",icon:"check",message:t,autohide:!0,delay:e})},showError:a,showErrorTitleAndMessage:function(t,e,n=1e4){console.log(i.default.now(),"error: ",e),s({title:t,icon:"alert",message:e,autohide:!0,delay:n})},showAndLogError:function(t,e=1e4){a(t,e),o.Z.logError(t)},throwError:function(t){throw o.Z.logError(t),new Error(t)},showPersistent:function(t){let e=$(`#toast-${t.id}`);e.length>0?e.find(".toast-body").html(t.message):(t.autohide=!1,e=s(t)),t.closeAfter&&setTimeout((()=>e.remove()),t.closeAfter)},closePersistent:function(t){$(`#toast-${t}`).remove()}}},8481:(t,e,n)=>{n.d(e,{Z:()=>g});var o=n(4264),i=n(9046),s=n(1412),a=n(3968),r=n(2817);async function d(t,e="root",n=!0){if(i.default.assertArguments(t),0===(t=t.split("?")[0].trim()).length)return null;const a=t.split("/").reverse();a.includes("root")||a.push("root");const r=[];let d=null,l=0;for(;!(l>=a.length);){const c=a[l++];if(null!==d){const a=await s.default.getNote(d,!n);if(!a)return n&&o.Z.logError(`Can't find note ${d}`),null;a.sortParents();const l=a.getParentNotes();if(!l.length)return n&&o.Z.logError(`No parents found for note ${d} (${a.title}) for path ${t}`),null;if(!l.some((t=>t.noteId===c))){if(n){const t=s.default.getNoteFromCache(c);console.debug(i.default.now(),`Did not find parent ${c} (${t?t.title:"n/a"}) \n                        for child ${d} (${a.title}), available parents: ${l.map((t=>`${t.noteId} (${t.title})`))}. \n                        You can ignore this message as it is mostly harmless.`)}const t=a.getBestNotePath(e);if(t){const e=t.reverse().slice(1);for(const t of e)r.push(t)}break}}r.push(c),d=c}if(r.reverse(),r.includes(e))return r;{const n=await s.default.getNote(c(t)),o=n.getBestNotePath(e);if(!o)throw new Error(`Did not find any path segments for '${n.toString()}', hoisted note '${e}'`);return o.includes(e)?o:r}}function c(t){if(!t)return null;const[e]=t.split("?"),n=e.split("/");return n[n.length-1]}function l(t){if(!t)return{};const[e]=t.split("?");if("root"===e)return{noteId:"root",parentNoteId:"none"};let n="root",o="";if(e){const t=e.split("/");o=t[t.length-1],t.length>1&&(n=t[t.length-2])}return{parentNoteId:n,noteId:o}}async function h(t,e=null){i.default.assertArguments(t);const n=await s.default.getNote(t);if(!n)return"[not found]";let{title:o}=n;if(null!==e){const t=n.parentToBranch[e];if(t){const e=s.default.getBranch(t);e?.prefix&&(o=`${e.prefix} - ${o}`)}}return o}async function u(t){const e=[];if(t.startsWith("root/")&&(t=t.substr(5)),"root"===t)e.push(await h(t));else{let n="root";for(const o of t.split("/"))e.push(await h(o,n)),n=o}return e}o.Z.subscribeToMessages((t=>{"openNote"===t.type&&(r.default.tabManager.activateOrOpenNote(t.noteId),i.default.isElectron())&&i.default.dynamicRequire("@electron/remote").getCurrentWindow().show()}));const g={resolveNotePath:async function(t,e="root"){const n=await d(t,e);return n?n.join("/"):null},resolveNotePathToSegments:d,getParentProtectedStatus:function(t){return!a.Z.isHoistedNode(t)&&t.getParent().data.isProtected},getNotePath:function(t){if(!t)return logError("节点为空"),"";const e=[];for(;t;)t.data.noteId&&e.push(t.data.noteId),t=t.getParent();return e.reverse().join("/")},getNoteIdFromUrl:c,getNoteIdAndParentIdFromUrl:l,getBranchIdFromUrl:async function(t){const{noteId:e,parentNoteId:n}=l(t);return await s.default.getBranchId(n,e)},getNoteTitle:h,getNotePathTitle:async function(t){return i.default.assertArguments(t),(await u(t)).join(" / ")},getNoteTitleWithPathAsSuffix:async function(t){i.default.assertArguments(t);const e=await u(t);if(!e||0===e.length)return"";const n=e[e.length-1],o=e.slice(0,e.length-1),s=$('<span class="note-title-with-path">').append($('<span class="note-title">').text(n));return o.length>0&&s.append($('<span class="note-path">').text(` (${o.join(" / ")})`)),s},isNotePathInHiddenSubtree:function(t){return t?.includes("root/_hidden")}}},4264:(t,e,n)=>{n.d(e,{Z:()=>R});var o=n(9046),i=n(6885),s=n(1736),a=n(4378);class r{constructor(t){this.entities={};for(const{entityId:e,entityName:n,entity:o}of t)o&&(this.entities[n]=this.entities[n]||[],this.entities[n][e]=o);this.noteIdToComponentId={},this.componentIdToNoteIds={},this.branchRows=[],this.attributeRows=[],this.noteReorderings=[],this.revisionRows=[],this.contentNoteIdToComponentId=[],this.optionNames=[],this.attachmentRows=[]}getEntityRow(t,e){return this.entities[t]?.[e]}addNote(t,e){this.noteIdToComponentId[t]=this.noteIdToComponentId[t]||[],this.noteIdToComponentId[t].includes(e)||this.noteIdToComponentId[t].push(e),this.componentIdToNoteIds[e]=this.componentIdToNoteIds[e]||[],this.componentIdToNoteIds[e]||this.componentIdToNoteIds[e].push(t)}addBranch(t,e){this.branchRows.push({branchId:t,componentId:e})}getBranchRows(){return this.branchRows.map((t=>this.getEntityRow("branches",t.branchId))).filter((t=>!!t))}addNoteReordering(t,e){this.noteReorderings.push(t)}getNoteReorderings(){return this.noteReorderings}addAttribute(t,e){this.attributeRows.push({attributeId:t,componentId:e})}getAttributeRows(t="none"){return this.attributeRows.filter((e=>e.componentId!==t)).map((t=>this.getEntityRow("attributes",t.attributeId))).filter((t=>!!t))}addRevision(t,e,n){this.revisionRows.push({revisionId:t,noteId:e,componentId:n})}hasRevisionForNote(t){return!!this.revisionRows.find((e=>e.noteId===t))}getNoteIds(){return Object.keys(this.noteIdToComponentId)}isNoteReloaded(t,e=null){if(!t)return!1;const n=this.noteIdToComponentId[t];return n&&void 0!==n.find((t=>t!==e))}addNoteContent(t,e){this.contentNoteIdToComponentId.push({noteId:t,componentId:e})}isNoteContentReloaded(t,e){return!!t&&this.contentNoteIdToComponentId.find((n=>n.noteId===t&&n.componentId!==e))}addOption(t){this.optionNames.push(t)}isOptionReloaded(t){return this.optionNames.includes(t)}getOptionNames(){return this.optionNames}addAttachmentRow(t){this.attachmentRows.push(t)}getAttachmentRows(){return this.attachmentRows}hasAttributeRelatedChanges(){return this.branchRows.length>0||this.attributeRows.length>0}isEmpty(){return 0===Object.keys(this.noteIdToComponentId).length&&0===this.branchRows.length&&0===this.attributeRows.length&&0===this.noteReorderings.length&&0===this.revisionRows.length&&0===this.contentNoteIdToComponentId.length&&0===this.optionNames.length&&0===this.attachmentRows.length}isEmptyForTree(){return 0===Object.keys(this.noteIdToComponentId).length&&0===this.branchRows.length&&0===this.attributeRows.length&&0===this.noteReorderings.length}}var d=n(1412),c=n(4585),l=n(8726),h=n(9673),u=n(9763);function g(t,e){const n=d.default.notes[e.entityId];if(n)if(t.addNote(e.entityId,e.componentId),e.isErased&&e.entityId in d.default.notes)o.default.reloadFrontendApp(`${e.entityName} '${e.entityId}' is erased, need to do complete reload.`);else if(e.isErased||e.entity?.isDeleted)delete d.default.notes[e.entityId];else{if(n.blobId!==e.entity.blobId){for(const t of Object.keys(d.default.blobPromises))t.includes(n.noteId)&&delete d.default.blobPromises[t];t.addNoteContent(n.noteId,e.componentId)}n.update(e.entity)}}async function p(t,e){if(e.isErased&&e.entityId in d.default.branches)return void o.default.reloadFrontendApp(`${e.entityName} '${e.entityId}' is erased, need to do complete reload.`);let n=d.default.branches[e.entityId];if(e.isErased||e.entity?.isDeleted){if(n){const o=d.default.notes[n.noteId],i=d.default.notes[n.parentNoteId];o&&(o.parents=o.parents.filter((t=>t!==n.parentNoteId)),delete o.parentToBranch[n.parentNoteId]),i&&(i.children=i.children.filter((t=>t!==n.noteId)),delete i.childToBranch[n.noteId]),t.addBranch(e.entityId,e.componentId),delete d.default.branches[e.entityId]}return}t.addBranch(e.entityId,e.componentId);const i=d.default.notes[e.entity.noteId];let s=d.default.notes[e.entity.parentNoteId];!i||i.isRoot()||s||(s=await d.default.getNote(e.entity.parentNoteId)),n?n.update(e.entity):(i||s)&&(d.default.branches[e.entityId]=n=new l.Z(d.default,e.entity)),i&&i.addParent(n.parentNoteId,n.branchId),s&&s.addChild(n.noteId,n.branchId)}function f(t,e){const n=new Set;for(const t in e.positions){const o=d.default.branches[t];o&&(o.notePosition=e.positions[t],n.add(o.parentNoteId))}for(const t of n){const e=d.default.notes[t];e&&e.sortChildren()}t.addNoteReordering(e.entityId,e.componentId)}function m(t,e){let n=d.default.attributes[e.entityId];if(e.isErased&&e.entityId in d.default.attributes)return void o.default.reloadFrontendApp(`${e.entityName} '${e.entityId}' is erased, need to do complete reload.`);if(e.isErased||e.entity?.isDeleted){if(n){const o=d.default.notes[n.noteId],i="relation"===n.type&&d.default.notes[n.value];o&&(o.attributes=o.attributes.filter((t=>t!==n.attributeId))),i&&(i.targetRelations=i.targetRelations.filter((t=>t!==n.attributeId))),t.addAttribute(e.entityId,e.componentId),delete d.default.attributes[e.entityId]}return}t.addAttribute(e.entityId,e.componentId);const i=d.default.notes[e.entity.noteId],s="relation"===e.entity.type&&d.default.notes[e.entity.value];n?n.update(e.entity):(i||s)&&(n=new h.Z(d.default,e.entity),d.default.attributes[n.attributeId]=n,i&&!i.attributes.includes(n.attributeId)&&i.attributes.push(n.attributeId),s&&!s.targetRelations.includes(n.attributeId)&&s.targetRelations.push(n.attributeId))}function w(t,e){if(e.isErased&&e.entityId in d.default.attachments)return void o.default.reloadFrontendApp(`${e.entityName} '${e.entityId}' is erased, need to do complete reload.`);const n=d.default.attachments[e.entityId];if(e.isErased||e.entity?.isDeleted){if(n){const o=n.getNote();o&&o.attachments&&(o.attachments=o.attachments.filter((t=>t.attachmentId!==n.attachmentId))),t.addAttachmentRow(e.entity),delete d.default.attachments[e.entityId]}}else{if(n)n.update(e.entity);else{const t=d.default.notes[e.entity.ownerId];t?.attachments&&t.attachments.push(new u.Z(d.default,e.entity))}t.addAttachmentRow(e.entity)}}const I={processEntityChanges:async function(t){const e=new r(t);for(const n of t)try{if("notes"===n.entityName)g(e,n);else if("branches"===n.entityName)await p(e,n);else if("attributes"===n.entityName)m(e,n);else if("note_reordering"===n.entityName)f(e,n);else if("revisions"===n.entityName)e.addRevision(n.entityId,n.noteId,n.componentId);else if("options"===n.entityName){if("openNoteContexts"===n.entity.name)continue;a.Z.set(n.entity.name,n.entity.value),e.addOption(n.entity.name)}else if("attachments"===n.entityName)w(e,n);else if("blobs"!==n.entityName&&"etapi_tokens"!==n.entityName)throw new Error(`Unknown entityName '${n.entityName}'`)}catch(t){throw new Error(`Can't process entity ${JSON.stringify(n)} with error ${t.message} ${t.stack}`)}const o=[];for(const{entityName:e,entity:n}of t)n&&("branches"!==e||n.parentNoteId in d.default.notes?"attributes"!==e||"relation"!==n.type||"template"!==n.name&&"inherit"!==n.name||n.value in d.default.notes||o.push(n.value):o.push(n.parentNoteId));if(o.length>0&&await d.default.reloadNotes(o),!e.isEmpty()){e.hasAttributeRelatedChanges()&&c.Z.invalidate();const t=(await Promise.resolve().then(n.bind(n,2817))).default;await t.triggerEvent("entitiesReloaded",{loadResults:e})}}};var b=n(2817);const y=[];let v,N,x=window.glob.maxEntityChangeIdAtLoad,C=window.glob.maxEntityChangeSyncIdAtLoad,$=window.glob.maxEntityChangeIdAtLoad,E=[];function A(t){console.error(o.default.now(),t),v&&1===v.readyState&&v.send(JSON.stringify({type:"log-error",error:t,stack:(new Error).stack}))}window.logError=A,window.logInfo=function(t){console.log(o.default.now(),t),v&&1===v.readyState&&v.send(JSON.stringify({type:"log-info",info:t}))};let S=null;const P=new Set;async function T(t){const e=JSON.parse(t.data);for(const t of y)t(e);if("ping"===e.type)N=Date.now();else if("reload-frontend"===e.type)o.default.reloadFrontendApp("received request from backend to reload frontend");else if("frontend-update"===e.type)await async function(t){if(N=Date.now(),t.length>0){!function(t){const e=t.filter((t=>!P.has(t.id)&&("options"!==t.entityName||"openNoteContexts"!==t.entityId)));e.length>0&&console.debug(o.default.now(),"Frontend update data: ",e)}(t),E.push(...t);for(const e of t)x=Math.max(x,e.id),e.isSynced&&(C=Math.max(C,e.id));for(Z();S;)await S;try{S=async function(){if(E.length>0){const t=E;E=[];const e=t.filter((t=>!P.has(t.id)));try{await o.default.timeLimit(I.processEntityChanges(e),3e4)}catch(t){A(`发生错误 ${t.message}: ${t.stack}, 重新加载界面.`),glob.isDev||a.Z.is("debugModeEnabled")?(console.log("nonProcessedEntityChanges causing the timeout",e),i.default.showError(`Encountered error "${t.message}", check out the console.`)):o.default.reloadFrontendApp()}for(const t of e)P.add(t.id),$=Math.max($,t.id)}_.filter((t=>t.desiredEntityChangeId<=$)).forEach((t=>t.resolvePromise())),_=_.filter((t=>t.desiredEntityChangeId>$)),_.filter((t=>Date.now()>t.start-6e4)).forEach((t=>console.log(`Waiting for entityChangeId ${t.desiredEntityChangeId} while last processed is ${$} (last accepted ${x}) for ${Math.floor((Date.now()-t.start)/1e3)}s`)))}(),await S}finally{S=null}}}(e.data.entityChanges);else if("sync-hash-check-failed"===e.type)i.default.showError("同步检查失败!",6e4);else if("consistency-checks-failed"===e.type)i.default.showError("一致性检查失败! 详情请看日志.",3e6);else if("api-log-messages"===e.type)b.default.triggerEvent("apiLogMessages",{noteId:e.noteId,messages:e.messages});else if("toast"===e.type)i.default.showMessage(e.message);else if("execute-script"===e.type){const t=(await Promise.resolve().then(n.bind(n,394))).default,o=(await Promise.resolve().then(n.bind(n,1412))).default,i=e.originEntityId?await o.getNote(e.originEntityId):null;t.getAndExecuteBundle(e.currentNoteId,i,e.script,e.params)}}let _=[];function M(){const t=window.location,e=`${"https:"===t.protocol?"wss:":"ws:"}//${t.host}${t.pathname}`,n=new WebSocket(e);return n.onopen=()=>console.debug(o.default.now(),`Connected to server ${e} with WebSocket`),n.onmessage=T,n}async function Z(){Date.now()-N>3e4&&console.log(o.default.now(),"Lost websocket connection to the backend. If you keep having this issue repeatedly, you might want to check your reverse proxy (nginx, apache) configuration and allow/unblock WebSocket."),v.readyState===v.OPEN?v.send(JSON.stringify({type:"ping",lastEntityChangeId:x})):v.readyState!==v.CLOSED&&v.readyState!==v.CLOSING||(console.log(o.default.now(),"WS closed or closing, trying to reconnect"),v=M())}setTimeout((()=>{v=M(),N=Date.now(),setInterval(Z,1e3)}),0);const R={logError:A,subscribeToMessages:function(t){y.push(t)},waitForMaxKnownEntityChangeId:function(){return(t=s.Z.getMaxKnownEntityChangeId())<=$?Promise.resolve():(console.debug(`Waiting for ${t}, last processed is ${$}, last accepted ${x}`),new Promise(((e,n)=>{_.push({desiredEntityChangeId:t,resolvePromise:e,start:Date.now()})})));var t},getMaxKnownEntityChangeSyncId:()=>C}},1167:(t,e,n)=>{n.d(e,{Z:()=>s});var o=n(8866);class i extends o.Z{constructor(){super(),this.attrs={style:""},this.classes=[],this.children=[],this.childPositionCounter=10}child(...t){if(!t)return this;super.child(...t);for(const e of t)void 0===e.position&&(e.position=this.childPositionCounter,this.childPositionCounter+=10);return this.children.sort(((t,e)=>t.position-e.position)),this}id(t){return this.attrs.id=t,this}class(t){return this.classes.push(t),this}css(t,e){return this.attrs.style+=`${t}: ${e};`,this}contentSized(){return this.css("contain","none"),this}collapsible(){return this.css("min-height","0"),this.css("min-width","0"),this}filling(){return this.css("flex-grow","1"),this}cssBlock(t){return this.cssEl=t,this}render(){if(this.doRender(),this.$widget.attr("data-component-id",this.componentId),this.$widget.addClass("component").prop("component",this),this.isEnabled()||this.toggleInt(!1),this.cssEl){const t=this.cssEl.trim().startsWith("<style>")?this.cssEl:`<style>${this.cssEl}</style>`;this.$widget.append(t)}for(const t in this.attrs)if("style"===t){if(this.attrs[t]){let e=this.$widget.attr("style");e=e?`${e}; ${this.attrs[t]}`:this.attrs[t],this.$widget.attr(t,e)}}else this.$widget.attr(t,this.attrs[t]);for(const t of this.classes)this.$widget.addClass(t);return this.$widget}isEnabled(){return!0}doRender(){}toggleInt(t){this.$widget.toggleClass("hidden-int",!t)}isHiddenInt(){return this.$widget.hasClass("hidden-int")}toggleExt(t){this.$widget.toggleClass("hidden-ext",!t)}isHiddenExt(){return this.$widget.hasClass("hidden-ext")}canBeShown(){return!this.isHiddenInt()&&!this.isHiddenExt()}isVisible(){return this.$widget.is(":visible")}getPosition(){return this.position}remove(){this.$widget&&this.$widget.remove()}getClosestNtxId(){return this.$widget?this.$widget.closest("[data-ntx-id]").attr("data-ntx-id"):null}cleanup(){}}const s=i},2503:(t,e,n)=>{n.d(e,{Z:()=>a});var o=n(1167),i=n(2817);class s extends o.Z{isNoteContext(t){return Array.isArray(t)?this.noteContext&&t.includes(this.noteContext.ntxId):this.noteContext&&this.noteContext.ntxId===t}isActiveNoteContext(){return i.default.tabManager.getActiveContext()===this.noteContext}isNote(t){return this.noteId===t}get note(){return this.noteContext?.note}get noteId(){return this.note?.noteId}get notePath(){return this.noteContext?.notePath}get hoistedNoteId(){return this.noteContext?.hoistedNoteId}get ntxId(){return this.noteContext?.ntxId}isEnabled(){return!!this.note}async refresh(){this.isEnabled()?(this.toggleInt(!0),await this.refreshWithNote(this.note)):this.toggleInt(!1)}async refreshWithNote(t){}async noteSwitchedEvent({noteContext:t,notePath:e}){t.notePath===e&&await this.noteSwitched()}async noteSwitched(){await this.refresh()}async activeContextChangedEvent({noteContext:t}){this.noteContext=t,await this.activeContextChanged()}async activeContextChanged(){await this.refresh()}async noteSwitchedAndActivatedEvent({noteContext:t,notePath:e}){this.noteContext=t,this.notePath===e&&await this.refresh()}setNoteContextEvent({noteContext:t}){this.noteContext=t}async noteTypeMimeChangedEvent({noteId:t}){this.isNote(t)&&await this.refresh()}async frocaReloadedEvent(){await this.refresh()}}const a=s},1698:(t,e,n)=>{n.d(e,{Z:()=>s});var o=n(2503);class i extends o.Z{get widgetTitle(){return"Untitled widget"}get widgetButtons(){return[]}get help(){return{}}constructor(){super(),this.child(...this.widgetButtons)}doRender(){this.$widget=$('\n<div class="card widget">\n    <div class="card-header">\n        <div class="card-header-title"></div>\n        <div class="card-header-buttons"></div>\n    </div>\n\n    <div id="[to be set]" class="body-wrapper">\n        <div class="card-body"></div>\n    </div>\n</div>'),this.contentSized(),this.$widget.find("[data-target]").attr("data-target",`#${this.componentId}`),this.$bodyWrapper=this.$widget.find(".body-wrapper"),this.$bodyWrapper.attr("id",this.componentId),this.$body=this.$bodyWrapper.find(".card-body"),this.$title=this.$widget.find(".card-header .card-header-title"),this.$title.text(this.widgetTitle),this.$buttons=this.$widget.find(".card-header .card-header-buttons"),this.$buttons.empty();for(const t of this.children)this.$buttons.append(t.render());this.initialized=this.doRenderBody()}async doRenderBody(){}}const s=i}}]);
//# sourceMappingURL=586.js.map