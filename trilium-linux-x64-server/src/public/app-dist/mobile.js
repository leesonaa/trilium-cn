(()=>{var __webpack_modules__={2817:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>Z});var o=n(1412),i=n(394),s=n(8866),a=n(383),r=n(8481),d=n(5489),l=n(7336),c=n(4378),h=n(9046);class p extends s.Z{editReadOnlyNoteCommand(){const t=Z.tabManager.getActiveContext();t.viewScope.readOnlyTemporarilyDisabled=!0,Z.triggerEvent("readOnlyTemporarilyDisabled",{noteContext:t})}async showSQLConsoleCommand(){const t=await a.Z.createSqlConsole(),e=await Z.tabManager.openTabWithNoteWithHoisting(t.noteId,{activate:!0});Z.triggerEvent("focusOnDetail",{ntxId:e.ntxId})}async searchNotesCommand({searchString:t,ancestorNoteId:e}){const n=await a.Z.createSearchNote({searchString:t,ancestorNoteId:e});await o.default.loadSearchNote(n.noteId);const i=await Z.tabManager.openTabWithNoteWithHoisting(n.noteId,{activate:!0});Z.triggerCommand("focusOnSearchDefinition",{ntxId:i.ntxId})}async searchInSubtreeCommand({notePath:t}){const e=r.Z.getNoteIdFromUrl(t);this.searchNotesCommand({ancestorNoteId:e})}openNoteExternallyCommand(){const t=Z.tabManager.getActiveContextNoteId(),e=Z.tabManager.getActiveContextNoteMime();t&&d.Z.openNoteExternally(t,e)}openNoteCustomCommand(){const t=Z.tabManager.getActiveContextNoteId(),e=Z.tabManager.getActiveContextNoteMime();t&&d.Z.openNoteCustom(t,e)}enterProtectedSessionCommand(){l.Z.enterProtectedSession()}leaveProtectedSessionCommand(){l.Z.leaveProtectedSession()}hideLeftPaneCommand(){c.Z.save("leftPaneVisible","false")}showLeftPaneCommand(){c.Z.save("leftPaneVisible","true")}toggleLeftPaneCommand(){c.Z.toggle("leftPaneVisible")}async showBackendLogCommand(){await Z.tabManager.openTabWithNoteWithHoisting("_backendLog",{activate:!0})}async showLaunchBarSubtreeCommand(){await this.showAndHoistSubtree("_lbRoot")}async showShareSubtreeCommand(){await this.showAndHoistSubtree("_share")}async showHiddenSubtreeCommand(){await this.showAndHoistSubtree("_hidden")}async showOptionsCommand({section:t}){await Z.tabManager.openContextWithNote(t||"_options",{activate:!0,hoistedNoteId:"_options"})}async showSQLConsoleHistoryCommand(){await this.showAndHoistSubtree("_sqlConsole")}async showSearchHistoryCommand(){await this.showAndHoistSubtree("_search")}async showAndHoistSubtree(t){await Z.tabManager.openContextWithNote(t,{activate:!0,hoistedNoteId:t})}async showNoteSourceCommand(){const t=Z.tabManager.getActiveContextNotePath();t&&await Z.tabManager.openTabWithNoteWithHoisting(t,{activate:!0,viewScope:{viewMode:"source"}})}async showAttachmentsCommand(){const t=Z.tabManager.getActiveContextNotePath();t&&await Z.tabManager.openTabWithNoteWithHoisting(t,{activate:!0,viewScope:{viewMode:"attachments"}})}async showAttachmentDetailCommand(){const t=Z.tabManager.getActiveContextNotePath();t&&await Z.tabManager.openTabWithNoteWithHoisting(t,{activate:!0,viewScope:{viewMode:"attachments"}})}toggleTrayCommand(){if(!h.default.isElectron())return;const{BrowserWindow:t}=h.default.dynamicRequire("@electron/remote"),e=t.getAllWindows(),n=e.every((t=>t.isVisible()))?"hide":"show";for(const t of e)t[n]()}firstTabCommand(){this.#t(1)}secondTabCommand(){this.#t(2)}thirdTabCommand(){this.#t(3)}fourthTabCommand(){this.#t(4)}fifthTabCommand(){this.#t(5)}sixthTabCommand(){this.#t(6)}seventhTabCommand(){this.#t(7)}eigthTabCommand(){this.#t(8)}ninthTabCommand(){this.#t(9)}lastTabCommand(){this.#t(Number.POSITIVE_INFINITY)}#t(t){const e=Z.tabManager.getMainNoteContexts(),n=e[t===Number.POSITIVE_INFINITY?e.length-1:t-1];n&&Z.tabManager.activateNoteContext(n.ntxId)}}var u=n(2040),g=n(1736),m=n(6885),f=n(4264),b=n(7844);class w extends s.Z{constructor(){super(),jQuery.hotkeys&&(jQuery.hotkeys.options.filterInputAcceptingElements=!1,jQuery.hotkeys.options.filterContentEditable=!1,jQuery.hotkeys.options.filterTextInputs=!1)}openDevToolsCommand(){h.default.isElectron()&&h.default.dynamicRequire("@electron/remote").getCurrentWindow().toggleDevTools()}async createNoteIntoInboxCommand(){const t=await a.Z.getInboxNote(),{note:e}=await g.Z.post(`notes/${t.noteId}/children?target=into`,{content:"",type:"text",isProtected:t.isProtected&&u.Z.isProtectedSessionAvailable()});await f.Z.waitForMaxKnownEntityChangeId(),await Z.tabManager.openTabWithNoteWithHoisting(e.noteId,{activate:!0}),Z.triggerEvent("focusAndSelectTitle",{isNewNote:!0})}async toggleNoteHoistingCommand({noteId:t=Z.tabManager.getActiveContextNoteId()}){const e=await o.default.getNote(t),n=Z.tabManager.getActiveContext();e.noteId===n.hoistedNoteId?await n.unhoist():"search"!==e.type&&await n.setHoistedNoteId(t)}async hoistNoteCommand({noteId:t}){const e=Z.tabManager.getActiveContext();e.hoistedNoteId!==t&&await e.setHoistedNoteId(t)}async unhoistCommand(){const t=Z.tabManager.getActiveContext();t&&t.unhoist()}copyWithoutFormattingCommand(){h.default.copySelectionToClipboard()}toggleFullscreenCommand(){if(h.default.isElectron()){const t=h.default.dynamicRequire("@electron/remote").getCurrentWindow();t.isFullScreenable()&&t.setFullScreen(!t.isFullScreen())}}reloadFrontendAppCommand(){h.default.reloadFrontendApp()}logoutCommand(){const t=$('<form action="logout" method="POST">').append($(`<input type='_hidden' name="_csrf" value="${glob.csrfToken}"/>`));$("body").append(t),t.trigger("submit")}backInNoteHistoryCommand(){if(h.default.isElectron()){const t=h.default.dynamicRequire("@electron/remote").getCurrentWebContents(),e=parseInt(t.getActiveIndex());t.goToIndex(e-1)}else window.history.back()}forwardInNoteHistoryCommand(){if(h.default.isElectron()){const t=h.default.dynamicRequire("@electron/remote").getCurrentWebContents(),e=parseInt(t.getActiveIndex());t.goToIndex(e+1)}else window.history.forward()}async switchToDesktopVersionCommand(){h.default.setCookie("trilium-device","desktop"),h.default.reloadFrontendApp("正在切换到桌面版")}async switchToMobileVersionCommand(){h.default.setCookie("trilium-device","mobile"),h.default.reloadFrontendApp("正在切换到移动版")}async openInWindowCommand({notePath:t,hoistedNoteId:e,viewScope:n}){const o=b.Z.calculateHash({notePath:t,hoistedNoteId:e,viewScope:n});if(h.default.isElectron()){const{ipcRenderer:t}=h.default.dynamicRequire("electron");t.send("create-extra-window",{extraWindowHash:o})}else{const t=`${window.location.protocol}//${window.location.host}${window.location.pathname}?extraWindow=1${o}`;window.open(t,"","width=1000,height=800")}}async openNewWindowCommand(){this.openInWindowCommand({notePath:"",hoistedNoteId:"root"})}async runActiveNoteCommand(){const{ntxId:t,note:e}=Z.tabManager.getActiveContext();if(e&&"code"===e.type){if(e.mime.endsWith("env=frontend"))await i.default.getAndExecuteBundle(e.noteId);else if(e.mime.endsWith("env=backend"))await g.Z.post(`script/run/${e.noteId}`);else if("text/x-sqlite;schema=trilium"===e.mime){const n=await g.Z.post(`sql/execute/${e.noteId}`);n.success||m.default.showError(`Error occurred while executing SQL query: ${n.error}`),await Z.triggerEvent("sqlQueryResults",{ntxId:t,results:n.results})}m.default.showMessage("笔记已执行")}}hideAllPopups(){h.default.isDesktop()&&$(".aa-input").autocomplete("close")}noteSwitchedEvent(){this.hideAllPopups()}activeContextChangedEvent(){this.hideAllPopups()}async forceSaveRevisionCommand(){const t=Z.tabManager.getActiveContextNoteId();await g.Z.post(`notes/${t}/revision`),m.default.showMessage("笔记历史已创建")}}var y=n(9925),x=n(1902),v=n(3968);class I extends s.Z{constructor(t=null,e="root",n=null){super(),this.ntxId=t||this.constructor.generateNtxId(),this.hoistedNoteId=e,this.mainNtxId=n,this.resetViewScope()}static generateNtxId(){return h.default.randomString(6)}setEmpty(){this.notePath=null,this.noteId=null,this.parentNoteId=null,this.triggerEvent("noteSwitched",{noteContext:this,notePath:this.notePath}),this.resetViewScope()}isEmpty(){return!this.noteId}async setNote(t,e={}){e.triggerSwitchEvent=void 0===e.triggerSwitchEvent||e.triggerSwitchEvent,e.viewScope=e.viewScope||{},e.viewScope.viewMode=e.viewScope.viewMode||"default";const n=await this.getResolvedNotePath(t);n&&(this.notePath===n&&h.default.areObjectsEqual(this.viewScope,e.viewScope)||(await this.triggerEvent("beforeNoteSwitch",{noteContext:this}),h.default.closeActiveDialog(),this.notePath=n,this.viewScope=e.viewScope,({noteId:this.noteId,parentNoteId:this.parentNoteId}=r.Z.getNoteIdAndParentIdFromUrl(n)),this.saveToRecentNotes(n),u.Z.touchProtectedSessionIfNecessary(this.note),e.triggerSwitchEvent&&await this.triggerEvent("noteSwitched",{noteContext:this,notePath:this.notePath}),await this.setHoistedNoteIfNeeded(),h.default.isMobile()&&this.triggerCommand("setActiveScreen",{screen:"detail"})))}async setHoistedNoteIfNeeded(){if("root"===this.hoistedNoteId&&this.notePath.startsWith("root/_hidden")&&!this.note.isLabelTruthy("keepCurrentHoisting")){let t="_hidden";this.note.isLaunchBarConfig()?t="_lbRoot":this.note.isOptions()&&(t="_options"),await this.setHoistedNoteId(t)}}getSubContexts(){return Z.tabManager.noteContexts.filter((t=>t.ntxId===this.ntxId||t.mainNtxId===this.ntxId))}isMainContext(){return!this.mainNtxId}getMainContext(){if(!this.mainNtxId)return this;try{return Z.tabManager.getNoteContextById(this.mainNtxId)}catch(t){return this.mainNtxId=null,this}}saveToRecentNotes(t){setTimeout((async()=>{t&&t===this.notePath&&await g.Z.post("recent-notes",{noteId:this.note.noteId,notePath:this.notePath})}),5e3)}async getResolvedNotePath(t){const e=await r.Z.resolveNotePath(t,this.hoistedNoteId);if(e){if(!1!==await v.Z.checkNoteAccess(e,this))return e}else logError(`Cannot resolve note path ${t}`)}get note(){return this.noteId&&this.noteId in o.default.notes?o.default.notes[this.noteId]:null}get notePathArray(){return this.notePath?this.notePath.split("/"):[]}isActive(){return Z.tabManager.activeNtxId===this.ntxId}getPojoState(){return"root"===this.hoistedNoteId||this.notePath||0!==this.getSubContexts().length?{ntxId:this.ntxId,mainNtxId:this.mainNtxId,notePath:this.notePath,hoistedNoteId:this.hoistedNoteId,active:this.isActive(),viewScope:this.viewScope}:null}async unhoist(){await this.setHoistedNoteId("root")}async setHoistedNoteId(t){this.hoistedNoteId!==t&&(this.hoistedNoteId=t,this.notePathArray?.includes(t)||h.default.isMobile()||await this.setNote(t),await this.triggerEvent("hoistedNoteChanged",{noteId:t,ntxId:this.ntxId}))}async isReadOnly(){if(this.viewScope.readOnlyTemporarilyDisabled)return!1;if(!this.note||"text"!==this.note.type&&"code"!==this.note.type)return!1;if(this.note.isLabelTruthy("readOnly"))return!0;if("source"===this.viewScope.viewMode)return!0;const t=await this.note.getBlob(),e="text"===this.note.type?c.Z.getInt("autoReadonlySizeText"):c.Z.getInt("autoReadonlySizeCode");return t.contentLength>e&&!this.note.isLabelTruthy("autoReadOnlyDisabled")}async entitiesReloadedEvent({loadResults:t}){t.isNoteReloaded(this.noteId)&&t.getEntityRow("notes",this.noteId).isDeleted&&(this.noteId=null,this.notePath=null,this.triggerEvent("noteSwitched",{noteContext:this,notePath:this.notePath}))}hasNoteList(){return this.note&&"default"===this.viewScope.viewMode&&this.note.hasChildren()&&["book","text","code"].includes(this.note.type)&&"text/x-sqlite;schema=trilium"!==this.note.mime&&!this.note.isLabelTruthy("hideChildrenOverview")}async getTextEditor(t){return this.timeout(new Promise((e=>Z.triggerCommand("executeWithTextEditor",{callback:t,resolve:e,ntxId:this.ntxId}))))}async getCodeEditor(){return this.timeout(new Promise((t=>Z.triggerCommand("executeWithCodeEditor",{resolve:t,ntxId:this.ntxId}))))}async getContentElement(){return this.timeout(new Promise((t=>Z.triggerCommand("executeWithContentElement",{resolve:t,ntxId:this.ntxId}))))}async getTypeWidget(){return this.timeout(new Promise((t=>Z.triggerCommand("executeWithTypeWidget",{resolve:t,ntxId:this.ntxId}))))}timeout(t){return Promise.race([t,new Promise((t=>setTimeout((()=>t(null)),200)))])}resetViewScope(){this.viewScope={}}async getNavigationTitle(){if(!this.note)return null;const{note:t,viewScope:e}=this;let n="default"===e.viewMode?t.title:`${t.title}: ${e.viewMode}`;if(e.attachmentId){const o=await t.getAttachmentById(e.attachmentId);o&&(n+=`: ${o.title}`)}return n}}const C=I;class N{constructor(){this.current=Promise.resolve()}lock(){let t;const e=new Promise((e=>t=()=>e())),n=this.current.then((()=>t));return this.current=e,n}async runExclusively(t){const e=await this.lock();try{return await t()}finally{e()}}}class k extends s.Z{constructor(){super(),this.children=[],this.mutex=new N,this.activeNtxId=null,this.recentlyClosedTabs=[],this.tabsUpdate=new x.Z((async()=>{if(!Z.isMainWindow)return;const t=this.noteContexts.map((t=>t.getPojoState())).filter((t=>!!t));await g.Z.put("options",{openNoteContexts:JSON.stringify(t)})})),Z.addBeforeUnloadListener(this)}get noteContexts(){return this.children}get mainNoteContexts(){return this.noteContexts.filter((t=>!t.mainNtxId))}async loadTabs(){try{const t=Z.isMainWindow&&c.Z.getJson("openNoteContexts")||[];await o.default.getNotes([...t.flatMap((t=>[r.Z.getNoteIdFromUrl(t.notePath),t.hoistedNoteId]))],!0);const e=t.filter((t=>h.default.isMobile()?!!t.active:r.Z.getNoteIdFromUrl(t.notePath)in o.default.notes&&(t.hoistedNoteId in o.default.notes||(t.hoistedNoteId="root"),!0))),n=b.Z.parseNavigationStateFromUrl(window.location.href);0===e.length?(n.ntxId=n.ntxId||C.generateNtxId(),e.push({notePath:n.notePath||"root",ntxId:n.ntxId,active:!0,hoistedNoteId:n.hoistedNoteId||"root",viewScope:n.viewScope||{}})):e.find((t=>t.active))||(e[0].active=!0),await this.tabsUpdate.allowUpdateWithoutChange((async()=>{for(const t of e)await this.openContextWithNote(t.notePath,{activate:t.active,ntxId:t.ntxId,mainNtxId:t.mainNtxId,hoistedNoteId:t.hoistedNoteId,viewScope:t.viewScope})})),n.notePath?await Z.tabManager.switchToNoteContext(n.ntxId,n.notePath,n.viewScope,n.hoistedNoteId):n.searchString&&await Z.triggerCommand("searchNotes",{searchString:n.searchString})}catch(t){logError(`Loading note contexts '${c.Z.get("openNoteContexts")}' failed: ${t.message} ${t.stack}`),await this.openEmptyTab()}}noteSwitchedEvent({noteContext:t}){t.isActive()&&this.setCurrentNavigationStateToHash(),this.tabsUpdate.scheduleUpdate()}setCurrentNavigationStateToHash(){const t=this.calculateHash();0!==window.history.length&&t===window.location?.hash||window.history.pushState(null,"",t);const e=this.getActiveContext();this.updateDocumentTitle(e),this.triggerEvent("activeNoteChanged")}calculateHash(){const t=this.getActiveContext();return t?b.Z.calculateHash({notePath:t.notePath,ntxId:t.ntxId,hoistedNoteId:t.hoistedNoteId,viewScope:t.viewScope}):""}getNoteContexts(){return this.noteContexts}getMainNoteContexts(){return this.noteContexts.filter((t=>t.isMainContext()))}getNoteContextById(t){const e=this.noteContexts.find((e=>e.ntxId===t));if(!e)throw new Error(`找不到 noteContext id='${t}'`);return e}getActiveContext(){return this.activeNtxId?this.getNoteContextById(this.activeNtxId):null}getActiveMainContext(){return this.activeNtxId?this.getNoteContextById(this.activeNtxId).getMainContext():null}getActiveContextNotePath(){const t=this.getActiveContext();return t?t.notePath:null}getActiveContextNote(){const t=this.getActiveContext();return t?t.note:null}getActiveContextNoteId(){const t=this.getActiveContextNote();return t?t.noteId:null}getActiveContextNoteType(){const t=this.getActiveContextNote();return t?t.type:null}getActiveContextNoteMime(){const t=this.getActiveContextNote();return t?t.mime:null}async switchToNoteContext(t,e,n={},o=null){const i=this.noteContexts.find((e=>e.ntxId===t))||await this.openEmptyTab();await this.activateNoteContext(i.ntxId),o&&await i.setHoistedNoteId(o),e&&await i.setNote(e,{viewScope:n})}async openAndActivateEmptyTab(){const t=await this.openEmptyTab();await this.activateNoteContext(t.ntxId),await t.setEmpty()}async openEmptyTab(t=null,e="root",n=null){const o=new C(t,e,n);let i;return i=h.default.isMobile()?this.getActiveContext():this.children.find((t=>t.ntxId===o.ntxId)),i?(await i.setHoistedNoteId(e),i):(this.child(o),await this.triggerEvent("newNoteContextCreated",{noteContext:o}),o)}async openInNewTab(t,e=null){const n=await this.openEmptyTab(null,e||this.getActiveContext().hoistedNoteId);await n.setNote(t)}async openInSameTab(t,e=null){const n=this.getActiveContext();await n.setHoistedNoteId(e||n.hoistedNoteId),await n.setNote(t)}async openTabWithNoteWithHoisting(t,e={}){const n=this.getActiveContext();let o="root";if(n){const e=await r.Z.resolveNotePath(t,n.hoistedNoteId);(e.includes(n.hoistedNoteId)||e.includes("_hidden"))&&(o=n.hoistedNoteId)}return e.hoistedNoteId=o,this.openContextWithNote(t,e)}async openContextWithNote(t,e={}){const n=!!e.activate,o=e.ntxId||null,i=e.mainNtxId||null,s=e.hoistedNoteId||"root",a=e.viewScope||{viewMode:"default"},r=await this.openEmptyTab(o,s,i);return t&&await r.setNote(t,{triggerSwitchEvent:!n,viewScope:a}),n&&(this.activateNoteContext(r.ntxId,!1),await this.triggerEvent("noteSwitchedAndActivated",{noteContext:r,notePath:r.notePath})),r}async activateOrOpenNote(t){for(const e of this.getNoteContexts())if(e.note&&e.note.noteId===t)return void this.activateNoteContext(e.ntxId);await this.openContextWithNote(t,{activate:!0})}async activateNoteContext(t,e=!0){t!==this.activeNtxId&&(this.activeNtxId=t,e&&await this.triggerEvent("activeContextChanged",{noteContext:this.getNoteContextById(t)}),this.tabsUpdate.scheduleUpdate(),this.setCurrentNavigationStateToHash())}async removeNoteContext(t){return await this.mutex.runExclusively((async()=>{let e;try{e=this.getNoteContextById(t)}catch{return!1}if(e.isMainContext()&&1===this.getNoteContexts().filter((t=>t.isMainContext())).length){if(e.isEmpty())return!1;await this.openEmptyTab()}$(".aa-input").autocomplete("close");const n=e.getSubContexts(),o=n.map((t=>t.ntxId));if(await this.triggerEvent("beforeNoteContextRemove",{ntxIds:o}),e.isMainContext())this.mainNoteContexts.length<=1?await this.openAndActivateEmptyTab():o.includes(this.activeNtxId)&&(this.mainNoteContexts.findIndex((t=>t.ntxId===e.ntxId))===this.mainNoteContexts.length-1?await this.activatePreviousTabCommand():await this.activateNextTabCommand());else{const t=e.getMainContext().getSubContexts(),n=t.findIndex((t=>t.ntxId===e.ntxId)),o=t[n===t.length-1?n-1:n+1];await this.activateNoteContext(o.ntxId)}return this.removeNoteContexts(n),!0}))}removeNoteContexts(t){const e=t.map((t=>t.ntxId)),n=this.noteContexts.findIndex((t=>e.includes(t.ntxId)));this.children=this.children.filter((t=>!e.includes(t.ntxId))),this.addToRecentlyClosedTabs(t,n),this.triggerEvent("noteContextRemoved",{ntxIds:e}),this.tabsUpdate.scheduleUpdate()}addToRecentlyClosedTabs(t,e){1===t.length&&t[0].isEmpty()||this.recentlyClosedTabs.push({contexts:t,position:e})}tabReorderEvent({ntxIdsInOrder:t}){const e={};let n=0;for(const o of t)for(const t of this.getNoteContextById(o).getSubContexts())e[t.ntxId]=n++;this.children.sort(((t,n)=>e[t.ntxId]<e[n.ntxId]?-1:1)),this.tabsUpdate.scheduleUpdate()}noteContextReorderEvent({ntxIdsInOrder:t,oldMainNtxId:e,newMainNtxId:n}){const o=Object.fromEntries(t.map(((t,e)=>[t,e])));this.children.sort(((t,e)=>o[t.ntxId]<o[e.ntxId]?-1:1)),e&&n&&this.children.forEach((t=>{t.ntxId===n?t.mainNtxId=null:t.ntxId!==e&&t.mainNtxId!==e||(t.mainNtxId=n)})),this.tabsUpdate.scheduleUpdate()}async activateNextTabCommand(){const t=this.getActiveMainContext().ntxId,e=this.mainNoteContexts.findIndex((e=>e.ntxId===t)),n=this.mainNoteContexts[e===this.mainNoteContexts.length-1?0:e+1].ntxId;await this.activateNoteContext(n)}async activatePreviousTabCommand(){const t=this.getActiveMainContext().ntxId,e=this.mainNoteContexts.findIndex((e=>e.ntxId===t)),n=this.mainNoteContexts[0===e?this.mainNoteContexts.length-1:e-1].ntxId;await this.activateNoteContext(n)}async closeActiveTabCommand(){await this.removeNoteContext(this.activeNtxId)}beforeUnloadEvent(){return this.tabsUpdate.updateNowIfNecessary(),!0}openNewTabCommand(){this.openAndActivateEmptyTab()}async closeAllTabsCommand(){for(const t of this.mainNoteContexts.map((t=>t.ntxId)))await this.removeNoteContext(t)}async closeOtherTabsCommand({ntxId:t}){for(const e of this.mainNoteContexts.map((t=>t.ntxId)))e!==t&&await this.removeNoteContext(e)}async closeTabCommand({ntxId:t}){await this.removeNoteContext(t)}async moveTabToNewWindowCommand({ntxId:t}){const{notePath:e,hoistedNoteId:n}=this.getNoteContextById(t);await this.removeNoteContext(t)&&this.triggerCommand("openInWindow",{notePath:e,hoistedNoteId:n})}async reopenLastTabCommand(){let t=null;await this.mutex.runExclusively((async()=>{if(0===this.recentlyClosedTabs.length)return;1===this.noteContexts.length&&this.noteContexts[0].isEmpty()&&(t=this.noteContexts[0]);const e=this.recentlyClosedTabs.pop(),n=e.contexts;for(const t of n)this.child(t),await this.triggerEvent("newNoteContextCreated",{noteContext:t});const o=[...this.noteContexts.slice(0,e.position),...this.noteContexts.slice(-n.length),...this.noteContexts.slice(e.position,-n.length)];await this.noteContextReorderEvent({ntxIdsInOrder:o.map((t=>t.ntxId))});let i=n.find((t=>t.isMainContext()));i?await this.triggerEvent("contextsReopened",{mainNtxId:i.ntxId,tabPosition:o.filter((t=>t.isMainContext())).findIndex((t=>t.ntxId===i.ntxId))}):await this.triggerEvent("contextsReopened",{ntxId:o[e.position].ntxId,afterNtxId:o[e.position-1].ntxId});const s=1===n.length?n[0]:n.find((t=>t.isMainContext()));await this.activateNoteContext(s.ntxId),await this.triggerEvent("noteSwitched",{noteContext:s,notePath:s.notePath})})),t&&await this.removeNoteContext(t.ntxId)}hoistedNoteChangedEvent(){this.tabsUpdate.scheduleUpdate()}async updateDocumentTitle(t){const e=[await t.getNavigationTitle(),"Trilium Notes"].filter(Boolean);document.title=e.join(" - ")}async entitiesReloadedEvent({loadResults:t}){const e=this.getActiveContext();e&&t.isNoteReloaded(e.noteId)&&await this.updateDocumentTitle(e)}async frocaReloadedEvent(){const t=this.getActiveContext();t&&await this.updateDocumentTitle(t)}}var S=n(6604);class T extends s.Z{setActiveScreenCommand({screen:t}){t!==this.activeScreen&&(this.activeScreen=t,"tree"===t&&Z.tabManager.getActiveContext().setEmpty(),this.triggerEvent("activeScreenChanged",{activeScreen:t}))}}var E=n(8181);class A extends s.Z{get tree(){return Z.noteTreeWidget}async cloneNotesToCommand(){const t=this.tree.getSelectedOrActiveNodes().map((t=>t.data.noteId));this.triggerCommand("cloneNoteIdsTo",{noteIds:t})}async moveNotesToCommand(){const t=this.tree.getSelectedOrActiveNodes().map((t=>t.data.branchId));this.triggerCommand("moveBranchIdsTo",{branchIds:t})}async createNoteIntoCommand(){const t=Z.tabManager.getActiveContext();t&&await E.Z.createNote(t.notePath,{isProtected:t.note.isProtected,saveSelection:!1})}async createNoteAfterCommand(){const t=this.tree.getActiveNode();if(!t)return;const e=r.Z.getNotePath(t.getParent()),n=r.Z.getParentProtectedStatus(t);"root"!==t.data.noteId&&t.data.noteId!==v.Z.getHoistedNoteId()&&await E.Z.createNote(e,{target:"after",targetBranchId:t.data.branchId,isProtected:n,saveSelection:!1})}}var _=n(1065);class P extends s.Z{constructor(){super(),g.Z.get("keyboard-shortcuts-for-notes").then((t=>{for(const e of t)this.bindNoteShortcutHandler(e)}))}bindNoteShortcutHandler(t){const e=t.attributeId;t.isDeleted?_.Z.removeGlobalShortcut(e):_.Z.bindGlobalShortcut(t.value,(()=>Z.tabManager.getActiveContext().setNote(t.noteId)),e)}async entitiesReloadedEvent({loadResults:t}){for(const e of t.getAttributeRows())if("label"===e.type&&"keyboardShortcut"===e.name){const t=await o.default.getNote(e.noteId);t&&"launcher"!==t.type&&this.bindNoteShortcutHandler(e)}}}class R extends s.Z{constructor(t){super(),this.isMainWindow=t,this.components=[],this.beforeUnloadListeners=[]}setLayout(t){this.layout=t}async start(){this.initComponents(),await c.Z.initializedPromise,this.renderWidgets(),await o.default.initializedPromise,this.tabManager.loadTabs(),setTimeout((()=>i.default.executeStartupBundles()),2e3)}initComponents(){this.tabManager=new k,this.components=[this.tabManager,new p,new w,new A,new P],h.default.isMobile()&&this.components.push(new T);for(const t of this.components)this.child(t);h.default.isElectron()&&this.child(y.Z)}renderWidgets(){const t=this.layout.getRootWidget(this),e=t.render();S.default.updateDisplayedShortcuts(e),$("body").append(e),e.on("click","[data-trigger-command]",(function(){if($(this).hasClass("disabled"))return;const t=$(this).attr("data-trigger-command");$(this).closest(".component").prop("component").triggerCommand(t,{$el:$(this)})})),this.child(t),this.triggerEvent("initialRenderComplete")}triggerEvent(t,e={}){return this.handleEvent(t,e)}triggerCommand(t,e={}){for(const n of this.components){const o=n[`${t}Command`];if(o)return n.callMethod(o,e)}return console.debug(`Unhandled command ${t}, converting to event.`),this.triggerEvent(t,e)}getComponentByEl(t){return $(t).closest(".component").prop("component")}addBeforeUnloadListener(t){"function"==typeof WeakRef&&this.beforeUnloadListeners.push(new WeakRef(t))}}const M=new R(window.glob.isMainWindow);$(window).on("beforeunload",(()=>{let t=!0;M.beforeUnloadListeners=M.beforeUnloadListeners.filter((t=>!!t.deref()));for(const e of M.beforeUnloadListeners){const n=e.deref();n&&(n.beforeUnloadEvent()||(console.log(`Component ${n.componentId} is not finished saving its state.`),m.default.showMessage("请等待几秒钟以完成保存, 然后可以重试.",1e4),t=!1))}if(!t)return"some string"})),$(window).on("hashchange",(function(){const{notePath:t,ntxId:e,viewScope:n}=b.Z.parseNavigationStateFromUrl(window.location.href);(t||e)&&M.tabManager.switchToNoteContext(e,t,n)}));const Z=M},8866:(t,e,n)=>{"use strict";n.d(e,{Z:()=>i});var o=n(9046);class i{constructor(){this.componentId=`${this.sanitizedClassName}-${o.default.randomString(8)}`,this.children=[],this.initialized=null}get sanitizedClassName(){return this.constructor.name.replace(/[^A-Z0-9]/gi,"_")}setParent(t){return this.parent=t,this}child(...t){for(const e of t)e.setParent(this),this.children.push(e);return this}handleEvent(t,e){try{const n=this.initialized?this.initialized.then((()=>this.callMethod(this[`${t}Event`],e))):this.callMethod(this[`${t}Event`],e),o=this.handleEventInChildren(t,e);return n&&o?Promise.all([n,o]):n||o}catch(e){return console.error(`Handling of event '${t}' failed in ${this.constructor.name} with error ${e.message} ${e.stack}`),null}}triggerEvent(t,e={}){return this.parent.triggerEvent(t,e)}handleEventInChildren(t,e={}){const n=[];for(const o of this.children){const i=o.handleEvent(t,e);i&&n.push(i)}return n.length>0?Promise.all(n):null}triggerCommand(t,e={}){const n=this[`${t}Command`];return n?this.callMethod(n,e):this.parent.triggerCommand(t,e)}callMethod(t,e){if("function"!=typeof t)return;const n=Date.now(),i=t.call(this,e),s=Date.now()-n;return glob.isDev&&s>20&&console.log(`Call to ${t.name} in ${this.componentId} took ${s}ms`),glob.isDev&&i?o.default.timeLimit(i,2e4,`Time limit failed on ${this.constructor.name} with ${t.name}`):i}}},9925:(t,e,n)=>{"use strict";n.d(e,{Z:()=>r});var o=n(4378),i=n(8866),s=n(9046);class a extends i.Z{constructor(){super(),s.default.isElectron()&&(o.Z.initializedPromise.then((()=>{this.setZoomFactor(o.Z.getFloat("zoomFactor"))})),window.addEventListener("wheel",(t=>{t.ctrlKey&&this.setZoomFactorAndSave(this.getCurrentZoom()+.001*t.deltaY)})))}setZoomFactor(t){t=parseFloat(t),s.default.dynamicRequire("electron").webFrame.setZoomFactor(t)}async setZoomFactorAndSave(t){t>=.5&&t<=2?(t=Math.round(10*t)/10,this.setZoomFactor(t),await o.Z.save("zoomFactor",t)):console.log(`Zoom factor ${t} outside of the range, ignored.`)}getCurrentZoom(){return s.default.dynamicRequire("electron").webFrame.getZoomFactor()}zoomOutEvent(){this.setZoomFactorAndSave(this.getCurrentZoom()-.1)}zoomInEvent(){this.setZoomFactorAndSave(this.getCurrentZoom()+.1)}zoomResetEvent(){this.setZoomFactorAndSave(1)}setZoomFactorAndSaveEvent({zoomFactor:t}){this.setZoomFactorAndSave(t)}}const r=new a},9763:(t,e,n)=>{"use strict";n.d(e,{Z:()=>o});const o=class{constructor(t,e){this.froca=t,this.update(e)}update(t){this.attachmentId=t.attachmentId,this.ownerId=t.ownerId,this.role=t.role,this.mime=t.mime,this.title=t.title,this.dateModified=t.dateModified,this.utcDateModified=t.utcDateModified,this.utcDateScheduledForErasureSince=t.utcDateScheduledForErasureSince,this.contentLength=t.contentLength,this.froca.attachments[this.attachmentId]=this}getNote(){return this.froca.notes[this.ownerId]}async getBlob(){return await this.froca.getBlob("attachments",this.attachmentId)}}},9673:(t,e,n)=>{"use strict";n.d(e,{Z:()=>i});var o=n(3847);const i=class{constructor(t,e){this.froca=t,this.update(e)}update(t){this.attributeId=t.attributeId,this.noteId=t.noteId,this.type=t.type,this.name=t.name,this.value=t.value,this.position=t.position,this.isInheritable=!!t.isInheritable}getNote(){return this.froca.notes[this.noteId]}async getTargetNote(){const t=this.targetNoteId;return await this.froca.getNote(t,!0)}get targetNoteId(){if("relation"!==this.type)throw new Error(`Attribute ${this.attributeId} is not a relation`);return this.value}get isAutoLink(){return"relation"===this.type&&["internalLink","imageLink","relationMapLink","includeNoteLink"].includes(this.name)}get toString(){return`FAttribute(attributeId=${this.attributeId}, type=${this.type}, name=${this.name}, value=${this.value})`}isDefinition(){return"label"===this.type&&(this.name.startsWith("label:")||this.name.startsWith("relation:"))}getDefinition(){return o.Z.parse(this.value)}isDefinitionFor(t){return"label"===this.type&&this.name===`${t.type}:${t.name}`}get dto(){const t=Object.assign({},this);return delete t.froca,t}}},8726:(t,e,n)=>{"use strict";n.d(e,{Z:()=>o});const o=class{constructor(t,e){this.froca=t,this.update(e)}update(t){this.branchId=t.branchId,this.noteId=t.noteId,this.parentNoteId=t.parentNoteId,this.notePosition=t.notePosition,this.prefix=t.prefix,this.isExpanded=!!t.isExpanded,this.fromSearchNote=!!t.fromSearchNote}async getNote(){return this.froca.getNote(this.noteId)}getNoteFromCache(){return this.froca.getNoteFromCache(this.noteId)}async getParentNote(){return this.froca.getNote(this.parentNoteId)}isTopLevel(){return"root"===this.parentNoteId}get toString(){return`FBranch(branchId=${this.branchId})`}get pojo(){const t={...this};return delete t.froca,t}}},2021:(t,e,n)=>{"use strict";n.d(e,{Z:()=>u});var o=n(1736),i=n(4585),s=n(4264),a=n(1412),r=n(2040);const d=new Set,l=function(t){if(!t?.trim())return"";const e=t.replace(/[^a-z0-9]/gi,"");if(!e.trim())return"";const n=`color-${e}`;return d.has(n)||($("head").append(`<style>.${n}, span.fancytree-active.${n} { color: ${t} !important; }</style>`),d.add(n)),n},c="label",h="relation",p={file:"bx bx-file",image:"bx bx-image",code:"bx bx-code",render:"bx bx-extension",search:"bx bx-file-find",relationMap:"bx bx-map-alt",book:"bx bx-book",noteMap:"bx bx-map-alt",mermaid:"bx bx-selection",canvas:"bx bx-pen",webView:"bx bx-globe-alt",launcher:"bx bx-link",doc:"bx bxs-file-doc",contentWidget:"bx bxs-widget"},u=class{constructor(t,e){this.froca=t,this.attributes=[],this.targetRelations=[],this.parents=[],this.children=[],this.parentToBranch={},this.childToBranch={},this.attachments=null,this.update(e)}update(t){this.noteId=t.noteId,this.title=t.title,this.isProtected=!!t.isProtected,this.type=t.type,this.mime=t.mime,this.blobId=t.blobId}addParent(t,e,n=!0){"none"!==t&&(this.parents.includes(t)||this.parents.push(t),this.parentToBranch[t]=e,n&&this.sortParents())}addChild(t,e,n=!0){t in this.childToBranch||this.children.push(t),this.childToBranch[t]=e,n&&this.sortChildren()}sortChildren(){const t={};for(const e of Object.values(this.childToBranch))t[e]=this.froca.getBranch(e).notePosition;this.children.sort(((e,n)=>t[this.childToBranch[e]]-t[this.childToBranch[n]]))}isJson(){return"application/json"===this.mime}async getContent(){const t=await this.getBlob();return t?.content}async getJsonContent(){const t=await this.getContent();try{return JSON.parse(t)}catch(t){return console.log(`Cannot parse content of note '${this.noteId}': `,t.message),null}}getParentBranchIds(){return Object.values(this.parentToBranch)}getBranchIds(){return this.getParentBranchIds()}getParentBranches(){const t=Object.values(this.parentToBranch);return this.froca.getBranches(t)}getBranches(){return this.getParentBranches()}hasChildren(){return this.children.length>0}getChildBranches(){const t=this.children.map((t=>this.childToBranch[t]));return this.froca.getBranches(t)}getParentNoteIds(){return this.parents}getParentNotes(){return this.froca.getNotesFromCache(this.parents)}sortParents(){this.parents.sort(((t,e)=>{const n=this.parentToBranch[t];if(n&&n.startsWith("virt-"))return 1;const o=this.froca.getNoteFromCache(t);return o.isArchived||o.isHiddenCompletely()?1:t<e?-1:1}))}get isArchived(){return this.hasAttribute("label","archived")}getChildNoteIds(){return this.children}async getChildNotes(){return await this.froca.getNotes(this.children)}async getAttachments(){return this.attachments||(this.attachments=await this.froca.getAttachmentsForNote(this.noteId)),this.attachments}async getAttachmentsByRole(t){return(await this.getAttachments()).filter((e=>e.role===t))}async getAttachmentById(t){return(await this.getAttachments()).find((e=>e.attachmentId===t))}isEligibleForConversionToAttachment(){if("image"!==this.type||!this.isContentAvailable()||this.hasChildren()||1!==this.getParentBranches().length)return!1;const t=this.getTargetRelations().filter((t=>"imageLink"===t.name));if(t.length>1)return!1;const e=this.getParentNotes()[0],n=t[0]?.getNote();return!(n&&n!==e||"text"!==e.type||!e.isContentAvailable())}getOwnedAttributes(t,e){const n=this.attributes.map((t=>this.froca.attributes[t])).filter(Boolean);return this.__filterAttrs(n,t,e)}getAttributes(t,e){return this.__filterAttrs(this.__getCachedAttributes([]),t,e)}__getCachedAttributes(t){if(t.includes(this.noteId))return[];if(!(this.noteId in i.Z.attributes)){const e=[...t,this.noteId],n=[this.getOwnedAttributes()];if("root"!==this.noteId&&"_hidden"!==this.noteId)for(const t of this.getParentNotes())"search"!==t.type&&n.push(t.__getInheritableAttributes(e));for(const t of n.flat().filter((t=>"relation"===t.type&&["template","inherit"].includes(t.name)))){const o=this.froca.notes[t.value];o&&o.noteId!==this.noteId&&n.push(o.__getCachedAttributes(e).filter((t=>!("label"===t.type&&("template"===t.name||"workspacetemplate"===t.name)))))}i.Z.attributes[this.noteId]=[];const o=new Set;for(const t of n.flat())o.has(t.attributeId)||(o.add(t.attributeId),i.Z.attributes[this.noteId].push(t))}return i.Z.attributes[this.noteId]}isRoot(){return"root"===this.noteId}getAllNotePaths(){if("root"===this.noteId)return[["root"]];const t=this.getParentNotes().filter((t=>"search"!==t.type)),e=1===t.length?t[0].getAllNotePaths():t.flatMap((t=>t.getAllNotePaths()));for(const t of e)t.push(this.noteId);return e}getSortedNotePathRecords(t="root"){const e="root"===t,n=this.getAllNotePaths().map((n=>({notePath:n,isInHoistedSubTree:e||n.includes(t),isArchived:n.some((t=>a.default.notes[t].isArchived)),isSearch:n.find((t=>"search"===a.default.notes[t].type)),isHidden:n.includes("_hidden")})));return n.sort(((t,e)=>t.isInHoistedSubTree!==e.isInHoistedSubTree?t.isInHoistedSubTree?-1:1:t.isArchived!==e.isArchived?t.isArchived?1:-1:t.isHidden!==e.isHidden?t.isHidden?1:-1:t.isSearch!==e.isSearch?t.isSearch?1:-1:t.notePath.length-e.notePath.length)),n}getBestNotePath(t="root"){return this.getSortedNotePathRecords(t)[0]?.notePath}getBestNotePathString(t="root"){const e=this.getBestNotePath(t);return e?.join("/")}isHiddenCompletely(){if("_hidden"===this.noteId)return!0;if("root"===this.noteId)return!1;for(const t of this.getParentNotes()){if("root"===t.noteId)return!1;if("_hidden"!==t.noteId&&"search"!==t.type&&!t.isHiddenCompletely())return!1}return!0}__filterAttrs(t,e,n){return this.__validateTypeName(e,n),e||n?e&&n?t.filter((t=>t.name===n&&t.type===e)):e?t.filter((t=>t.type===e)):n?t.filter((t=>t.name===n)):void 0:t}__getInheritableAttributes(t){return this.__getCachedAttributes(t).filter((t=>t.isInheritable))}__validateTypeName(t,e){if(t&&"label"!==t&&"relation"!==t)throw new Error(`Unrecognized attribute type '${t}'. Only 'label' and 'relation' are possible values.`);if(e){const t=e.charAt(0);if("#"===t||"~"===t)throw new Error("Detect '#' or '~' in the attribute's name. In the API, attribute names should be set without these characters.")}}getOwnedLabels(t){return this.getOwnedAttributes(c,t)}getLabels(t){return this.getAttributes(c,t)}getIcon(){const t=this.getLabels("iconClass"),e=this.getWorkspaceIconClass();return t.length>0?t[0].value:e||("root"===this.noteId?"bx bx-chevrons-right":"_share"===this.noteId?"bx bx-share-alt":"text"===this.type?this.isFolder()?"bx bx-folder":"bx bx-note":"code"===this.type&&this.mime.startsWith("text/x-sql")?"bx bx-data":p[this.type])}getColorClass(){const t=this.getLabelValue("color");return l(t)}isFolder(){return"search"===this.type||this.getFilteredChildBranches().length>0}getFilteredChildBranches(){let t=this.getChildBranches();if(t)return t;s.Z.logError(`No children for '${this.noteId}'. This shouldn't happen.`)}getOwnedRelations(t){return this.getOwnedAttributes(h,t)}getRelations(t){return this.getAttributes(h,t)}hasAttribute(t,e){return this.getAttributes().some((n=>n.name===e&&n.type===t))}hasOwnedAttribute(t,e){return!!this.getOwnedAttribute(t,e)}getOwnedAttribute(t,e){return this.getOwnedAttributes().find((n=>n.name===e&&n.type===t))}getAttribute(t,e){return this.getAttributes().find((n=>n.name===e&&n.type===t))}getOwnedAttributeValue(t,e){const n=this.getOwnedAttribute(t,e);return n?n.value:null}getAttributeValue(t,e){const n=this.getAttribute(t,e);return n?n.value:null}hasOwnedLabel(t){return this.hasOwnedAttribute(c,t)}hasLabel(t){return this.hasAttribute(c,t)}isLabelTruthy(t){const e=this.getLabel(t);return!!e&&e&&"false"!==e.value}hasOwnedRelation(t){return this.hasOwnedAttribute(h,t)}hasRelation(t){return this.hasAttribute(h,t)}getOwnedLabel(t){return this.getOwnedAttribute(c,t)}getLabel(t){return this.getAttribute(c,t)}getOwnedRelation(t){return this.getOwnedAttribute(h,t)}getRelation(t){return this.getAttribute(h,t)}getOwnedLabelValue(t){return this.getOwnedAttributeValue(c,t)}getLabelValue(t){return this.getAttributeValue(c,t)}getOwnedRelationValue(t){return this.getOwnedAttributeValue(h,t)}getRelationValue(t){return this.getAttributeValue(h,t)}async getRelationTarget(t){const e=await this.getRelationTargets(t);return e.length>0?e[0]:null}async getRelationTargets(t){const e=this.getRelations(t),n=[];for(const t of e)n.push(await this.froca.getNote(t.value));return n}getNotesToInheritAttributesFrom(){return[...this.getRelations("template"),...this.getRelations("inherit")].map((t=>this.froca.notes[t.value]))}getPromotedDefinitionAttributes(){if(this.isLabelTruthy("hidePromotedAttributes"))return[];const t=this.getAttributes().filter((t=>t.isDefinition())).filter((t=>{const e=t.getDefinition();return e&&e.isPromoted}));return t.sort(((t,e)=>t.noteId===e.noteId?t.position<e.position?-1:1:t.noteId<e.noteId?-1:1)),t}hasAncestor(t,e=!1,n=null){if(this.noteId===t)return!0;if(n){if(n.has(this.noteId))return!1}else n=new Set;if(n.add(this.noteId),e)for(const o of this.getNotesToInheritAttributesFrom())if(o.hasAncestor(t,e,n))return!0;for(const o of this.getParentNotes())if(o.hasAncestor(t,e,n))return!0;return!1}isInHiddenSubtree(){return"_hidden"===this.noteId||this.hasAncestor("_hidden")}invalidateAttributeCache(){}getTargetRelations(){return this.targetRelations.map((t=>this.froca.attributes[t]))}async getTargetRelationSourceNotes(){const t=this.getTargetRelations();return await this.froca.getNotes(t.map((t=>t.noteId)))}async getNoteComplement(){return this.getBlob()}async getBlob(){return await this.froca.getBlob("notes",this.noteId)}toString(){return`Note(noteId=${this.noteId}, title=${this.title})`}get dto(){const t=Object.assign({},this);return delete t.froca,t}getCssClass(){return this.getLabels("cssClass").map((t=>t.value)).join(" ")}getWorkspaceIconClass(){const t=this.getLabels("workspaceIconClass");return t.length>0?t[0].value:""}getWorkspaceTabBackgroundColor(){const t=this.getLabels("workspaceTabBackgroundColor");return t.length>0?t[0].value:""}isJavaScript(){return("code"===this.type||"file"===this.type||"launcher"===this.type)&&(this.mime.startsWith("application/javascript")||"application/x-javascript"===this.mime||"text/javascript"===this.mime)}isHtml(){return("code"===this.type||"file"===this.type||"render"===this.type)&&"text/html"===this.mime}getScriptEnv(){return this.isHtml()||this.isJavaScript()&&this.mime.endsWith("env=frontend")||"render"===this.type?"frontend":this.isJavaScript()&&this.mime.endsWith("env=backend")?"backend":null}async executeScript(){if(!this.isJavaScript())throw new Error(`Note ${this.noteId} is of type ${this.type} and mime ${this.mime} and thus cannot be executed`);const t=this.getScriptEnv();if("frontend"===t){const t=(await Promise.resolve().then(n.bind(n,394))).default;return await t.getAndExecuteBundle(this.noteId)}if("backend"!==t)throw new Error(`Unrecognized env type ${t} for note ${this.noteId}`);await o.Z.post(`script/run/${this.noteId}`)}isShared(){for(const t of this.parents){if("root"===t||"none"===t)continue;const e=a.default.notes[t];if(e&&"search"!==e.type&&("_share"===e.noteId||e.isShared()))return!0}return!1}isContentAvailable(){return!this.isProtected||r.Z.isProtectedSessionAvailable()}isLaunchBarConfig(){return"launcher"===this.type||["_lbRoot","_lbAvailableLaunchers","_lbVisibleLaunchers"].includes(this.noteId)}isOptions(){return this.noteId.startsWith("_options")}async getMetadata(){return await o.Z.get(`notes/${this.noteId}/metadata`)}}},1801:(t,e,n)=>{"use strict";n.d(e,{Z:()=>i});var o=n(6604);const i=new class{constructor(){this.$widget=$("#context-menu-container"),this.dateContextMenuOpenedMs=0,$(document).on("click",(()=>this.hide()))}async show(t){this.options=t,this.$widget.empty(),this.addItems(this.$widget,t.items),o.default.updateDisplayedShortcuts(this.$widget),this.positionMenu(),this.dateContextMenuOpenedMs=Date.now()}positionMenu(){const t=document.documentElement.clientHeight,e=document.documentElement.clientWidth,n=this.$widget.outerHeight(),o=this.$widget.outerWidth();let i,s;i=this.options.y+n-0>t-5?t-n-5:this.options.y-0<5?5:this.options.y-0,s="left"===this.options.orientation?this.options.x+0>e-5?e-o-0:this.options.x-o+0<5?5:this.options.x-o+0:this.options.x+o-0>e-5?e-o-5:this.options.x-0<5?5:this.options.x-0,this.$widget.css({display:"block",top:i,left:s}).addClass("show")}addItems(t,e){for(const n of e)if(n)if("----"===n.title)t.append($("<div>").addClass("dropdown-divider"));else{const e=$("<span>");n.uiIcon?e.addClass(n.uiIcon):e.append("&nbsp;");const o=$("<span>").append(e).append(" &nbsp; ").append(n.title),i=$("<li>").addClass("dropdown-item").append(o).on("contextmenu",(t=>!1)).on("mousedown",(t=>(t.stopPropagation(),1!==t.which||(this.hide(),n.handler&&n.handler(n,t),this.options.selectMenuItemHandler(n,t)),!1)));if(void 0===n.enabled||n.enabled||i.addClass("disabled"),n.items){i.addClass("dropdown-submenu"),o.addClass("dropdown-toggle");const t=$("<ul>").addClass("dropdown-menu");this.addItems(t,n.items),i.append(t)}t.append(i)}}hide(){Date.now()-this.dateContextMenuOpenedMs>300&&setTimeout((()=>this.$widget.hide()),100)}}},592:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var o=n(1801),i=n(2817);const s={openContextMenu:function(t,e,n={},s=null){o.Z.show({x:e.pageX,y:e.pageY,items:[{title:"在新标签页中打开笔记",command:"openNoteInNewTab",uiIcon:"bx bx-empty"},{title:"在新的拆分中打开笔记",command:"openNoteInNewSplit",uiIcon:"bx bx-dock-right"},{title:"在新窗口中打开笔记",command:"openNoteInNewWindow",uiIcon:"bx bx-window-open"}],selectMenuItemHandler:({command:e})=>{if(s||(s=i.default.tabManager.getActiveContext().hoistedNoteId),"openNoteInNewTab"===e)i.default.tabManager.openContextWithNote(t,{hoistedNoteId:s,viewScope:n});else if("openNoteInNewSplit"===e){const e=i.default.tabManager.getActiveContext().getSubContexts(),{ntxId:o}=e[e.length-1];i.default.triggerCommand("openNewNoteSplit",{ntxId:o,notePath:t,hoistedNoteId:s,viewScope:n})}else"openNoteInNewWindow"===e&&i.default.triggerCommand("openInWindow",{notePath:t,hoistedNoteId:s,viewScope:n})}})}}},1375:(t,e,n)=>{"use strict";n.d(e,{Z:()=>d});var o=n(4264),i=n(1412);async function s(t,e){const n=e&&t.isInheritable?"(可继承的)":"",s=$("<span>");if("label"===t.type)s.append(document.createTextNode(`#${t.name}${n}`)),t.value&&(s.append("="),s.append(document.createTextNode((a=t.value,/^[\p{L}\p{N}\-_,.]+$/u.test(a)?a:a.includes('"')?a.includes("'")?a.includes("`")?`"${a.replace(/"/g,'\\"')}"`:`\`${a}\``:`'${a}'`:`"${a}"`))));else if("relation"===t.type){if(t.isAutoLink)return s;t.value&&(s.append(document.createTextNode(`~${t.name}${n}=`)),s.append(await async function(t){const e=await i.default.getNote(t);if(e)return $("<a>",{href:`#root/${t}`,class:"reference-link"}).text(e.title)}(t.value)))}else o.Z.logError(`Unknown attr type: ${t.type}`);var a;return s}async function a(t,e){const n=$('<span class="rendered-note-attributes">');for(let o=0;o<t.length;o++){const i=t[o],a=await s(i,e);n.append(a.html()),o<t.length-1&&n.append(" ")}return n}const r=["originalFileName","fileSize","template","inherit","cssClass","iconClass","pageSize","viewType"],d={renderAttribute:s,renderAttributes:a,renderNormalAttributes:async function(t){const e=t.getPromotedDefinitionAttributes();let n=t.getAttributes();n=e.length>0?n.filter((t=>!!e.find((e=>e.isDefinitionFor(t))))):n.filter((e=>!e.isDefinition()&&!e.isAutoLink&&!r.includes(e.name)&&e.noteId===t.noteId));const o=await a(n,!1);return{count:n.length,$renderedAttributes:o}}}},8159:(t,e,n)=>{"use strict";n.d(e,{Z:()=>u});var o=n(9046),i=n(1736),s=n(6885),a=n(1412),r=n(3968),d=n(4264),l=n(2817);function c(t){return t.filter((t=>!t.startsWith("virt-")))}function h(t){const e=r.Z.getHoistedNoteId();return t.filter((t=>{const n=a.default.getBranch(t);return"root"!==n.noteId&&n.noteId!==e}))}function p(t,e){return{id:t,title:"删除状态",message:e,icon:"trash"}}d.Z.subscribeToMessages((async t=>{if("deleteNotes"===t.taskType)if("taskError"===t.type)s.default.closePersistent(t.taskId),s.default.showError(t.message);else if("taskProgressCount"===t.type)s.default.showPersistent(p(t.taskId,`Delete notes in progress: ${t.progressCount}`));else if("taskSucceeded"===t.type){const e=p(t.taskId,"删除成功.");e.closeAfter=5e3,s.default.showPersistent(e)}})),d.Z.subscribeToMessages((async t=>{if("undeleteNotes"===t.taskType)if("taskError"===t.type)s.default.closePersistent(t.taskId),s.default.showError(t.message);else if("taskProgressCount"===t.type)s.default.showPersistent(p(t.taskId,`Undeleting notes in progress: ${t.progressCount}`));else if("taskSucceeded"===t.type){const e=p(t.taskId,"撤销删除成功");e.closeAfter=5e3,s.default.showPersistent(e)}}));const u={moveBeforeBranch:async function(t,e){t=c(t=h(t));const n=a.default.getBranch(e);if(["root","_lbRoot","_lbAvailableLaunchers","_lbVisibleLaunchers"].includes(n.noteId))s.default.showError("无法在此移动笔记。");else for(const n of t){const t=await i.Z.put(`branches/${n}/move-before/${e}`);if(!t.success)return void s.default.showError(t.message)}},moveAfterBranch:async function(t,e){t=c(t=h(t));const n=a.default.getBranch(e).getNote();if(["root",r.Z.getHoistedNoteId(),"_lbRoot","_lbAvailableLaunchers","_lbVisibleLaunchers"].includes(n.noteId))s.default.showError("无法在此移动笔记。");else{t.reverse();for(const n of t){const t=await i.Z.put(`branches/${n}/move-after/${e}`);if(!t.success)return void s.default.showError(t.message)}}},moveToParentNote:async function(t,e){if("_lbRoot"!==a.default.getBranch(e).noteId){t=h(t);for(const n of t){const t=a.default.getBranch(n);if(t.noteId===r.Z.getHoistedNoteId()||"search"===(await t.getParentNote()).type)continue;const o=await i.Z.put(`branches/${n}/move-to/${e}`);if(!o.success)return void s.default.showError(o.message)}}else s.default.showError("无法在此移动笔记。")},deleteNotes:async function(t,e=!1){if(0===(t=h(t)).length)return!1;let n,s,r;if(o.default.isMobile()?(n=!0,s=!1):({proceed:n,deleteAllClones:s,eraseNotes:r}=await new Promise((n=>l.default.triggerCommand("showDeleteNotesDialog",{branchIdsToDelete:t,callback:n,forceDeleteAllClones:e})))),!n)return!1;const d=o.default.randomString(10);let c=0;for(const e of t){c++;const n=`?taskId=${d}&eraseNotes=${r?"true":"false"}&last=${c===t.length?"true":"false"}`,o=a.default.getBranch(e);s?await i.Z.remove(`notes/${o.noteId}${n}`):await i.Z.remove(`branches/${e}${n}`)}return r&&o.default.reloadFrontendApp("erasing notes requires reload"),!0},moveNodeUpInHierarchy:async function(t){if(r.Z.isHoistedNode(t)||r.Z.isTopLevelNode(t)||"search"===t.getParent().data.noteType)return;const e=t.getParent().data.branchId,n=t.data.branchId,o=await i.Z.put(`branches/${n}/move-after/${e}`);o.success?!r.Z.isTopLevelNode(t)&&t.getParent().getChildren().length<=1&&(t.getParent().folder=!1,t.getParent().renderTitle()):s.default.showError(o.message)},cloneNoteAfter:async function(t,e){const n=await i.Z.put(`notes/${t}/clone-after/${e}`);n.success||s.default.showError(n.message)},cloneNoteToBranch:async function(t,e,n){const o=await i.Z.put(`notes/${t}/clone-to-branch/${e}`,{prefix:n});o.success||s.default.showError(o.message)},cloneNoteToParentNote:async function(t,e,n){const o=await i.Z.put(`notes/${t}/clone-to-note/${e}`,{prefix:n});o.success||s.default.showError(o.message)}}},394:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>__WEBPACK_DEFAULT_EXPORT__});var _script_context_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(5574),_server_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1736),_toast_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(6885),_froca_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(1412),_utils_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(9046);async function getAndExecuteBundle(t,e=null,n=null,o=null){const i=await _server_js__WEBPACK_IMPORTED_MODULE_1__.Z.post(`script/bundle/${t}`,{script:n,params:o});return await executeBundle(i,e)}async function executeBundle(bundle,originEntity,$container){const apiContext=await(0,_script_context_js__WEBPACK_IMPORTED_MODULE_0__.Z)(bundle.noteId,bundle.allNoteIds,originEntity,$container);try{return await function(){return eval(`const apiContext = this; (async function() { ${bundle.script}\r\n})()`)}.call(apiContext)}catch(t){const e=await _froca_js__WEBPACK_IMPORTED_MODULE_3__.default.getNote(bundle.noteId);_toast_js__WEBPACK_IMPORTED_MODULE_2__.default.showAndLogError(`执行 ID 为 ${bundle.noteId} 的JS笔记"${e.title}"失败, 错误: ${t.message}`)}}async function executeStartupBundles(){const t=_utils_js__WEBPACK_IMPORTED_MODULE_4__.default.isMobile(),e=await _server_js__WEBPACK_IMPORTED_MODULE_1__.Z.get("script/startup"+(t?"?mobile=true":""));for(const t of e)await executeBundle(t)}class WidgetsByParent{constructor(){this.byParent={}}add(t){t.parentWidget?(this.byParent[t.parentWidget]=this.byParent[t.parentWidget]||[],this.byParent[t.parentWidget].push(t)):console.log("Custom widget does not have mandatory 'parentWidget' property defined")}get(t){return this.byParent[t]?this.byParent[t].map((t=>t.prototype?new t:t)):[]}}async function getWidgetBundlesByParent(){const t=await _server_js__WEBPACK_IMPORTED_MODULE_1__.Z.get("script/widgets"),e=new WidgetsByParent;for(const n of t){let t;try{t=await executeBundle(n),e.add(t)}catch(t){logError("小部件初始化失败: ",t);continue}}return e}const __WEBPACK_DEFAULT_EXPORT__={executeBundle,getAndExecuteBundle,executeStartupBundles,getWidgetBundlesByParent}},1035:(t,e,n)=>{"use strict";n.d(e,{Z:()=>h});var o=n(8159),i=n(6885),s=n(1412),a=n(7844),r=n(9046);let d=[],l=null;function c(){return d=d.filter((t=>!!s.default.getBranch(t))),0===d.length}const h={pasteAfter:async function(t){if(!c())if("cut"===l)await o.Z.moveAfterBranch(d,t),d=[],l=null;else if("copy"===l){const e=d.map((t=>s.default.getBranch(t)));for(const n of e){const e=await n.getNote();await o.Z.cloneNoteAfter(e.noteId,t)}}else i.default.throwError(`Unrecognized clipboard mode=${l}`)},pasteInto:async function(t){if(!c())if("cut"===l)await o.Z.moveToParentNote(d,t),d=[],l=null;else if("copy"===l){const e=d.map((t=>s.default.getBranch(t)));for(const n of e){const e=await n.getNote();await o.Z.cloneNoteToBranch(e.noteId,t)}}else i.default.throwError(`Unrecognized clipboard mode=${l}`)},cut:function(t){d=t,d.length>0&&(l="cut",i.default.showMessage("笔记已被剪切到剪贴板."))},copy:async function(t){if(d=t,l="copy",r.default.isElectron()){const{clipboard:t}=n(2298),e=[];for(const t of s.default.getBranches(d)){const n=await a.Z.createLink(`${t.parentNoteId}/${t.noteId}`,{referenceLink:!0});e.push(n[0].outerHTML)}t.writeHTML(e.join(", "))}i.default.showMessage("笔记已复制到剪贴板.")},isClipboardEmpty:c}},5913:(t,e,n)=>{"use strict";n.d(e,{Z:()=>m});var o=n(5437),i=n(7336),s=n(2040),a=n(6707),r=n(5489),d=n(1412),l=n(9046),c=n(7844),h=n(8481),p=n(2021),u=n(9763);let g=1;const m={getRenderedContent:async function(t,e={}){e=Object.assign({tooltip:!1},e);const n=function(t){let e=t.type||t.role;const n=t.mime;return"file"===e&&"application/pdf"===n?e="pdf":"file"===e&&n.startsWith("audio/")?e="audio":"file"===e&&n.startsWith("video/")&&(e="video"),t.isProtected&&(s.Z.isProtectedSessionAvailable()?s.Z.touchProtectedSession():e="protectedSession"),e}(t),m=$('<div class="rendered-content">');if("text"===n)await async function(t,e){const n=await t.getBlob();if(l.default.isHtmlEmpty(n.content))await async function(t,e){t.css("padding","10px"),t.addClass("text-with-ellipsis");let n=e.getChildNoteIds();n.length>10&&(n=n.slice(0,10));const o=await d.default.getNotes(n);for(const n of o)t.append(await c.Z.createLink(`${e.noteId}/${n.noteId}`,{showTooltip:!1,showNoteIcon:!0})),t.append("<br>")}(e,t);else{e.append($('<div class="ck-content">').html(n.content)),e.find("span.math-tex").length>0&&(await a.Z.requireLibrary(a.Z.KATEX),renderMathInElement(e[0],{trust:!0}));const t=t=>h.Z.getNoteIdFromUrl($(t).attr("href")),o=e.find("a.reference-link"),i=o.map((e=>t(e)));await d.default.getNotes(i);for(const t of o)await c.Z.loadReferenceLinkTitle($(t))}}(t,m);else if("code"===n)await async function(t,e){const n=await t.getBlob();e.append($("<pre>").text(n.content))}(t,m);else if("image"===n||"canvas"===n)!function(t,e,n={}){const o=encodeURIComponent(t.title);let i;t instanceof p.Z?i=`api/images/${t.noteId}/${o}?${Math.random()}`:t instanceof u.Z&&(i=`api/attachments/${t.attachmentId}/image/${o}?${t.utcDateModified}">`),e.css("display","flex").css("align-items","center").css("justify-content","center");const s=$("<img>").attr("src",i).attr("id","attachment-image-"+g++).css("max-width","100%");e.append(s),n.imageHasZoom&&a.Z.requireLibrary(a.Z.WHEEL_ZOOM).then((()=>{WZoom.create(`#${s.attr("id")}`,{maxScale:50,speed:1.3,zoomOnClick:!1})}))}(t,m,e);else if(!e.tooltip&&["file","pdf","audio","video"].includes(n))!function(t,e,n){let o,i;if(t instanceof p.Z)o="notes",i=t.noteId;else{if(!(t instanceof u.Z))throw new Error(`Can't recognize entity type of '${t}'`);o="attachments",i=t.attachmentId}const s=$('<div style="display: flex; flex-direction: column; height: 100%;">');if("pdf"===e){const t=$('<iframe class="pdf-preview" style="width: 100%; flex-grow: 100;"></iframe>');t.attr("src",r.Z.getUrlForDownload(`api/${o}/${i}/open`)),s.append(t)}else if("audio"===e){const e=$("<audio controls></audio>").attr("src",r.Z.getUrlForDownload(`api/${o}/${i}/open-partial`)).attr("type",t.mime).css("width","100%");s.append(e)}else if("video"===e){const e=$("<video controls></video>").attr("src",r.Z.getUrlForDownload(`api/${o}/${i}/open-partial`)).attr("type",t.mime).css("width","100%");s.append(e)}if("notes"===o){const e=$('<button class="file-download btn btn-primary" type="button">下载</button>'),n=$('<button class="file-open btn btn-primary" type="button">打开</button>');e.on("click",(()=>r.Z.downloadFileNote(t.noteId))),n.on("click",(()=>r.Z.openNoteExternally(t.noteId,t.mime))),n.toggle(!t.isProtected),s.append($('<div style="display: flex; justify-content: space-evenly; margin-top: 5px;">').append(e).append(n))}n.append(s)}(t,n,m);else if("mermaid"===n)await async function(t,e){await a.Z.requireLibrary(a.Z.MERMAID);const n=(await t.getBlob()).content||"";e.css("display","flex").css("justify-content","space-around");const o=window.getComputedStyle(document.documentElement).getPropertyValue("--mermaid-theme");mermaid.mermaidAPI.initialize({startOnLoad:!1,theme:o.trim(),securityLevel:"antiscript"});try{const{svg:t}=await mermaid.mermaidAPI.render("in-mermaid-graph-"+g++,n);e.append($(t))}catch(t){const n=$("<p>图表无法显示.</p>");e.append(n)}}(t,m);else if("render"===n){const e=$("<div>");await o.Z.render(t,e,this.ctx),m.append(e)}else if(e.tooltip||"protectedSession"!==n)t instanceof p.Z&&m.append($("<div>").css("display","flex").css("justify-content","space-around").css("align-items","center").css("height","100%").css("font-size","500%").append($("<span>").addClass(t.getIcon())));else{const t=$('<button class="btn btn-sm"><span class="bx bx-log-in"></span>进入受保护的会话</button>').on("click",i.Z.enterProtectedSession);m.append($("<div>").append("<div>此笔记受保护, 您需要输入密码来访问它.</div>").append("<br/>").append(t))}return t instanceof p.Z&&m.addClass(t.getCssClass()),{$renderedContent:m,type:n}}}},383:(t,e,n)=>{"use strict";n.d(e,{Z:()=>r});var o=n(1412),i=n(1736),s=n(4264);async function a(t){const e=await i.Z.get(`special-notes/days/${t}`,"date-note");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)}const r={getInboxNote:async function(){const t=await i.Z.get(`special-notes/inbox/${dayjs().format("YYYY-MM-DD")}`,"date-note");return await o.default.getNote(t.noteId)},getTodayNote:async function(){return await a(dayjs().format("YYYY-MM-DD"))},getDayNote:a,getWeekNote:async function(t){const e=await i.Z.get(`special-notes/weeks/${t}`,"date-note");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)},getMonthNote:async function(t){const e=await i.Z.get(`special-notes/months/${t}`,"date-note");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)},getYearNote:async function(t){const e=await i.Z.get(`special-notes/years/${t}`,"date-note");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)},createSqlConsole:async function(){const t=await i.Z.post("special-notes/sql-console");return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(t.noteId)},createSearchNote:async function(t={}){const e=await i.Z.post("special-notes/search-note",t);return await s.Z.waitForMaxKnownEntityChangeId(),await o.default.getNote(e.noteId)}}},3152:(t,e,n)=>{"use strict";n.d(e,{Z:()=>i});var o=n(2817);const i={info:async function(t){return new Promise((e=>o.default.triggerCommand("showInfoDialog",{message:t,callback:e})))},confirm:async function(t){return new Promise((e=>o.default.triggerCommand("showConfirmDialog",{message:t,callback:t=>e(t.confirmed)})))},confirmDeleteNoteBoxWithNote:async function(t){return new Promise((e=>o.default.triggerCommand("showConfirmDeleteNoteBoxWithNoteDialog",{title:t,callback:e})))},prompt:async function(t){return new Promise((e=>o.default.triggerCommand("showPromptDialog",{...t,callback:e})))}}},1412:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>h});var o=n(8726),i=n(2021),s=n(9673),a=n(1736),r=n(2817);class d{constructor(t){this.blobId=t.blobId,this.content=t.content,this.contentLength=t.contentLength,this.dateModified=t.dateModified,this.utcDateModified=t.utcDateModified}getJsonContent(){return this.content&&this.content.trim()?JSON.parse(this.content):null}getJsonContentSafely(){try{return this.getJsonContent()}catch(t){return null}}}var l=n(9763);const c=new class{constructor(){this.initializedPromise=this.loadInitialTree()}async loadInitialTree(){const t=await a.Z.get("tree");this.notes={},this.branches={},this.attributes={},this.attachments={},this.blobPromises={},this.addResp(t)}async loadSubTree(t){const e=await a.Z.get(`tree?subTreeNoteId=${t}`);return this.addResp(e),this.notes[t]}addResp(t){const e=t.notes,n=t.branches,a=t.attributes,r=new Set;for(const t of e){const{noteId:e}=t;let n=this.notes[e];if(n){if(n.update(t),"search"!==n.type){for(const t of n.children){const n=this.notes[t];n&&(n.parents=n.parents.filter((t=>t!==e)),delete this.branches[n.parentToBranch[e]],delete n.parentToBranch[e])}n.children=[],n.childToBranch={}}n.parents=n.parents.filter((t=>{const n=this.notes[t],o=this.branches[n.childToBranch[e]];return!(!n||!o||!o.fromSearchNote&&(n.children=n.children.filter((t=>t!==e)),delete this.branches[n.childToBranch[e]],delete n.childToBranch[e],1))}))}else this.notes[e]=new i.Z(this,t)}for(const t of n){const e=new o.Z(this,t);this.branches[e.branchId]=e;const n=this.notes[e.noteId];n&&n.addParent(e.parentNoteId,e.branchId,!1);const i=this.notes[e.parentNoteId];i&&(i.addChild(e.noteId,e.branchId,!1),r.add(i.noteId))}for(const t of a){const{attributeId:e}=t;this.attributes[e]=new s.Z(this,t);const n=this.notes[t.noteId];if(n&&!n.attributes.includes(e)&&n.attributes.push(e),"relation"===t.type){const n=this.notes[t.value];n&&(n.targetRelations.includes(e)||n.targetRelations.push(e))}}for(const t of r)this.notes[t].sortChildren(),this.notes[t].sortParents()}async reloadNotes(t){if(0===t.length)return;t=Array.from(new Set(t));const e=await a.Z.post("tree/load",{noteIds:t});this.addResp(e),r.default.triggerEvent("notesReloaded",{noteIds:t})}async loadSearchNote(t){const e=await this.getNote(t);if(!e||"search"!==e.type)return;const{searchResultNoteIds:n,highlightedTokens:o,error:i}=await a.Z.get(`search-note/${e.noteId}`);if(!Array.isArray(n))throw new Error(`Search note '${e.noteId}' failed: ${n}`);e.noteId in c.notes&&(c.notes[e.noteId].children=[],c.notes[e.noteId].childToBranch={});const s=[...e.getParentBranches(),...e.getChildBranches()];return n.forEach(((t,n)=>s.push({branchId:`virt-${e.noteId}-${t}`,noteId:t,parentNoteId:e.noteId,notePosition:10*(n+1),fromSearchNote:!0}))),this.addResp({notes:[e],branches:s,attributes:[]}),c.notes[e.noteId].searchResultsLoaded=!0,c.notes[e.noteId].highlightedTokens=o,{error:i}}getNotesFromCache(t,e=!1){return t.map((t=>this.notes[t]||e?this.notes[t]:(console.trace(`Can't find note '${t}'`),null))).filter((t=>!!t))}async getNotes(t,e=!1){const n=(t=Array.from(new Set(t))).filter((t=>!this.notes[t]));return await this.reloadNotes(n),t.map((t=>this.notes[t]||e?this.notes[t]:(console.trace(`Can't find note '${t}'`),null))).filter((t=>!!t))}async noteExists(t){return 1===(await this.getNotes([t],!0)).length}async getNote(t,e=!1){return"none"===t?(console.trace("No 'none' note."),null):t?(await this.getNotes([t],e))[0]:(console.trace(`Falsy noteId '${t}', returning null.`),null)}getNoteFromCache(t){if(!t)throw new Error("空 noteId");return this.notes[t]}getBranches(t,e=!1){return t.map((t=>this.getBranch(t,e))).filter((t=>!!t))}getBranch(t,e=!1){if(t in this.branches)return this.branches[t];e||logError(`Not existing branch '${t}'`)}async getBranchId(t,e){if("root"===e)return"none_root";const n=await this.getNote(e);return n?n.parentToBranch[t]:(logError(`Could not find branchId for parent '${t}', child '${e}' since child does not exist`),null)}async getAttachment(t,e=!1){const n=this.attachments[t];if(n)return n;let o;try{o=await a.Z.getWithSilentNotFound(`attachments/${t}/all`)}catch(n){if(e)return logInfo(`Attachment '${t}' not found, but silentNotFoundError is enabled: `+n.message),null;throw n}const i=this.processAttachmentRows(o);return i.length&&(i[0].getNote().attachments=i),this.attachments[t]}async getAttachmentsForNote(t){const e=await a.Z.get(`notes/${t}/attachments`);return this.processAttachmentRows(e)}processAttachmentRows(t){return t.map((t=>{let e;return t.attachmentId in this.attachments?(e=this.attachments[t.attachmentId],e.update(t)):(e=new l.Z(this,t),this.attachments[e.attachmentId]=e),e}))}async getBlob(t,e){const n=`${t}-${e}`;return this.blobPromises[n]||(this.blobPromises[n]=a.Z.get(`${t}/${e}/blob`).then((t=>new d(t))).catch((n=>console.error(`Cannot get blob for ${t} '${e}'`,n))),this.blobPromises[n].then((()=>setTimeout((()=>this.blobPromises[n]=null),1e3)))),await this.blobPromises[n]}},h=c},3968:(t,e,n)=>{"use strict";n.d(e,{Z:()=>c});var o=n(2817),i=n(8481),s=n(3152),a=n(1412);function r(){const t=o.default.tabManager.getActiveContext();return t?t.hoistedNoteId:"root"}async function d(){const t=o.default.tabManager.getActiveContext();t&&await t.unhoist()}function l(t){return"root"===t.data.noteId||t.data.noteId===r()}const c={getHoistedNoteId:r,unhoist:d,isTopLevelNode:function(t){return l(t.getParent())},isHoistedNode:l,checkNoteAccess:async function(t,e){const n=await i.Z.resolveNotePath(t,e.hoistedNoteId);if(!n)return console.log(`Cannot activate '${t}'`),!1;const o=e.hoistedNoteId;if(!n.includes(o)&&!n.includes("_hidden")){const t=await a.default.getNote(i.Z.getNoteIdFromUrl(n)),e=await a.default.getNote(o);if(!e.hasAncestor("_hidden")&&!await s.Z.confirm(`Requested note '${t.title}' is outside of hoisted note '${e.title}' subtree and you must unhoist to access the note. Do you want to proceed with unhoisting?`))return!1;await d()}return!0},isHoistedInHiddenSubtree:async function(){const t=r();return"root"!==t&&(await a.default.getNote(t)).isHiddenCompletely()}}},6604:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>c});var o=n(1736),i=n(2817),s=n(1065);const a={},r=o.Z.get("keyboard-actions").then((t=>{t=t.filter((t=>!!t.actionName));for(const e of t)e.effectiveShortcuts=e.effectiveShortcuts.filter((t=>!t.startsWith("global:"))),a[e.actionName]=e;return t}));async function d(t){return(await r).filter((e=>e.scope===t))}async function l(t,e=!1){await r;const n=a[t];if(!n){if(!e)throw new Error(`Cannot find action '${t}'`);console.debug(`Cannot find action '${t}'`)}return n}d("window").then((t=>{for(const e of t)for(const t of e.effectiveShortcuts)s.Z.bindGlobalShortcut(t,(()=>i.default.triggerCommand(e.actionName,{ntxId:i.default.tabManager.activeNtxId})))}));const c={updateDisplayedShortcuts:function(t){t.find("kbd[data-command]").each((async(t,e)=>{const n=$(e).attr("data-command"),o=await l(n,!0);if(o){const t=o.effectiveShortcuts.join(", ");(t||"not set"!==$(e).text())&&$(e).text(t)}})),t.find("[data-trigger-command]").each((async(t,e)=>{const n=$(e).attr("data-trigger-command"),o=await l(n,!0);if(o){const t=$(e).attr("title"),n=o.effectiveShortcuts.join(", ");if(t?.includes(n))return;const i=t?.trim()?`${t} (${n})`:n;$(e).attr("title",i)}}))},setupActionsForElement:async function(t,e,n){const o=await d(t);for(const t of o)for(const o of t.effectiveShortcuts)s.Z.bindElShortcut(e,o,(()=>n.triggerCommand(t.actionName,{ntxId:i.default.tabManager.activeNtxId})))},getActions:async function(){return await r},getActionsForScope:d}},6707:(t,e,n)=>{"use strict";n.d(e,{Z:()=>a});const o={};async function i(t){t=`${window.glob.assetPath}/${t}`,o[t]||(o[t]=$.ajax({url:t,dataType:"script",cache:!0})),await o[t]}async function s(t,e=!0){Array.from(document.querySelectorAll("link")).map((t=>t.href)).some((e=>e.endsWith(t)))||(e&&(t=`${window.glob.assetPath}/${t}`),$("head").append($('<link rel="stylesheet" type="text/css" />').attr("href",t)))}const a={requireCss:s,requireLibrary:async function(t){if(t.css&&t.css.map((t=>s(t))),t.js)for(const e of t.js)await i(e)},CKEDITOR:{js:["libraries/ckeditor/ckeditor.js"]},CODE_MIRROR:{js:["libraries/codemirror/codemirror.js","libraries/codemirror/addon/display/placeholder.js","libraries/codemirror/addon/edit/matchbrackets.js","libraries/codemirror/addon/edit/matchtags.js","libraries/codemirror/addon/fold/xml-fold.js","libraries/codemirror/addon/lint/lint.js","libraries/codemirror/addon/lint/eslint.js","libraries/codemirror/addon/mode/loadmode.js","libraries/codemirror/addon/mode/multiplex.js","libraries/codemirror/addon/mode/overlay.js","libraries/codemirror/addon/mode/simple.js","libraries/codemirror/addon/search/match-highlighter.js","libraries/codemirror/mode/meta.js","libraries/codemirror/keymap/vim.js"],css:["libraries/codemirror/codemirror.css","libraries/codemirror/addon/lint/lint.css"]},ESLINT:{js:["libraries/eslint.js"]},RELATION_MAP:{js:["libraries/jsplumb.js","libraries/panzoom.js"],css:["stylesheets/relation_map.css"]},PRINT_THIS:{js:["libraries/printThis.js"]},CALENDAR_WIDGET:{css:["stylesheets/calendar.css"]},KATEX:{js:["node_modules/katex/dist/katex.min.js","node_modules/katex/dist/contrib/mhchem.min.js","node_modules/katex/dist/contrib/auto-render.min.js"],css:["node_modules/katex/dist/katex.min.css"]},WHEEL_ZOOM:{js:["libraries/wheel-zoom.min.js"]},FORCE_GRAPH:{js:["libraries/force-graph.min.js"]},MERMAID:{js:["libraries/mermaid.min.js"]},EXCALIDRAW:{js:["node_modules/react/umd/react.production.min.js","node_modules/react-dom/umd/react-dom.production.min.js","node_modules/@excalidraw/excalidraw/dist/excalidraw.production.min.js"]},MARKJS:{js:["libraries/jquery.mark.es6.min.js"]}}},7844:(t,e,n)=>{"use strict";n.d(e,{Z:()=>g});var o=n(8481),i=n(592),s=n(2817),a=n(1412),r=n(9046);async function d(t,e){let n;return"default"===e?n=(await a.default.getNote(t)).getIcon():"source"===e?n="bx bx-code-curly":"attachments"===e&&(n="bx bx-file"),n}function l({notePath:t,ntxId:e,hoistedNoteId:n,viewScope:o={}}){t=t||"";const i=[e?{ntxId:e}:null,n&&"root"!==n?{hoistedNoteId:n}:null,o.viewMode&&"default"!==o.viewMode?{viewMode:o.viewMode}:null,o.attachmentId?{attachmentId:o.attachmentId}:null].filter((t=>!!t)).map((t=>{const e=Object.keys(t)[0],n=t[e];return`${encodeURIComponent(e)}=${encodeURIComponent(n)}`})).join("&");if(!t&&!i)return"";let s=`#${t}`;return i&&(s+=`?${i}`),s}function c(t){if(!t)return{};const e=t.indexOf("#");if(-1===e)return{};const n=t.substr(e+1),[i,s]=n.split("?");if(!i.match(/^[_a-z0-9]{4,}(\/[_a-z0-9]{4,})*$/i))return{};const a={viewMode:"default"};let r=null,d=null,l=null;if(s)for(const t of s.split("&")){let[e,n]=t.split("=");e=decodeURIComponent(e),n=decodeURIComponent(n),"ntxId"===e?r=n:"hoistedNoteId"===e?d=n:"searchString"===e?l=n:["viewMode","attachmentId"].includes(e)?a[e]=n:console.warn(`Unrecognized hash parameter '${e}'.`)}return{notePath:i,noteId:o.Z.getNoteIdFromUrl(i),ntxId:r,hoistedNoteId:d,viewScope:a,searchString:l}}function h(t){const e=$(t.target).closest("a,.block-link");return p(t,e.attr("href")||e.attr("data-href"),e)}function p(t,e,n){if(e?.startsWith("data:"))return!0;t.preventDefault(),t.stopPropagation();const{notePath:o,viewScope:i}=c(e),a=r.default.isCtrlKey(t),d=1===t.which,l=2===t.which,h=d&&a||l,p=1===t.which,u=2===t.which;if(o){if(h)s.default.tabManager.openTabWithNoteWithHoisting(o,{viewScope:i});else if(d){const e=$(t.target).closest("[data-ntx-id]").attr("data-ntx-id"),n=e?s.default.tabManager.getNoteContextById(e):s.default.tabManager.getActiveContext();n.setNote(o,{viewScope:i}).then((()=>{n!==s.default.tabManager.getActiveContext()&&s.default.tabManager.activateNoteContext(n.ntxId)}))}}else if(e){const t=n?.hasClass("ck-link-actions__preview"),o=!n||0===n.closest("[contenteditable]").length;(h||t&&(p||u)||o&&(p||u))&&(e.toLowerCase().startsWith("http")||e.startsWith("api/")?window.open(e,"_blank"):e.toLowerCase().startsWith("file:")&&r.default.isElectron()&&r.default.dynamicRequire("electron").shell.openPath(e))}return!0}async function u(t){const{noteId:e,viewScope:n}=c(t);if(!e)return"[missing note]";const o=await a.default.getNote(e);if(!o)return"[missing note]";if("attachments"===n?.viewMode&&n?.attachmentId){const t=await o.getAttachmentById(n.attachmentId);return t?t.title:"[missing attachment]"}return o.title}$(document).on("click","a",h),$(document).on("auxclick","a",h),$(document).on("contextmenu","a",(function(t){const e=$(t.target).closest("a"),n=e.attr("href")||e.attr("data-href"),{notePath:o,viewScope:s}=c(n);o&&(t.preventDefault(),i.Z.openContextMenu(o,t,s,null))})),$(document).on("dblclick","a",(t=>{t.preventDefault(),t.stopPropagation();const e=$(t.target).closest("a").attr("href");e&&e.startsWith("http")&&window.open(e,"_blank")})),$(document).on("mousedown","a",(t=>{if(2===t.which)return t.preventDefault(),!1}));const g={getNotePathFromUrl:function(t){const e=/#(root[A-Za-z0-9_/]*)$/.exec(t);return null===e?null:e[1]},createLink:async function(t,e={}){if(!t||!t.trim())return logError("缺少笔记路径"),$("<span>").text("[missing note]");t.startsWith("root")||(t=`root/${t}`);const n=void 0===e.showTooltip||e.showTooltip,i=void 0!==e.showNotePath&&e.showNotePath,s=void 0!==e.showNoteIcon&&e.showNoteIcon,r=void 0!==e.referenceLink&&e.referenceLink,c=void 0!==e.autoConvertToImage&&e.autoConvertToImage,{noteId:h,parentNoteId:p}=o.Z.getNoteIdAndParentIdFromUrl(t),u=e.viewScope||{},g=u.viewMode||"default";let m=e.title;if(!m)if("attachments"===g&&u.attachmentId){const t=await a.default.getAttachment(u.attachmentId);m=t?t.title:"[missing attachment]"}else m=await o.Z.getNoteTitle(h,p);const f=await a.default.getNote(h);if(c&&["image","canvas","mermaid"].includes(f.type)&&"default"===g){const t=encodeURIComponent(m);return $("<img>").attr("src",`api/images/${h}/${t}?${Math.random()}`).attr("alt",m)}const b=$("<span>");if(s){let t=await d(h,g);t&&b.append($("<span>").addClass(`bx ${t}`)).append(" ")}const w=l({notePath:t,viewScope:u}),y=$("<a>",{href:w,text:m});if(n||y.addClass("no-tooltip-preview"),r&&y.addClass("reference-link"),b.append(y),i){const e=await o.Z.resolveNotePathToSegments(t);if(e){e.pop();const t=e.join("/").trim();t&&b.append($("<small>").text(` (${await o.Z.getNotePathTitle(t)})`))}}return b},goToLink:h,goToLinkExt:p,loadReferenceLinkTitle:async function(t,e=null){const n="A"===t[0].tagName?t:t.find("a");if(!(e=e||n.attr("href")))return void console.warn("Empty URL for parsing: "+t[0].outerHTML);const{noteId:o,viewScope:i}=c(e),s=await a.default.getNote(o,!0);s&&t.addClass(s.getColorClass());const r=await u(e);if(t.text(r),s){const e=await d(o,i.viewMode);t.prepend($("<span>").addClass(e))}},getReferenceLinkTitle:u,getReferenceLinkTitleSync:function(t){const{noteId:e,viewScope:n}=c(t);if(!e)return"[missing note]";const o=a.default.getNoteFromCache(e);if(!o)return"[missing note]";if("attachments"===n?.viewMode&&n?.attachmentId){if(!o.attachments)return"[loading title...]";const t=o.attachments.find((t=>t.attachmentId===n.attachmentId));return t?t.title:"[missing attachment]"}return o.title},calculateHash:l,parseNavigationStateFromUrl:c}},4585:(t,e,n)=>{"use strict";n.d(e,{Z:()=>o});const o=new class{constructor(){this.attributes={}}invalidate(){this.attributes={}}}},8181:(t,e,n)=>{"use strict";n.d(e,{Z:()=>p});var o=n(2817),i=n(2040),s=n(1736),a=n(4264),r=n(1412),d=n(8481),l=n(6885);async function c(t,e={}){(e=Object.assign({activate:!0,focus:"title",target:"into"},e)).isProtected&&i.Z.isProtectedSessionAvailable()||(e.isProtected=!1),"text"!==o.default.tabManager.getActiveContextNoteType()&&(e.saveSelection=!1),e.saveSelection&&([e.title,e.content]=function(t){const e=$.parseHTML(t);return e.length>0&&e[0].tagName&&e[0].tagName.match(/h[1-6]/i)?[$(e[0]).text(),t.replace(e[0].outerHTML,"")]:[null,t]}(e.textEditor.getSelectedHtml()));const n=d.Z.getNoteIdFromUrl(t);"mermaid"!==e.type||e.content||(e.content="graph TD;\n    A--\x3eB;\n    A--\x3eC;\n    B--\x3eD;\n    C--\x3eD;");const{note:l,branch:c}=await s.Z.post(`notes/${n}/children?target=${e.target}&targetBranchId=${e.targetBranchId||""}`,{title:e.title,content:e.content||"",isProtected:e.isProtected,type:e.type,mime:e.mime,templateNoteId:e.templateNoteId});if(e.saveSelection&&e.textEditor.removeSelection(),await a.Z.waitForMaxKnownEntityChangeId(),e.activate){const n=o.default.tabManager.getActiveContext();await n.setNote(`${t}/${l.noteId}`),"title"===e.focus?o.default.triggerEvent("focusAndSelectTitle",{isNewNote:!0}):"content"===e.focus&&o.default.triggerEvent("focusOnDetail",{ntxId:n.ntxId})}return{note:await r.default.getNote(l.noteId),branch:r.default.getBranch(c.branchId)}}async function h(){return new Promise((t=>{o.default.triggerCommand("chooseNoteType",{callback:t})}))}const p={createNote:c,createNoteWithTypePrompt:async function(t,e={}){const{success:n,noteType:o,templateNoteId:i}=await h();if(n)return e.type=o,e.templateNoteId=i,await c(t,e)},duplicateSubtree:async function(t,e){const n=d.Z.getNoteIdFromUrl(e),{note:i}=await s.Z.post(`notes/${t}/duplicate/${n}`);await a.Z.waitForMaxKnownEntityChangeId(),o.default.tabManager.getActiveContext().setNote(`${e}/${i.noteId}`);const c=await r.default.getNote(t);l.default.showMessage(`笔记 "${c.title}" 已被复制`)},chooseNoteType:h}},4716:(t,e,n)=>{"use strict";n.d(e,{Z:()=>p});var o=n(8481),i=n(7844),s=n(1412),a=n(9046),r=n(1375),d=n(5913),l=n(2817);async function c(){const t=$(this);if(t.hasClass("no-tooltip-preview")||t.hasClass("disabled"))return;if(t.closest(".ck-link-actions").length)return;if(t.closest(".note-tooltip").length)return;const e=t.attr("href")||t.attr("data-href"),{notePath:n,noteId:o,viewScope:r}=i.Z.parseNavigationStateFromUrl(e);if(!n||"default"!==r.viewMode)return;const d=t.attr("data-link-id")||`link-${Math.floor(1e6*Math.random())}`;if(t.attr("data-link-id",d),$(`.${d}`).is(":visible"))return;const l=await s.default.getNote(o),[c]=await Promise.all([h(l),new Promise((t=>setTimeout(t,500)))]);if(a.default.isHtmlEmpty(c))return;const p=`<div class="note-tooltip-content">${c}</div>`,u="tooltip-"+Math.floor(999999999*Math.random());if($(this).filter(":hover").length>0){$(this).tooltip({container:"body",placement:"bottom",trigger:"manual",boundary:"window",title:p,html:!0,template:`<div class="tooltip note-tooltip ${u}" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>`,sanitize:!1,customClass:d}),$(this).tooltip("show");const t=()=>{$(`.${u}`).is(":visible")?$(this).filter(":hover").length||$(`.${d}:hover`).length?setTimeout(t,1e3):$(this).tooltip("dispose"):console.log("Not visible anymore")};setTimeout(t,1e3)}}async function h(t){if(!t)return"<div>笔记已被删除.</div>";const e=l.default.tabManager.getActiveContext()?.hoistedNoteId,n=t.getBestNotePathString(e);if(!n)return;let i=`<h5 class="note-tooltip-title">${(await o.Z.getNoteTitleWithPathAsSuffix(n)).prop("outerHTML")}</h5>`;const{$renderedAttributes:s}=await r.Z.renderNormalAttributes(t),{$renderedContent:a}=await d.Z.getRenderedContent(t,{tooltip:!0,trim:!0});return i=`${i}<div class="note-tooltip-attributes">${s[0].outerHTML}</div>${a[0].outerHTML}`,i}const p={setupGlobalTooltip:function(){$(document).on("mouseenter","a",c),$(document).on("click",(t=>{$(t.target).closest(".note-tooltip").length||$(".note-tooltip").remove()}))},setupElementTooltip:function(t){t.on("mouseenter",c)}}},5489:(t,e,n)=>{"use strict";n.d(e,{Z:()=>h});var o=n(9046),i=n(1736);function s(t){if("notes"!==t&&"attachments"!==t)throw new Error(`Unrecognized type '${t}', should be 'notes' or 'attachments'`)}function a(t,e){return s(t),l(`api/${t}/${e}/download`)}function r(t){o.default.isElectron()?o.default.dynamicRequire("@electron/remote").getCurrentWebContents().downloadURL(t):window.location.href=t}async function d(t,e,n){if(s(t),!o.default.isElectron()||o.default.isMac())return;let r=(await i.Z.post(`${t}/${e}/save-to-tmp-dir`)).tmpFilePath;const{exec:d}=o.default.dynamicRequire("child_process"),l=process.platform;if("linux"===l){const t=["x-terminal-emulator","gnome-terminal","konsole","xterm","xfce4-terminal","mate-terminal","rxvt","terminator","terminology"],n=e=>{const n=`${e} -e 'mimeopen -d "${r}"'`;console.log(`Open Note custom: ${n} `),d(n,((n,i,s)=>{n?(console.error(`Open Note custom: Failed to open file with ${e}: ${n}`),o(t.indexOf(e)+1)):console.log(`Open Note custom: File opened with ${e}: ${i}`)}))},o=i=>{const s=t[i];if(!s)return console.error("Open Note custom: No terminal found!"),void open(a(e),{url:!0});d(`which ${s}`,((t,e,a)=>{e.trim()?n(s):o(i+1)}))};o(0)}else"win32"===l?(-1!==r.indexOf("/")&&(r=r.replace(/\//g,"\\")),d("rundll32.exe shell32.dll,OpenAs_RunDLL "+r,((t,n,o)=>{if(t)return console.error("Open Note custom: ",t),void open(a(e),{url:!0})}))):(console.log('Currently "Open Note custom" only supports linux and windows systems'),open(a(e),{url:!0}))}function l(t){return o.default.isElectron()?`${function(){const t=new URL(window.location.href);return`${t.protocol}//${t.hostname}:${t.port}`}()}/${t}`:t}async function c(t,e,n){if(s(t),o.default.isElectron()){const n=await i.Z.post(`${t}/${e}/save-to-tmp-dir`),s=o.default.dynamicRequire("electron");await s.shell.openPath(n.tmpFilePath)&&window.open(a(t,e))}else!function(t){return"application/pdf"===t||t.startsWith("image")||t.startsWith("audio")||t.startsWith("video")}(n)?window.location.href=a(t,e):window.open(function(t,e){return s(t),l(`api/${t}/${e}/open`)}(t,e))}const h={download:r,downloadFileNote:function(t){r(`${a("notes",t)}?${Date.now()}`)},downloadRevision:function(t,e){r(l(`api/revisions/${e}/download`))},downloadAttachment:function(t){r(`${a("attachments",t)}?${Date.now()}`)},getUrlForDownload:l,openNoteExternally:async(t,e)=>await c("notes",t,e),openAttachmentExternally:async(t,e)=>await c("attachments",t,e),openNoteCustom:async(t,e)=>await d("notes",t),openAttachmentCustom:async(t,e)=>await d("attachments",t)}},4378:(t,e,n)=>{"use strict";n.d(e,{Z:()=>i});var o=n(1736);const i=new class{constructor(){this.initializedPromise=o.Z.get("options").then((t=>this.load(t)))}load(t){this.arr=t}get(t){return this.arr[t]}getNames(){return Object.keys(this.arr)}getJson(t){try{return JSON.parse(this.arr[t])}catch(t){return null}}getInt(t){return parseInt(this.arr[t])}getFloat(t){return parseFloat(this.arr[t])}is(t){return"true"===this.arr[t]}set(t,e){this.arr[t]=e}async save(t,e){this.set(t,e);const n={};n[t]=e,await o.Z.put("options",n)}async toggle(t){await this.save(t,(!this.is(t)).toString())}}},3847:(t,e,n)=>{"use strict";n.d(e,{Z:()=>o});const o={parse:function(t){const e=t.split(",").map((t=>t.trim())),n={};for(const t of e)if("promoted"===t)n.isPromoted=!0;else if(["text","number","boolean","date","datetime","url"].includes(t))n.labelType=t;else if(["single","multi"].includes(t))n.multiplicity=t;else if(t.startsWith("precision")){const e=t.split("=");n.numberPrecision=parseInt(e[1])}else if(t.startsWith("alias")){const e=t.split("=");n.promotedAlias=e[1]}else if(t.startsWith("inverse")){const e=t.split("=");n.inverseRelation=e[1]}else console.log("Unrecognized attribute definition token:",t);return n}}},7336:(t,e,n)=>{"use strict";n.d(e,{Z:()=>g});var o=n(1736),i=n(2040),s=n(6885),a=n(4264),r=n(2817),d=n(1412),l=n(9046),c=n(4378);let h=null;function p(){const t=$.Deferred();return c.Z.is("isPasswordSet")?(i.Z.isProtectedSessionAvailable()?t.resolve(!1):(h=t,r.default.triggerCommand("showProtectedSessionPasswordDialog")),t.promise()):(r.default.triggerCommand("showPasswordNotSet"),t)}function u(t,e,n){return{id:t.taskId,title:`${e} status`,message:n,icon:t.data.protect?"check-shield":"shield"}}a.Z.subscribeToMessages((async t=>{"protectedSessionLogin"===t.type?(await async function(){const t=Object.keys(d.default.notes);await d.default.loadInitialTree(),await d.default.reloadNotes(t,!0)}(),await r.default.triggerEvent("frocaReloaded"),r.default.triggerEvent("protectedSessionStarted"),r.default.triggerCommand("closeProtectedSessionPasswordDialog"),null!==h&&(h.resolve(!0),h=null),s.default.showMessage("受保护的会话已启动.")):"protectedSessionLogout"===t.type&&l.default.reloadFrontendApp("Protected session logout")})),a.Z.subscribeToMessages((async t=>{if("protectNotes"!==t.taskType)return;const e=t.data.protect?"保护":"取消保护";if("taskError"===t.type)s.default.closePersistent(t.taskId),s.default.showError(t.message);else if("taskProgressCount"===t.type)s.default.showPersistent(u(t,e,`${e} in progress: ${t.progressCount}`));else if("taskSucceeded"===t.type){const n=u(t,e,`${e} finished successfully.`);n.closeAfter=3e3,s.default.showPersistent(n)}}));const g={protectNote:async function(t,e,n){await p(),await o.Z.put(`notes/${t}/protect/${e?1:0}?subtree=${n?1:0}`)},enterProtectedSession:p,leaveProtectedSession:async function(){i.Z.isProtectedSessionAvailable()&&await i.Z.resetProtectedSession()},setupProtectedSession:async function(t){(await o.Z.post("login/protected",{password:t})).success?i.Z.enableProtectedSession():s.default.showError("密码错误.",3e3)}}},2040:(t,e,n)=>{"use strict";n.d(e,{Z:()=>a});var o=n(1736);function i(){return glob.isProtectedSessionAvailable}async function s(){i()&&await o.Z.post("login/protected/touch")}const a={enableProtectedSession:function(){glob.isProtectedSessionAvailable=!0,s()},resetProtectedSession:async function(){await o.Z.post("logout/protected")},isProtectedSessionAvailable:i,touchProtectedSession:s,touchProtectedSessionIfNecessary:function(t){t&&t.isProtected&&i()&&s()}}},5437:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var o=n(1736),i=n(394);const s={render:async function(t,e){const n=t.getRelations("renderNote").map((t=>t.value)).filter((t=>t));e.empty().toggle(n.length>0);for(const s of n){const n=await o.Z.post(`script/bundle/${s}`),a=$("<div>");e.append(a),a.append(n.html),i.default.executeBundle(n,t,a)}return n.length>0}}},5574:(t,e,n)=>{"use strict";n.d(e,{Z:()=>v});var o=n(1736),i=n(9046),s=n(6885),a=n(7844),r=n(1412),d=n(4716),l=n(7336),c=n(383),h=n(9692),p=n(1698),u=n(4264),g=n(2817),m=n(2503),f=n(1167),b=n(1902),w=n(1065),y=n(3152);const x=function(t,e,n=null,x=null){function v(t){return t?t.map((t=>"function"==typeof t?`!@#Function: ${t.toString()}`:t)):t}this.$container=x,this.startNote=t,this.currentNote=e,this.originEntity=n,this.dayjs=dayjs,this.RightPanelWidget=p.Z,this.NoteContextAwareWidget=m.Z,this.BasicWidget=f.Z,this.activateNote=async t=>{await g.default.tabManager.getActiveContext().setNote(t)},this.activateNewNote=async t=>{await u.Z.waitForMaxKnownEntityChangeId(),await g.default.tabManager.getActiveContext().setNote(t),await g.default.triggerEvent("focusAndSelectTitle")},this.openTabWithNote=async(t,e)=>{await u.Z.waitForMaxKnownEntityChangeId(),await g.default.tabManager.openTabWithNoteWithHoisting(t,{activate:e}),e&&await g.default.triggerEvent("focusAndSelectTitle")},this.openSplitWithNote=async(t,e)=>{await u.Z.waitForMaxKnownEntityChangeId();const n=g.default.tabManager.getActiveContext().getSubContexts(),{ntxId:o}=n[n.length-1];await g.default.triggerCommand("openNewNoteSplit",{ntxId:o,notePath:t}),e&&await g.default.triggerEvent("focusAndSelectTitle")},this.addButtonToToolbar=async t=>{console.warn("api.addButtonToToolbar() has been deprecated since v0.58 and may be removed in the future. Use  Menu -> Configure Launchbar to create/update launchers instead.");const{action:e,...n}=t;n.action=e.toString(),await o.Z.put("special-notes/api-script-launcher",n)},this.__runOnBackendInner=async(i,s,a)=>{"function"==typeof i&&(i=i.toString());const r=await o.Z.post("script/exec",{script:i,params:v(s),startNoteId:t.noteId,currentNoteId:e.noteId,originEntityName:"notes",originEntityId:n?n.noteId:null,transactional:a},"script");if(r.success)return await u.Z.waitForMaxKnownEntityChangeId(),r.executionResult;throw new Error(`server error: ${r.error}`)},this.runOnBackend=async(t,e=[])=>(("AsyncFunction"===t?.constructor.name||t?.startsWith?.("async "))&&s.default.showError("You're passing an async function to api.runOnBackend() which will likely not work as you intended. Either make the function synchronous (by removing 'async' keyword), or use api.runAsyncOnBackendWithManualTransactionHandling()"),await this.__runOnBackendInner(t,e,!0)),this.runAsyncOnBackendWithManualTransactionHandling=async(t,e=[])=>(("Function"===t?.constructor.name||t?.startsWith?.("function"))&&s.default.showError("You're passing a synchronous function to api.runAsyncOnBackendWithManualTransactionHandling(), while you should likely use api.runOnBackend() instead."),await this.__runOnBackendInner(t,e,!1)),this.searchForNotes=async t=>await h.Z.searchForNotes(t),this.searchForNote=async t=>{const e=await this.searchForNotes(t);return e.length>0?e[0]:null},this.getNote=async t=>await r.default.getNote(t),this.getNotes=async(t,e=!1)=>await r.default.getNotes(t,e),this.reloadNotes=async t=>await r.default.reloadNotes(t),this.getInstanceName=()=>window.glob.instanceName,this.formatDateISO=i.default.formatDateISO,this.parseDate=i.default.parseDate,this.showMessage=s.default.showMessage,this.showError=s.default.showError,this.showInfoDialog=y.Z.info,this.showConfirmDialog=y.Z.confirm,this.showPromptDialog=y.Z.prompt,this.triggerCommand=(t,e)=>g.default.triggerCommand(t,e),this.triggerEvent=(t,e)=>g.default.triggerEvent(t,e),this.createLink=a.Z.createLink,this.createNoteLink=a.Z.createLink,this.addTextToActiveContextEditor=t=>g.default.triggerCommand("addTextToActiveEditor",{text:t}),this.getActiveContextNote=()=>g.default.tabManager.getActiveContextNote(),this.getActiveContext=()=>g.default.tabManager.getActiveContext(),this.getActiveMainContext=()=>g.default.tabManager.getActiveMainContext(),this.getNoteContexts=()=>g.default.tabManager.getNoteContexts(),this.getMainNoteContexts=()=>g.default.tabManager.getMainNoteContexts(),this.getActiveContextTextEditor=()=>g.default.tabManager.getActiveContext()?.getTextEditor(),this.getActiveContextCodeEditor=()=>g.default.tabManager.getActiveContext()?.getCodeEditor(),this.getActiveNoteDetailWidget=()=>new Promise((t=>g.default.triggerCommand("executeInActiveNoteDetailWidget",{callback:t}))),this.getActiveContextNotePath=()=>g.default.tabManager.getActiveContextNotePath(),this.getComponentByEl=t=>g.default.getComponentByEl(t),this.setupElementTooltip=d.Z.setupElementTooltip,this.protectNote=async(t,e)=>{await l.Z.protectNote(t,e,!1)},this.protectSubTree=async(t,e)=>{await l.Z.protectNote(t,e,!0)},this.getTodayNote=c.Z.getTodayNote,this.getDayNote=c.Z.getDayNote,this.getWeekNote=c.Z.getWeekNote,this.getMonthNote=c.Z.getMonthNote,this.getYearNote=c.Z.getYearNote,this.setHoistedNoteId=t=>{const e=g.default.tabManager.getActiveContext();e&&e.setHoistedNoteId(t)},this.bindGlobalShortcut=w.Z.bindGlobalShortcut,this.waitUntilSynced=u.Z.waitForMaxKnownEntityChangeId,this.refreshIncludedNote=t=>g.default.triggerEvent("refreshIncludedNote",{noteId:t}),this.randomString=i.default.randomString,this.formatSize=i.default.formatSize,this.formatNoteSize=i.default.formatSize,this.logMessages={},this.logSpacedUpdates={},this.log=t=>{const{noteId:e}=this.startNote;t=`${i.default.now()}: ${t}`,console.log(`Script ${e}: ${t}`),this.logMessages[e]=this.logMessages[e]||[],this.logSpacedUpdates[e]=this.logSpacedUpdates[e]||new b.Z((()=>{const t=this.logMessages[e];this.logMessages[e]=[],g.default.triggerEvent("apiLogMessages",{noteId:e,messages:t})}),100),this.logMessages[e].push(t),this.logSpacedUpdates[e].scheduleUpdate()}},v=async function(t,e,n=null,o=null){const s={};await r.default.initializedPromise;const a=await r.default.getNote(t),d=await r.default.getNotes(e);return{modules:s,notes:i.default.toObject(d,(t=>[t.noteId,t])),apis:i.default.toObject(d,(t=>[t.noteId,new x(a,t,n,o)])),require:t=>e=>{const n=d.filter((e=>t.includes(e.noteId))),o=n.find((t=>t.title===e));if(!o)throw new Error(`Could not find module note ${e}`);return s[o.noteId].exports}}}},9692:(t,e,n)=>{"use strict";n.d(e,{Z:()=>a});var o=n(1736),i=n(1412);async function s(t){return await o.Z.get(`search/${encodeURIComponent(t)}`)}const a={searchForNoteIds:s,searchForNotes:async function(t){const e=await s(t);return await i.default.getNotes(e)}}},1736:(t,e,n)=>{"use strict";n.d(e,{Z:()=>h});var o=n(9046);class i{constructor(t){for(const e in t)this[e]=t[e]}}async function s(t){const e=(await Promise.resolve().then(n.bind(n,2817))).default,i=e.tabManager?e.tabManager.getActiveContext():null,s={"trilium-component-id":glob.componentId,"trilium-local-now-datetime":o.default.localNowDateTime(),"trilium-hoisted-note-id":i?i.hoistedNoteId:null,"x-csrf-token":glob.csrfToken};for(const e in t)t[e]&&(s[e]=t[e]);return o.default.isElectron()&&(s.cookie=document.cookie),s}let a=1;const r={};let d=0;async function l(t,e,n,i={}){let l;const h=await s({"trilium-component-id":n}),{data:p}=i;if(o.default.isElectron()){const n=o.default.dynamicRequire("electron").ipcRenderer,s=a++;l=await new Promise(((o,a)=>{r[s]={resolve:o,reject:a,silentNotFound:!!i.silentNotFound},n.send("server-request",{requestId:s,headers:h,method:t,url:`/${window.glob.baseApiUrl}${e}`,data:p})}))}else l=await function(t,e,n,o,i){return new Promise(((s,a)=>{const r={url:window.glob.baseApiUrl+t,type:e,headers:o,timeout:6e4,success:(t,e,n)=>{const o={};n.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((t=>{const e=t.split(": "),n=e.shift();o[n]=e.join(": ")})),s({body:t,headers:o})},error:async n=>{i&&404===n.status||await c(e,t,n.status,n.responseText),a(n.responseText)}};if(n){try{r.data=JSON.stringify(n)}catch(t){console.log("Can't stringify data: ",n," because of error: ",t)}r.contentType="application/json"}$.ajax(r)}))}(e,t,p,h,!!i.silentNotFound);const u=l.headers["trilium-max-entity-change-id"];return u&&u.trim()&&(d=Math.max(d,parseInt(u))),l.body}if(o.default.isElectron()){function p(t){if("application/json"===t.headers["Content-Type"]&&(t.body=JSON.parse(t.body)),!(t.requestId in r))throw new Error(`Unknown requestId '${t.requestId}'`);r[t.requestId].resolve({body:t.body,headers:t.headers})}o.default.dynamicRequire("electron").ipcRenderer.on("server-response",(async(t,e)=>{e.statusCode>=200&&e.statusCode<300?p(e):(404===e.statusCode&&r[e.requestId]?.silentNotFound||await c(e.method,e.url,e.statusCode,e.body),r[e.requestId].reject(new Error(`Server responded with ${e.statusCode}`))),delete r[e.requestId]}))}async function c(t,e,o,s){let a=s;if("string"==typeof s)try{a=(s=JSON.parse(s)).message}catch(t){}const r=(await Promise.resolve().then(n.bind(n,6885))).default;if([400,404].includes(o)&&s&&"object"==typeof s)throw r.showError(a),new i({requestUrl:e,method:t,statusCode:o,...s});{const n=`${o} ${t} ${e}`;r.showErrorTitleAndMessage(n,a),r.throwError(`${n} - ${a}`)}}const h={get:async function(t,e){return await l("GET",t,e)},getWithSilentNotFound:async function(t,e){return await l("GET",t,e,{silentNotFound:!0})},post:async function(t,e,n){return await l("POST",t,n,{data:e})},put:async function(t,e,n){return await l("PUT",t,n,{data:e})},patch:async function(t,e,n){return await l("PATCH",t,n,{data:e})},remove:async function(t,e){return await l("DELETE",t,e)},upload:async function(t,e){const n=new FormData;return n.append("upload",e),await $.ajax({url:window.glob.baseApiUrl+t,headers:await s(),data:n,type:"PUT",timeout:36e5,contentType:!1,processData:!1})},getHeaders:s,getMaxKnownEntityChangeId:()=>d}},1065:(t,e,n)=>{"use strict";n.d(e,{Z:()=>r});var o=n(9046);function i(t,e,n=null){s($(document),t,e,n)}function s(t,e,n,i=null){if(o.default.isDesktop()){e=a(e);let o="keydown";i&&(o+=`.${i}`,t.off(o)),e&&t.bind(o,e,(t=>{n(t),t.preventDefault(),t.stopPropagation()}))}}function a(t){return t?t.toLowerCase().replace("enter","return").replace("delete","del").replace("ctrl+alt","alt+ctrl").replace("meta+alt","alt+meta"):t}const r={bindGlobalShortcut:i,bindElShortcut:s,removeGlobalShortcut:function(t){i("",null,t)},normalizeShortcut:a}},1902:(t,e,n)=>{"use strict";n.d(e,{Z:()=>o});class o{constructor(t,e=1e3){this.updater=t,this.lastUpdated=Date.now(),this.changed=!1,this.updateInterval=e}scheduleUpdate(){this.changeForbidden||(this.changed=!0,setTimeout((()=>this.triggerUpdate())))}async updateNowIfNecessary(){if(this.changed){this.changed=!1;try{await this.updater()}catch(t){throw this.changed=!0,t}}}isAllSavedAndTriggerUpdate(){const t=!this.changed;return this.updateNowIfNecessary(),t}triggerUpdate(){this.changed&&(Date.now()-this.lastUpdated>this.updateInterval?(this.updater(),this.lastUpdated=Date.now(),this.changed=!1):this.scheduleUpdate())}async allowUpdateWithoutChange(t){this.changeForbidden=!0;try{await t()}finally{this.changeForbidden=!1}}}},6885:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>r});var o=n(4264),i=n(9046);function s(t){const e=$(`<div class="toast" role="alert" aria-live="assertive" aria-atomic="true">\n    <div class="toast-header">\n        <strong class="mr-auto"><span class="bx bx-${t.icon}"></span> <span class="toast-title"></span></strong>\n        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">\n            <span aria-hidden="true">&times;</span>\n        </button>\n    </div>\n    <div class="toast-body"></div>\n</div>`);return e.find(".toast-title").text(t.title),e.find(".toast-body").text(t.message),t.id&&e.attr("id",`toast-${t.id}`),$("#toast-container").append(e),e.toast({delay:t.delay||3e3,autohide:!!t.autohide}),e.on("hidden.bs.toast",(t=>t.target.remove())),e.toast("show"),e}function a(t,e=1e4){console.log(i.default.now(),"error: ",t),s({title:"错误",icon:"alert",message:t,autohide:!0,delay:e})}const r={showMessage:function(t,e=2e3){console.debug(i.default.now(),"message:",t),s({title:"信息",icon:"check",message:t,autohide:!0,delay:e})},showError:a,showErrorTitleAndMessage:function(t,e,n=1e4){console.log(i.default.now(),"error: ",e),s({title:t,icon:"alert",message:e,autohide:!0,delay:n})},showAndLogError:function(t,e=1e4){a(t,e),o.Z.logError(t)},throwError:function(t){throw o.Z.logError(t),new Error(t)},showPersistent:function(t){let e=$(`#toast-${t.id}`);e.length>0?e.find(".toast-body").html(t.message):(t.autohide=!1,e=s(t)),t.closeAfter&&setTimeout((()=>e.remove()),t.closeAfter)},closePersistent:function(t){$(`#toast-${t}`).remove()}}},8481:(t,e,n)=>{"use strict";n.d(e,{Z:()=>u});var o=n(4264),i=n(9046),s=n(1412),a=n(3968),r=n(2817);async function d(t,e="root",n=!0){if(i.default.assertArguments(t),0===(t=t.split("?")[0].trim()).length)return null;const a=t.split("/").reverse();a.includes("root")||a.push("root");const r=[];let d=null,c=0;for(;!(c>=a.length);){const l=a[c++];if(null!==d){const a=await s.default.getNote(d,!n);if(!a)return n&&o.Z.logError(`Can't find note ${d}`),null;a.sortParents();const c=a.getParentNotes();if(!c.length)return n&&o.Z.logError(`No parents found for note ${d} (${a.title}) for path ${t}`),null;if(!c.some((t=>t.noteId===l))){if(n){const t=s.default.getNoteFromCache(l);console.debug(i.default.now(),`Did not find parent ${l} (${t?t.title:"n/a"}) \n                        for child ${d} (${a.title}), available parents: ${c.map((t=>`${t.noteId} (${t.title})`))}. \n                        You can ignore this message as it is mostly harmless.`)}const t=a.getBestNotePath(e);if(t){const e=t.reverse().slice(1);for(const t of e)r.push(t)}break}}r.push(l),d=l}if(r.reverse(),r.includes(e))return r;{const n=await s.default.getNote(l(t)),o=n.getBestNotePath(e);if(!o)throw new Error(`Did not find any path segments for '${n.toString()}', hoisted note '${e}'`);return o.includes(e)?o:r}}function l(t){if(!t)return null;const[e]=t.split("?"),n=e.split("/");return n[n.length-1]}function c(t){if(!t)return{};const[e]=t.split("?");if("root"===e)return{noteId:"root",parentNoteId:"none"};let n="root",o="";if(e){const t=e.split("/");o=t[t.length-1],t.length>1&&(n=t[t.length-2])}return{parentNoteId:n,noteId:o}}async function h(t,e=null){i.default.assertArguments(t);const n=await s.default.getNote(t);if(!n)return"[not found]";let{title:o}=n;if(null!==e){const t=n.parentToBranch[e];if(t){const e=s.default.getBranch(t);e?.prefix&&(o=`${e.prefix} - ${o}`)}}return o}async function p(t){const e=[];if(t.startsWith("root/")&&(t=t.substr(5)),"root"===t)e.push(await h(t));else{let n="root";for(const o of t.split("/"))e.push(await h(o,n)),n=o}return e}o.Z.subscribeToMessages((t=>{"openNote"===t.type&&(r.default.tabManager.activateOrOpenNote(t.noteId),i.default.isElectron())&&i.default.dynamicRequire("@electron/remote").getCurrentWindow().show()}));const u={resolveNotePath:async function(t,e="root"){const n=await d(t,e);return n?n.join("/"):null},resolveNotePathToSegments:d,getParentProtectedStatus:function(t){return!a.Z.isHoistedNode(t)&&t.getParent().data.isProtected},getNotePath:function(t){if(!t)return logError("节点为空"),"";const e=[];for(;t;)t.data.noteId&&e.push(t.data.noteId),t=t.getParent();return e.reverse().join("/")},getNoteIdFromUrl:l,getNoteIdAndParentIdFromUrl:c,getBranchIdFromUrl:async function(t){const{noteId:e,parentNoteId:n}=c(t);return await s.default.getBranchId(n,e)},getNoteTitle:h,getNotePathTitle:async function(t){return i.default.assertArguments(t),(await p(t)).join(" / ")},getNoteTitleWithPathAsSuffix:async function(t){i.default.assertArguments(t);const e=await p(t);if(!e||0===e.length)return"";const n=e[e.length-1],o=e.slice(0,e.length-1),s=$('<span class="note-title-with-path">').append($('<span class="note-title">').text(n));return o.length>0&&s.append($('<span class="note-path">').text(` (${o.join(" / ")})`)),s},isNotePathInHiddenSubtree:function(t){return t?.includes("root/_hidden")}}},9046:(t,e,n)=>{"use strict";function o(t){return`${t<=9?"0":""}${t}`}function i(t){return`${t.getFullYear()}-${o(t.getMonth()+1)}-${o(t.getDate())}`}function s(){return!!(window&&window.process&&window.process.type)}function a(){return navigator.platform.indexOf("Mac")>-1}n.d(e,{default:()=>b});const r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function d(){glob.activeDialog&&(glob.activeDialog.modal("hide"),glob.activeDialog=null)}let l=null;function c(){l=$(":focus")}function h(){if(l){if(l.hasClass("ck")){const t=l.closest(".ck-editor__editable").prop("ckeditorInstance");t?t.editing.view.focus():console.log("Could not find CKEditor instance to focus last element")}else l.focus();l=null}}function p(t){return"undefined"!=typeof require?require(t):n(3676)(t)}const u="https://github.com/zadam/trilium/wiki/";function g(t){const e=t.attr("data-help-page");if(e){const t=u+e;window.open(t,"_blank")}}function m(t){t.on("click",(t=>{g($(t.target).closest("[data-help-page]"))}))}const f=new RegExp("^[\\p{L}\\p{N}_:]+$","u"),b={reloadFrontendApp:function(t){t&&logInfo(`Frontend app reload: ${t}`),window.location.reload()},parseDate:function(t){try{return new Date(Date.parse(t))}catch(e){throw new Error(`Can't parse date from '${t}': ${e.message} ${e.stack}`)}},formatDateISO:i,formatDateTime:function(t){return`${function(t){return i(t)}(t)} ${function(t){return`${o(t.getHours())}:${o(t.getMinutes())}`}(t)}`},formatTimeInterval:function(t){const e=Math.round(t/1e3),n=Math.floor(e/60),o=Math.floor(n/60),i=Math.floor(o/24),s=(t,e)=>`${t} ${e}`,a=[];return i>0&&a.push(s(i,"天")),i<2&&(o%24>0&&a.push(s(o%24,"小时")),o<4&&(n%60>0&&a.push(s(n%60,"分钟")),n<5&&e%60>0&&a.push(s(e%60,"秒")))),a.join(", ")},formatSize:function(t){return(t=Math.max(Math.round(t/1024),1))<1024?`${t} KiB`:Math.round(t/102.4)/10+" MiB"},localNowDateTime:function(){return dayjs().format("YYYY-MM-DD HH:mm:ss.SSSZZ")},now:function(){return`${o((t=new Date).getHours())}:${o(t.getMinutes())}:${o(t.getSeconds())}`;var t},isElectron:s,isMac:a,isCtrlKey:function(t){return!a()&&t.ctrlKey||a()&&t.metaKey},assertArguments:function(){for(const t in arguments)arguments[t]||console.trace(`Argument idx#${t} should not be falsy: ${arguments[t]}`)},escapeHtml:function(t){return t.replace(/[&<>"'`=\/]/g,(t=>r[t]))},toObject:function(t,e){const n={};for(const o of t){const[t,i]=e(o);n[t]=i}return n},randomString:function(t){let e="";for(let n=0;n<t;n++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return e},isMobile:function(){return"mobile"===window.glob?.device||!window.glob?.device&&/Mobi/.test(navigator.userAgent)},isDesktop:function(){return"desktop"===window.glob?.device||!window.glob?.device&&!/Mobi/.test(navigator.userAgent)},setCookie:function(t,e){const n=`; expires=${new Date(Date.now()+31536e7).toUTCString()}`;document.cookie=`${t}=${e||""}${n};`},getNoteTypeClass:function(t){return`type-${t}`},getMimeTypeClass:function(t){if(!t)return"";const e=t.indexOf(";");return-1!==e&&(t=t.substr(0,e)),`mime-${t.toLowerCase().replace(/[\W_]+/g,"-")}`},closeActiveDialog:d,openDialog:async function(t,e=!0){e&&(d(),glob.activeDialog=t),c(),t.modal(),t.on("hidden.bs.modal",(()=>{$(".aa-input").autocomplete("close"),glob.activeDialog&&glob.activeDialog!==t||h()})),(await n.e(586).then(n.bind(n,6604))).default.updateDisplayedShortcuts(t)},saveFocusedElement:c,focusSavedElement:h,isHtmlEmpty:function(t){return!(t&&("string"!=typeof t?(logError(`Got object of type '${typeof t}' where string was expected.`),1):(t=t.toLowerCase()).includes("<img")||t.includes("<section")||0!==$("<div>").html(t).text().trim().length))},clearBrowserCache:async function(){if(s()){const t=p("@electron/remote").getCurrentWindow();await t.webContents.session.clearCache()}},copySelectionToClipboard:function(){const t=window.getSelection().toString();navigator.clipboard&&navigator.clipboard.writeText(t)},dynamicRequire:p,timeLimit:function(t,e,n){if(!t||!t.then)return t;const o=new Error(n||`Process exceeded time limit ${e}`);return new Promise(((n,i)=>{let s=!1;t.then((t=>{s=!0,n(t)})),setTimeout((()=>{s||i(o)}),e)}))},initHelpDropdown:function(t){const e=t.find(".help-dropdown .dropdown-menu");e.on("click",(t=>t.stopPropagation())),m(e)},initHelpButtons:m,openHelp:g,filterAttributeName:function(t){return t.replace(/[^\p{L}\p{N}_:]/gu,"")},isValidAttributeName:function(t){return f.test(t)},sleep:function(t){return new Promise((e=>{setTimeout(e,t)}))},escapeRegExp:function(t){return t.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},areObjectsEqual:function(){let t,e,n,o;function i(t,e){let s;if(isNaN(t)&&isNaN(e)&&"number"==typeof t&&"number"==typeof e)return!0;if(t===e)return!0;if("function"==typeof t&&"function"==typeof e||t instanceof Date&&e instanceof Date||t instanceof RegExp&&e instanceof RegExp||t instanceof String&&e instanceof String||t instanceof Number&&e instanceof Number)return t.toString()===e.toString();if(!(t instanceof Object&&e instanceof Object))return!1;if(t.isPrototypeOf(e)||e.isPrototypeOf(t))return!1;if(t.constructor!==e.constructor)return!1;if(t.prototype!==e.prototype)return!1;if(n.indexOf(t)>-1||o.indexOf(e)>-1)return!1;for(s in e){if(e.hasOwnProperty(s)!==t.hasOwnProperty(s))return!1;if(typeof e[s]!=typeof t[s])return!1}for(s in t){if(e.hasOwnProperty(s)!==t.hasOwnProperty(s))return!1;if(typeof e[s]!=typeof t[s])return!1;switch(typeof t[s]){case"object":case"function":if(n.push(t),o.push(e),!i(t[s],e[s]))return!1;n.pop(),o.pop();break;default:if(t[s]!==e[s])return!1}}return!0}if(arguments.length<1)return!0;for(t=1,e=arguments.length;t<e;t++)if(n=[],o=[],!i(arguments[0],arguments[t]))return!1;return!0},copyHtmlToClipboard:function(t){const e=new ClipboardItem({"text/html":new Blob([t],{type:"text/html"}),"text/plain":new Blob([t],{type:"text/plain"})});navigator.clipboard.write([e])},createImageSrcUrl:function(t){return`api/images/${t.noteId}/${encodeURIComponent(t.title)}?timestamp=${Date.now()}`}}},4264:(t,e,n)=>{"use strict";n.d(e,{Z:()=>M});var o=n(9046),i=n(6885),s=n(1736),a=n(4378);class r{constructor(t){this.entities={};for(const{entityId:e,entityName:n,entity:o}of t)o&&(this.entities[n]=this.entities[n]||[],this.entities[n][e]=o);this.noteIdToComponentId={},this.componentIdToNoteIds={},this.branchRows=[],this.attributeRows=[],this.noteReorderings=[],this.revisionRows=[],this.contentNoteIdToComponentId=[],this.optionNames=[],this.attachmentRows=[]}getEntityRow(t,e){return this.entities[t]?.[e]}addNote(t,e){this.noteIdToComponentId[t]=this.noteIdToComponentId[t]||[],this.noteIdToComponentId[t].includes(e)||this.noteIdToComponentId[t].push(e),this.componentIdToNoteIds[e]=this.componentIdToNoteIds[e]||[],this.componentIdToNoteIds[e]||this.componentIdToNoteIds[e].push(t)}addBranch(t,e){this.branchRows.push({branchId:t,componentId:e})}getBranchRows(){return this.branchRows.map((t=>this.getEntityRow("branches",t.branchId))).filter((t=>!!t))}addNoteReordering(t,e){this.noteReorderings.push(t)}getNoteReorderings(){return this.noteReorderings}addAttribute(t,e){this.attributeRows.push({attributeId:t,componentId:e})}getAttributeRows(t="none"){return this.attributeRows.filter((e=>e.componentId!==t)).map((t=>this.getEntityRow("attributes",t.attributeId))).filter((t=>!!t))}addRevision(t,e,n){this.revisionRows.push({revisionId:t,noteId:e,componentId:n})}hasRevisionForNote(t){return!!this.revisionRows.find((e=>e.noteId===t))}getNoteIds(){return Object.keys(this.noteIdToComponentId)}isNoteReloaded(t,e=null){if(!t)return!1;const n=this.noteIdToComponentId[t];return n&&void 0!==n.find((t=>t!==e))}addNoteContent(t,e){this.contentNoteIdToComponentId.push({noteId:t,componentId:e})}isNoteContentReloaded(t,e){return!!t&&this.contentNoteIdToComponentId.find((n=>n.noteId===t&&n.componentId!==e))}addOption(t){this.optionNames.push(t)}isOptionReloaded(t){return this.optionNames.includes(t)}getOptionNames(){return this.optionNames}addAttachmentRow(t){this.attachmentRows.push(t)}getAttachmentRows(){return this.attachmentRows}hasAttributeRelatedChanges(){return this.branchRows.length>0||this.attributeRows.length>0}isEmpty(){return 0===Object.keys(this.noteIdToComponentId).length&&0===this.branchRows.length&&0===this.attributeRows.length&&0===this.noteReorderings.length&&0===this.revisionRows.length&&0===this.contentNoteIdToComponentId.length&&0===this.optionNames.length&&0===this.attachmentRows.length}isEmptyForTree(){return 0===Object.keys(this.noteIdToComponentId).length&&0===this.branchRows.length&&0===this.attributeRows.length&&0===this.noteReorderings.length}}var d=n(1412),l=n(4585),c=n(8726),h=n(9673),p=n(9763);function u(t,e){const n=d.default.notes[e.entityId];if(n)if(t.addNote(e.entityId,e.componentId),e.isErased&&e.entityId in d.default.notes)o.default.reloadFrontendApp(`${e.entityName} '${e.entityId}' is erased, need to do complete reload.`);else if(e.isErased||e.entity?.isDeleted)delete d.default.notes[e.entityId];else{if(n.blobId!==e.entity.blobId){for(const t of Object.keys(d.default.blobPromises))t.includes(n.noteId)&&delete d.default.blobPromises[t];t.addNoteContent(n.noteId,e.componentId)}n.update(e.entity)}}async function g(t,e){if(e.isErased&&e.entityId in d.default.branches)return void o.default.reloadFrontendApp(`${e.entityName} '${e.entityId}' is erased, need to do complete reload.`);let n=d.default.branches[e.entityId];if(e.isErased||e.entity?.isDeleted){if(n){const o=d.default.notes[n.noteId],i=d.default.notes[n.parentNoteId];o&&(o.parents=o.parents.filter((t=>t!==n.parentNoteId)),delete o.parentToBranch[n.parentNoteId]),i&&(i.children=i.children.filter((t=>t!==n.noteId)),delete i.childToBranch[n.noteId]),t.addBranch(e.entityId,e.componentId),delete d.default.branches[e.entityId]}return}t.addBranch(e.entityId,e.componentId);const i=d.default.notes[e.entity.noteId];let s=d.default.notes[e.entity.parentNoteId];!i||i.isRoot()||s||(s=await d.default.getNote(e.entity.parentNoteId)),n?n.update(e.entity):(i||s)&&(d.default.branches[e.entityId]=n=new c.Z(d.default,e.entity)),i&&i.addParent(n.parentNoteId,n.branchId),s&&s.addChild(n.noteId,n.branchId)}function m(t,e){const n=new Set;for(const t in e.positions){const o=d.default.branches[t];o&&(o.notePosition=e.positions[t],n.add(o.parentNoteId))}for(const t of n){const e=d.default.notes[t];e&&e.sortChildren()}t.addNoteReordering(e.entityId,e.componentId)}function f(t,e){let n=d.default.attributes[e.entityId];if(e.isErased&&e.entityId in d.default.attributes)return void o.default.reloadFrontendApp(`${e.entityName} '${e.entityId}' is erased, need to do complete reload.`);if(e.isErased||e.entity?.isDeleted){if(n){const o=d.default.notes[n.noteId],i="relation"===n.type&&d.default.notes[n.value];o&&(o.attributes=o.attributes.filter((t=>t!==n.attributeId))),i&&(i.targetRelations=i.targetRelations.filter((t=>t!==n.attributeId))),t.addAttribute(e.entityId,e.componentId),delete d.default.attributes[e.entityId]}return}t.addAttribute(e.entityId,e.componentId);const i=d.default.notes[e.entity.noteId],s="relation"===e.entity.type&&d.default.notes[e.entity.value];n?n.update(e.entity):(i||s)&&(n=new h.Z(d.default,e.entity),d.default.attributes[n.attributeId]=n,i&&!i.attributes.includes(n.attributeId)&&i.attributes.push(n.attributeId),s&&!s.targetRelations.includes(n.attributeId)&&s.targetRelations.push(n.attributeId))}function b(t,e){if(e.isErased&&e.entityId in d.default.attachments)return void o.default.reloadFrontendApp(`${e.entityName} '${e.entityId}' is erased, need to do complete reload.`);const n=d.default.attachments[e.entityId];if(e.isErased||e.entity?.isDeleted){if(n){const o=n.getNote();o&&o.attachments&&(o.attachments=o.attachments.filter((t=>t.attachmentId!==n.attachmentId))),t.addAttachmentRow(e.entity),delete d.default.attachments[e.entityId]}}else{if(n)n.update(e.entity);else{const t=d.default.notes[e.entity.ownerId];t?.attachments&&t.attachments.push(new p.Z(d.default,e.entity))}t.addAttachmentRow(e.entity)}}const w={processEntityChanges:async function(t){const e=new r(t);for(const n of t)try{if("notes"===n.entityName)u(e,n);else if("branches"===n.entityName)await g(e,n);else if("attributes"===n.entityName)f(e,n);else if("note_reordering"===n.entityName)m(e,n);else if("revisions"===n.entityName)e.addRevision(n.entityId,n.noteId,n.componentId);else if("options"===n.entityName){if("openNoteContexts"===n.entity.name)continue;a.Z.set(n.entity.name,n.entity.value),e.addOption(n.entity.name)}else if("attachments"===n.entityName)b(e,n);else if("blobs"!==n.entityName&&"etapi_tokens"!==n.entityName)throw new Error(`Unknown entityName '${n.entityName}'`)}catch(t){throw new Error(`Can't process entity ${JSON.stringify(n)} with error ${t.message} ${t.stack}`)}const o=[];for(const{entityName:e,entity:n}of t)n&&("branches"!==e||n.parentNoteId in d.default.notes?"attributes"!==e||"relation"!==n.type||"template"!==n.name&&"inherit"!==n.name||n.value in d.default.notes||o.push(n.value):o.push(n.parentNoteId));if(o.length>0&&await d.default.reloadNotes(o),!e.isEmpty()){e.hasAttributeRelatedChanges()&&l.Z.invalidate();const t=(await Promise.resolve().then(n.bind(n,2817))).default;await t.triggerEvent("entitiesReloaded",{loadResults:e})}}};var y=n(2817);const x=[];let v,$,I=window.glob.maxEntityChangeIdAtLoad,C=window.glob.maxEntityChangeSyncIdAtLoad,N=window.glob.maxEntityChangeIdAtLoad,k=[];function S(t){console.error(o.default.now(),t),v&&1===v.readyState&&v.send(JSON.stringify({type:"log-error",error:t,stack:(new Error).stack}))}window.logError=S,window.logInfo=function(t){console.log(o.default.now(),t),v&&1===v.readyState&&v.send(JSON.stringify({type:"log-info",info:t}))};let T=null;const E=new Set;async function A(t){const e=JSON.parse(t.data);for(const t of x)t(e);if("ping"===e.type)$=Date.now();else if("reload-frontend"===e.type)o.default.reloadFrontendApp("received request from backend to reload frontend");else if("frontend-update"===e.type)await async function(t){if($=Date.now(),t.length>0){!function(t){const e=t.filter((t=>!E.has(t.id)&&("options"!==t.entityName||"openNoteContexts"!==t.entityId)));e.length>0&&console.debug(o.default.now(),"Frontend update data: ",e)}(t),k.push(...t);for(const e of t)I=Math.max(I,e.id),e.isSynced&&(C=Math.max(C,e.id));for(R();T;)await T;try{T=async function(){if(k.length>0){const t=k;k=[];const e=t.filter((t=>!E.has(t.id)));try{await o.default.timeLimit(w.processEntityChanges(e),3e4)}catch(t){S(`发生错误 ${t.message}: ${t.stack}, 重新加载界面.`),glob.isDev||a.Z.is("debugModeEnabled")?(console.log("nonProcessedEntityChanges causing the timeout",e),i.default.showError(`Encountered error "${t.message}", check out the console.`)):o.default.reloadFrontendApp()}for(const t of e)E.add(t.id),N=Math.max(N,t.id)}_.filter((t=>t.desiredEntityChangeId<=N)).forEach((t=>t.resolvePromise())),_=_.filter((t=>t.desiredEntityChangeId>N)),_.filter((t=>Date.now()>t.start-6e4)).forEach((t=>console.log(`Waiting for entityChangeId ${t.desiredEntityChangeId} while last processed is ${N} (last accepted ${I}) for ${Math.floor((Date.now()-t.start)/1e3)}s`)))}(),await T}finally{T=null}}}(e.data.entityChanges);else if("sync-hash-check-failed"===e.type)i.default.showError("同步检查失败!",6e4);else if("consistency-checks-failed"===e.type)i.default.showError("一致性检查失败! 详情请看日志.",3e6);else if("api-log-messages"===e.type)y.default.triggerEvent("apiLogMessages",{noteId:e.noteId,messages:e.messages});else if("toast"===e.type)i.default.showMessage(e.message);else if("execute-script"===e.type){const t=(await Promise.resolve().then(n.bind(n,394))).default,o=(await Promise.resolve().then(n.bind(n,1412))).default,i=e.originEntityId?await o.getNote(e.originEntityId):null;t.getAndExecuteBundle(e.currentNoteId,i,e.script,e.params)}}let _=[];function P(){const t=window.location,e=`${"https:"===t.protocol?"wss:":"ws:"}//${t.host}${t.pathname}`,n=new WebSocket(e);return n.onopen=()=>console.debug(o.default.now(),`Connected to server ${e} with WebSocket`),n.onmessage=A,n}async function R(){Date.now()-$>3e4&&console.log(o.default.now(),"Lost websocket connection to the backend. If you keep having this issue repeatedly, you might want to check your reverse proxy (nginx, apache) configuration and allow/unblock WebSocket."),v.readyState===v.OPEN?v.send(JSON.stringify({type:"ping",lastEntityChangeId:I})):v.readyState!==v.CLOSED&&v.readyState!==v.CLOSING||(console.log(o.default.now(),"WS closed or closing, trying to reconnect"),v=P())}setTimeout((()=>{v=P(),$=Date.now(),setInterval(R,1e3)}),0);const M={logError:S,subscribeToMessages:function(t){x.push(t)},waitForMaxKnownEntityChangeId:function(){return(t=s.Z.getMaxKnownEntityChangeId())<=N?Promise.resolve():(console.debug(`Waiting for ${t}, last processed is ${N}, last accepted ${I}`),new Promise(((e,n)=>{_.push({desiredEntityChangeId:t,resolvePromise:e,start:Date.now()})})));var t},getMaxKnownEntityChangeSyncId:()=>C}},3676:t=>{function e(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}e.keys=()=>[],e.resolve=e,e.id=3676,t.exports=e},1167:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var o=n(8866);class i extends o.Z{constructor(){super(),this.attrs={style:""},this.classes=[],this.children=[],this.childPositionCounter=10}child(...t){if(!t)return this;super.child(...t);for(const e of t)void 0===e.position&&(e.position=this.childPositionCounter,this.childPositionCounter+=10);return this.children.sort(((t,e)=>t.position-e.position)),this}id(t){return this.attrs.id=t,this}class(t){return this.classes.push(t),this}css(t,e){return this.attrs.style+=`${t}: ${e};`,this}contentSized(){return this.css("contain","none"),this}collapsible(){return this.css("min-height","0"),this.css("min-width","0"),this}filling(){return this.css("flex-grow","1"),this}cssBlock(t){return this.cssEl=t,this}render(){if(this.doRender(),this.$widget.attr("data-component-id",this.componentId),this.$widget.addClass("component").prop("component",this),this.isEnabled()||this.toggleInt(!1),this.cssEl){const t=this.cssEl.trim().startsWith("<style>")?this.cssEl:`<style>${this.cssEl}</style>`;this.$widget.append(t)}for(const t in this.attrs)if("style"===t){if(this.attrs[t]){let e=this.$widget.attr("style");e=e?`${e}; ${this.attrs[t]}`:this.attrs[t],this.$widget.attr(t,e)}}else this.$widget.attr(t,this.attrs[t]);for(const t of this.classes)this.$widget.addClass(t);return this.$widget}isEnabled(){return!0}doRender(){}toggleInt(t){this.$widget.toggleClass("hidden-int",!t)}isHiddenInt(){return this.$widget.hasClass("hidden-int")}toggleExt(t){this.$widget.toggleClass("hidden-ext",!t)}isHiddenExt(){return this.$widget.hasClass("hidden-ext")}canBeShown(){return!this.isHiddenInt()&&!this.isHiddenExt()}isVisible(){return this.$widget.is(":visible")}getPosition(){return this.position}remove(){this.$widget&&this.$widget.remove()}getClosestNtxId(){return this.$widget?this.$widget.closest("[data-ntx-id]").attr("data-ntx-id"):null}cleanup(){}}const s=i},2503:(t,e,n)=>{"use strict";n.d(e,{Z:()=>a});var o=n(1167),i=n(2817);class s extends o.Z{isNoteContext(t){return Array.isArray(t)?this.noteContext&&t.includes(this.noteContext.ntxId):this.noteContext&&this.noteContext.ntxId===t}isActiveNoteContext(){return i.default.tabManager.getActiveContext()===this.noteContext}isNote(t){return this.noteId===t}get note(){return this.noteContext?.note}get noteId(){return this.note?.noteId}get notePath(){return this.noteContext?.notePath}get hoistedNoteId(){return this.noteContext?.hoistedNoteId}get ntxId(){return this.noteContext?.ntxId}isEnabled(){return!!this.note}async refresh(){this.isEnabled()?(this.toggleInt(!0),await this.refreshWithNote(this.note)):this.toggleInt(!1)}async refreshWithNote(t){}async noteSwitchedEvent({noteContext:t,notePath:e}){t.notePath===e&&await this.noteSwitched()}async noteSwitched(){await this.refresh()}async activeContextChangedEvent({noteContext:t}){this.noteContext=t,await this.activeContextChanged()}async activeContextChanged(){await this.refresh()}async noteSwitchedAndActivatedEvent({noteContext:t,notePath:e}){this.noteContext=t,this.notePath===e&&await this.refresh()}setNoteContextEvent({noteContext:t}){this.noteContext=t}async noteTypeMimeChangedEvent({noteId:t}){this.isNote(t)&&await this.refresh()}async frocaReloadedEvent(){await this.refresh()}}const a=s},1698:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var o=n(2503);class i extends o.Z{get widgetTitle(){return"Untitled widget"}get widgetButtons(){return[]}get help(){return{}}constructor(){super(),this.child(...this.widgetButtons)}doRender(){this.$widget=$('\n<div class="card widget">\n    <div class="card-header">\n        <div class="card-header-title"></div>\n        <div class="card-header-buttons"></div>\n    </div>\n\n    <div id="[to be set]" class="body-wrapper">\n        <div class="card-body"></div>\n    </div>\n</div>'),this.contentSized(),this.$widget.find("[data-target]").attr("data-target",`#${this.componentId}`),this.$bodyWrapper=this.$widget.find(".body-wrapper"),this.$bodyWrapper.attr("id",this.componentId),this.$body=this.$bodyWrapper.find(".card-body"),this.$title=this.$widget.find(".card-header .card-header-title"),this.$title.text(this.widgetTitle),this.$buttons=this.$widget.find(".card-header .card-header-buttons"),this.$buttons.empty();for(const t of this.children)this.$buttons.append(t.render());this.initialized=this.doRenderBody()}async doRenderBody(){}}const s=i},2298:t=>{"use strict";t.exports=require("electron")}},__webpack_module_cache__={},inProgress,dataWebpackPrefix;function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var n=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t](n,n.exports,__webpack_require__),n.exports}__webpack_require__.m=__webpack_modules__,__webpack_require__.d=(t,e)=>{for(var n in e)__webpack_require__.o(e,n)&&!__webpack_require__.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},__webpack_require__.f={},__webpack_require__.e=t=>Promise.all(Object.keys(__webpack_require__.f).reduce(((e,n)=>(__webpack_require__.f[n](t,e),e)),[])),__webpack_require__.u=t=>t+".js",__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),inProgress={},dataWebpackPrefix="trilium:",__webpack_require__.l=(t,e,n,o)=>{if(inProgress[t])inProgress[t].push(e);else{var i,s;if(void 0!==n)for(var a=document.getElementsByTagName("script"),r=0;r<a.length;r++){var d=a[r];if(d.getAttribute("src")==t||d.getAttribute("data-webpack")==dataWebpackPrefix+n){i=d;break}}i||(s=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,__webpack_require__.nc&&i.setAttribute("nonce",__webpack_require__.nc),i.setAttribute("data-webpack",dataWebpackPrefix+n),i.src=t),inProgress[t]=[e];var l=(e,n)=>{i.onerror=i.onload=null,clearTimeout(c);var o=inProgress[t];if(delete inProgress[t],i.parentNode&&i.parentNode.removeChild(i),o&&o.forEach((t=>t(n))),e)return e(n)},c=setTimeout(l.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=l.bind(null,i.onerror),i.onload=l.bind(null,i.onload),s&&document.head.appendChild(i)}},__webpack_require__.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},__webpack_require__.p="assets/v0.62.4/app-dist/",(()=>{var t={8:0,586:0};__webpack_require__.f.j=(e,n)=>{var o=__webpack_require__.o(t,e)?t[e]:void 0;if(0!==o)if(o)n.push(o[2]);else{var i=new Promise(((n,i)=>o=t[e]=[n,i]));n.push(o[2]=i);var s=__webpack_require__.p+__webpack_require__.u(e),a=new Error;__webpack_require__.l(s,(n=>{if(__webpack_require__.o(t,e)&&(0!==(o=t[e])&&(t[e]=void 0),o)){var i=n&&("load"===n.type?"missing":n.type),s=n&&n.target&&n.target.src;a.message="Loading chunk "+e+" failed.\n("+i+": "+s+")",a.name="ChunkLoadError",a.type=i,a.request=s,o[1](a)}}),"chunk-"+e,e)}};var e=(e,n)=>{var o,i,[s,a,r]=n,d=0;if(s.some((e=>0!==t[e]))){for(o in a)__webpack_require__.o(a,o)&&(__webpack_require__.m[o]=a[o]);r&&r(__webpack_require__)}for(e&&e(n);d<s.length;d++)i=s[d],__webpack_require__.o(t,i)&&t[i]&&t[i][0](),t[i]=0},n=global.webpackChunktrilium=global.webpackChunktrilium||[];n.forEach(e.bind(null,0)),n.push=e.bind(null,n.push.bind(n))})();var __webpack_exports__={};(()=>{"use strict";var t=__webpack_require__(2817),e=__webpack_require__(1167);class n extends e.Z{doRender(){this.$widget=$("<div>"),this.renderChildren()}renderChildren(){for(const t of this.children)this.$widget.append(t.render())}}class o extends n{constructor(t){if(super(),!t||!["row","column"].includes(t))throw new Error(`Direction argument given as '${t}', use either 'row' or 'column'`);this.attrs.style=`display: flex; flex-direction: ${t};`}}var i=__webpack_require__(2503),s=__webpack_require__(2040),a=__webpack_require__(1736),r=__webpack_require__(1902),d=__webpack_require__(8159),l=__webpack_require__(1065);class c extends i.Z{constructor(){super(),this.spacedUpdate=new r.Z((async()=>{const t=this.$noteTitle.val();s.Z.touchProtectedSessionIfNecessary(this.note),await a.Z.put(`notes/${this.noteId}/title`,{title:t},this.componentId)})),this.deleteNoteOnEscape=!1,t.default.addBeforeUnloadListener(this)}doRender(){this.$widget=$('\n<div class="note-title-widget">\n    <style>\n    .note-title-widget {\n        flex-grow: 1000;\n        height: 100%;\n    }\n    \n    .note-title-widget input.note-title {\n        font-size: 180%;\n        border: 0;\n        min-width: 5em;\n        width: 100%;\n    }\n    \n    .note-title-widget input.note-title.protected {\n        text-shadow: 4px 4px 4px var(--muted-text-color);\n    }\n    </style>\n\n    <input autocomplete="off" value="" placeholder="输入笔记标题..." class="note-title" tabindex="100">\n</div>'),this.$noteTitle=this.$widget.find(".note-title"),this.$noteTitle.on("input",(()=>this.spacedUpdate.scheduleUpdate())),this.$noteTitle.on("blur",(()=>{this.spacedUpdate.updateNowIfNecessary(),this.deleteNoteOnEscape=!1})),l.Z.bindElShortcut(this.$noteTitle,"esc",(()=>{this.deleteNoteOnEscape&&this.noteContext.isActive()&&d.Z.deleteNotes(Object.values(this.noteContext.note.parentToBranch))})),l.Z.bindElShortcut(this.$noteTitle,"return",(()=>{this.triggerCommand("focusOnDetail",{ntxId:this.noteContext.ntxId})}))}async refreshWithNote(t){const e=t.isProtected&&!s.Z.isProtectedSessionAvailable()||["_lbRoot","_lbAvailableLaunchers","_lbVisibleLaunchers"].includes(t.noteId)||"default"!==this.noteContext.viewScope.viewMode;this.$noteTitle.val(e?await this.noteContext.getNavigationTitle():t.title),this.$noteTitle.prop("readonly",e),this.setProtectedStatus(t)}setProtectedStatus(t){this.$noteTitle.toggleClass("protected",!!t.isProtected)}async beforeNoteSwitchEvent({noteContext:t}){this.isNoteContext(t.ntxId)&&await this.spacedUpdate.updateNowIfNecessary()}async beforeNoteContextRemoveEvent({ntxIds:t}){this.isNoteContext(t)&&await this.spacedUpdate.updateNowIfNecessary()}focusOnTitleEvent(){this.noteContext&&this.noteContext.isActive()&&this.$noteTitle.trigger("focus")}focusAndSelectTitleEvent({isNewNote:t}={isNewNote:!1}){this.noteContext&&this.noteContext.isActive()&&(this.$noteTitle.trigger("focus").trigger("select"),this.deleteNoteOnEscape=t)}entitiesReloadedEvent({loadResults:t}){t.isNoteReloaded(this.noteId)&&this.setProtectedStatus(this.note),t.isNoteReloaded(this.noteId,this.componentId)&&this.refresh()}beforeUnloadEvent(){return this.spacedUpdate.isAllSavedAndTriggerUpdate()}}var h=__webpack_require__(6707),p=__webpack_require__(6604),u=__webpack_require__(8181),g=__webpack_require__(1412);const m={addLabel:async function(t,e,n=""){await a.Z.put(`notes/${t}/attribute`,{type:"label",name:e,value:n})},setLabel:async function(t,e,n=""){await a.Z.put(`notes/${t}/set-attribute`,{type:"label",name:e,value:n})},removeAttributeById:async function(t,e){await a.Z.remove(`notes/${t}/attributes/${e}`)},isAffecting:function(t,e){if(!e||!t)return!1;const n=g.default.notes[t.noteId];if(!n)return!1;const o=[e,...e.getNotesToInheritAttributesFrom()];for(const t of o)if(t.noteId===n.noteId)return!0;if(this.isInheritable)for(const t of o)if(t.hasAncestor(n.noteId,!0))return!0;return!1}};var f=__webpack_require__(1375),b=__webpack_require__(9046);async function w(e,n,o={}){const i=t.default.tabManager.getActiveContextNoteId();let s=await a.Z.get(`autocomplete?query=${encodeURIComponent(e)}&activeNoteId=${i}`);e.trim().length>=1&&o.allowCreatingNotes&&(s=[{action:"create-note",noteTitle:e,parentNoteId:i||"root",highlightedNotePathTitle:`创建并关联子笔记 "${b.default.escapeHtml(e)}"`}].concat(s)),e.match(/^[a-z]+:\/\/.+/i)&&o.allowExternalLinks&&(s=[{action:"external-link",externalLink:e,highlightedNotePathTitle:`插入外部链接到 "${b.default.escapeHtml(e)}"`}].concat(s)),n(s)}function y(t){b.default.isMobile()||(t.setSelectedNotePath(""),t.autocomplete("val","").trigger("change"))}function x(t){if(b.default.isMobile())return;t.setSelectedNotePath(""),t.autocomplete("val",""),t.trigger("focus");const e=$.Event("keydown");e.which=40,t.trigger(e)}const v=async function(t){return await new Promise(((e,n)=>{w(t,(t=>{e(t.map((t=>({action:t.action,noteTitle:t.noteTitle,id:`@${t.notePathTitle}`,name:t.notePathTitle,link:`#${t.notePath}`,notePath:t.notePath,highlightedNotePathTitle:t.highlightedNotePathTitle}))))}),{allowCreatingNotes:!0})}))},I=function(e,n){if(e.hasClass("note-autocomplete-input")||b.default.isMobile())return e.off("autocomplete:noteselected"),e;n=n||{},e.addClass("note-autocomplete-input");const o=$("<a>").addClass("input-group-text input-clearer-button bx bxs-tag-x").prop("title","清空文字"),i=$("<a>").addClass("input-group-text show-recent-notes-button bx bx-time").prop("title","显示最近笔记"),s=$("<a>").addClass("input-group-text go-to-selected-note-button bx bx-arrow-to-right"),a=$("<div>").addClass("input-group-append").append(o).append(i);n.hideGoToSelectedNoteButton||a.append(s),e.after(a),o.on("click",(()=>y(e))),i.on("click",(t=>(x(e),!1)));let r={};return n.container&&(r.dropdownMenuContainer=n.container,r.debug=!0),e.autocomplete({...r,appendTo:document.querySelector("body"),hint:!1,autoselect:!0,openOnFocus:!1,minLength:0,tabAutocomplete:!1},[{source:(t,e)=>w(t,e,n),displayKey:"notePathTitle",templates:{suggestion:t=>t.highlightedNotePathTitle},cache:!1}]),e.on("autocomplete:selected",(async(n,o)=>{if("external-link"===o.action)return e.setSelectedNotePath(null),e.setSelectedExternalLink(o.externalLink),e.autocomplete("val",o.externalLink),e.autocomplete("close"),void e.trigger("autocomplete:externallinkselected",[o]);if("create-note"===o.action){const{success:e,noteType:n,templateNoteId:i}=await u.Z.chooseNoteType();if(!e)return;const{note:s}=await u.Z.createNote(o.parentNoteId,{title:o.noteTitle,activate:!1,type:n,templateNoteId:i}),a=t.default.tabManager.getActiveContext()?.hoistedNoteId;o.notePath=s.getBestNotePathString(a)}e.setSelectedNotePath(o.notePath),e.setSelectedExternalLink(null),e.autocomplete("val",o.noteTitle),e.autocomplete("close"),e.trigger("autocomplete:noteselected",[o])})),e.on("autocomplete:closed",(()=>{e.val().trim()||y(e)})),e.on("autocomplete:opened",(()=>{e.attr("readonly")&&e.autocomplete("close")})),e.off("autocomplete:noteselected"),e};class C extends i.Z{static getType(){}doRender(){return this.contentSized(),super.doRender()}async doRefresh(t){}async refresh(){this.constructor.getType()!==await this.parent.getWidgetType()?(this.toggleInt(!1),this.cleanup()):(this.toggleInt(!0),await this.doRefresh(this.note),this.triggerEvent("noteDetailRefreshed",{ntxId:this.noteContext.ntxId}))}isActive(){return this.$widget.is(":visible")&&this.noteContext?.ntxId===t.default.tabManager.activeNtxId}getData(){}focus(){}async readOnlyTemporarilyDisabledEvent({noteContext:t}){this.isNoteContext(t.ntxId)&&(await this.refresh(),this.focus())}handleEventInChildren(t,e){return["activeContextChanged","setNoteContext"].includes(t)?super.handleEventInChildren("setNoteContext",e):"entitiesReloaded"===t?super.handleEventInChildren(t,e):Promise.resolve()}}var N=__webpack_require__(9692),k=__webpack_require__(4378);const S=[{default:!0,title:"纯文本",mime:"text/plain"},{title:"APL",mime:"text/apl"},{title:"ASN.1",mime:"text/x-ttcn-asn"},{title:"ASP.NET",mime:"application/x-aspx"},{title:"Asterisk",mime:"text/x-asterisk"},{title:"Brainfuck",mime:"text/x-brainfuck"},{default:!0,title:"C",mime:"text/x-csrc"},{default:!0,title:"C#",mime:"text/x-csharp"},{default:!0,title:"C++",mime:"text/x-c++src"},{title:"Clojure",mime:"text/x-clojure"},{title:"ClojureScript",mime:"text/x-clojurescript"},{title:"Closure Stylesheets (GSS)",mime:"text/x-gss"},{title:"CMake",mime:"text/x-cmake"},{title:"Cobol",mime:"text/x-cobol"},{title:"CoffeeScript",mime:"text/coffeescript"},{title:"Common Lisp",mime:"text/x-common-lisp"},{title:"CQL",mime:"text/x-cassandra"},{title:"Crystal",mime:"text/x-crystal"},{default:!0,title:"CSS",mime:"text/css"},{title:"Cypher",mime:"application/x-cypher-query"},{title:"Cython",mime:"text/x-cython"},{title:"D",mime:"text/x-d"},{title:"Dart",mime:"application/dart"},{title:"diff",mime:"text/x-diff"},{title:"Django",mime:"text/x-django"},{title:"Dockerfile",mime:"text/x-dockerfile"},{title:"DTD",mime:"application/xml-dtd"},{title:"Dylan",mime:"text/x-dylan"},{title:"EBNF",mime:"text/x-ebnf"},{title:"ECL",mime:"text/x-ecl"},{title:"edn",mime:"application/edn"},{title:"Eiffel",mime:"text/x-eiffel"},{title:"Elm",mime:"text/x-elm"},{title:"Embedded Javascript",mime:"application/x-ejs"},{title:"Embedded Ruby",mime:"application/x-erb"},{title:"Erlang",mime:"text/x-erlang"},{title:"Esper",mime:"text/x-esper"},{title:"F#",mime:"text/x-fsharp"},{title:"Factor",mime:"text/x-factor"},{title:"FCL",mime:"text/x-fcl"},{title:"Forth",mime:"text/x-forth"},{title:"Fortran",mime:"text/x-fortran"},{title:"Gas",mime:"text/x-gas"},{title:"Gherkin",mime:"text/x-feature"},{title:"GitHub风格的Markdown",mime:"text/x-gfm"},{default:!0,title:"Go",mime:"text/x-go"},{default:!0,title:"Groovy",mime:"text/x-groovy"},{title:"HAML",mime:"text/x-haml"},{default:!0,title:"Haskell",mime:"text/x-haskell"},{title:"Haskell (Literate)",mime:"text/x-literate-haskell"},{title:"Haxe",mime:"text/x-haxe"},{default:!0,title:"HTML",mime:"text/html"},{default:!0,title:"HTTP",mime:"message/http"},{title:"HXML",mime:"text/x-hxml"},{title:"IDL",mime:"text/x-idl"},{default:!0,title:"Java",mime:"text/x-java"},{title:"Java服务器页面",mime:"application/x-jsp"},{title:"Jinja2",mime:"text/jinja2"},{default:!0,title:"JS backend",mime:"application/javascript;env=backend"},{default:!0,title:"JS frontend",mime:"application/javascript;env=frontend"},{default:!0,title:"JSON",mime:"application/json"},{title:"JSON-LD",mime:"application/ld+json"},{title:"JSX",mime:"text/jsx"},{title:"Julia",mime:"text/x-julia"},{default:!0,title:"Kotlin",mime:"text/x-kotlin"},{title:"LaTeX",mime:"text/x-latex"},{title:"LESS",mime:"text/x-less"},{title:"LiveScript",mime:"text/x-livescript"},{title:"Lua",mime:"text/x-lua"},{title:"MariaDB SQL",mime:"text/x-mariadb"},{default:!0,title:"Markdown",mime:"text/x-markdown"},{title:"Mathematica",mime:"text/x-mathematica"},{title:"mbox",mime:"application/mbox"},{title:"mIRC",mime:"text/mirc"},{title:"Modelica",mime:"text/x-modelica"},{title:"MS SQL",mime:"text/x-mssql"},{title:"mscgen",mime:"text/x-mscgen"},{title:"msgenny",mime:"text/x-msgenny"},{title:"MUMPS",mime:"text/x-mumps"},{title:"MySQL",mime:"text/x-mysql"},{title:"Nginx",mime:"text/x-nginx-conf"},{title:"NSIS",mime:"text/x-nsis"},{title:"NTriples",mime:"application/n-triples"},{title:"Objective-C",mime:"text/x-objectivec"},{title:"OCaml",mime:"text/x-ocaml"},{title:"Octave",mime:"text/x-octave"},{title:"Oz",mime:"text/x-oz"},{title:"Pascal",mime:"text/x-pascal"},{title:"PEG.js",mime:"null"},{default:!0,title:"Perl",mime:"text/x-perl"},{title:"PGP",mime:"application/pgp"},{default:!0,title:"PHP",mime:"text/x-php"},{title:"Pig",mime:"text/x-pig"},{title:"PLSQL",mime:"text/x-plsql"},{title:"PostgreSQL",mime:"text/x-pgsql"},{title:"PowerShell",mime:"application/x-powershell"},{title:"属性文件",mime:"text/x-properties"},{title:"ProtoBuf",mime:"text/x-protobuf"},{title:"Pug",mime:"text/x-pug"},{title:"Puppet",mime:"text/x-puppet"},{default:!0,title:"Python",mime:"text/x-python"},{title:"Q",mime:"text/x-q"},{title:"R",mime:"text/x-rsrc"},{title:"reStructuredText",mime:"text/x-rst"},{title:"RPM Changes",mime:"text/x-rpm-changes"},{title:"RPM Spec",mime:"text/x-rpm-spec"},{default:!0,title:"Ruby",mime:"text/x-ruby"},{title:"Rust",mime:"text/x-rustsrc"},{title:"SAS",mime:"text/x-sas"},{title:"Sass",mime:"text/x-sass"},{title:"Scala",mime:"text/x-scala"},{title:"Scheme",mime:"text/x-scheme"},{title:"SCSS",mime:"text/x-scss"},{default:!0,title:"Shell (bash)",mime:"text/x-sh"},{title:"Sieve",mime:"application/sieve"},{title:"Slim",mime:"text/x-slim"},{title:"Smalltalk",mime:"text/x-stsrc"},{title:"Smarty",mime:"text/x-smarty"},{title:"SML",mime:"text/x-sml"},{title:"Solr",mime:"text/x-solr"},{title:"Soy",mime:"text/x-soy"},{title:"SPARQL",mime:"application/sparql-query"},{title:"Spreadsheet",mime:"text/x-spreadsheet"},{default:!0,title:"SQL",mime:"text/x-sql"},{title:"SQLite",mime:"text/x-sqlite"},{default:!0,title:"SQLite (Trilium)",mime:"text/x-sqlite;schema=trilium"},{title:"Squirrel",mime:"text/x-squirrel"},{title:"sTeX",mime:"text/x-stex"},{title:"Stylus",mime:"text/x-styl"},{default:!0,title:"Swift",mime:"text/x-swift"},{title:"SystemVerilog",mime:"text/x-systemverilog"},{title:"Tcl",mime:"text/x-tcl"},{title:"Textile",mime:"text/x-textile"},{title:"TiddlyWiki ",mime:"text/x-tiddlywiki"},{title:"Tiki wiki",mime:"text/tiki"},{title:"TOML",mime:"text/x-toml"},{title:"Tornado",mime:"text/x-tornado"},{title:"troff",mime:"text/troff"},{title:"TTCN",mime:"text/x-ttcn"},{title:"TTCN_CFG",mime:"text/x-ttcn-cfg"},{title:"Turtle",mime:"text/turtle"},{title:"Twig",mime:"text/x-twig"},{title:"TypeScript",mime:"application/typescript"},{title:"TypeScript-JSX",mime:"text/typescript-jsx"},{title:"VB.NET",mime:"text/x-vb"},{title:"VBScript",mime:"text/vbscript"},{title:"Velocity",mime:"text/velocity"},{title:"Verilog",mime:"text/x-verilog"},{title:"VHDL",mime:"text/x-vhdl"},{title:"Vue.js部件",mime:"text/x-vue"},{title:"Web IDL",mime:"text/x-webidl"},{default:!0,title:"XML",mime:"text/xml"},{title:"XQuery",mime:"application/xquery"},{title:"xu",mime:"text/x-xu"},{title:"Yacas",mime:"text/x-yacas"},{default:!0,title:"YAML",mime:"text/x-yaml"},{title:"Z80",mime:"text/x-z80"}];let T=null;function E(){T=JSON.parse(JSON.stringify(S));const t=k.Z.getJson("codeNotesMimeTypes")||S.filter((t=>t.default)).map((t=>t.mime));for(const e of T)e.enabled=t.includes(e.mime)||"text/plain"===e.mime}const A={getMimeTypes:async function(){return null===T&&E(),T},loadMimeTypes:E};var _=__webpack_require__(7844),P=__webpack_require__(5913);class R extends C{setupImageOpening(t){this.$widget.on("dblclick","img",(t=>this.openImageInCurrentTab($(t.target)))),this.$widget.on("click","img",(e=>{const n=1===e.which,o=2===e.which,i=b.default.isCtrlKey(e);n&&i||o?this.openImageInNewTab($(e.target)):n&&t&&this.openImageInCurrentTab($(e.target))}))}async openImageInCurrentTab(e){const{noteId:n,viewScope:o}=await this.parseFromImage(e);n?t.default.tabManager.getActiveContext().setNote(n,{viewScope:o}):window.open(e.prop("src"),"_blank")}openImageInNewTab(e){const{noteId:n,viewScope:o}=this.parseFromImage(e);n?t.default.tabManager.openTabWithNoteWithHoisting(n,{viewScope:o}):window.open(e.prop("src"),"_blank")}async parseFromImage(t){const e=t.prop("src"),n=e.match(/\/api\/images\/([A-Za-z0-9_]+)\//);if(n)return{noteId:n[1],viewScope:{}};const o=e.match(/\/api\/attachments\/([A-Za-z0-9_]+)\/image\//);if(o){const t=o[1];return{noteId:(await g.default.getAttachment(t)).ownerId,viewScope:{viewMode:"attachments",attachmentId:t}}}return null}async loadIncludedNote(t,e){const n=await g.default.getNote(t);if(n){const t=$('<div class="include-note-wrapper">'),o=await _.Z.createLink(n.noteId,{showTooltip:!1});t.empty().append($('<h4 class="include-note-title">').append(o));const{$renderedContent:i,type:s}=await P.Z.getRenderedContent(n);t.append($(`<div class="include-note-content type-${s}">`).append(i)),e.empty().append(t)}}async loadReferenceLinkTitle(t,e=null){await _.Z.loadReferenceLinkTitle(t,e)}refreshIncludedNote(t,e){t&&t.find(`section[data-note-id="${e}"]`).each(((t,n)=>{this.loadIncludedNote(e,$(n))}))}}var M=__webpack_require__(3152);const Z={feeds:[{marker:"@",feed:t=>v(t),itemRenderer:t=>{const e=document.createElement("button");return e.innerHTML=`${t.highlightedNotePathTitle} `,e},minimumCharacters:0}]};var L=__webpack_require__(5489),D=__webpack_require__(1801),B=__webpack_require__(6885);const O=function(t){try{t.attr("contenteditable","true"),function(t){const e=window.getSelection(),n=document.createRange();n.selectNodeContents(t),e.removeAllRanges(),e.addRange(n)}(t.get(0)),document.execCommand("copy")?B.default.showMessage("Image copied to the clipboard"):B.default.showAndLogError("Could not copy the image to clipboard.")}finally{window.getSelection().removeAllRanges(),t.removeAttr("contenteditable")}};var F=__webpack_require__(5437);const W=function({$el:t,attributeType:e,open:n}){t.hasClass("aa-input")||(t.autocomplete({appendTo:document.querySelector("body"),hint:!1,openOnFocus:!0,minLength:0,tabAutocomplete:!1},[{displayKey:"name",cache:!1,source:async(t,n)=>{const o="function"==typeof e?e():e;n((await a.Z.get(`attribute-names/?type=${o}&query=${encodeURIComponent(t)}`)).map((t=>({name:t}))))}}]),t.on("autocomplete:opened",(()=>{t.attr("readonly")&&t.autocomplete("close")}))),n&&t.autocomplete("open")},z=[["Arrow",{location:1,id:"arrow",length:14,foldback:.8}],["Label",{label:"",id:"label",cssClass:"connection-label"}]],H=[["Arrow",{location:1,id:"arrow",length:14,foldback:.8}],["Label",{label:"",id:"label",cssClass:"connection-label"}],["Arrow",{location:0,id:"arrow2",length:14,direction:-1,foldback:.8}]],U=[["Arrow",{location:1,id:"arrow",length:14,foldback:.8}],["Label",{label:"",location:.2,id:"label-source",cssClass:"connection-label"}],["Label",{label:"",location:.8,id:"label-target",cssClass:"connection-label"}],["Arrow",{location:0,id:"arrow2",length:14,direction:-1,foldback:.8}]],j=[["Arrow",{location:1,id:"arrow",length:14,foldback:.8}]];let q=1;function V(t,e,n=!1){let o,i,s,a,r;function d(){const l=Date.now()-a;l<e&&l>=0?o=setTimeout(d,e-l):(o=null,n||(r=t.apply(s,i),s=i=null))}null==e&&(e=100);const l=function(){s=this,i=arguments,a=Date.now();const l=n&&!o;return o||(o=setTimeout(d,e)),l&&(r=t.apply(s,i),s=i=null),r};return l.clear=function(){o&&(clearTimeout(o),o=null)},l.flush=function(){o&&(r=t.apply(s,i),s=i=null,clearTimeout(o),o=null)},l}V.debounce=V;const K=V,{sleep:J}=b.default;var G=__webpack_require__(7336),Y=__webpack_require__(3968),Q=__webpack_require__(592);const X=b.default.escapeHtml;class tt extends i.Z{constructor(t){super(),this.widgetMode=t}doRender(){this.$widget=$('<div class="note-map-widget" style="position: relative;">\n    <style>\n        .note-detail-note-map {\n            height: 100%;\n            overflow: hidden;\n        }\n        \n        .map-type-switcher {\n            position: absolute; \n            top: 10px; \n            left: 10px; \n            z-index: 10; /* should be below dropdown (note actions) */\n        }\n        \n        .map-type-switcher button.bx {\n            font-size: 130%;\n            padding: 1px 10px 1px 10px;\n        }\n    </style>\n    \n    <div class="btn-group btn-group-sm map-type-switcher" role="group">\n      <button type="button" class="btn bx bx-network-chart" title="链接地图" data-type="link"></button>\n      <button type="button" class="btn bx bx-sitemap" title="树形图" data-type="tree"></button>\n    </div>\n\n    <div class="style-resolver"></div>\n\n    <div class="note-map-container"></div>\n</div>');const t=window.getComputedStyle(document.documentElement);this.themeStyle=t.getPropertyValue("--theme-style")?.trim(),this.$container=this.$widget.find(".note-map-container"),this.$styleResolver=this.$widget.find(".style-resolver"),new ResizeObserver((()=>this.setDimensions())).observe(this.$container[0]),this.$widget.find(".map-type-switcher button").on("click",(async t=>{const e=$(t.target).closest("button").attr("data-type");await m.setLabel(this.noteId,"mapType",e)})),super.doRender()}setDimensions(){if(!this.graph)return;const t=this.$widget.parent();this.graph.height(t.height()).width(t.width())}async refreshWithNote(e){this.$widget.show(),this.css={fontFamily:this.$container.css("font-family"),textColor:this.rgb2hex(this.$container.css("color")),mutedTextColor:this.rgb2hex(this.$styleResolver.css("color"))},this.mapType="tree"===this.note.getLabelValue("mapType")?"tree":"link",await h.Z.requireLibrary(h.Z.FORCE_GRAPH),this.graph=ForceGraph()(this.$container[0]).width(this.$container.width()).height(this.$container.height()).onZoom((t=>this.setZoomLevel(t.k))).d3AlphaDecay(.01).d3VelocityDecay(.08).nodeCanvasObject(((t,e)=>this.paintNode(t,this.getColorForNode(t),e))).nodePointerAreaPaint(((t,e)=>this.paintNode(t,this.getColorForNode(t),e))).nodePointerAreaPaint(((t,e,n)=>{n.fillStyle=e,n.beginPath(),n.arc(t.x,t.y,this.noteIdToSizeMap[t.id],0,2*Math.PI,!1),n.fill()})).nodeLabel((t=>X(t.name))).maxZoom(7).warmupTicks(30).linkDirectionalArrowLength(5).linkDirectionalArrowRelPos(1).linkWidth(1).linkColor((()=>this.css.mutedTextColor)).onNodeClick((e=>t.default.tabManager.getActiveContext().setNote(e.id))).onNodeRightClick(((t,e)=>Q.Z.openContextMenu(t.id,e))),"link"===this.mapType&&this.graph.linkLabel((t=>`${X(t.source.name)} - <strong>${X(t.name)}</strong> - ${X(t.target.name)}`)).linkCanvasObject(((t,e)=>this.paintLink(t,e))).linkCanvasObjectMode((()=>"after"));const n=this.getMapRootNoteId(),o=await this.loadNotesAndRelations(n),i=o.nodes.length/o.links.length,s=-20/Math.pow(i,1.5),a=Math.min(-3,s);this.graph.d3Force("link").distance(40),this.graph.d3Force("center").strength(.2),this.graph.d3Force("charge").strength(a),this.graph.d3Force("charge").distanceMax(1e3),this.renderData(o)}getMapRootNoteId(){if("ribbon"===this.widgetMode)return this.noteId;let e=this.note.getLabelValue("mapRootNoteId");return"hoisted"===e?e=Y.Z.getHoistedNoteId():e||(e=t.default.tabManager.getActiveContext().parentNoteId),e}getColorForNode(t){return t.color?t.color:"ribbon"===this.widgetMode&&t.id===this.noteId?"red":this.generateColorFromString(t.type)}generateColorFromString(t){"dark"===this.themeStyle&&(t=`0${t}`);let e=0;for(let n=0;n<t.length;n++)e=t.charCodeAt(n)+((e<<5)-e);let n="#";for(let t=0;t<3;t++)n+=`00${(e>>8*t&255).toString(16)}`.substr(-2);return n}rgb2hex(t){return`#${t.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map((t=>parseInt(t,10).toString(16).padStart(2,"0"))).join("")}`}setZoomLevel(t){this.zoomLevel=t}paintNode(t,e,n){const{x:o,y:i}=t,s=this.noteIdToSizeMap[t.id];if(n.fillStyle=e,n.beginPath(),n.arc(o,i,s,0,2*Math.PI,!1),n.fill(),!(this.zoomLevel>2||this.zoomLevel>1&&s>6||this.zoomLevel>.3&&s>10))return;n.fillStyle=this.css.textColor,n.font=`${s}px ${this.css.fontFamily}`,n.textAlign="center",n.textBaseline="middle";let a=t.name;a.length>15&&(a=`${a.substr(0,15)}...`),n.fillText(a,o,i+Math.round(1.5*s))}paintLink(t,e){if(this.zoomLevel<5)return;e.font=`3px ${this.css.fontFamily}`,e.textAlign="center",e.textBaseline="middle",e.fillStyle=this.css.mutedTextColor;const{source:n,target:o}=t,i=(n.x+o.x)/2,s=(n.y+o.y)/2;e.save(),e.translate(i,s);const a=n.y-o.y,r=n.x-o.x;let d=Math.atan2(a,r),l=2;(d<-Math.PI/2||d>Math.PI/2)&&(d+=Math.PI,l=-2),e.rotate(d),e.fillText(t.name,0,l),e.restore()}async loadNotesAndRelations(t){const e=await a.Z.post(`note-map/${t}/${this.mapType}`);this.calculateNodeSizes(e);const n=this.getGroupedLinks(e.links);return this.nodes=e.notes.map((([t,e,n,o])=>({id:t,name:e,type:n,color:o}))),{nodes:this.nodes,links:n.map((t=>({id:`${t.sourceNoteId}-${t.targetNoteId}`,source:t.sourceNoteId,target:t.targetNoteId,name:t.names.join(", ")})))}}getGroupedLinks(t){const e={};for(const n of t){const t=`${n.sourceNoteId}-${n.targetNoteId}`;t in e?e[t].names.includes(n.name)||e[t].names.push(n.name):e[t]={id:t,sourceNoteId:n.sourceNoteId,targetNoteId:n.targetNoteId,names:[n.name]}}return Object.values(e)}calculateNodeSizes(t){if(this.noteIdToSizeMap={},"tree"===this.mapType){const{noteIdToDescendantCountMap:e}=t;for(const t in e){this.noteIdToSizeMap[t]=4;const n=e[t];n>0&&(this.noteIdToSizeMap[t]+=1+Math.round(Math.log(n)/Math.log(1.5)))}}else if("link"===this.mapType){const e={};for(const n of t.links)e[n.targetNoteId]=1+(e[n.targetNoteId]||0);for(const[n]of t.notes)this.noteIdToSizeMap[n]=4,n in e&&(this.noteIdToSizeMap[n]+=Math.min(Math.pow(e[n],.5),15))}}renderData(t){this.graph.graphData(t),"ribbon"===this.widgetMode&&"search"!==this.note?.type?setTimeout((()=>{this.setDimensions();const e=this.getSubGraphConnectedToCurrentNote(t);this.graph.zoomToFit(400,50,(t=>e.has(t.id))),e.size<30&&this.graph.d3VelocityDecay(.4)}),1e3):t.nodes.length>1&&setTimeout((()=>{this.setDimensions();const e=this.getNoteIdsWithLinks(t);e.size>0&&this.graph.zoomToFit(400,30,(t=>e.has(t.id))),e.size<30&&this.graph.d3VelocityDecay(.4)}),1e3)}getNoteIdsWithLinks(t){const e=new Set;for(const n of t.links)e.add(n.source.id),e.add(n.target.id);return e}getSubGraphConnectedToCurrentNote(t){function e(t,e){const n={};for(const o of t){const t=o[e].id;n[t]=n[t]||[],n[t].push(o)}return n}const n=e(t.links,"source"),o=e(t.links,"target"),i=new Set;return function t(e){if(!i.has(e)){i.add(e);for(const o of n[e]||[])t(o.target.id);for(const n of o[e]||[])t(n.source.id)}}(this.noteId),i}cleanup(){this.$container.html("")}entitiesReloadedEvent({loadResults:t}){t.getAttributeRows(this.componentId).find((t=>"label"===t.type&&["mapType","mapRootNoteId"].includes(t.name)&&m.isAffecting(t,this.note)))&&this.refresh()}}class et extends i.Z{constructor(){super(),this.contentSized()}async updateOption(t,e){const n={[t]:e};await this.updateMultipleOptions(n)}async updateMultipleOptions(t){await a.Z.put("options",t),this.showUpdateNotification()}showUpdateNotification(){B.default.showPersistent({id:"options-change-saved",title:"选项状态",message:"选项更改已保存.",icon:"slider",closeAfter:2e3})}async updateCheckboxOption(t,e){const n=e.prop("checked");return await this.updateOption(t,n?"true":"false")}setCheckboxState(t,e){t.prop("checked","true"===e)}optionsLoaded(t){}async refreshWithNote(t){const e=await a.Z.get("options");this.optionsLoaded(e)}async entitiesReloadedEvent({loadResults:t}){t.getOptionNames().length>0&&this.refresh()}}const nt=[{value:"theme",label:"Theme defined"},{value:"serif",label:"Serif"},{value:"sans-serif",label:"Sans Serif"},{value:"monospace",label:"Monospace"},{value:"Arial",label:"Arial"},{value:"Verdana",label:"Verdana"},{value:"Helvetica",label:"Helvetica"},{value:"Tahoma",label:"Tahoma"},{value:"Trebuchet MS",label:"Trebuchet MS"},{value:"Times New Roman",label:"Times New Roman"},{value:"Georgia",label:"Georgia"},{value:"Garamond",label:"Garamond"},{value:"Courier New",label:"Courier New"},{value:"Brush Script MT",label:"Brush Script MT"},{value:"Impact",label:"Impact"},{value:"American Typewriter",label:"American Typewriter"},{value:"Andalé Mono",label:"Andalé Mono"},{value:"Lucida Console",label:"Lucida Console"},{value:"Monaco",label:"Monaco"},{value:"Bradley Hand",label:"Bradley Hand"},{value:"Luminari",label:"Luminari"},{value:"Comic Sans MS",label:"Comic Sans MS"},{value:"Microsoft YaHei",label:"Microsoft YaHei"}];let ot,it=1;const st={Bing:"https://www.bing.com/search?q={keyword}",Baidu:"https://www.baidu.com/s?wd={keyword}",DuckDuckGo:"https://duckduckgo.com/?q={keyword}",Google:"https://www.google.com/search?q={keyword}"};class at extends i.Z{doRender(){this.$widget=$('<div style="height: 100%; display: flex; flex-direction: column;">\n    <style>\n        .backend-log-textarea {\n            flex-grow: 1; \n            width: 100%;\n            border: none;\n        }   \n    </style>\n\n    <textarea class="backend-log-textarea" readonly="readonly"></textarea>\n    \n    <div style="display: flex; justify-content: space-around; margin-top: 10px;">\n        <button class="refresh-backend-log-button btn btn-primary">刷新</button>\n    </div>\n</div>'),this.$backendLogTextArea=this.$widget.find(".backend-log-textarea"),this.$refreshBackendLog=this.$widget.find(".refresh-backend-log-button"),this.$refreshBackendLog.on("click",(()=>this.load()))}scrollToBottom(){this.$backendLogTextArea.scrollTop(this.$backendLogTextArea[0].scrollHeight)}async refresh(){await this.load()}async load(){const t=await a.Z.get("backend-log");this.$backendLogTextArea.text(t),this.scrollToBottom()}}const rt={_optionsAppearance:[class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>主题</h4>\n    \n    <div class="form-group row">\n        <div class="col-6">\n            <label>主题</label>\n            <select class="theme-select form-control"></select>\n        </div>\n        \n        <div class="col-6">\n            <label>覆盖主题字体</label>\n            <input type="checkbox" class="override-theme-fonts form-control">\n        </div>\n    </div>\n</div>'),this.$themeSelect=this.$widget.find(".theme-select"),this.$overrideThemeFonts=this.$widget.find(".override-theme-fonts"),this.$themeSelect.on("change",(async()=>{const t=this.$themeSelect.val();await a.Z.put(`options/theme/${t}`),b.default.reloadFrontendApp("theme change")})),this.$overrideThemeFonts.on("change",(()=>this.updateCheckboxOption("overrideThemeFonts",this.$overrideThemeFonts)))}async optionsLoaded(t){const e=[{val:"light",title:"明亮"},{val:"dark",title:"深色"}].concat(await a.Z.get("options/user-themes"));this.$themeSelect.empty();for(const t of e)this.$themeSelect.append($("<option>").attr("value",t.val).attr("data-note-id",t.noteId).text(t.title));this.$themeSelect.val(t.theme),this.setCheckboxState(this.$overrideThemeFonts,t.overrideThemeFonts)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>字体</h4>\n    \n    <h5>主字体</h5>\n    \n    <div class="form-group row">\n        <div class="col-6">\n            <label>字体系列</label>\n            <select class="main-font-family form-control"></select>\n        </div>\n    \n        <div class="col-6">\n            <label>大小</label>\n\n            <div class="input-group">\n                <input type="number" class="main-font-size form-control options-number-input" min="50" max="200" step="10"/>\n                <div class="input-group-append">\n                    <span class="input-group-text">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <h5>笔记树字体</h5>\n\n    <div class="form-group row">\n        <div class="col-4">\n            <label>字体系列</label>\n            <select class="tree-font-family form-control"></select>\n        </div>\n    \n        <div class="col-4">\n            <label>大小</label>\n\n            <div class="input-group">\n                <input type="number" class="tree-font-size form-control options-number-input" min="50" max="200" step="10"/>\n                <div class="input-group-append">\n                    <span class="input-group-text">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n    \n    <h5>笔记详情字体</h5>\n    \n    <div class="form-group row">\n        <div class="col-4">\n            <label>字体系列</label>\n            <select class="detail-font-family form-control"></select>\n        </div>\n        \n        <div class="col-4">\n            <label>大小</label>\n\n            <div class="input-group">\n                <input type="number" class="detail-font-size form-control options-number-input" min="50" max="200" step="10"/>\n                <div class="input-group-append">\n                    <span class="input-group-text">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n    \n    <h5>等宽字体 (代码)</h5>\n    \n    <div class="form-group row">\n        <div class="col-4">\n            <label>字体系列</label>\n            <select class="monospace-font-family form-control"></select>\n        </div>\n    \n        <div class="col-4">\n            <label>大小</label>\n\n            <div class="input-group">\n                <input type="number" class="monospace-font-size form-control options-number-input" min="50" max="200" step="10"/>\n                <div class="input-group-append">\n                    <span class="input-group-text">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <p>注意树和详情字体的大小和主字体大小有关.</p>\n\n    <p>并非所有列出的字体都可以在您的系统上使用.</p>\n    \n    <p>\n        应用字体修改, 请点击 \n        <button class="btn btn-micro reload-frontend-button">重新加载前端</button>\n    </p>\n</div>'),this.$mainFontSize=this.$widget.find(".main-font-size"),this.$mainFontFamily=this.$widget.find(".main-font-family"),this.$treeFontSize=this.$widget.find(".tree-font-size"),this.$treeFontFamily=this.$widget.find(".tree-font-family"),this.$detailFontSize=this.$widget.find(".detail-font-size"),this.$detailFontFamily=this.$widget.find(".detail-font-family"),this.$monospaceFontSize=this.$widget.find(".monospace-font-size"),this.$monospaceFontFamily=this.$widget.find(".monospace-font-family"),this.$widget.find(".reload-frontend-button").on("click",(()=>b.default.reloadFrontendApp("changes from appearance options")))}async optionsLoaded(t){if("true"!==t.overrideThemeFonts)return void this.toggleInt(!1);this.toggleInt(!0),this.$mainFontSize.val(t.mainFontSize),this.fillFontFamilyOptions(this.$mainFontFamily,t.mainFontFamily),this.$treeFontSize.val(t.treeFontSize),this.fillFontFamilyOptions(this.$treeFontFamily,t.treeFontFamily),this.$detailFontSize.val(t.detailFontSize),this.fillFontFamilyOptions(this.$detailFontFamily,t.detailFontFamily),this.$monospaceFontSize.val(t.monospaceFontSize),this.fillFontFamilyOptions(this.$monospaceFontFamily,t.monospaceFontFamily);const e=["mainFontFamily","mainFontSize","treeFontFamily","treeFontSize","detailFontFamily","detailFontSize","monospaceFontFamily","monospaceFontSize"];for(const t of e)this[`$${t}`].on("change",(()=>this.updateOption(t,this[`$${t}`].val())))}fillFontFamilyOptions(t,e){t.empty();for(const{value:n,label:o}of nt)t.append($("<option>").attr("value",n).prop("selected",n===e).text(o))}},class extends et{isEnabled(){return super.isEnabled()&&b.default.isElectron()}doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>缩放系数(仅桌面客户端有效)</h4>\n\n    <input type="number" class="zoom-factor-select form-control options-number-input" min="0.3" max="2.0" step="0.1"/>\n    <p>缩放可以通过 ctrl+- 和 ctrl+= 来控制.</p>\n</div>'),this.$zoomFactorSelect=this.$widget.find(".zoom-factor-select"),this.$zoomFactorSelect.on("change",(()=>{t.default.triggerCommand("setZoomFactorAndSave",{zoomFactor:this.$zoomFactorSelect.val()})}))}async optionsLoaded(t){this.$zoomFactorSelect.val(t.zoomFactor)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>原生标题栏(需要重启)</h4>\n    \n    <select class="native-title-bar-select form-control">\n        <option value="show">启用</option>\n        <option value="hide">禁用</option>\n    </select>\n</div>'),this.$nativeTitleBarSelect=this.$widget.find(".native-title-bar-select"),this.$nativeTitleBarSelect.on("change",(()=>{const t="show"===this.$nativeTitleBarSelect.val()?"true":"false";this.updateOption("nativeTitleBarVisible",t)}))}async optionsLoaded(t){this.$nativeTitleBarSelect.val("true"===t.nativeTitleBarVisible?"show":"hide")}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>内容宽度</h4>\n    \n    <p>Trilium默认会限制内容的最大宽度以提高在宽屏中全屏时的可读性.</p>\n    \n    <div class="form-group row">\n        <div class="col-4">\n            <label>内容最大宽度(像素)</label>\n            <input type="number" min="200" step="10" class="max-content-width form-control options-number-input">\n        </div>\n    </div>\n    \n    <p>\n        应用内容宽度修改, 请点击 \n        <button class="btn btn-micro reload-frontend-button">重新加载前端</button>\n    </p>\n</div>'),this.$maxContentWidth=this.$widget.find(".max-content-width"),this.$maxContentWidth.on("change",(async()=>this.updateOption("maxContentWidth",this.$maxContentWidth.val()))),this.$widget.find(".reload-frontend-button").on("click",(()=>b.default.reloadFrontendApp("changes from appearance options")))}async optionsLoaded(t){this.$maxContentWidth.val(t.maxContentWidth)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>功能选项组件</h4>\n    <label>\n        <input type="checkbox" class="promoted-attributes-open-in-ribbon">\n        如果笔记中存在升级属性，升级属性功能选项卡将自动打开\n    </label>\n    \n    <label>\n        <input type="checkbox" class="edited-notes-open-in-ribbon">\n        日记笔记自动打开编辑过的笔记选项\n    </label>\n</div>'),this.$promotedAttributesOpenInRibbon=this.$widget.find(".promoted-attributes-open-in-ribbon"),this.$promotedAttributesOpenInRibbon.on("change",(()=>this.updateCheckboxOption("promotedAttributesOpenInRibbon",this.$promotedAttributesOpenInRibbon))),this.$editedNotesOpenInRibbon=this.$widget.find(".edited-notes-open-in-ribbon"),this.$editedNotesOpenInRibbon.on("change",(()=>this.updateCheckboxOption("editedNotesOpenInRibbon",this.$editedNotesOpenInRibbon)))}async optionsLoaded(t){this.setCheckboxState(this.$promotedAttributesOpenInRibbon,t.promotedAttributesOpenInRibbon),this.setCheckboxState(this.$editedNotesOpenInRibbon,t.editedNotesOpenInRibbon)}}],_optionsShortcuts:[class extends et{doRender(){this.$widget=$('\n<div class="options-section shortcuts-options-section">\n    <style>\n        .shortcuts-options-section {\n            display: flex; \n            flex-direction: column; \n            height: 100%;\n        }\n    \n        .shortcuts-table-container {\n            overflow: auto; \n            flex-grow: 1; \n            flex-shrink: 1; \n        }    \n        \n        .shortcuts-options-buttons {\n            display: flex; \n            justify-content: space-between;\n            margin: 15px 15px 0 15px;\n        }\n    </style>\n\n    <h4>快捷键</h4>\n    \n    <p>\n      同一操作的多个快捷方式可以用逗号隔开.\n      更多快捷键设置请查看<a href="https://www.electronjs.org/docs/latest/api/accelerator">Electron 文档</a>.\n    </p>\n    \n    <div class="form-group">\n        <input type="text" class="keyboard-shortcut-filter form-control" placeholder="输入关键字过滤快捷键...">\n    </div>\n    \n    <div class="shortcuts-table-container">\n        <table class="keyboard-shortcut-table" cellpadding="10">\n        <thead>\n            <tr>\n                <th>动作名称</th>\n                <th>快捷键</th>\n                <th>默认快捷键</th>\n                <th>描述</th>\n            </tr>\n        </thead>\n        <tbody></tbody>\n        </table>\n    </div>\n    \n    <div class="shortcuts-options-buttons">\n        <button class="options-keyboard-shortcuts-reload-app btn btn-primary">重新加载应用程序以应用更改</button>\n        \n        <button class="options-keyboard-shortcuts-set-all-to-default btn">重置所有快捷键</button>\n    </div>\n</div>'),this.$widget.find(".options-keyboard-shortcuts-reload-app").on("click",(()=>b.default.reloadFrontendApp()));const t=this.$widget.find(".keyboard-shortcut-table tbody");a.Z.get("keyboard-actions").then((e=>{ot=e;for(const n of e){const e=$("<tr>");n.separator?e.append($('<td colspan="4">').attr("style","background-color: var(--accented-background-color); font-weight: bold;").text(n.separator)):e.append($("<td>").text(n.actionName)).append($("<td>").append($('<input type="text" class="form-control">').val(n.effectiveShortcuts.join(", ")).attr("data-keyboard-action-name",n.actionName).attr("data-default-keyboard-shortcuts",n.defaultShortcuts.join(", ")))).append($("<td>").text(n.defaultShortcuts.join(", "))).append($("<td>").text(n.description)),t.append(e)}})),t.on("change","input.form-control",(t=>{const e=this.$widget.find(t.target),n=e.attr("data-keyboard-action-name"),o=e.val().replace("+,","+Comma").split(",").map((t=>t.replace("+Comma","+,"))).filter((t=>!!t)),i=`keyboardShortcuts${n.substr(0,1).toUpperCase()}${n.substr(1)}`;this.updateOption(i,JSON.stringify(o))})),this.$widget.find(".options-keyboard-shortcuts-set-all-to-default").on("click",(async()=>{await M.Z.confirm("确定要重置所有快捷键吗？")&&t.find("input.form-control").each(((t,e)=>{const n=this.$widget.find(e).attr("data-default-keyboard-shortcuts");this.$widget.find(e).val()!==n&&this.$widget.find(e).val(n).trigger("change")}))}));const e=this.$widget.find(".keyboard-shortcut-filter");e.on("keyup",(()=>{const n=e.val().trim().toLowerCase();t.find("tr").each(((t,e)=>{if(!n)return void this.$widget.find(e).show();const o=this.$widget.find(e).find("input").attr("data-keyboard-action-name");if(!o)return void this.$widget.find(e).hide();const i=ot.find((t=>t.actionName===o));i?this.$widget.find(e).toggle(!!(i.actionName.toLowerCase().includes(n)||i.defaultShortcuts.some((t=>t.toLowerCase().includes(n)))||i.effectiveShortcuts.some((t=>t.toLowerCase().includes(n)))||i.description&&i.description.toLowerCase().includes(n))):this.$widget.find(e).hide()}))}))}}],_optionsTextNotes:[class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>标题风格</h4>\n    \n    <select class="heading-style form-control">\n        <option value="plain">纯文本</option>\n        <option value="underline">下划线</option>\n        <option value="markdown">Markdown风格</option>\n    </select>\n</div>'),this.$body=$("body"),this.$headingStyle=this.$widget.find(".heading-style"),this.$headingStyle.on("change",(()=>{const t=this.$headingStyle.val();this.toggleBodyClass("heading-style-",t),this.updateOption("headingStyle",t)}))}async optionsLoaded(t){this.$headingStyle.val(t.headingStyle)}toggleBodyClass(t,e){for(const e of Array.from(this.$body[0].classList))e.startsWith(t)&&this.$body.removeClass(e);this.$body.addClass(t+e)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>目录</h4>\n    \n    当笔记具有超过定义数量的标题时, 目录将出现在文本笔记中. 你可以自定义这个数值:\n    \n    <div class="form-group">\n        <input type="number" class="min-toc-headings form-control options-number-input options-number-input" min="0" max="9999999999999999" step="1" />\n    </div>\n    \n    <p>您可以设置一个非常大的数来禁用目录.</p>\n</div>'),this.$minTocHeadings=this.$widget.find(".min-toc-headings"),this.$minTocHeadings.on("change",(()=>this.updateOption("minTocHeadings",this.$minTocHeadings.val())))}async optionsLoaded(t){this.$minTocHeadings.val(t.minTocHeadings)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>高亮列表</h4>\n\n    <p>您可以自定义在右侧面板显示的高亮列表:</p>\n\n    </div>\n        <label><input type="checkbox" class="highlights-list-check" value="bold"> 粗体字 &nbsp;</label>\n        <label><input type="checkbox" class="highlights-list-check" value="italic"> 斜体字 &nbsp;</label>\n        <label><input type="checkbox" class="highlights-list-check" value="underline"> 下划线字体 &nbsp;</label>\n        <label><input type="checkbox" class="highlights-list-check" value="color"> 彩色字体 &nbsp;</label>\n        <label><input type="checkbox" class="highlights-list-check" value="bgColor"> 带有背景色的字体 &nbsp;</label>\n    </div>\n\n    <br/><br/>\n    <h5>Highlists List visibility</h5>\n\n    <p>您可以通过添加 <code>#hideHighlightWidget</code> 标签来在每个笔记中隐藏高亮小部件。</p>\n</div>'),this.$hlt=this.$widget.find("input.highlights-list-check"),this.$hlt.on("change",(()=>{const t=this.$widget.find('input.highlights-list-check[type="checkbox"]:checked').map((function(){return this.value})).get();this.updateOption("highlightsList",JSON.stringify(t))}))}async optionsLoaded(t){const e=JSON.parse(t.highlightsList);this.$widget.find('input.highlights-list-check[type="checkbox"]').each((function(){-1!==$.inArray($(this).val(),e)?$(this).prop("checked",!0):$(this).prop("checked",!1)}))}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>自动只读大小</h4>\n\n    <p>自动只读大小是指笔记超过设置的大小后自动设置为只读模式(为性能考虑)</p>\n\n    <div class="form-group">\n        <label>自动只读大小 (文字笔记)</label>\n        <input class="auto-readonly-size-text form-control options-number-input" type="number" min="0">\n    </div>\n</div>'),this.$autoReadonlySizeText=this.$widget.find(".auto-readonly-size-text"),this.$autoReadonlySizeText.on("change",(()=>this.updateOption("autoReadonlySizeText",this.$autoReadonlySizeText.val())))}async optionsLoaded(t){this.$autoReadonlySizeText.val(t.autoReadonlySizeText)}}],_optionsCodeNotes:[class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>在代码笔记中使用vim按键绑定(无ex模式)</h4>\n    <label>\n        <input type="checkbox" class="vim-keymap-enabled">\n        启用vim按键绑定\n    </label>\n</div>'),this.$vimKeymapEnabled=this.$widget.find(".vim-keymap-enabled"),this.$vimKeymapEnabled.on("change",(()=>this.updateCheckboxOption("vimKeymapEnabled",this.$vimKeymapEnabled)))}async optionsLoaded(t){this.setCheckboxState(this.$vimKeymapEnabled,t.vimKeymapEnabled)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>代码笔记自动换行</h4>\n    <label>\n        <input type="checkbox" class="line-wrap-enabled">\n        启用自动换行(需要重新加载前端才会生效)\n    </label>\n</div>'),this.$codeLineWrapEnabled=this.$widget.find(".line-wrap-enabled"),this.$codeLineWrapEnabled.on("change",(()=>this.updateCheckboxOption("codeLineWrapEnabled",this.$codeLineWrapEnabled)))}async optionsLoaded(t){this.setCheckboxState(this.$codeLineWrapEnabled,t.codeLineWrapEnabled)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>自动只读大小</h4>\n\n    <p>自动只读大小是指笔记超过设置的大小后自动设置为只读模式(为性能考虑)</p>\n\n    <div class="form-group">\n        <label>自动只读大小 (代码笔记)</label>\n        <input class="auto-readonly-size-code form-control options-number-input" type="number" min="0">\n    </div>\n</div>'),this.$autoReadonlySizeCode=this.$widget.find(".auto-readonly-size-code"),this.$autoReadonlySizeCode.on("change",(()=>this.updateOption("autoReadonlySizeCode",this.$autoReadonlySizeCode.val())))}async optionsLoaded(t){this.$autoReadonlySizeCode.val(t.autoReadonlySizeCode)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>下拉菜单可用的MIME文件类型</h4>\n    \n    <ul class="options-mime-types" style="list-style-type: none;"></ul>\n</div>'),this.$mimeTypes=this.$widget.find(".options-mime-types")}async optionsLoaded(t){this.$mimeTypes.empty();for(const t of await A.getMimeTypes()){const e="code-mime-type-"+it++;this.$mimeTypes.append($("<li>").append($('<input type="checkbox">').attr("id",e).attr("data-mime-type",t.mime).prop("checked",t.enabled)).on("change",(()=>this.save())).append(" &nbsp; ").append($("<label>").attr("for",e).text(t.title)))}}async save(){const t=[];this.$mimeTypes.find("input:checked").each(((e,n)=>t.push(this.$widget.find(n).attr("data-mime-type")))),await this.updateOption("codeNotesMimeTypes",JSON.stringify(t)),A.loadMimeTypes()}}],_optionsImages:[class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <style>\n        .options-section .disabled-field {\n            opacity: 0.5;\n            pointer-events: none;\n        }\n    </style>\n\n    <h4>图片</h4>\n    \n    <label>\n        <input class="download-images-automatically" type="checkbox" name="download-images-automatically">\n        自动下载图片以便于离线使用.\n    </label>\n    \n    <p>(粘贴的HTML可能包含在线图片的引用, Trilium会找到并下载这些图片用于离线使用)</p>\n    \n    <label>\n        <input class="image-compresion-enabled" type="checkbox" name="image-compression-enabled">\n        启用图像压缩\n    </label>\n\n    <div class="image-compression-enabled-wraper">\n        <div class="form-group">\n            <label>图片的最大像素宽度和高度(超过限制会缩放).</label>\n            <input class="image-max-width-height form-control options-number-input" type="number" min="1">\n        </div>\n    \n        <div class="form-group">\n            <label>JPEG质量 (10最低, 100最好, 推荐设置为50-85之间)</label>\n            <input class="image-jpeg-quality form-control options-number-input" min="10" max="100" type="number">\n        </div>\n    </div>\n</div>\n'),this.$imageMaxWidthHeight=this.$widget.find(".image-max-width-height"),this.$imageJpegQuality=this.$widget.find(".image-jpeg-quality"),this.$imageMaxWidthHeight.on("change",(()=>this.updateOption("imageMaxWidthHeight",this.$imageMaxWidthHeight.val()))),this.$imageJpegQuality.on("change",(()=>this.updateOption("imageJpegQuality",this.$imageJpegQuality.val().trim()||"75"))),this.$downloadImagesAutomatically=this.$widget.find(".download-images-automatically"),this.$downloadImagesAutomatically.on("change",(()=>this.updateCheckboxOption("downloadImagesAutomatically",this.$downloadImagesAutomatically))),this.$enableImageCompression=this.$widget.find(".image-compresion-enabled"),this.$imageCompressionWrapper=this.$widget.find(".image-compression-enabled-wraper"),this.$enableImageCompression.on("change",(()=>{this.updateCheckboxOption("compressImages",this.$enableImageCompression),this.setImageCompression()}))}optionsLoaded(t){this.$imageMaxWidthHeight.val(t.imageMaxWidthHeight),this.$imageJpegQuality.val(t.imageJpegQuality),this.setCheckboxState(this.$downloadImagesAutomatically,t.downloadImagesAutomatically),this.setCheckboxState(this.$enableImageCompression,t.compressImages),this.setImageCompression()}setImageCompression(){this.$enableImageCompression.prop("checked")?this.$imageCompressionWrapper.removeClass("disabled-field"):this.$imageCompressionWrapper.addClass("disabled-field")}}],_optionsSpellcheck:[class extends et{doRender(){if(this.$widget=$('\n<div class="options-section">\n    <h4>拼写检查</h4>\n\n    <p>这些选项只在桌面客户端有效, 浏览器会使用浏览器的拼写检查. 修改设置后需要重启应用.</p>\n\n    <label>\n        <input type="checkbox" class="spell-check-enabled">\n        开启拼写检查\n    </label>\n\n    <br/>\n\n    <div class="form-group">\n        <label>语言码</label>\n        <input type="text" class="spell-check-language-code form-control" placeholder="for example &quot;en-US&quot;, &quot;de-AT&quot;">\n    </div>\n\n    <p>多个语言可以用逗号分隔, 例如: <code>en-US, de-DE, cs</code>. 拼写检查选项的修改将在应用程序重新启动后生效.</p>\n    \n    <p><strong>可用的语言代码</strong> <span class="available-language-codes"></span></p>\n</div>'),this.$spellCheckEnabled=this.$widget.find(".spell-check-enabled"),this.$spellCheckLanguageCode=this.$widget.find(".spell-check-language-code"),this.$spellCheckEnabled.on("change",(()=>this.updateCheckboxOption("spellCheckEnabled",this.$spellCheckEnabled))),this.$spellCheckLanguageCode.on("change",(()=>this.updateOption("spellCheckLanguageCode",this.$spellCheckLanguageCode.val()))),this.$availableLanguageCodes=this.$widget.find(".available-language-codes"),b.default.isElectron()){const{webContents:t}=b.default.dynamicRequire("@electron/remote").getCurrentWindow();this.$availableLanguageCodes.text(t.session.availableSpellCheckerLanguages.join(", "))}}optionsLoaded(t){this.setCheckboxState(this.$spellCheckEnabled,t.spellCheckEnabled),this.$spellCheckLanguageCode.val(t.spellCheckLanguageCode)}}],_optionsPassword:[class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4 class="password-heading"></h4>\n    \n    <div class="alert alert-warning" role="alert" style="font-weight: bold; color: red !important;">\n      请一定要记住你的新密码. 密码被用来登录和加密笔记. 如果你忘记了密码, 所有受保护的笔记将永远丢失. \n      如果你忘记了密码, <a class="reset-password-button" href="javascript:">点击这里来重置它</a>.\n    </div>\n    \n    <form class="change-password-form">\n        <div class="old-password-form-group form-group">\n            <label>旧密码</label>\n            <input class="old-password form-control" type="password">\n        </div>\n    \n        <div class="form-group">\n            <label>新密码</label>\n            <input class="new-password1 form-control" type="password">\n        </div>\n    \n        <div class="form-group">\n            <label>新密码确认</label>\n            <input class="new-password2 form-control" type="password">\n        </div>\n    \n        <button class="save-password-button btn btn-primary">修改密码</button>\n    </form>\n</div>\n\n<div class="options-section">\n    <h4>保护会话超时</h4>\n\n    <p>保护会话超时是从浏览器内存里清理保护会话的间隔, 这个时间从最后一次编辑保护的笔记开始计算. 详见 <a href="https://github.com/zadam/trilium/wiki/Protected-notes" class="external">wiki</a> 以获取更多信息</p>\n\n    <div class="form-group">\n        <label>保护会话超时(单位:秒)</label>\n        <input class="protected-session-timeout-in-seconds form-control options-number-input" type="number" min="60">\n    </div>\n</div>'),this.$passwordHeading=this.$widget.find(".password-heading"),this.$changePasswordForm=this.$widget.find(".change-password-form"),this.$oldPassword=this.$widget.find(".old-password"),this.$newPassword1=this.$widget.find(".new-password1"),this.$newPassword2=this.$widget.find(".new-password2"),this.$savePasswordButton=this.$widget.find(".save-password-button"),this.$resetPasswordButton=this.$widget.find(".reset-password-button"),this.$resetPasswordButton.on("click",(async()=>{if(confirm("重置密码会永远丢失所有受保护的笔记. 确定要重置密码吗?")){await a.Z.post("password/reset?really=yesIReallyWantToResetPasswordAndLoseAccessToMyProtectedNotes");const t=await a.Z.get("options");this.optionsLoaded(t),B.default.showError("Password has been reset. Please set new password")}})),this.$changePasswordForm.on("submit",(()=>this.save())),this.$protectedSessionTimeout=this.$widget.find(".protected-session-timeout-in-seconds"),this.$protectedSessionTimeout.on("change",(()=>this.updateOption("protectedSessionTimeout",this.$protectedSessionTimeout.val())))}optionsLoaded(t){const e="true"===t.isPasswordSet;this.$widget.find(".old-password-form-group").toggle(e),this.$passwordHeading.text(e?"修改密码":"设置密码"),this.$savePasswordButton.text(e?"修改密码":"设置密码"),this.$protectedSessionTimeout.val(t.protectedSessionTimeout)}save(){const t=this.$oldPassword.val(),e=this.$newPassword1.val(),n=this.$newPassword2.val();return this.$oldPassword.val(""),this.$newPassword1.val(""),this.$newPassword2.val(""),e!==n?(B.default.showError("New passwords are not the same."),!1):(a.Z.post("password/change",{current_password:t,new_password:e}).then((t=>{t.success?(B.default.showError("Password has been changed. Trilium will be reloaded after you press OK."),s.Z.resetProtectedSession()):B.default.showError(t.message)})),!1)}}],_optionsEtapi:[class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>ETAPI</h4>\n    \n    <p>ETAPI 是一个 REST API, 用于以编程方式访问 Trilium 实例, 无需 UI. <br/>\n       更多信息请访问 <a href="https://github.com/zadam/trilium/wiki/ETAPI">wiki</a> 和 <a onclick="window.open(\'etapi/etapi.openapi.yaml\')" href="etapi/etapi.openapi.yaml">ETAPI OpenAPI 文档</a>.</p>\n    \n    <button type="button" class="create-etapi-token btn btn-sm">创建新的 ETAPI 令牌</button>\n\n    <h5>已有令牌</h5>\n    \n    <div class="no-tokens-yet">暂无令牌. 点击上方按钮来创建令牌.</div>\n    \n    <div style="overflow: auto; height: 500px;">\n        <table class="tokens-table table table-stripped">\n        <thead>\n            <tr>\n                <th>令牌名称</th>\n                <th>创建</th>\n                <th>动作</th>\n            </tr>\n        </thead>\n        <tbody></tbody>\n        </table>\n    </div>\n</div>\n\n<style>\n    .token-table-button {\n        display: inline-block;\n        cursor: pointer;\n        padding: 3px;\n        margin-right: 20px;\n        font-size: large;\n        border: 1px solid transparent;\n        border-radius: var(--button-border-radius);\n    }\n    \n    .token-table-button:hover {\n        border: 1px solid var(--button-border-color);\n    }\n</style>'),this.$widget.find(".create-etapi-token").on("click",(async()=>{const t=await M.Z.prompt({title:"新的 ETAPI 令牌",message:"请输入新令牌的名称",defaultValue:"新令牌"});if(!t.trim())return void B.default.showError("令牌名称不能为空");const{authToken:e}=await a.Z.post("etapi-tokens",{tokenName:t});await M.Z.prompt({title:"ETAPI 令牌已创建",message:"复制新令牌到剪贴板. Trilium会保存令牌的哈希值, 请注意这将是你最后一次看到这个令牌.",defaultValue:e}),this.refreshTokens()})),this.refreshTokens()}async refreshTokens(){const t=this.$widget.find(".no-tokens-yet"),e=this.$widget.find(".tokens-table"),n=await a.Z.get("etapi-tokens");t.toggle(0===n.length),e.toggle(n.length>0);const o=e.find("tbody");o.empty();for(const t of n)o.append($("<tr>").append($("<td>").text(t.name)).append($("<td>").text(t.utcDateCreated)).append($("<td>").append($('<span class="bx bx-pen token-table-button" title="重命名此令牌"></span>').on("click",(()=>this.renameToken(t.etapiTokenId,t.name))),$('<span class="bx bx-trash token-table-button" title="删除/停用此令牌"></span>').on("click",(()=>this.deleteToken(t.etapiTokenId,t.name))))))}async renameToken(t,e){const n=await M.Z.prompt({title:"重命名令牌",message:"请输入新令牌的名称",defaultValue:e});n?.trim()&&(await a.Z.patch(`etapi-tokens/${t}`,{name:n}),this.refreshTokens())}async deleteToken(t,e){await M.Z.confirm(`你确认要删除ETAPI令牌 "${e}"?`)&&(await a.Z.remove(`etapi-tokens/${t}`),this.refreshTokens())}}],_optionsBackup:[class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>自动备份</h4>\n    \n    <p>Trilium 可以自动备份数据库:</p>\n    \n    <ul style="list-style: none">\n        <li>\n            <label>\n                <input type="checkbox" class="daily-backup-enabled">\n                启用每日备份\n            </label>\n        </li>\n        <li>    \n            <label>\n                <input type="checkbox" class="weekly-backup-enabled">\n                启用每周备份\n            </label>\n        </li>\n        <li>\n        <label>\n            <input type="checkbox" class="monthly-backup-enabled">\n            启用每月备份\n            </label>\n        </li>\n    </ul>\n    \n    <p>建议打开备份功能, 但这可能会使大型数据库和/或慢速存储设备的应用程序启动变慢.</p>\n</div>\n\n<div class="options-section">\n    <h4>立即备份</h4>\n    \n    <button class="backup-database-button btn">立即备份数据库</button>\n</div>\n\n<div class="options-section">\n    <h4>已有备份</h4>\n    \n    <ul class="existing-backup-list"></ul>\n</div>\n'),this.$backupDatabaseButton=this.$widget.find(".backup-database-button"),this.$backupDatabaseButton.on("click",(async()=>{const{backupFile:t}=await a.Z.post("database/backup-database");B.default.showMessage(`数据库已备份至${t}`,1e4),this.refresh()})),this.$dailyBackupEnabled=this.$widget.find(".daily-backup-enabled"),this.$weeklyBackupEnabled=this.$widget.find(".weekly-backup-enabled"),this.$monthlyBackupEnabled=this.$widget.find(".monthly-backup-enabled"),this.$dailyBackupEnabled.on("change",(()=>this.updateCheckboxOption("dailyBackupEnabled",this.$dailyBackupEnabled))),this.$weeklyBackupEnabled.on("change",(()=>this.updateCheckboxOption("weeklyBackupEnabled",this.$weeklyBackupEnabled))),this.$monthlyBackupEnabled.on("change",(()=>this.updateCheckboxOption("monthlyBackupEnabled",this.$monthlyBackupEnabled))),this.$existingBackupList=this.$widget.find(".existing-backup-list")}optionsLoaded(t){this.setCheckboxState(this.$dailyBackupEnabled,t.dailyBackupEnabled),this.setCheckboxState(this.$weeklyBackupEnabled,t.weeklyBackupEnabled),this.setCheckboxState(this.$monthlyBackupEnabled,t.monthlyBackupEnabled),a.Z.get("database/backups").then((t=>{this.$existingBackupList.empty(),t.length||(t=[{filePath:"还没有备份",mtime:""}]);for(const{filePath:e,mtime:n}of t)this.$existingBackupList.append($("<li>").text(`${e} ${n?` - ${n}`:""}`))}))}}],_optionsSync:[class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4 style="margin-top: 0px;">同步设置</h4>\n    \n    <form class="sync-setup-form">\n        <div class="form-group">\n            <label>服务器地址</label>\n            <input class="sync-server-host form-control" placeholder="https://<host>:<port>">\n        </div>\n    \n        <div class="form-group">\n            <label>同步超时(单位:毫秒)</label>\n            <input class="sync-server-timeout form-control" min="1" max="10000000" type="number" style="text-align: left;">\n        </div>\n    \n        <div class="form-group">\n            <label>同步代理服务器(可选)</label>\n            <input class="sync-proxy form-control" placeholder="https://<host>:<port>">\n    \n            <p><strong>备注:</strong> 代理设置留空则使用系统代理(仅桌面客户端有效).</p>\n            <p>另一个特殊值是<code>noproxy</code>，它会强制忽略代理，即使是系统代理也会忽略，并且会遵从<code>NODE_TLS_REJECT_UNAUTHORIZED</code>.</p>\n        </div>\n    \n        <div style="display: flex; justify-content: space-between;">\n            <button class="btn btn-primary">保存</button>\n    \n            <button class="btn" type="button" data-help-page="Synchronization">帮助</button>\n        </div>\n    </form>\n</div>\n\n<div class="options-section">\n    <h4>同步测试</h4>\n    \n    <p>测试和同步服务器之间的连接. 如果同步服务器没有初始化, 会将本地文档同步到同步服务器上.</p>\n    \n    <button class="test-sync-button btn">测试同步</button>\n</div>'),this.$form=this.$widget.find(".sync-setup-form"),this.$syncServerHost=this.$widget.find(".sync-server-host"),this.$syncServerTimeout=this.$widget.find(".sync-server-timeout"),this.$syncProxy=this.$widget.find(".sync-proxy"),this.$testSyncButton=this.$widget.find(".test-sync-button"),this.$form.on("submit",(()=>this.save())),this.$testSyncButton.on("click",(async()=>{const t=await a.Z.post("sync/test");t.success?B.default.showMessage(t.message):B.default.showError(`Sync server handshake failed, error: ${t.message}`)}))}optionsLoaded(t){this.$syncServerHost.val(t.syncServerHost),this.$syncServerTimeout.val(t.syncServerTimeout),this.$syncProxy.val(t.syncProxy)}save(){return this.updateMultipleOptions({syncServerHost:this.$syncServerHost.val(),syncServerTimeout:this.$syncServerTimeout.val(),syncProxy:this.$syncProxy.val()}),!1}}],_optionsOther:[class extends et{isEnabled(){return super.isEnabled()&&b.default.isElectron()}doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>搜索引擎</h4>\n    \n    <p>自定义搜索引擎需要设置名称和URL。如果其中任何一个未设置，将使用DuckDuckGo作为默认搜索引擎。</p>\n    \n    <form class="sync-setup-form">\n        <div class="form-group">\n            <label>预定义的搜索引擎模板</label>\n            <select class="predefined-search-engine-select form-control">\n                <option value="Bing">必应</option>\n                <option value="Baidu">百度</option>\n                <option value="DuckDuckGo">DuckDuckGo</option>\n                <option value="Google">谷歌</option>\n            </select>\n        </div>\n        \n        <div class="form-group">\n            <label>自定义搜索引擎名称</label>\n            <input type="text" class="custom-search-engine-name form-control" placeholder="Customize search engine name">\n        </div>\n        \n        <div class="form-group">\n            <label>自定义搜索引擎的URL应该包含<code>{keyword}</code>作为搜索词的占位符。</label>\n            <input type="text" class="custom-search-engine-url form-control" placeholder="Customize search engine url">\n        </div>\n        \n        <div style="display: flex; justify-content: space-between;">\n            <button class="btn btn-primary">保存</button>\n        </div>\n    </form>\n</div>'),this.$form=this.$widget.find(".sync-setup-form"),this.$predefinedSearchEngineSelect=this.$widget.find(".predefined-search-engine-select"),this.$customSearchEngineName=this.$widget.find(".custom-search-engine-name"),this.$customSearchEngineUrl=this.$widget.find(".custom-search-engine-url"),this.$predefinedSearchEngineSelect.on("change",(()=>{const t=this.$predefinedSearchEngineSelect.val();this.$customSearchEngineName[0].value=t,this.$customSearchEngineUrl[0].value=st[t]})),this.$form.on("submit",(()=>{this.updateMultipleOptions({customSearchEngineName:this.$customSearchEngineName.val(),customSearchEngineUrl:this.$customSearchEngineUrl.val()})}))}async optionsLoaded(t){this.$predefinedSearchEngineSelect.val(""),this.$customSearchEngineName[0].value=t.customSearchEngineName,this.$customSearchEngineUrl[0].value=t.customSearchEngineUrl}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>托盘</h4>\n\n    <label>\n        <input type="checkbox" class="tray-enabled">\n        启用托盘图标(修改需要重启生效)\n    </label>\n</div>'),this.$trayEnabled=this.$widget.find(".tray-enabled"),this.$trayEnabled.on("change",(()=>this.updateOption("disableTray",this.$trayEnabled.is(":checked")?"false":"true")))}async optionsLoaded(t){this.$trayEnabled.prop("checked","true"!==t.disableTray)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>笔记清理超时</h4>\n\n    <p>被删除的笔记(属性, 修改版本等)只是被标记为"删除", 是可以从"最近笔记"还原的. 过了一段时间这些笔记会被"清理", 被清理的笔记就无法还原了. 这个设置可以用来调整从"删除"到被"清理"的时间间隔</p>\n\n    <div class="form-group">\n        <label>超过X秒后清理笔记</label>\n        <input class="erase-entities-after-time-in-seconds form-control options-number-input" type="number" min="0">\n    </div>\n    \n    <p>您也可以手动触发清理（而不考虑上述定义的超时时间）:</p>\n    \n    <button class="erase-deleted-notes-now-button btn">清理已删除的笔记</button>\n</div>'),this.$eraseEntitiesAfterTimeInSeconds=this.$widget.find(".erase-entities-after-time-in-seconds"),this.$eraseEntitiesAfterTimeInSeconds.on("change",(()=>this.updateOption("eraseEntitiesAfterTimeInSeconds",this.$eraseEntitiesAfterTimeInSeconds.val()))),this.$eraseDeletedNotesButton=this.$widget.find(".erase-deleted-notes-now-button"),this.$eraseDeletedNotesButton.on("click",(()=>{a.Z.post("notes/erase-deleted-notes-now").then((()=>{B.default.showMessage("删除的笔记已被清理.")}))}))}async optionsLoaded(t){this.$eraseEntitiesAfterTimeInSeconds.val(t.eraseEntitiesAfterTimeInSeconds)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>附件清理超时</h4>\n\n    <p>如果附件在一段时间后不再被笔记引用，它们将自动被删除(并被清理)。</p>\n\n    <div class="form-group">\n        <label>在附件在笔记中未被使用 X 秒后清理附件</label>\n        <input class="erase-unused-attachments-after-time-in-seconds form-control options-number-input" type="number" min="0">\n    </div>\n    \n    <p>您也可以手动触发清理（而不考虑上述定义的超时时间）:</p>\n    \n    <button class="erase-unused-attachments-now-button btn">立即清理未使用的附件</button>\n</div>'),this.$eraseUnusedAttachmentsAfterTimeInSeconds=this.$widget.find(".erase-unused-attachments-after-time-in-seconds"),this.$eraseUnusedAttachmentsAfterTimeInSeconds.on("change",(()=>this.updateOption("eraseUnusedAttachmentsAfterSeconds",this.$eraseUnusedAttachmentsAfterTimeInSeconds.val()))),this.$eraseUnusedAttachmentsNowButton=this.$widget.find(".erase-unused-attachments-now-button"),this.$eraseUnusedAttachmentsNowButton.on("click",(()=>{a.Z.post("notes/erase-unused-attachments-now").then((()=>{B.default.showMessage("未使用的附件已被删除.")}))}))}async optionsLoaded(t){this.$eraseUnusedAttachmentsAfterTimeInSeconds.val(t.eraseUnusedAttachmentsAfterSeconds)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>笔记修改快照间隔</h4>\n\n    <p>这个是笔记修改后创建快照的时间. 详见:<a href="https://github.com/zadam/trilium/wiki/Note-revisions" class="external">wiki</a> 以获取更多信息</p>\n\n    <div class="form-group">\n        <label>笔记修改快照间隔(单位:秒)</label>\n        <input class="revision-snapshot-time-interval-in-seconds form-control options-number-input" type="number" min="10">\n    </div>\n</div>'),this.$revisionsTimeInterval=this.$widget.find(".revision-snapshot-time-interval-in-seconds"),this.$revisionsTimeInterval.on("change",(()=>this.updateOption("revisionSnapshotTimeInterval",this.$revisionsTimeInterval.val())))}async optionsLoaded(t){this.$revisionsTimeInterval.val(t.revisionSnapshotTimeInterval)}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>网络连接</h4>\n        \n    <label>\n        <input class="check-for-updates" type="checkbox" name="check-for-updates">\n        自动检查更新\n    </label>\n</div>'),this.$checkForUpdates=this.$widget.find(".check-for-updates"),this.$checkForUpdates.on("change",(()=>this.updateCheckboxOption("checkForUpdates",this.$checkForUpdates)))}async optionsLoaded(t){this.setCheckboxState(this.$checkForUpdates,t.checkForUpdates)}}],_optionsAdvanced:[class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>数据库完整性检查</h4>\n    \n    <p>检查SQLite数据库是否损坏. 根据数据库大小, 可能会需要一些时间.</p>\n    \n    <button class="check-integrity-button btn">检查数据库完整性</button>\n</div>'),this.$checkIntegrityButton=this.$widget.find(".check-integrity-button"),this.$checkIntegrityButton.on("click",(async()=>{B.default.showMessage("正在检查数据库完整性...");const{results:t}=await a.Z.get("database/check-integrity");1===t.length&&"ok"===t[0].integrity_check?B.default.showMessage("完整性检查成功 - 未发现问题."):B.default.showMessage(`Integrity check failed: ${JSON.stringify(t,null,2)}`,15e3)}))}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>一致性检查</h4>\n    \n    <button class="find-and-fix-consistency-issues-button btn">查找并解决一致性问题</button>\n</div>'),this.$findAndFixConsistencyIssuesButton=this.$widget.find(".find-and-fix-consistency-issues-button"),this.$findAndFixConsistencyIssuesButton.on("click",(async()=>{B.default.showMessage("查找并修复一致性问题..."),await a.Z.post("database/find-and-fix-consistency-issues"),B.default.showMessage("一致性问题应该已经解决了.")}))}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>数据库匿名化</h4>\n    \n    <h5>完全匿名化</h5>\n    \n    <p>这会创建一个数据库的副本并匿名化处理(删除所有笔记内容, 仅保留结构和一些非敏感的元数据信息)用来分享到网上做调试而不用担心泄漏你的个人资料.</p>\n    \n    <button class="anonymize-full-button btn">保存完全匿名化的数据库</button>\n\n    <h5>轻度匿名化</h5>\n    \n    <p>此操作将创建数据库的新副本并对其进行轻度匿名化 - 仅删除所有笔记的内容,但标题和属性将保留. 另外, 自定义前端和后端JS代码以及自定义部件会保留. 这会给查找bug提供更完整的环境.</p>\n    \n    <p>您可以自行决定是否要提供完全或轻度匿名化的数据库. 完全匿名化的数据库会对解决问题有帮助, 在一些情况下, 如果能提供轻度匿名化的数据库能加快定位bug和修复的过程.</p>\n    \n    <button class="anonymize-light-button btn">保存轻度匿名化的数据库</button>\n    \n    <h5>已有匿名化数据库</h5>\n    \n    <ul class="existing-anonymized-databases"></ul>\n</div>'),this.$anonymizeFullButton=this.$widget.find(".anonymize-full-button"),this.$anonymizeLightButton=this.$widget.find(".anonymize-light-button"),this.$anonymizeFullButton.on("click",(async()=>{B.default.showMessage("创建完全匿名的数据库...");const t=await a.Z.post("database/anonymize/full");t.success?B.default.showMessage(`Created fully anonymized database in ${t.anonymizedFilePath}`,1e4):B.default.showError("无法创建匿名化数据库, 详情请检查后台日志."),this.refresh()})),this.$anonymizeLightButton.on("click",(async()=>{B.default.showMessage("创建轻度匿名数据库...");const t=await a.Z.post("database/anonymize/light");t.success?B.default.showMessage(`Created lightly anonymized database in ${t.anonymizedFilePath}`,1e4):B.default.showError("无法创建匿名化数据库, 详情请检查后台日志."),this.refresh()})),this.$existingAnonymizedDatabases=this.$widget.find(".existing-anonymized-databases")}optionsLoaded(t){a.Z.get("database/anonymized-databases").then((t=>{this.$existingAnonymizedDatabases.empty(),t.length||(t=[{filePath:"还没有匿名化的数据库"}]);for(const{filePath:e}of t)this.$existingAnonymizedDatabases.append($("<li>").text(e))}))}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>同步</h4>\n    <button class="force-full-sync-button btn">强制完全同步</button> \n    \n    <button class="fill-entity-changes-button btn">填充变化记录</button>\n</div>'),this.$forceFullSyncButton=this.$widget.find(".force-full-sync-button"),this.$fillEntityChangesButton=this.$widget.find(".fill-entity-changes-button"),this.$forceFullSyncButton.on("click",(async()=>{await a.Z.post("sync/force-full-sync"),B.default.showMessage("完全同步已触发")})),this.$fillEntityChangesButton.on("click",(async()=>{B.default.showMessage("填充实体修改数据..."),await a.Z.post("sync/fill-entity-changes"),B.default.showMessage("同步行已成功填充")}))}async optionsLoaded(t){}},class extends et{doRender(){this.$widget=$('\n<div class="options-section">\n    <h4>整理数据库</h4>\n    \n    <p>这会重建数据库, 通常会减少占用空间, 不会删除数据.</p>\n    \n    <button class="vacuum-database-button btn">整理数据库</button>\n</div>'),this.$vacuumDatabaseButton=this.$widget.find(".vacuum-database-button"),this.$vacuumDatabaseButton.on("click",(async()=>{B.default.showMessage("整理数据库..."),await a.Z.post("database/vacuum-database"),B.default.showMessage("数据库已整理")}))}}],_backendLog:[at]};var dt=__webpack_require__(4264);class lt extends e.Z{constructor(t,e){super(),this.attachment=t,this.isFullDetail=e}get attachmentId(){return this.attachment.attachmentId}doRender(){this.$widget=$('\n<div class="dropdown attachment-actions">\n    <style>\n    .attachment-actions {\n        width: 35px;\n        height: 35px;\n    }\n    \n    .attachment-actions .dropdown-menu {\n        width: 20em;\n    }\n    \n    .attachment-actions .dropdown-item[disabled], .attachment-actions .dropdown-item[disabled]:hover {\n        color: var(--muted-text-color) !important;\n        background-color: transparent !important;\n        pointer-events: none; /* makes it unclickable */\n    }\n    </style>\n\n    <button type="button" data-toggle="dropdown" aria-haspopup="true" \n        aria-expanded="false" class="icon-action icon-action-always-border bx bx-dots-vertical-rounded"\n        style="position: relative; top: 3px;"></button>\n\n    <div class="dropdown-menu dropdown-menu-right">\n        <a data-trigger-command="openAttachment" class="dropdown-item"\n            title="文件将在外部应用程序中打开并监视更改, 然后您可以将修改后的版本上传回Trilium">用外部程序打开</a>\n        <a data-trigger-command="openAttachmentCustom" class="dropdown-item"\n            title="文件将在外部应用程序中打开并监视更改, 然后您可以将修改后的版本上传回Trilium">使用自定义程序打开</a>\n        <a data-trigger-command="downloadAttachment" class="dropdown-item">下载</a>\n        <a data-trigger-command="renameAttachment" class="dropdown-item">重命名附件</a>\n        <a data-trigger-command="uploadNewAttachmentRevision" class="dropdown-item">上传新的修改</a>\n        <a data-trigger-command="copyAttachmentLinkToClipboard" class="dropdown-item">复制链接到剪贴板</a>\n        <a data-trigger-command="convertAttachmentIntoNote" class="dropdown-item">将附件转换为笔记</a>\n        <a data-trigger-command="deleteAttachment" class="dropdown-item">删除附件</a>\n    </div>\n    \n    <input type="file" class="attachment-upload-new-revision-input" style="display: none">\n</div>'),this.$widget.on("click",".dropdown-item",(()=>this.$widget.find("[data-toggle='dropdown']").dropdown("toggle"))),this.$uploadNewRevisionInput=this.$widget.find(".attachment-upload-new-revision-input"),this.$uploadNewRevisionInput.on("change",(async()=>{const t=this.$uploadNewRevisionInput[0].files[0];this.$uploadNewRevisionInput.val(""),(await a.Z.upload(`attachments/${this.attachmentId}/file`,t)).uploaded?B.default.showMessage("已上传新附件版本。"):B.default.showError("Upload of a new attachment revision failed.")})),this.isFullDetail||(this.$widget.find("[data-trigger-command='openAttachment']").addClass("disabled").append($('<span class="disabled-tooltip"> (?)</span>').attr("title","用外部程序打开附件仅在详细页面使用, 请先单击附件详情并重复操作")),this.$widget.find("[data-trigger-command='openAttachmentCustom']").addClass("disabled").append($('<span class="disabled-tooltip"> (?)</span>').attr("title","用外部程序打开附件仅在详细页面使用, 请先单击附件详情并重复操作"))),b.default.isElectron()||this.$widget.find("[data-trigger-command='openAttachmentCustom']").addClass("disabled").append($('<span class="disabled-tooltip"> (?)</span>').attr("title","Custom opening of attachments can only be done from the client."))}async openAttachmentCommand(){await L.Z.openAttachmentExternally(this.attachmentId,this.attachment.mime)}async openAttachmentCustomCommand(){await L.Z.openAttachmentCustom(this.attachmentId,this.attachment.mime)}async downloadAttachmentCommand(){await L.Z.downloadAttachment(this.attachmentId)}async uploadNewAttachmentRevisionCommand(){this.$uploadNewRevisionInput.trigger("click")}async copyAttachmentLinkToClipboardCommand(){this.parent.copyAttachmentLinkToClipboard()}async deleteAttachmentCommand(){await M.Z.confirm(`您确定要删除附件吗 '${this.attachment.title}'?`)&&(await a.Z.remove(`attachments/${this.attachmentId}`),B.default.showMessage(`已删除附件 '${this.attachment.title}'`))}async convertAttachmentIntoNoteCommand(){if(!await M.Z.confirm(`Are you sure you want to convert attachment '${this.attachment.title}' into a separate note?`))return;const{note:e}=await a.Z.post(`attachments/${this.attachmentId}/convert-to-note`);B.default.showMessage(`附件 '${this.attachment.title}' 已转换为笔记`),await dt.Z.waitForMaxKnownEntityChangeId(),await t.default.tabManager.getActiveContext().setNote(e.noteId)}async renameAttachmentCommand(){const t=await M.Z.prompt({title:"重命名附件",message:"请输入新附件的名称",defaultValue:this.attachment.title});t?.trim()&&await a.Z.put(`attachments/${this.attachmentId}/rename`,{title:t})}}const ct='\n<div class="attachment-detail-widget">\n    <style>\n        .attachment-detail-widget {\n            height: 100%;\n        }\n    \n        .attachment-detail-wrapper {\n            margin-bottom: 20px;\n            display: flex;\n            flex-direction: column;\n        }\n        \n        .attachment-title-line {\n            display: flex;\n            align-items: baseline;\n            gap: 1em;\n        }\n        \n        .attachment-details {\n            margin-left: 10px;\n        }\n        \n        .attachment-content-wrapper {\n            flex-grow: 1;\n        }\n        \n        .attachment-content-wrapper .rendered-content {\n            height: 100%;\n        }\n        \n        .attachment-content-wrapper pre {\n            background: var(--accented-background-color);\n            padding: 10px;\n            margin-top: 10px;\n            margin-bottom: 10px;\n        }\n        \n        .attachment-detail-wrapper.list-view .attachment-content-wrapper {\n            max-height: 300px;\n        }\n\n        .attachment-detail-wrapper.full-detail {\n            height: 100%;\n        }\n\n        .attachment-detail-wrapper.full-detail .attachment-content-wrapper {\n            height: 100%;\n        }\n        \n        .attachment-detail-wrapper.list-view .attachment-content-wrapper pre {\n            max-height: 400px;\n        }\n        \n        .attachment-content-wrapper img {\n            margin: 10px;\n        }\n        \n        .attachment-detail-wrapper.list-view .attachment-content-wrapper img, .attachment-detail-wrapper.list-view .attachment-content-wrapper video {\n            max-height: 300px; \n            max-width: 90%; \n            object-fit: contain;\n        }\n        \n        .attachment-detail-wrapper.full-detail .attachment-content-wrapper img {\n            max-width: 90%; \n            object-fit: contain;\n        }\n        \n        .attachment-detail-wrapper.scheduled-for-deletion .attachment-content-wrapper img {\n            filter: contrast(10%);\n        }\n    </style>\n\n    <div class="attachment-detail-wrapper">\n        <div class="attachment-title-line">\n            <div class="attachment-actions-container"></div>\n            <h4 class="attachment-title"></h4>                \n            <div class="attachment-details"></div>\n            <div style="flex: 1 1;"></div>\n        </div>\n        \n        <div class="attachment-deletion-warning alert alert-info" style="margin-top: 15px;"></div>\n        \n        <div class="attachment-content-wrapper"></div>\n    </div>\n</div>';class ht extends e.Z{constructor(t,e){super(),this.contentSized(),this.attachment=t,this.attachmentActionsWidget=new lt(t,e),this.isFullDetail=e,this.child(this.attachmentActionsWidget)}doRender(){this.$widget=$(ct),this.refresh(),super.doRender()}async refresh(){this.$widget.find(".attachment-detail-wrapper").empty().append($(ct).find(".attachment-detail-wrapper").html()),this.$wrapper=this.$widget.find(".attachment-detail-wrapper"),this.$wrapper.addClass(this.isFullDetail?"full-detail":"list-view"),this.isFullDetail?this.$wrapper.find(".attachment-title").text(this.attachment.title):this.$wrapper.find(".attachment-title").append(await _.Z.createLink(this.attachment.ownerId,{title:this.attachment.title,viewScope:{viewMode:"attachments",attachmentId:this.attachment.attachmentId}}));const t=this.$wrapper.find(".attachment-deletion-warning"),{utcDateScheduledForErasureSince:e}=this.attachment;if(e){this.$wrapper.addClass("scheduled-for-deletion");const n=b.default.parseDate(e)?.getTime(),o=n+1e3*k.Z.getInt("eraseUnusedAttachmentsAfterSeconds")-Date.now();t.show(),o>=6e4?t.text(`此附件将在 ${b.default.formatTimeInterval(o)} 后自动删除。`):t.text("此附件将很快被自动删除"),t.append(", 因为附件未在笔记内容中链接。为防止被删除，请将附件链接添加回内容中或将附件转换为笔记。")}else this.$wrapper.removeClass("scheduled-for-deletion"),t.hide();this.$wrapper.find(".attachment-details").text(`角色：${this.attachment.role}，大小：${b.default.formatSize(this.attachment.contentLength)}`),this.$wrapper.find(".attachment-actions-container").append(this.attachmentActionsWidget.render());const{$renderedContent:n}=await P.Z.getRenderedContent(this.attachment,{imageHasZoom:this.isFullDetail});this.$wrapper.find(".attachment-content-wrapper").append(n)}async copyAttachmentLinkToClipboard(){if("image"===this.attachment.role)O(this.$wrapper.find(".attachment-content-wrapper"));else{if("file"!==this.attachment.role)throw new Error(`Unrecognized attachment role '${this.attachment.role}'.`);{const t=await _.Z.createLink(this.attachment.ownerId,{referenceLink:!0,viewScope:{viewMode:"attachments",attachmentId:this.attachment.attachmentId}});b.default.copyHtmlToClipboard(t[0].outerHTML),B.default.showMessage("附件链接已复制到剪贴板.")}}}async entitiesReloadedEvent({loadResults:t}){const e=t.getAttachmentRows().find((t=>t.attachmentId===this.attachment.attachmentId));e&&(e.isDeleted?this.toggleInt(!1):this.refresh())}}const pt={empty:class extends C{static getType(){return"empty"}doRender(){this.$widget=$('\n<div class="note-detail-empty note-detail-printable">\n    <style>\n        .workspace-notes {\n            display: flex;\n            flex-direction: row;\n            flex-wrap: wrap;\n            justify-content: space-evenly;\n        }\n        \n        .workspace-notes .workspace-note {\n            width: 130px;\n            text-align: center;\n            margin: 10px;\n            padding; 10px;\n            border: 1px transparent solid;\n        }\n        \n        .workspace-notes .workspace-note:hover {\n            cursor: pointer;\n            border: 1px solid var(--main-border-color);\n        }\n        \n        .workspace-icon {\n            text-align: center;\n            font-size: 500%;\n        }\n    </style>\n\n    <div class="form-group">\n        <label>在下方输入笔记名称或者点树形图来打开笔记.</label>\n        <div class="input-group">\n            <input class="form-control note-autocomplete" placeholder="根据名称搜索笔记">\n        </div>\n    </div>\n    \n    <div class="workspace-notes"></div>\n</div>'),this.$autoComplete=this.$widget.find(".note-autocomplete"),I(this.$autoComplete,{hideGoToSelectedNoteButton:!0,allowCreatingNotes:!0}).on("autocomplete:noteselected",(function(e,n,o){if(!n.notePath)return!1;t.default.tabManager.getActiveContext().setNote(n.notePath)})),this.$workspaceNotes=this.$widget.find(".workspace-notes"),super.doRender()}async doRefresh(t){const e=await N.Z.searchForNotes("#workspace #!template");this.$workspaceNotes.empty();for(const t of e)this.$workspaceNotes.append($('<div class="workspace-note">').append($("<div>").addClass(`${t.getIcon()} workspace-icon`)).append($("<div>").text(t.title)).attr("title",`进入工作空间 ${t.title}`).on("click",(()=>this.triggerCommand("hoistNote",{noteId:t.noteId}))));this.$autoComplete.trigger("focus").trigger("select")}},editableText:class extends R{static getType(){return"editableText"}doRender(){this.$widget=$('\n<div class="note-detail-editable-text note-detail-printable">\n    <style>\n    .note-detail-editable-text {\n        font-family: var(--detail-font-family);\n        padding-left: 14px;\n        padding-top: 10px;\n        height: 100%;\n    }\n    \n    body.mobile .note-detail-editable-text {\n        padding-left: 4px;\n    }\n    \n    .note-detail-editable-text a:hover {\n        cursor: pointer;\n    }\n    \n    .note-detail-editable-text a[href^="http://"], .note-detail-editable-text a[href^="https://"] {\n        cursor: text !important;\n    }\n    \n    .note-detail-editable-text *:not(figure,.include-note):first-child {\n        margin-top: 0 !important;\n    }\n         \n    .note-detail-editable-text h2 { font-size: 1.6em; } \n    .note-detail-editable-text h3 { font-size: 1.4em; }\n    .note-detail-editable-text h4 { font-size: 1.2em; }\n    .note-detail-editable-text h5 { font-size: 1.1em; }\n    .note-detail-editable-text h6 { font-size: 1.0em; }\n    \n    body.heading-style-markdown .note-detail-editable-text h2::before { content: "##\\2004"; color: var(--muted-text-color); }\n    body.heading-style-markdown .note-detail-editable-text h3::before { content: "###\\2004"; color: var(--muted-text-color); }\n    body.heading-style-markdown .note-detail-editable-text h4:not(.include-note-title)::before { content: "####\\2004"; color: var(--muted-text-color); }\n    body.heading-style-markdown .note-detail-editable-text h5::before { content: "#####\\2004"; color: var(--muted-text-color); }\n    body.heading-style-markdown .note-detail-editable-text h6::before { content: "######\\2004"; color: var(--muted-text-color); }\n    \n    body.heading-style-underline .note-detail-editable-text h2 { border-bottom: 1px solid var(--main-border-color); }\n    body.heading-style-underline .note-detail-editable-text h3 { border-bottom: 1px solid var(--main-border-color); }\n    body.heading-style-underline .note-detail-editable-text h4:not(.include-note-title) { border-bottom: 1px solid var(--main-border-color); }\n    body.heading-style-underline .note-detail-editable-text h5 { border-bottom: 1px solid var(--main-border-color); }\n    body.heading-style-underline .note-detail-editable-text h6 { border-bottom: 1px solid var(--main-border-color); }\n    \n    .note-detail-editable-text-editor {\n        padding-top: 10px;\n        border: 0 !important;\n        box-shadow: none !important;\n        min-height: 50px;\n        height: 100%;\n    }\n    </style>\n\n    <div class="note-detail-editable-text-editor" tabindex="300"></div>\n</div>\n'),this.$editor=this.$widget.find(".note-detail-editable-text-editor"),this.initialized=this.initEditor(),p.default.setupActionsForElement("text-detail",this.$widget,this),this.setupImageOpening(!1),super.doRender()}async initEditor(){await h.Z.requireLibrary(h.Z.CKEDITOR);const t=(await A.getMimeTypes()).filter((t=>t.enabled)).map((t=>({language:t.mime.toLowerCase().replace(/[\W_]+/g,"-"),label:t.title})));this.$widget.show(),this.watchdog=new EditorWatchdog(BalloonEditor,{minimumNonErrorTimePeriod:5e3,crashNumberLimit:3,saveInterval:5e3}),this.watchdog.on("stateChange",(()=>{const t=this.watchdog.state;["crashed","crashedPermanently"].includes(t)&&(console.log(`CKEditor changed to ${t}`),this.watchdog.crashes.forEach((t=>console.log(t))),"crashedPermanently"===t&&(M.Z.info("Editing component keeps crashing. Please try restarting Trilium. If problem persists, consider creating a bug report."),this.watchdog.editor.enableReadOnlyMode("crashed-editor")))})),this.watchdog.setCreator((async(t,e)=>{const n=await BalloonEditor.create(t,e);return n.model.document.on("change:data",(()=>this.spacedUpdate.scheduleUpdate())),glob.isDev,n})),await this.watchdog.create(this.$editor[0],{placeholder:"在这里输入笔记内容",mention:Z,codeBlock:{languages:t},math:{engine:"katex",outputType:"span",lazyLoad:async()=>await h.Z.requireLibrary(h.Z.KATEX),forceOutputType:!1,enablePreview:!0}})}async doRefresh(t){const e=await t.getBlob();await this.spacedUpdate.allowUpdateWithoutChange((()=>this.watchdog.editor.setData(e.content||"")))}getData(){const t=this.watchdog.editor.getData();return{content:b.default.isHtmlEmpty(t)?"":t}}focus(){this.$editor.trigger("focus")}scrollToEnd(){this.watchdog?.editor.model.change((t=>{t.setSelection(t.createPositionAt(this.watchdog?.editor.model.document.getRoot(),"end"))})),this.watchdog?.editor.editing.view.focus()}show(){}getEditor(){return this.watchdog?.editor}cleanup(){this.watchdog?.editor&&this.spacedUpdate.allowUpdateWithoutChange((()=>{this.watchdog.editor.setData("")}))}insertDateTimeToTextCommand(){const t=new Date,e=b.default.formatDateTime(t);this.addTextToEditor(e)}async addLinkToEditor(t,e){await this.initialized,this.watchdog.editor.model.change((n=>{const o=this.watchdog.editor.model.document.selection.getFirstPosition();n.insertText(e,{linkHref:t},o)}))}async addTextToEditor(t){await this.initialized,this.watchdog.editor.model.change((e=>{const n=this.watchdog.editor.model.document.selection.getLastPosition();e.insertText(t,n)}))}addTextToActiveEditorEvent({text:t}){this.isActive()&&this.addTextToEditor(t)}async addLink(t,e){await this.initialized,e?this.hasSelection()?this.watchdog.editor.execute("link",`#${t}`):await this.addLinkToEditor(`#${t}`,e):this.watchdog.editor.execute("referenceLink",{href:"#"+t}),this.watchdog.editor.editing.view.focus()}hasSelection(){return!this.watchdog.editor.model.document.selection.isCollapsed}async executeWithTextEditorEvent({callback:t,resolve:e,ntxId:n}){this.isNoteContext(n)&&(await this.initialized,t&&t(this.watchdog.editor),e(this.watchdog.editor))}addLinkToTextCommand(){const t=this.getSelectedText();this.triggerCommand("showAddLinkDialog",{textTypeWidget:this,text:t})}getSelectedText(){const t=this.watchdog.editor.model.document.selection.getFirstRange();let e="";for(const n of t.getItems())n.data&&(e+=n.data);return e}async followLinkUnderCursorCommand(){await this.initialized;const e=this.watchdog.editor.model.document.selection,n=e.getSelectedElement();if("reference"===n?.name){const e=n.getAttribute("notePath");if(e)return void await t.default.tabManager.getActiveContext().setNote(e)}if(!e.hasAttribute("linkHref"))return;const o=e.getAttribute("linkHref"),i=_.Z.getNotePathFromUrl(o);i?await t.default.tabManager.getActiveContext().setNote(i):window.open(o,"_blank")}addIncludeNoteToTextCommand(){this.triggerCommand("showIncludeNoteDialog",{textTypeWidget:this})}addIncludeNote(t,e){this.watchdog.editor.model.change((n=>{this.watchdog.editor.model.insertContent(n.createElement("includeNote",{noteId:t,boxSize:e}))}))}async addImage(t){const e=await g.default.getNote(t);this.watchdog.editor.model.change((t=>{const n=encodeURIComponent(e.title),o=`api/images/${e.noteId}/${n}`;this.watchdog.editor.execute("insertImage",{source:o})}))}async createNoteForReferenceLink(t){const e=await u.Z.createNoteWithTypePrompt(this.notePath,{activate:!1,title:t});if(e)return e.note.getBestNotePathString()}async refreshIncludedNoteEvent({noteId:t}){this.refreshIncludedNote(this.$editor,t)}},readOnlyText:class extends R{static getType(){return"readOnlyText"}doRender(){this.$widget=$('\n<div class="note-detail-readonly-text note-detail-printable">\n    <style>\n    /* h1 should not be used at all since semantically that\'s a note title */\n    .note-detail-readonly-text h1 { font-size: 1.8em; }\n    .note-detail-readonly-text h2 { font-size: 1.6em; }\n    .note-detail-readonly-text h3 { font-size: 1.4em; }\n    .note-detail-readonly-text h4 { font-size: 1.2em; }\n    .note-detail-readonly-text h5 { font-size: 1.1em; }\n    .note-detail-readonly-text h6 { font-size: 1.0em; }\n    \n    body.heading-style-markdown .note-detail-readonly-text h1::before { content: "#\\2004"; color: var(--muted-text-color); }\n    body.heading-style-markdown .note-detail-readonly-text h2::before { content: "##\\2004"; color: var(--muted-text-color); }\n    body.heading-style-markdown .note-detail-readonly-text h3::before { content: "###\\2004"; color: var(--muted-text-color); }\n    body.heading-style-markdown .note-detail-readonly-text h4:not(.include-note-title)::before { content: "####\\2004"; color: var(--muted-text-color); }\n    body.heading-style-markdown .note-detail-readonly-text h5::before { content: "#####\\2004"; color: var(--muted-text-color); }\n    body.heading-style-markdown .note-detail-readonly-text h6::before { content: "######\\2004"; color: var(--muted-text-color); }\n\n    body.heading-style-underline .note-detail-readonly-text h1 { border-bottom: 1px solid var(--main-border-color); }\n    body.heading-style-underline .note-detail-readonly-text h2 { border-bottom: 1px solid var(--main-border-color); }\n    body.heading-style-underline .note-detail-readonly-text h3 { border-bottom: 1px solid var(--main-border-color); }\n    body.heading-style-underline .note-detail-readonly-text h4:not(.include-note-title) { border-bottom: 1px solid var(--main-border-color); }\n    body.heading-style-underline .note-detail-readonly-text h5 { border-bottom: 1px solid var(--main-border-color); }\n    body.heading-style-underline .note-detail-readonly-text h6 { border-bottom: 1px solid var(--main-border-color); }\n    \n    .note-detail-readonly-text {\n        padding-left: 24px;\n        padding-top: 10px;\n        font-family: var(--detail-font-family);\n        min-height: 50px;\n        position: relative;\n    }\n    \n    body.mobile .note-detail-readonly-text {\n        padding-left: 10px;\n    }\n        \n    .note-detail-readonly-text p:first-child, .note-detail-readonly-text::before {\n        margin-top: 0;\n    }\n    \n    .note-detail-readonly-text img {\n        max-width: 100%;\n        cursor: pointer;\n    }\n    \n    .edit-text-note-button {\n        position: absolute; \n        top: 5px;\n        right: 10px;\n        font-size: 150%;\n        padding: 5px;\n        cursor: pointer;\n        border: 1px solid transparent;\n        border-radius: var(--button-border-radius);\n        color: var(--button-text-color);\n    }\n    \n    .edit-text-note-button:hover {\n        border-color: var(--button-border-color);\n    }\n    </style>\n\n    <div class="note-detail-readonly-text-content ck-content"></div>\n</div>\n'),this.$content=this.$widget.find(".note-detail-readonly-text-content"),this.setupImageOpening(!0),super.doRender()}cleanup(){this.$content.html("")}async doRefresh(t){await h.Z.requireLibrary(h.Z.CKEDITOR);const e=await t.getBlob();this.$content.html(e.content),this.$content.find("a.reference-link").each((async(t,e)=>{this.loadReferenceLinkTitle($(e))})),this.$content.find("section").each((async(t,e)=>{const n=$(e).attr("data-note-id");this.loadIncludedNote(n,$(e))})),this.$content.find("span.math-tex").length>0&&(await h.Z.requireLibrary(h.Z.KATEX),renderMathInElement(this.$content[0],{trust:!0}))}async refreshIncludedNoteEvent({noteId:t}){this.refreshIncludedNote(this.$content,t)}async executeWithContentElementEvent({resolve:t,ntxId:e}){this.isNoteContext(e)&&(await this.initialized,t(this.$content))}},editableCode:class extends C{static getType(){return"editableCode"}doRender(){this.$widget=$('\n<div class="note-detail-code note-detail-printable">\n    <style>\n    .note-detail-code {\n        position: relative;\n        height: 100%;\n    }\n    \n    .note-detail-code-editor {\n        min-height: 50px;\n        height: 100%;\n    }\n    </style>\n\n    <div class="note-detail-code-editor"></div>\n</div>'),this.$editor=this.$widget.find(".note-detail-code-editor"),p.default.setupActionsForElement("code-detail",this.$widget,this),super.doRender(),this.initialized=this.initEditor()}async initEditor(){await h.Z.requireLibrary(h.Z.CODE_MIRROR),CodeMirror.keyMap.default["Shift-Tab"]="indentLess",CodeMirror.keyMap.default.Tab="indentMore",delete CodeMirror.keyMap.default["Alt-Left"],delete CodeMirror.keyMap.default["Alt-Right"],CodeMirror.modeURL=`${window.glob.assetPath}/libraries/codemirror/mode/%N/%N.js`,this.codeEditor=CodeMirror(this.$editor[0],{value:"",viewportMargin:1/0,indentUnit:4,matchBrackets:!0,keyMap:k.Z.is("vimKeymapEnabled")?"vim":"default",matchTags:{bothTags:!0},highlightSelectionMatches:{showToken:!1,annotateScrollbar:!1},lint:!0,gutters:["CodeMirror-lint-markers"],lineNumbers:!0,tabindex:300,lineWrapping:k.Z.is("codeLineWrapEnabled"),dragDrop:!1,placeholder:"在此处输入代码笔记的内容..."}),this.codeEditor.on("change",(()=>this.spacedUpdate.scheduleUpdate()))}async doRefresh(t){const e=await this.note.getBlob();await this.spacedUpdate.allowUpdateWithoutChange((()=>{this.codeEditor.setValue(e.content||""),this.codeEditor.clearHistory();let n=CodeMirror.findModeByMIME(t.mime);n||(n=CodeMirror.findModeByMIME("text/plain")),this.codeEditor.setOption("mode",n.mime),CodeMirror.autoLoadMode(this.codeEditor,n.mode)})),this.show()}show(){this.$widget.show(),this.codeEditor&&this.codeEditor.refresh()}getData(){return{content:this.codeEditor.getValue()}}focus(){this.$editor.focus(),this.codeEditor.focus()}scrollToEnd(){this.codeEditor.setCursor(this.codeEditor.lineCount(),0),this.codeEditor.focus()}cleanup(){this.codeEditor&&this.spacedUpdate.allowUpdateWithoutChange((()=>{this.codeEditor.setValue("")}))}async executeWithCodeEditorEvent({resolve:t,ntxId:e}){this.isNoteContext(e)&&(await this.initialized,t(this.codeEditor))}},readOnlyCode:class extends C{static getType(){return"readOnlyCode"}doRender(){this.$widget=$('\n<div class="note-detail-readonly-code note-detail-printable">\n    <style>\n    .note-detail-readonly-code {\n        min-height: 50px;\n        position: relative;\n    }\n    \n    .note-detail-readonly-code-content {\n        padding: 10px;\n    }\n    </style>\n\n    <pre class="note-detail-readonly-code-content"></pre>\n</div>'),this.$content=this.$widget.find(".note-detail-readonly-code-content"),super.doRender()}async doRefresh(t){let{content:e}=await this.note.getBlob();"text"===t.type&&"source"===this.noteContext?.viewScope?.viewMode&&(e=this.format(e)),this.$content.text(e)}async executeWithContentElementEvent({resolve:t,ntxId:e}){this.isNoteContext(e)&&(await this.initialized,t(this.$content))}format(t){let e="\n",n=0,o=[];for(t=t.replace(new RegExp("<pre>((.|\\t|\\n|\\r)+)?</pre>"),(function(t){return o.push({indent:"",tag:t}),"<--TEMPPRE"+n+++"/--\x3e"})).replace(new RegExp("<[^<>]+>[^<]?","g"),(function(t){let n,i=/<\/?([^\s/>]+)/.exec(t)[1],s=new RegExp("<--TEMPPRE(\\d+)/--\x3e").exec(t);return s&&(o[s[1]].indent=e),["area","base","br","col","command","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"].indexOf(i)>=0?n=e+t:t.indexOf("</")<0?(n=">"!==t.charAt(t.length-1)?e+t.substr(0,t.length-1)+e+"\t"+t.substr(t.length-1,t.length):e+t,!s&&(e+="\t")):(e=e.substr(0,e.length-1),n=">"!==t.charAt(t.length-1)?e+t.substr(0,t.length-1)+e+t.substr(t.length-1,t.length):e+t),n})),n=o.length;n--;)t=t.replace("<--TEMPPRE"+n+"/--\x3e",o[n].tag.replace("<pre>","<pre>\n").replace("</pre>",o[n].indent+"</pre>"));return"\n"===t.charAt(0)?t.substr(1,t.length-1):t}},file:class extends C{static getType(){return"file"}doRender(){this.$widget=$('\n<div class="note-detail-file note-detail-printable">\n    <style>\n        .type-file .note-detail {\n            height: 100%;\n        }\n        \n        .note-detail-file {\n            padding: 10px;\n            height: 100%;\n        }\n\n        .file-preview-content {\n            background-color: var(--accented-background-color);\n            padding: 15px;\n            height: 100%;\n            overflow: auto;\n            margin: 10px;\n        }\n    </style>\n    \n    <pre class="file-preview-content"></pre>\n    \n    <div class="file-preview-not-available alert alert-info">\n        这种文件格式不支持预览.\n    </div>\n    \n    <iframe class="pdf-preview" style="width: 100%; height: 100%; flex-grow: 100;"></iframe>\n    \n    <video class="video-preview" controls></video>\n    \n    <audio class="audio-preview" controls></audio>\n</div>'),this.$previewContent=this.$widget.find(".file-preview-content"),this.$previewNotAvailable=this.$widget.find(".file-preview-not-available"),this.$pdfPreview=this.$widget.find(".pdf-preview"),this.$videoPreview=this.$widget.find(".video-preview"),this.$audioPreview=this.$widget.find(".audio-preview"),super.doRender()}async doRefresh(t){this.$widget.show();const e=await this.note.getBlob();this.$previewContent.empty().hide(),this.$pdfPreview.attr("src","").empty().hide(),this.$previewNotAvailable.hide(),this.$videoPreview.hide(),this.$audioPreview.hide(),e.content?(this.$previewContent.show().scrollTop(0),this.$previewContent.text(e.content)):"application/pdf"===t.mime?this.$pdfPreview.show().attr("src",L.Z.getUrlForDownload(`api/notes/${this.noteId}/open`)):t.mime.startsWith("video/")?this.$videoPreview.show().attr("src",L.Z.getUrlForDownload(`api/notes/${this.noteId}/open-partial`)).attr("type",this.note.mime).css("width",this.$widget.width()):t.mime.startsWith("audio/")?this.$audioPreview.show().attr("src",L.Z.getUrlForDownload(`api/notes/${this.noteId}/open-partial`)).attr("type",this.note.mime).css("width",this.$widget.width()):this.$previewNotAvailable.show()}async entitiesReloadedEvent({loadResults:t}){t.isNoteReloaded(this.noteId)&&this.refresh()}},image:class extends C{static getType(){return"image"}doRender(){this.$widget=$('\n<div class="note-detail-image note-detail-printable">\n    <style>\n        .type-image .note-detail {\n            height: 100%;\n        }\n    \n        .note-detail-image {\n            height: 100%; \n        }\n        \n        .note-detail-image-wrapper {\n            position: relative;\n            display: flex;\n            align-items: center;\n            overflow: hidden;\n            justify-content: center;\n            height: 100%;\n        }\n        \n        .note-detail-image-view {\n            display: block;\n            width: auto;\n            height: auto;\n            align-self: center;\n            flex-shrink: 0;\n        }\n    </style>\n\n    <div class="note-detail-image-wrapper">\n        <img class="note-detail-image-view" />\n    </div>\n</div>'),this.$imageWrapper=this.$widget.find(".note-detail-image-wrapper"),this.$imageView=this.$widget.find(".note-detail-image-view").attr("id",`image-view-${b.default.randomString(10)}`),h.Z.requireLibrary(h.Z.WHEEL_ZOOM).then((()=>{WZoom.create(`#${this.$imageView.attr("id")}`,{maxScale:50,speed:1.3,zoomOnClick:!1})})),b.default.isElectron()&&this.$imageView.on("contextmenu",(t=>{t.preventDefault(),D.Z.show({x:t.pageX,y:t.pageY,items:[{title:"复制引用到剪贴板",command:"copyImageReferenceToClipboard",uiIcon:"bx bx-empty"},{title:"复制图片到剪贴板",command:"copyImageToClipboard",uiIcon:"bx bx-empty"}],selectMenuItemHandler:({command:e})=>{if("copyImageReferenceToClipboard"===e)O(this.$imageWrapper);else{if("copyImageToClipboard"!==e)throw new Error(`未识别的命令 '${e}'`);{const e=b.default.dynamicRequire("@electron/remote").getCurrentWebContents();b.default.dynamicRequire("electron"),e.copyImageAt(t.pageX,t.pageY)}}}})})),super.doRender()}async doRefresh(t){this.$imageView.prop("src",b.default.createImageSrcUrl(t))}copyImageReferenceToClipboardEvent({ntxId:t}){this.isNoteContext(t)&&O(this.$imageWrapper)}async entitiesReloadedEvent({loadResults:t}){t.isNoteReloaded(this.noteId)&&this.refresh()}},search:class extends C{static getType(){return"none"}doRender(){this.$widget=$('<div class="note-detail-none note-detail-printable"></div>'),super.doRender()}},render:class extends C{static getType(){return"render"}doRender(){this.$widget=$('\n<div class="note-detail-render note-detail-printable">\n    <style>\n        .note-detail-render {\n            position: relative;\n        }\n    </style>\n\n    <div class="note-detail-render-help alert alert-warning" style="margin: 50px; padding: 20px;">\n        <p><strong>之所以显示此帮助说明, 是因为该类型的渲染HTML没有设置好必须的关联关系.</strong></p>\n\n        <p>笔记类型: 渲染HTML 是用来<a class="external" href="https://github.com/zadam/trilium/wiki/Scripts">编写脚本</a>用的. 简单说就是你可以写HTML代码(或者加上一些JavaScript代码), 然后这个笔记会把页面渲染出来. 你得定义一个叫"renderNote"的<a class="external" href="https://github.com/zadam/trilium/wiki/Attributes">关系</a>来指向要渲染的HTML笔记.</p>\n    </div>\n\n    <div class="note-detail-render-content"></div>\n</div>'),this.$noteDetailRenderHelp=this.$widget.find(".note-detail-render-help"),this.$noteDetailRenderContent=this.$widget.find(".note-detail-render-content"),super.doRender()}async doRefresh(t){this.$widget.show(),this.$noteDetailRenderHelp.hide(),await F.Z.render(t,this.$noteDetailRenderContent)||this.$noteDetailRenderHelp.show()}cleanup(){this.$noteDetailRenderContent.empty()}renderActiveNoteEvent(){this.noteContext.isActive()&&this.refresh()}async executeWithContentElementEvent({resolve:t,ntxId:e}){this.isNoteContext(e)&&(await this.initialized,t(this.$noteDetailRenderContent))}},relationMap:class extends C{static getType(){return"relationMap"}doRender(){this.$widget=$('\n<div class="note-detail-relation-map note-detail-printable">\n    <div class="relation-map-wrapper">\n       <div class="relation-map-container"></div>\n    </div>\n</div>'),this.$relationMapContainer=this.$widget.find(".relation-map-container"),this.mapData=null,this.jsPlumbInstance=null,this.relations=null,this.pzInstance=null,this.$relationMapWrapper=this.$widget.find(".relation-map-wrapper"),this.$relationMapWrapper.on("click",(t=>{if(this.clipboard){let{x:e,y:n}=this.getMousePosition(t);e-=80,n-=15,this.createNoteBox(this.clipboard.noteId,this.clipboard.title,e,n),this.mapData.notes.push({noteId:this.clipboard.noteId,x:e,y:n}),this.saveData(),this.clipboard=null}return!0})),this.$relationMapContainer.attr("id","relation-map-container-"+q++),this.$relationMapContainer.on("contextmenu",".note-box",(t=>(D.Z.show({x:t.pageX,y:t.pageY,items:[{title:"在新标签页中打开",command:"openInNewTab",uiIcon:"bx bx-empty"},{title:"删除笔记",command:"remove",uiIcon:"bx bx-trash"},{title:"编辑标题",command:"editTitle",uiIcon:"bx bx-pencil"}],selectMenuItemHandler:({command:e})=>this.contextMenuHandler(e,t.target)}),!1))),this.clipboard=null,this.$widget.on("drop",(t=>this.dropNoteOntoRelationMapHandler(t))),this.$widget.on("dragover",(t=>t.preventDefault())),this.initialized=new Promise((async t=>{await h.Z.requireLibrary(h.Z.RELATION_MAP),jsPlumb.ready(t)})),super.doRender()}async contextMenuHandler(e,n){const o=$(n).closest(".note-box"),i=o.find(".title a"),s=this.idToNoteId(o.prop("id"));if("openInNewTab"===e)t.default.tabManager.openTabWithNoteWithHoisting(s);else if("remove"===e){const t=await M.Z.confirmDeleteNoteBoxWithNote(i.text());if(!t.confirmed)return;if(this.jsPlumbInstance.remove(this.noteIdToId(s)),t.isDeleteNoteChecked){const t=b.default.randomString(10);await a.Z.remove(`notes/${s}?taskId=${t}&last=true`)}this.mapData.notes=this.mapData.notes.filter((t=>t.noteId!==s)),this.relations=this.relations.filter((t=>t.sourceNoteId!==s&&t.targetNoteId!==s)),this.saveData()}else if("editTitle"===e){const t=await M.Z.prompt({title:"重命名笔记",message:"输入新的笔记标题:",defaultValue:i.text()});if(!t)return;await a.Z.put(`notes/${s}/title`,{title:t}),i.text(t)}}async loadMapData(){this.mapData={notes:[],transform:{x:0,y:0,scale:1}};const t=await this.note.getBlob();if(t.content)try{this.mapData=JSON.parse(t.content)}catch(t){console.log("Could not parse content: ",t)}}noteIdToId(t){return`rel-map-note-${t}`}idToNoteId(t){return t.substr(13)}async doRefresh(t){await this.loadMapData(),this.initJsPlumbInstance(),this.initPanZoom(),this.loadNotesAndRelations()}clearMap(){this.jsPlumbInstance.deleteEveryEndpoint(),this.$relationMapContainer.empty()}async loadNotesAndRelations(){const t=this.mapData.notes.map((t=>t.noteId)),e=await a.Z.post("relation-map",{noteIds:t,relationMapNoteId:this.noteId});this.relations=[];for(const t of e.relations){const n=this.relations.find((n=>n.name===e.inverseRelations[t.name]&&(n.sourceNoteId===t.sourceNoteId&&n.targetNoteId===t.targetNoteId||n.sourceNoteId===t.targetNoteId&&n.targetNoteId===t.sourceNoteId)));n?(n.type=t.type=t.name===e.inverseRelations[t.name]?"biDirectional":"inverse",t.render=!1):(t.type="uniDirectional",t.render=!0),this.relations.push(t)}this.mapData.notes=this.mapData.notes.filter((t=>t.noteId in e.noteTitles)),this.jsPlumbInstance.batch((async()=>{this.clearMap();for(const t of this.mapData.notes){const n=e.noteTitles[t.noteId];await this.createNoteBox(t.noteId,n,t.x,t.y)}for(const t of this.relations){if(!t.render)continue;const n=this.jsPlumbInstance.connect({source:this.noteIdToId(t.sourceNoteId),target:this.noteIdToId(t.targetNoteId),type:t.type});n.id=t.attributeId,"inverse"===t.type?(n.getOverlay("label-source").setLabel(t.name),n.getOverlay("label-target").setLabel(e.inverseRelations[t.name])):n.getOverlay("label").setLabel(t.name),n.canvas.setAttribute("data-connection-id",n.id)}}))}initPanZoom(){this.pzInstance||(this.pzInstance=panzoom(this.$relationMapContainer[0],{maxZoom:2,minZoom:.3,smoothScroll:!1,filterKey:function(t,e,n,o){return t.altKey}}),this.pzInstance.on("transform",(()=>{this.jsPlumbInstance.setZoom(this.getZoom()),this.saveCurrentTransform()})),this.mapData.transform?(this.pzInstance.zoomTo(0,0,this.mapData.transform.scale),this.pzInstance.moveTo(this.mapData.transform.x,this.mapData.transform.y)):this.pzInstance.moveTo(0,0))}saveCurrentTransform(){const t=this.pzInstance.getTransform();JSON.stringify(t)!==JSON.stringify(this.mapData.transform)&&(this.mapData.transform=JSON.parse(JSON.stringify(t)),this.saveData())}cleanup(){this.jsPlumbInstance&&this.clearMap(),this.pzInstance&&(this.pzInstance.dispose(),this.pzInstance=null)}initJsPlumbInstance(){this.jsPlumbInstance?this.cleanup():(this.jsPlumbInstance=jsPlumb.getInstance({Endpoint:["Dot",{radius:2}],Connector:"StateMachine",ConnectionOverlays:z,HoverPaintStyle:{stroke:"#777",strokeWidth:1},Container:this.$relationMapContainer.attr("id")}),this.jsPlumbInstance.registerConnectionType("uniDirectional",{anchor:"Continuous",connector:"StateMachine",overlays:z}),this.jsPlumbInstance.registerConnectionType("biDirectional",{anchor:"Continuous",connector:"StateMachine",overlays:H}),this.jsPlumbInstance.registerConnectionType("inverse",{anchor:"Continuous",connector:"StateMachine",overlays:U}),this.jsPlumbInstance.registerConnectionType("link",{anchor:"Continuous",connector:"StateMachine",overlays:j}),this.jsPlumbInstance.bind("connection",((t,e)=>this.connectionCreatedHandler(t,e))))}async connectionCreatedHandler(t,e){const n=t.connection;if(n.bind("contextmenu",((t,e)=>{n.getType().includes("link")?e.preventDefault():(e.preventDefault(),e.stopPropagation(),D.Z.show({x:e.pageX,y:e.pageY,items:[{title:"删除关系",command:"remove",uiIcon:"bx bx-trash"}],selectMenuItemHandler:async({command:t})=>{if("remove"===t){if(!await M.Z.confirm("确定要删除这个关系吗?"))return;const t=this.relations.find((t=>t.attributeId===n.id));await a.Z.remove(`notes/${t.sourceNoteId}/relations/${t.name}/to/${t.targetNoteId}`),this.jsPlumbInstance.deleteConnection(n),this.relations=this.relations.filter((t=>t.attributeId!==n.id))}}}))})),!e)return;let o=await M.Z.prompt({message:"指定新的关系名称(允许的字符: 字母数字,冒号和下划线):",shown:({$answer:t})=>{t.on("keyup",(()=>{const e=b.default.filterAttributeName(t.val());t.val(e)})),W({$el:t,attributeType:"relation",open:!0})}});if(!o||!o.trim())return void this.jsPlumbInstance.deleteConnection(n);o=b.default.filterAttributeName(o);const i=this.idToNoteId(n.target.id),s=this.idToNoteId(n.source.id);if(this.relations.some((t=>t.targetNoteId===i&&t.sourceNoteId===s&&t.name===o)))return await M.Z.info(`Connection '${o}' between these notes already exists.`),void this.jsPlumbInstance.deleteConnection(n);await a.Z.put(`notes/${s}/relations/${o}/to/${i}`),this.loadNotesAndRelations()}saveData(){this.spacedUpdate.scheduleUpdate()}async createNoteBox(t,e,n,o){const i=await _.Z.createLink(t,{title:e});i.mousedown((t=>_.Z.goToLink(t)));const s=await g.default.getNote(t),a=$("<div>").addClass("note-box").addClass(s.getCssClass()).prop("id",this.noteIdToId(t)).append($("<span>").addClass("title").append(i)).append($("<div>").addClass("endpoint").attr("title","从这里拖拽到别的笔记来创建关系.")).css("left",`${n}px`).css("top",`${o}px`);this.jsPlumbInstance.getContainer().appendChild(a[0]),this.jsPlumbInstance.draggable(a[0],{start:t=>{},drag:t=>{},stop:t=>{const e=this.idToNoteId(t.el.id),n=this.mapData.notes.find((t=>t.noteId===e));n?([n.x,n.y]=t.finalPos,this.saveData()):logError(`笔记 ${e} 未找到!`)}}),this.jsPlumbInstance.makeSource(a[0],{filter:".endpoint",anchor:"Continuous",connectorStyle:{stroke:"#000",strokeWidth:1},connectionType:"basic",extract:{action:"the-action"}}),this.jsPlumbInstance.makeTarget(a[0],{dropOptions:{hoverClass:"dragHover"},anchor:"Continuous",allowLoopback:!0})}getZoom(){const t=this.$relationMapContainer.css("transform");if("none"===t)return 1;const e=t.match(/matrix\((-?\d*\.?\d+),\s*0,\s*0,\s*-?\d*\.?\d+,\s*-?\d*\.?\d+,\s*-?\d*\.?\d+\)/);if(!e)throw new Error(`Cannot match transform: ${t}`);return e[1]}async dropNoteOntoRelationMapHandler(t){t.preventDefault();const e=JSON.parse(t.originalEvent.dataTransfer.getData("text"));let{x:n,y:o}=this.getMousePosition(t);for(const t of e)this.mapData.notes.some((e=>e.noteId===t.noteId))?B.default.showError(`笔记 "${t.title}" 已经在图中.`):(this.mapData.notes.push({noteId:t.noteId,x:n,y:o}),n>1e3?(o+=100,n=0):n+=200);this.saveData(),this.loadNotesAndRelations()}getMousePosition(t){const e=this.$relationMapContainer[0].getBoundingClientRect(),n=this.getZoom();return{x:(t.clientX-e.left)/n,y:(t.clientY-e.top)/n}}getData(){return{content:JSON.stringify(this.mapData)}}async relationMapCreateChildNoteEvent({ntxId:t}){if(!this.isNoteContext(t))return;const e=await M.Z.prompt({message:"输入新笔记的标题",defaultValue:"新建笔记"});if(!e.trim())return;const{note:n}=await a.Z.post(`notes/${this.noteId}/children?target=into`,{title:e,content:"",type:"text"});B.default.showMessage("在画布上单击以放置新笔记"),this.clipboard={noteId:n.noteId,title:e}}relationMapResetPanZoomEvent({ntxId:t}){this.isNoteContext(t)&&(this.pzInstance.zoomTo(0,0,1/this.getZoom()),this.pzInstance.moveTo(0,0))}relationMapResetZoomInEvent({ntxId:t}){this.isNoteContext(t)&&this.pzInstance.zoomTo(0,0,1.2)}relationMapResetZoomOutEvent({ntxId:t}){this.isNoteContext(t)&&this.pzInstance.zoomTo(0,0,.8)}},canvas:class extends C{constructor(){super(),this.SCENE_VERSION_INITIAL=-1,this.SCENE_VERSION_ERROR=-2,this.DEBOUNCE_TIME_ONCHANGEHANDLER=750,window.EXCALIDRAW_ASSET_PATH=`${window.location.origin}/node_modules/@excalidraw/excalidraw/dist/`,this.currentNoteId="",this.currentSceneVersion=this.SCENE_VERSION_INITIAL,this.excalidrawRef,this.$render,this.$widget,this.reactHandlers,this.createExcalidrawReactApp=this.createExcalidrawReactApp.bind(this),this.onChangeHandler=this.onChangeHandler.bind(this),this.isNewSceneVersion=this.isNewSceneVersion.bind(this),this.libraryChanged=!1}static getType(){return"canvas"}doRender(){this.$widget=$('\n    <div class="canvas-widget note-detail-canvas note-detail-printable note-detail">\n        <style>\n        .excalidraw .App-menu_top .buttonList {\n            display: flex;\n        }\n        \n        /* Conflict between excalidraw and bootstrap classes keeps the menu hidden */\n        /* https://github.com/zadam/trilium/issues/3780 */\n        /* https://github.com/excalidraw/excalidraw/issues/6567 */\n        .excalidraw .dropdown-menu {\n            display: block;\n        }\n\n        .excalidraw-wrapper {\n            height: 100%;\n        }\n        \n        .excalidraw button[data-testid="json-export-button"] {\n            display: none !important;\n        }\n\n        :root[dir="ltr"]\n        .excalidraw\n        .layer-ui__wrapper\n        .zen-mode-transition.App-menu_bottom--transition-left {\n            transform: none;\n        }\n        \n        /* collaboration not possible so hide the button */\n        .CollabButton {\n            display: none !important;\n        }\n        \n        button[data-testid=\'save-button\'], button[data-testid=\'json-export-button\'] {\n            display: none !important; /* these exports don\'t work, user should use import/export dialog */\n        }\n        \n        .library-button {\n            display: none !important; /* library won\'t work without extra support which isn\'t currently implemented */\n        }\n\n        </style>\n        \x3c!-- height here necessary. otherwise excalidraw not shown --\x3e\n        <div class="canvas-render" style="height: 100%"></div>  \n    </div>\n'),this.$widget.bind("mousewheel DOMMouseScroll",(t=>{if(t.ctrlKey)return t.preventDefault(),t.stopPropagation(),!1})),this.$widget.toggleClass("full-height",!0),this.$render=this.$widget.find(".canvas-render");const t=window.getComputedStyle(document.documentElement);return this.themeStyle=t.getPropertyValue("--theme-style")?.trim(),h.Z.requireLibrary(h.Z.EXCALIDRAW).then((()=>{const t=window.React,e=window.ReactDOM,n=this.$render.get(0);e.unmountComponentAtNode(n),e.render(t.createElement(this.createExcalidrawReactApp),n)})),this.$widget}async doRefresh(t){this.currentNoteId!==t.noteId&&(this.currentSceneVersion=this.SCENE_VERSION_INITIAL),this.currentNoteId=t.noteId;const e=await t.getBlob();for(;!this.excalidrawRef?.current;)console.log("excalidrawRef not yet loaded, sleep 200ms..."),await J(200);if(e.content?.trim()){if(e.content){let n;try{n=e.getJsonContent()}catch(o){console.error("Error parsing content. Probably note.type changed. Starting with empty canvas",t,e,o),n={elements:[],files:[],appState:{}}}const{elements:o,files:i,appState:s={}}=n;s.theme=this.themeStyle;const a=this.excalidrawWrapperRef.current.getBoundingClientRect();s.width=a.width,s.height=a.height,s.offsetLeft=a.left,s.offsetTop=a.top;const r={elements:o,appState:s,collaborators:[]},d=[];for(const t in i){const e=i[t];d.push(e)}this.excalidrawRef.current.updateScene(r),this.excalidrawRef.current.addFiles(d),this.excalidrawRef.current.history.clear()}}else{const t={elements:[],appState:{theme:this.themeStyle},collaborators:[]};this.excalidrawRef.current.updateScene(t)}Promise.all((await t.getAttachmentsByRole("canvasLibraryItem")).map((t=>t.getBlob()))).then((e=>{if(t.noteId!==this.currentNoteId)return;const n=e.map((t=>t.getJsonContentSafely())).filter((t=>!!t));this.excalidrawRef.current.updateLibrary({libraryItems:n,merge:!1})})),this.currentSceneVersion===this.SCENE_VERSION_INITIAL&&(this.currentSceneVersion=this.getSceneVersion())}async getData(){const t=this.excalidrawRef.current.getSceneElements(),e=this.excalidrawRef.current.getAppState(),n=this.excalidrawRef.current.getFiles(),o=(await window.ExcalidrawLib.exportToSvg({elements:t,appState:e,exportPadding:5,metadata:"trilium-export",files:n})).outerHTML,i={};t.forEach((t=>{t.fileId&&(i[t.fileId]=n[t.fileId])}));const s={type:"excalidraw",version:2,elements:t,files:i,appState:{scrollX:e.scrollX,scrollY:e.scrollY,zoom:e.zoom}},a=[{role:"image",title:"canvas-export.svg",mime:"image/svg+xml",content:o,position:0}];if(this.libraryChanged){const t=await this.excalidrawRef.current.updateLibrary({merge:!0});let e=10;for(const n of t)a.push({role:"canvasLibraryItem",title:n.id,mime:"application/json",content:JSON.stringify(n),position:e}),e+=10}return{content:JSON.stringify(s),attachments:a}}saveData(){this.spacedUpdate.scheduleUpdate()}dataSaved(){this.libraryChanged=!1}onChangeHandler(){const t=this.isNewSceneVersion(),e=this.currentSceneVersion!==this.SCENE_VERSION_INITIAL;t&&e&&(this.updateSceneVersion(),this.saveData())}createExcalidrawReactApp(){const t=window.React,{Excalidraw:e}=window.ExcalidrawLib,n=t.useRef(null);this.excalidrawRef=n;const o=t.useRef(null);this.excalidrawWrapperRef=o;const[i,s]=t.useState({width:void 0,height:void 0});t.useEffect((()=>{const t={width:o.current.getBoundingClientRect().width,height:o.current.getBoundingClientRect().height};s(t);const e=()=>{if("canvas"!==this.note?.type)return;const t={width:o.current.getBoundingClientRect().width,height:o.current.getBoundingClientRect().height};s(t)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)}),[o]);const a=t.useCallback(((t,e)=>{let n=t.link;n.startsWith("root/")&&(n="#"+n);const{nativeEvent:o}=e.detail;return e.preventDefault(),_.Z.goToLinkExt(o,n,null)}),[]);return t.createElement(t.Fragment,null,t.createElement("div",{className:"excalidraw-wrapper",ref:o},t.createElement(e,{theme:this.themeStyle,ref:n,langCode:"zh-CN",width:i.width,height:i.height,onPaste:(t,e)=>{console.log("Verbose: excalidraw internal paste. No trilium action implemented.",t,e)},onLibraryChange:()=>{this.libraryChanged=!0,this.saveData()},onChange:K(this.onChangeHandler,this.DEBOUNCE_TIME_ONCHANGEHANDLER),viewModeEnabled:!1,zenModeEnabled:!1,gridModeEnabled:!1,isCollaborating:!1,detectScroll:!1,handleKeyboardGlobally:!1,autoFocus:!1,onLinkOpen:a,UIOptions:{saveToActiveFile:!1,saveAsImage:!1}})))}isNewSceneVersion(){const t=this.getSceneVersion();return this.currentSceneVersion===this.SCENE_VERSION_INITIAL||this.currentSceneVersion!==t}getSceneVersion(){if(this.excalidrawRef){const t=this.excalidrawRef.current.getSceneElements();return window.ExcalidrawLib.getSceneVersion(t)}return this.SCENE_VERSION_ERROR}updateSceneVersion(){this.currentSceneVersion=this.getSceneVersion()}},protectedSession:class extends C{static getType(){return"protectedSession"}doRender(){this.$widget=$('\n<div class="protected-session-password-component note-detail-printable">\n    <style>\n    .protected-session-password-component {\n        width: 300px;\n        margin: 30px auto auto;\n    }\n    </style>\n\n    <form class="protected-session-password-form">\n        <div class="form-group">\n            <label for="protected-session-password-in-detail">查看受保护的笔记需要输入密码:</label>\n            <input class="protected-session-password-in-detail form-control protected-session-password" type="password">\n        </div>\n\n        <button class="btn btn-primary">开始受保护的会话<kbd>回车</kbd></button>\n    </form>\n</div>'),this.$passwordForm=this.$widget.find(".protected-session-password-form"),this.$passwordInput=this.$widget.find(".protected-session-password"),this.$passwordForm.on("submit",(()=>{const t=this.$passwordInput.val();return this.$passwordInput.val(""),G.Z.setupProtectedSession(t),!1})),super.doRender()}},book:class extends C{static getType(){return"book"}doRender(){this.$widget=$('\n<div class="note-detail-book note-detail-printable">\n    <style>\n    .note-detail-book-auto-help {\n        background-color: var(--accented-background-color);\n        text-align: center;\n        border-radius: 10px;\n        padding: 5px;\n        margin: 0 10px 10px 10px;\n    }\n    </style>\n\n    <div class="note-detail-book-empty-help alert alert-warning" style="margin: 50px; padding: 20px;">\n        这个类型为"书"的笔记没有任何子笔记, 所以什么也不显示. 详见 <a href="https://github.com/zadam/trilium/wiki/Book-note">wiki</a>.\n    </div>\n</div>'),this.$helpNoChildren=this.$widget.find(".note-detail-book-empty-help"),super.doRender()}async doRefresh(t){this.$helpNoChildren.toggle(!this.note.hasChildren())}},noteMap:class extends C{static getType(){return"noteMap"}constructor(){super(),this.noteMapWidget=new tt("type"),this.child(this.noteMapWidget)}doRender(){this.$widget=$('<div class="note-detail-note-map note-detail-printable"></div>'),this.$widget.append(this.noteMapWidget.render()),super.doRender()}async doRefresh(t){await this.noteMapWidget.refresh()}},webView:class extends C{static getType(){return"webView"}doRender(){this.$widget=$('\n<div class="note-detail-web-view note-detail-printable" style="height: 100%">\n    <div class="note-detail-web-view-help alert alert-warning" style="margin: 50px; padding: 20px 20px 0px 20px;">\n        <h4>网页视图</h4>\n        \n        <p>网页视图类型的笔记允许您将网站嵌入到 Trilium.</p>\n\n        <p>首先, 请创建一个带有您要嵌入的 URL 地址的标签, 例如<code>#webViewSrc="https://www.baidu.com"</code></p>\n\n        <h4>实验性功能免责声明</h4>\n        \n        <p>网页视图是一种实验性笔记类型, 将来可能会被删除或大幅更改. 网页视图只在桌面端有效</p>\n    </div>\n\n    <webview class="note-detail-web-view-content"></webview>\n</div>'),this.$noteDetailWebViewHelp=this.$widget.find(".note-detail-web-view-help"),this.$noteDetailWebViewContent=this.$widget.find(".note-detail-web-view-content"),window.addEventListener("resize",(()=>this.setDimensions()),!1),super.doRender()}async doRefresh(t){this.$widget.show(),this.$noteDetailWebViewHelp.hide(),this.$noteDetailWebViewContent.hide();const e=this.note.getLabelValue("webViewSrc");e?this.$noteDetailWebViewContent.show().attr("src",e):(this.$noteDetailWebViewContent.hide(),this.$noteDetailWebViewHelp.show()),this.setDimensions(),setTimeout((()=>this.setDimensions()),1e3)}cleanup(){this.$noteDetailWebViewContent.removeAttribute("src")}setDimensions(){const t=this.$widget;this.$noteDetailWebViewContent.height(t.height()).width(t.width())}entitiesReloadedEvent({loadResults:t}){t.getAttributeRows().find((t=>"webViewSrc"===t.name&&m.isAffecting(t,this.noteContext.note)))&&this.refresh()}},doc:class extends C{static getType(){return"doc"}doRender(){this.$widget=$('<div class="note-detail-doc note-detail-printable">\n    <style>\n        .note-detail-doc-content {\n            padding: 15px;\n        }\n        \n        .note-detail-doc-content pre {\n            background-color: var(--accented-background-color);\n            border: 1px solid var(--main-border-color);\n            padding: 15px;\n            border-radius: 5px;\n        }\n    </style>\n    \n    <div class="note-detail-doc-content"></div>\n</div>'),this.$content=this.$widget.find(".note-detail-doc-content"),super.doRender()}async doRefresh(t){const e=t.getLabelValue("docName");e?this.$content.load(`${window.glob.appPath}/doc_notes/${e}.html`):this.$content.empty()}},contentWidget:class extends C{static getType(){return"contentWidget"}doRender(){this.$widget=$('<div class="note-detail-content-widget note-detail-printable">\n    <style>\n        .type-contentWidget .note-detail {\n            height: 100%;\n        }\n        \n        .note-detail-content-widget {\n            height: 100%;\n        }\n    \n        .note-detail-content-widget-content {\n            padding: 15px;\n            height: 100%;\n        }\n    </style>\n\n    <div class="note-detail-content-widget-content"></div>\n</div>'),this.$content=this.$widget.find(".note-detail-content-widget-content"),super.doRender()}async doRefresh(t){this.$content.empty(),this.children=[];const e=rt[t.noteId];if(e)for(const t of e){const e=new t;await e.handleEvent("setNoteContext",{noteContext:this.noteContext}),this.child(e),this.$content.append(e.render()),await e.refresh()}else this.$content.append(`Unknown widget for "${t.noteId}"`)}},attachmentDetail:class extends C{static getType(){return"attachmentDetail"}doRender(){this.$widget=$('\n<div class="attachment-detail note-detail-printable">\n    <style>\n        .attachment-detail {\n            padding-left: 15px;\n            padding-right: 15px;\n            height: 100%;\n            display: flex;\n            flex-direction: column;\n        }\n        \n        .attachment-detail .links-wrapper {\n            font-size: larger;\n            padding: 0 0 16px 0;\n        }\n        \n        .attachment-detail .attachment-wrapper {\n            flex-grow: 1;\n        }\n    </style>\n\n    <div class="links-wrapper"></div>\n\n    <div class="attachment-wrapper"></div>\n</div>'),this.$wrapper=this.$widget.find(".attachment-wrapper"),this.$linksWrapper=this.$widget.find(".links-wrapper"),super.doRender()}async doRefresh(t){this.$wrapper.empty(),this.children=[];const e=$('<button class="attachment-help-button" type="button" data-help-page="attachments" title="打开附件帮助页面"><span class="bx bx-help-circle"></span></button>');b.default.initHelpButtons(e),this.$linksWrapper.empty().append("所属笔记: ",await _.Z.createLink(this.noteId),", 你也可以打开 ",await _.Z.createLink(this.noteId,{title:"所有附件列表",viewScope:{viewMode:"attachments"}}),e);const n=await g.default.getAttachment(this.attachmentId,!0);if(!n)return void this.$wrapper.html("<strong>这个附件已被删除</strong>");const o=new ht(n,!0);this.child(o),this.$wrapper.append(o.render())}async entitiesReloadedEvent({loadResults:t}){const e=t.getAttachmentRows().find((t=>t.attachmentId===this.attachmentId));e?.isDeleted&&this.refresh()}get attachmentId(){return this.noteContext.viewScope.attachmentId}},attachmentList:class extends C{static getType(){return"attachmentList"}doRender(){this.$widget=$('\n<div class="attachment-list note-detail-printable">\n    <style>\n        .attachment-list {\n            padding-left: 15px;\n            padding-right: 15px;\n        }\n        \n        .attachment-list .links-wrapper {\n            font-size: larger;\n            margin-bottom: 15px;\n            display: flex;\n            justify-content: space-between;\n            align-items: baseline;\n        }\n    </style>\n    \n    <div class="links-wrapper"></div>\n\n    <div class="attachment-list-wrapper"></div>\n</div>'),this.$list=this.$widget.find(".attachment-list-wrapper"),this.$linksWrapper=this.$widget.find(".links-wrapper"),super.doRender()}async doRefresh(t){const e=$('<button class="attachment-help-button" type="button" data-help-page="attachments" title="打开附件帮助页面"><span class="bx bx-help-circle"></span></button>');b.default.initHelpButtons(e);const n=await _.Z.createLink(this.noteId);this.$linksWrapper.empty().append($("<div>").append("所属笔记: ",n),$("<div>").append($('<button class="btn btn-sm">').text("上传附件").on("click",(()=>this.triggerCommand("showUploadAttachmentsDialog",{noteId:this.noteId}))),e)),this.$list.empty(),this.children=[],this.renderedAttachmentIds=new Set;const o=await t.getAttachments();if(0!==o.length)for(const t of o){const e=new ht(t,!1);this.child(e),this.renderedAttachmentIds.add(t.attachmentId),this.$list.append(e.render())}else this.$list.html('<div class="alert alert-info">这个笔记没有附件</div>')}async entitiesReloadedEvent({loadResults:t}){t.getAttachmentRows().some((t=>!this.renderedAttachmentIds.has(t.attachmentId)))&&this.refresh()}}};class ut extends i.Z{constructor(){super(),this.typeWidgets={},this.spacedUpdate=new r.Z((async()=>{const{note:t}=this.noteContext,{noteId:e}=t,n=await this.getTypeWidget().getData();void 0!==n&&(s.Z.touchProtectedSessionIfNecessary(t),await a.Z.put(`notes/${e}/data`,n,this.componentId),this.getTypeWidget().dataSaved?.())})),t.default.addBeforeUnloadListener(this)}isEnabled(){return!0}doRender(){this.$widget=$('\n<div class="note-detail">\n    <style>\n    .note-detail {\n        font-family: var(--detail-font-family);\n        font-size: var(--detail-font-size);\n    }\n    \n    .note-detail.full-height {\n        height: 100%;\n    }\n    </style>\n</div>\n'),this.contentSized()}async refresh(){if(this.type=await this.getWidgetType(),this.mime=this.note?.mime,!(this.type in this.typeWidgets)){const t=pt[this.type];if(!t)throw new Error(`Cannot find type widget for type '${this.type}'`);const e=this.typeWidgets[this.type]=new t;e.spacedUpdate=this.spacedUpdate,e.setParent(this);const n=e.render();p.default.updateDisplayedShortcuts(n),this.$widget.append(n),await e.handleEvent("setNoteContext",{noteContext:this.noteContext}),await e.handleEvent("noteSwitched",{noteContext:this.noteContext,notePath:this.noteContext.notePath}),this.child(e)}this.checkFullHeight()}checkFullHeight(){this.$widget.toggleClass("full-height",!this.noteContext.hasNoteList()&&["canvas","webView","noteMap"].includes(this.type)&&"text/x-sqlite;schema=trilium"!==this.mime||"attachments"===this.noteContext.viewScope.viewMode)}getTypeWidget(){if(!this.typeWidgets[this.type])throw new Error(`Could not find typeWidget for type '${this.type}'`);return this.typeWidgets[this.type]}async getWidgetType(){const t=this.note;if(!t)return"empty";let e=t.type;const n=this.noteContext.viewScope;return"source"===n.viewMode?e="readOnlyCode":"attachments"===n.viewMode?e=n.attachmentId?"attachmentDetail":"attachmentList":"text"===e&&await this.noteContext.isReadOnly()?e="readOnlyText":"code"!==e&&"mermaid"!==e||!await this.noteContext.isReadOnly()?"text"===e?e="editableText":"code"===e||"mermaid"===e?e="editableCode":"launcher"===e&&(e="doc"):e="readOnlyCode",t.isProtected&&!s.Z.isProtectedSessionAvailable()&&(e="protectedSession"),e}async focusOnDetailEvent({ntxId:t}){if(this.noteContext.ntxId!==t)return;await this.refresh();const e=this.getTypeWidget();await e.initialized,e.focus()}async scrollToEndEvent({ntxId:t}){if(this.noteContext.ntxId!==t)return;await this.refresh();const e=this.getTypeWidget();await e.initialized,e.scrollToEnd&&e.scrollToEnd()}async beforeNoteSwitchEvent({noteContext:t}){this.isNoteContext(t.ntxId)&&await this.spacedUpdate.updateNowIfNecessary()}async beforeNoteContextRemoveEvent({ntxIds:t}){this.isNoteContext(t)&&await this.spacedUpdate.updateNowIfNecessary()}async runActiveNoteCommand(t){return this.isNoteContext(t.ntxId)&&await this.spacedUpdate.updateNowIfNecessary(),await this.parent.triggerCommand("runActiveNote",t)}async printActiveNoteEvent(){if(!this.noteContext.isActive())return;await h.Z.requireLibrary(h.Z.PRINT_THIS);let t=$("");this.note.getPromotedDefinitionAttributes().length>0&&(t=(await f.Z.renderNormalAttributes(this.note)).$renderedAttributes);const{assetPath:e}=window.glob;this.$widget.find(".note-detail-printable:visible").printThis({header:$("<div>").append($("<h2>").text(this.note.title)).append(t).prop("outerHTML"),footer:`\n<script src="${e}/node_modules/katex/dist/katex.min.js"><\/script>\n<script src="${e}/node_modules/katex/dist/contrib/mhchem.min.js"><\/script>\n<script src="${e}/node_modules/katex/dist/contrib/auto-render.min.js"><\/script>\n<script>\n    document.body.className += ' ck-content printed-content';\n    \n    renderMathInElement(document.body, {trust: true});\n<\/script>\n`,importCSS:!1,loadCSS:[`${e}/libraries/codemirror/codemirror.css`,`${e}/libraries/ckeditor/ckeditor-content.css`,`${e}/libraries/bootstrap/css/bootstrap.min.css`,`${e}/node_modules/katex/dist/katex.min.css`,`${e}/stylesheets/print.css`,`${e}/stylesheets/relation_map.css`,`${e}/stylesheets/ckeditor-theme.css`],debug:!0})}hoistedNoteChangedEvent({ntxId:t}){this.isNoteContext(t)&&this.refresh()}async entitiesReloadedEvent({loadResults:t}){if(t.isNoteContentReloaded(this.noteId,this.componentId))this.handleEvent("noteTypeMimeChanged",{noteId:this.noteId});else if(!t.isNoteReloaded(this.noteId,this.componentId)||this.type===await this.getWidgetType()&&this.mime===this.note.mime){const e=t.getAttributeRows(),n=e.find((t=>"label"===t.type&&["readOnly","autoReadOnlyDisabled","cssClass","displayRelations","hideRelations"].includes(t.name)&&m.isAffecting(t,this.note))),o=e.find((t=>"relation"===t.type&&["template","inherit","renderNote"].includes(t.name)&&m.isAffecting(t,this.note)));(n||o)&&this.triggerEvent("noteTypeMimeChanged",{noteId:this.noteId})}else this.triggerEvent("noteTypeMimeChanged",{noteId:this.noteId})}beforeUnloadEvent(){return this.spacedUpdate.isAllSavedAndTriggerUpdate()}readOnlyTemporarilyDisabledEvent({noteContext:t}){this.isNoteContext(t.ntxId)&&this.refresh()}async executeInActiveNoteDetailWidgetEvent({callback:t}){this.isActiveNoteContext()&&(await this.initialized,t(this))}async cutIntoNoteCommand(){const e=t.default.tabManager.getActiveContextNote();e&&u.Z.createNote(t.default.tabManager.getActiveContextNotePath(),{isProtected:e.isProtected,saveSelection:!0,textEditor:await this.noteContext.getTextEditor()})}async saveNoteDetailNowCommand(){await this.spacedUpdate.updateNowIfNecessary()}renderActiveNoteEvent(){this.noteContext.isActive()&&this.refresh()}async executeWithTypeWidgetEvent({resolve:t,ntxId:e}){this.isNoteContext(e)&&(await this.initialized,await this.getWidgetType(),t(this.getTypeWidget()))}}class gt extends e.Z{doRender(){return this.$widget=$('\n<div class="quick-search input-group input-group-sm">\n  <style>\n    .quick-search {\n        padding: 10px 10px 10px 0px;\n        height: 50px;\n    }\n    \n    .quick-search button, .quick-search input {\n        border: 0;\n        font-size: 100% !important;\n    }\n  \n    .quick-search .dropdown-menu {\n        max-height: 600px;\n        max-width: 400px;\n        overflow-y: auto;\n        overflow-x: hidden;\n        text-overflow: ellipsis;\n        box-shadow: -30px 50px 93px -50px black;\n    }\n  </style>\n  \n  <div class="input-group-prepend">\n    <button class="btn btn-outline-secondary search-button" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n        <span class="bx bx-search"></span>\n    </button>\n    <div class="dropdown-menu dropdown-menu-left"></div>\n  </div>\n  <input type="text" class="form-control form-control-sm search-string" placeholder="快速搜索">\n  </div>\n</div>'),this.$searchString=this.$widget.find(".search-string"),this.$dropdownMenu=this.$widget.find(".dropdown-menu"),this.$dropdownToggle=this.$widget.find(".search-button"),this.$dropdownToggle.dropdown(),this.$widget.find(".input-group-prepend").on("shown.bs.dropdown",(()=>this.search())),b.default.isMobile()&&this.$searchString.keydown((t=>{13===t.which&&(this.$dropdownMenu.is(":visible")?this.search():this.$dropdownToggle.dropdown("show"),t.preventDefault(),t.stopPropagation())})),l.Z.bindElShortcut(this.$searchString,"return",(()=>{this.$dropdownMenu.is(":visible")?this.search():this.$dropdownToggle.dropdown("show"),this.$searchString.focus()})),l.Z.bindElShortcut(this.$searchString,"down",(()=>{this.$dropdownMenu.find(".dropdown-item:first").focus()})),l.Z.bindElShortcut(this.$searchString,"esc",(()=>{this.$dropdownToggle.dropdown("hide")})),this.$widget}async search(){const e=this.$searchString.val().trim();if(!e)return void this.$dropdownToggle.dropdown("hide");this.$dropdownMenu.empty(),this.$dropdownMenu.append('<span class="dropdown-item disabled"><span class="bx bx-loader bx-spin"></span>正在搜索...</span>');const{searchResultNoteIds:n,error:o}=await a.Z.get(`quick-search/${encodeURIComponent(e)}`);o&&(this.$searchString.tooltip({trigger:"manual",title:`Search error: ${o}`,placement:"right"}),this.$searchString.tooltip("show"),setTimeout((()=>this.$searchString.tooltip("dispose")),4e3));const i=n.slice(0,Math.min(15,n.length));this.$dropdownMenu.empty(),0===i.length&&this.$dropdownMenu.append('<span class="dropdown-item disabled">没有找到结果</span>');for(const e of await g.default.getNotes(i)){const n=await _.Z.createLink(e.noteId,{showNotePath:!0});n.addClass("dropdown-item"),n.attr("tabIndex","0"),n.on("click",(n=>{this.$dropdownToggle.dropdown("hide"),n.target&&"A"===n.target.nodeName||t.default.tabManager.getActiveContext().setNote(e.noteId)})),l.Z.bindElShortcut(n,"return",(()=>{this.$dropdownToggle.dropdown("hide"),t.default.tabManager.getActiveContext().setNote(e.noteId)})),this.$dropdownMenu.append(n)}n.length>15&&this.$dropdownMenu.append(`<span class="dropdown-item disabled">... 以及另外 ${n.length-15} 个结果</span>`);const s=$('<a class="dropdown-item" tabindex="0">').append($('<button class="btn btn-sm">在搜索中显示</button>'));this.$dropdownMenu.append(s),s.on("click",(()=>this.showInFullSearch())),l.Z.bindElShortcut(s,"return",(()=>this.showInFullSearch())),l.Z.bindElShortcut(this.$dropdownMenu.find(".dropdown-item:first"),"up",(()=>this.$searchString.focus())),this.$dropdownToggle.dropdown("update")}async showInFullSearch(){this.$dropdownToggle.dropdown("hide"),await t.default.triggerCommand("searchNotes",{searchString:this.$searchString.val()})}quickSearchEvent(){this.$searchString.focus()}}var mt=__webpack_require__(8481),ft=__webpack_require__(1035);const bt=100,wt=t=>t.stopPropagation();class yt extends i.Z{constructor(){super(),this.treeName="main"}doRender(){this.$widget=$('\n<div class="tree-wrapper">\n    <style>\n    .tree-wrapper {\n        flex-grow: 1;\n        flex-shrink: 1;\n        flex-basis: 60%;\n        font-family: var(--tree-font-family);\n        font-size: var(--tree-font-size);\n        position: relative;\n        min-height: 0;\n    }\n    \n    .tree {\n        height: 100%;\n        overflow: auto;\n        padding-bottom: 35px;\n        padding-top: 5px;\n    }\n    \n    .tree-actions {\n        background-color: var(--launcher-pane-background-color);\n        z-index: 100;\n        position: absolute;\n        bottom: 0;\n        display: flex;\n        align-items: flex-end;\n        justify-content: flex-end;\n        right: 17px;\n        border-radius: 7px;\n        border: 1px solid var(--main-border-color);\n    }\n    \n    button.tree-floating-button {\n        margin: 1px;\n        font-size: 1.5em;\n        padding: 5px;\n        max-height: 34px;\n        color: var(--launcher-pane-text-color);\n        background-color: var(--button-background-color);\n        border-radius: var(--button-border-radius);\n        border: 1px solid transparent;\n    }\n    \n    button.tree-floating-button:hover {\n        border: 1px solid var(--button-border-color);\n    }\n    \n    .collapse-tree-button {\n        right: 100px;\n    }\n    \n    .scroll-to-active-note-button {\n        right: 55px;\n    }\n    \n    .tree-settings-button {\n        right: 10px;\n    }\n    \n    .tree-settings-popup {\n        display: none; \n        position: absolute; \n        background-color: var(--accented-background-color); \n        border: 1px solid var(--main-border-color); \n        padding: 20px; \n        z-index: 1000;\n        width: 340px; \n        border-radius: 10px;\n    }\n    \n    .tree .hidden-node-is-hidden {\n        display: none;\n    }\n    </style>\n    \n    <div class="tree"></div>\n    \n    <div class="tree-actions">\n        <button class="tree-floating-button bx bx-layer-minus collapse-tree-button" \n                title="折叠笔记树" \n                data-trigger-command="collapseTree"></button>\n        \n        <button class="tree-floating-button bx bx-crosshair scroll-to-active-note-button" \n                title="滚动到活动笔记" \n                data-trigger-command="scrollToActiveNote"></button>\n        \n        <button class="tree-floating-button bx bx-cog tree-settings-button" \n                title="树设置"></button>\n    </div>\n    \n    \n    <div class="tree-settings-popup">\n        <div class="form-check">\n            <label class="form-check-label">\n                <input class="form-check-input hide-archived-notes" type="checkbox" value="">\n            \n                隐藏已归档笔记\n            </label>\n        </div>\n        <div class="form-check">\n            <label class="form-check-label">\n                <input class="form-check-input auto-collapse-note-tree" type="checkbox" value="">\n                \n                自动折叠笔记\n                <span class="bx bx-info-circle" \n                      title="一段时间不活跃的笔记会被折叠."></span>\n            </label>\n        </div>\n    \n        <br/>\n    \n        <button class="btn btn-sm btn-primary save-tree-settings-button" type="submit">保存并应用修改</button>\n    </div>\n</div>\n'),this.$tree=this.$widget.find(".tree"),this.$treeActions=this.$widget.find(".tree-actions"),this.$tree.on("mousedown",".unhoist-button",(()=>Y.Z.unhoist())),this.$tree.on("mousedown",".refresh-search-button",(t=>this.refreshSearch(t))),this.$tree.on("mousedown",".add-note-button",(t=>{const e=$.ui.fancytree.getNode(t),n=mt.Z.getNotePath(e);u.Z.createNote(n,{isProtected:e.data.isProtected})})),this.$tree.on("mousedown",".enter-workspace-button",(t=>{const e=$.ui.fancytree.getNode(t);this.triggerCommand("hoistNote",{noteId:e.data.noteId})})),this.$tree.on("mousedown",".fancytree-title",(e=>{if(2===e.which){const n=$.ui.fancytree.getNode(e),o=mt.Z.getNotePath(n);o&&t.default.tabManager.openTabWithNoteWithHoisting(o),e.stopPropagation(),e.preventDefault()}})),this.$treeSettingsPopup=this.$widget.find(".tree-settings-popup"),this.$hideArchivedNotesCheckbox=this.$treeSettingsPopup.find(".hide-archived-notes"),this.$autoCollapseNoteTree=this.$treeSettingsPopup.find(".auto-collapse-note-tree"),this.$treeSettingsButton=this.$widget.find(".tree-settings-button"),this.$treeSettingsButton.on("click",(t=>{if(this.$treeSettingsPopup.is(":visible"))return void this.$treeSettingsPopup.hide();this.$hideArchivedNotesCheckbox.prop("checked",this.hideArchivedNotes),this.$autoCollapseNoteTree.prop("checked",this.autoCollapseNoteTree);const e=this.$treeActions[0].offsetTop-this.$treeSettingsPopup.outerHeight(),n=Math.max(0,this.$treeActions[0].offsetLeft-this.$treeSettingsPopup.outerWidth()+this.$treeActions.outerWidth());return this.$treeSettingsPopup.css({top:e,left:n}).show(),!1})),this.$treeSettingsPopup.on("click",(t=>{t.stopPropagation()})),$(document).on("click",(()=>this.$treeSettingsPopup.hide())),this.$saveTreeSettingsButton=this.$treeSettingsPopup.find(".save-tree-settings-button"),this.$saveTreeSettingsButton.on("click",(async()=>{await this.setHideArchivedNotes(this.$hideArchivedNotesCheckbox.prop("checked")),await this.setAutoCollapseNoteTree(this.$autoCollapseNoteTree.prop("checked")),this.$treeSettingsPopup.hide(),this.reloadTreeFromCache()})),Promise.all([k.Z.initializedPromise,g.default.initializedPromise]).then((()=>this.initFancyTree())),this.setupNoteTitleTooltip()}setupNoteTitleTooltip(){this.$tree.on("mouseenter","span.fancytree-title",(t=>{t.currentTarget.title=((t,e)=>{const n=t.offset(),o=n.top+t.outerHeight(!0),i=n.left+t.outerWidth(!0),s=e.offset(),a=s.top+e.outerHeight(!0),r=s.left+e.outerWidth(!0);return o>a&&n.top<s.top&&i>r&&n.left<s.left})(this.$tree,$(t.currentTarget))?"":t.currentTarget.innerText}))}get hideArchivedNotes(){return k.Z.is(`hideArchivedNotes_${this.treeName}`)}async setHideArchivedNotes(t){await k.Z.save(`hideArchivedNotes_${this.treeName}`,t.toString())}get autoCollapseNoteTree(){return k.Z.is("autoCollapseNoteTree")}async setAutoCollapseNoteTree(t){await k.Z.save("autoCollapseNoteTree",t.toString())}initFancyTree(){const e=[this.prepareRootNode()];this.$tree.fancytree({titlesTabbable:!0,keyboard:!0,extensions:["dnd5","clones","filter"],source:e,scrollOfs:{top:100,bottom:100},scrollParent:this.$tree,minExpandLevel:2,click:(e,n)=>{this.activityDetected();const o=n.targetType,i=n.node;if(i.isSelected()&&"icon"===o)return this.triggerCommand("openBulkActionsDialog",{selectedOrActiveNoteIds:this.getSelectedOrActiveNoteIds(i)}),!1;if("title"===o||"icon"===o){if(e.shiftKey){const s=this.getActiveNode();if(s.getParent()!==i.getParent())return;function a(t,e){for(let n=0;t&&t!==e&&n<1e4;n++)t.setSelected(!0),t=t.getNextSibling();e.setSelected()}this.clearSelectedNodes(),s.getIndex()<i.getIndex()?a(s,i):a(i,s),i.setFocus(!0)}else if(!b.default.isMac()&&e.ctrlKey||b.default.isMac()&&e.metaKey){const r=mt.Z.getNotePath(i);t.default.tabManager.openTabWithNoteWithHoisting(r)}else e.altKey?(i.setSelected(!i.isSelected()),i.setFocus(!0)):n.node.isActive()?this.tree.reactivate(!0):i.setActive();return!1}},beforeActivate:(t,{node:e})=>"_hidden"===Y.Z.getHoistedNoteId()?"root"!==e.data.noteId:"_hidden"!==e.data.noteId,activate:async(e,n)=>{D.Z.hide(),this.clearSelectedNodes();const o=mt.Z.getNotePath(n.node),i=t.default.tabManager.getActiveContext();await i.setNote(o)},expand:(t,e)=>this.setExpanded(e.node.data.branchId,!0),collapse:(t,e)=>this.setExpanded(e.node.data.branchId,!1),filter:{counter:!1,mode:"hide",autoExpand:!0},dnd5:{autoExpandMS:600,preventLazyParents:!1,dragStart:(t,e)=>{if(["root","_hidden","_lbRoot","_lbAvailableLaunchers","_lbVisibleLaunchers"].includes(t.data.noteId)||t.data.noteId.startsWith("_options"))return!1;const n=this.getSelectedOrActiveNodes(t).map((t=>({noteId:t.data.noteId,branchId:t.data.branchId,title:t.title})));return 1===n.length?_.Z.createLink(n[0].noteId,{referenceLink:!0,autoConvertToImage:!0}).then((t=>e.dataTransfer.setData("text/html",t[0].outerHTML))):Promise.all(n.map((t=>_.Z.createLink(t.noteId,{referenceLink:!0,autoConvertToImage:!0})))).then((t=>{const n=$("<ul>").append(...t.map((t=>$("<li>").append(t))));e.dataTransfer.setData("text/html",n[0].outerHTML)})),e.dataTransfer.setData("text",JSON.stringify(n)),!0},dragEnter:(t,e)=>"search"!==t.data.noteType&&"_lbRoot"!==t.data.noteId&&!t.data.noteId.startsWith("_options")&&("launcher"===t.data.noteType?["before","after"]:!["_lbAvailableLaunchers","_lbVisibleLaunchers"].includes(t.data.noteId)||["over"]),dragDrop:async(t,e)=>{if("over"===e.hitMode&&"search"===t.data.noteType||["after","before"].includes(e.hitMode)&&(t.data.noteId===Y.Z.getHoistedNoteId()||"search"===t.getParent().data.noteType))return void await M.Z.info("笔记不允许移动到这个地方.");const n=e.dataTransfer;if(n&&n.files&&n.files.length>0){const e=[...n.files];(await __webpack_require__.e(274).then(__webpack_require__.bind(__webpack_require__,1274))).uploadFiles("notes",t.data.noteId,e,{safeImport:!0,shrinkImages:!0,textImportedAsText:!0,codeImportedAsCode:!0,explodeArchives:!0,replaceUnderscoresWithSpaces:!0})}else{const o=n.getData("text");let i=null;try{i=JSON.parse(o)}catch(t){return void logError(`Cannot parse JSON '${o}' into notes for drop`)}const s=i.map((t=>t.branchId));if("before"===e.hitMode)d.Z.moveBeforeBranch(s,t.data.branchId);else if("after"===e.hitMode)d.Z.moveAfterBranch(s,t.data.branchId);else{if("over"!==e.hitMode)throw new Error(`Unknown hitMode '${e.hitMode}'`);d.Z.moveToParentNote(s,t.data.branchId)}}}},lazyLoad:(t,e)=>{const{noteId:n,noteType:o}=e.node.data;if("search"===o){if(mt.Z.getNotePath(e.node.getParent()).includes(n))return void(e.result=[]);e.result=g.default.loadSearchNote(n).then((()=>{const t=g.default.getNoteFromCache(n);let e=t.getChildNoteIds();return"search"===t.type&&e.length>bt&&(e=e.slice(0,bt)),g.default.getNotes(e)})).then((()=>{const t=g.default.getNoteFromCache(n);return this.prepareChildren(t)}))}else e.result=g.default.loadSubTree(n).then((t=>this.prepareChildren(t)))},clones:{highlightActiveClones:!0},enhanceTitle:async function(e,n){const o=n.node;if(!o.data.noteId)return;const i=await g.default.getNote(o.data.noteId,!0);if(!i)return;const s=t.default.tabManager.getActiveContext(),a=$(o.span);a.find(".tree-item-button").remove();const r=s&&s.hoistedNoteId===i.noteId&&"root"!==i.noteId;if(i.hasLabel("workspace")&&!r){const t=$('<span class="tree-item-button enter-workspace-button bx bx-door-open" title="提升这个笔记(工作区)"></span>').on("click",wt);a.append(t)}if("search"===i.type){const t=$('<span class="tree-item-button refresh-search-button bx bx-refresh" title="刷新保存的搜索结果"></span>').on("click",wt);a.append(t)}if(!["search","launcher"].includes(i.type)&&!i.isOptions()&&!i.isLaunchBarConfig()){const t=$('<span class="tree-item-button add-note-button bx bx-plus" title="创建子笔记"></span>').on("click",wt);a.append(t)}if(r){const t=$('<span class="tree-item-button unhoist-button bx bx-door-open" title="取消提升"></span>').on("click",wt);a.append(t)}},loadChildren:(t,e)=>{e.node.visit((t=>{t.isUndefined()&&t.isExpanded()&&t.load()}))},select:(t,{node:e})=>{"root"===Y.Z.getHoistedNoteId()&&"_hidden"===e.data.noteId&&e.isSelected()?e.setSelected(!1):$(e.span).find(".fancytree-custom-icon").attr("title",e.isSelected()?"对选定的笔记应用批量动作":"")}}),b.default.isMobile()||this.getHotKeys().then((t=>{for(const e in t){const n=t[e];$(this.tree.$container).on("keydown",null,e,(t=>{const e=this.tree.getActiveNode();return n(e,t)}))}})),this.$tree.on("contextmenu",".fancytree-node",(t=>{const e=$.ui.fancytree.getNode(t);return g.default.getNoteFromCache(e.data.noteId).isLaunchBarConfig()?__webpack_require__.e(475).then(__webpack_require__.bind(__webpack_require__,2475)).then((({default:n})=>{new n(this,e).show(t)})):__webpack_require__.e(494).then(__webpack_require__.bind(__webpack_require__,1494)).then((({default:n})=>{new n(this,e).show(t)})),!1})),this.tree=$.ui.fancytree.getTree(this.$tree)}prepareRootNode(){return this.prepareNode(g.default.getBranch("none_root"))}prepareChildren(t){b.default.assertArguments(t);const e=[],n=this.hideArchivedNotes;let o=t.getFilteredChildBranches();"search"===t.type&&o.length>bt&&(o=o.slice(0,bt));for(const t of o){if(n&&t.getNoteFromCache().hasLabel("archived"))continue;const o=this.prepareNode(t);e.push(o)}return e}async updateNode(t){const e=g.default.getNoteFromCache(t.data.noteId),n=g.default.getBranch(t.data.branchId);if(!e)return void console.log(`Node update not possible because note '${t.data.noteId}' was not found.`);if(!n)return void console.log(`Node update not possible because branch '${t.data.branchId}' was not found.`);const o=`${n.prefix?`${n.prefix} - `:""}${e.title}`;t.data.isProtected=e.isProtected,t.data.noteType=e.type,t.folder=e.isFolder(),t.icon=e.getIcon(),t.extraClasses=this.getExtraClasses(e),t.title=b.default.escapeHtml(o),t.isExpanded()!==n.isExpanded&&await t.setExpanded(n.isExpanded,{noEvents:!0,noAnimation:!0}),t.renderTitle()}prepareNode(t,e=!1){const n=t.getNoteFromCache();if(!n)throw new Error(`Branch '${t.branchId}' has no child note '${t.noteId}'`);const o=`${t.prefix?`${t.prefix} - `:""}${n.title}`,i=n.isFolder(),s={noteId:n.noteId,parentNoteId:t.parentNoteId,branchId:t.branchId,isProtected:n.isProtected,noteType:n.type,title:b.default.escapeHtml(o),extraClasses:this.getExtraClasses(n),icon:n.getIcon(i),refKey:n.noteId,lazy:!0,folder:i,expanded:t.isExpanded&&"search"!==n.type,key:b.default.randomString(12)};return i&&s.expanded&&!e&&(s.children=this.prepareChildren(n)),s}getExtraClasses(t){b.default.assertArguments(t);const e=[];t.isProtected&&e.push("protected"),t.isShared()&&e.push("shared"),t.getParentNoteIds().length>1&&t.getParentNoteIds().map((t=>g.default.notes[t])).filter((t=>!!t)).filter((t=>!["_share","_lbBookmarks"].includes(t.noteId)&&"search"!==t.type)).length>1&&e.push("multiple-parents");const n=t.getCssClass();n&&e.push(n),e.push(b.default.getNoteTypeClass(t.type)),t.mime&&e.push(b.default.getMimeTypeClass(t.mime)),t.hasLabel("archived")&&e.push("archived");const o=t.getColorClass();return o&&e.push(o),e.join(" ")}getSelectedNodes(t=!1){return this.tree.getSelectedNodes(t)}getSelectedOrActiveNodes(t=null){const e=this.getSelectedNodes(!0);return t&&!e.find((e=>e.key===t.key))&&e.push(t),0===e.length&&e.push(this.getActiveNode()),e.filter((t=>"root"!==Y.Z.getHoistedNoteId()||"_hidden"!==t.data.noteId))}async setExpandedStatusForSubtree(t,e){if(!t){const e=Y.Z.getHoistedNoteId();t=this.getNodesByNoteId(e)[0]}const{branchIds:n}=await a.Z.put(`branches/${t.data.branchId}/expanded-subtree/${e?1:0}`);g.default.getBranches(n,!0).forEach((t=>t.isExpanded=!!e)),await this.batchUpdate((async()=>{await t.load(!0),t.data.noteId!==Y.Z.getHoistedNoteId()&&await t.setExpanded(e,{noEvents:!0,noAnimation:!0})})),await this.filterHoistedBranch(!0)}async expandTree(t=null){await this.setExpandedStatusForSubtree(t,!0)}async collapseTree(t=null){await this.setExpandedStatusForSubtree(t,!1)}collapseTreeEvent(){this.collapseTree()}getActiveNode(){return this.tree.getActiveNode()}getFocusedNode(){return this.tree.getFocusNode()}clearSelectedNodes(){for(const t of this.getSelectedNodes())t.setSelected(!1)}async scrollToActiveNoteEvent(){const e=t.default.tabManager.getActiveContext();if(e&&e.notePath){this.tree.$container.focus(),this.tree.setFocus(!0);const t=await this.expandToNote(e.notePath);t&&(await t.makeVisible({scrollIntoView:!0}),t.setActive(!0,{noEvents:!0,noFocus:!1}))}}async focusTreeEvent(){this.tree.$container.focus(),this.tree.setFocus(!0)}async getNodeFromPath(t,e=!1,n=!0){b.default.assertArguments(t);let o=this.getNodesByNoteId("root")[0],i=await mt.Z.resolveNotePathToSegments(t,this.hoistedNoteId,n);if(i){i=i.slice(1);for(const s of i)if(o){o.isLoaded()||await o.load(),e&&(o.isExpanded()||await o.setExpanded(!0,{noAnimation:!0}),g.default.getBranch(o.data.branchId).isExpanded=!0),await this.updateNode(o);let i=this.findChildNode(o,s);if(!i&&(await o.load(!0),i=this.findChildNode(o,s),!i)){if(n){const e=await g.default.getNote(s);e&&"image"===e.type||dt.Z.logError(`Can't find node for child node of noteId=${s} for parent of noteId=${o.data.noteId} and hoistedNoteId=${Y.Z.getHoistedNoteId()}, requested path is ${t}`)}return}o=i}return o}n&&logError("找不到运行路径, 对应notePath为:",t)}findChildNode(t,e){return t.getChildren().find((t=>t.data.noteId===e))}async expandToNote(t,e=!0){return this.getNodeFromPath(t,!0,e)}getNodesByBranch(t){return b.default.assertArguments(t),this.getNodesByNoteId(t.noteId).filter((e=>e.data.branchId===t.branchId))}getNodesByNoteId(t){b.default.assertArguments(t);return this.tree.getNodesByRef(t)||[]}isEnabled(){return!!this.noteContext}async refresh(){this.toggleInt(this.isEnabled()),this.$treeSettingsPopup.hide(),this.activityDetected();const t=this.getActiveNode(),e=this.noteContext?.notePath&&(!mt.Z.isNotePathInHiddenSubtree(this.noteContext.notePath)||await Y.Z.isHoistedInHiddenSubtree())&&await this.getNodeFromPath(this.noteContext.notePath);if(e!==t){let n=!1;t&&(n=t.hasFocus(),t.setActive(!1),t.setFocus(!1)),e&&(e.isVisible()||await this.expandToNote(this.noteContext.notePath),e.setActive(!0,{noEvents:!0,noFocus:!n}),e.makeVisible({scrollIntoView:!0}))}this.filterHoistedBranch(!1)}async refreshSearch(t){const e=$.ui.fancytree.getNode(t);e.load(!0),e.setExpanded(!0,{noAnimation:!0}),B.default.showMessage("保存的搜索结果已刷新.")}async batchUpdate(t){try{this.tree.enableUpdate(!1),await t()}finally{this.tree.enableUpdate(!0)}}activityDetected(){this.autoCollapseTimeoutId&&clearTimeout(this.autoCollapseTimeoutId),this.autoCollapseTimeoutId=setTimeout((()=>{if(!this.autoCollapseNoteTree)return;const e=new Set(t.default.tabManager.getNoteContexts().map((t=>t.notePathArray)).flat());let n=!0;this.tree.getRootNode().visit((t=>{t.isExpanded()&&!e.has(t.data.noteId)&&(t.setExpanded(!1),n&&(B.default.showMessage("自动折叠一段时间不活跃的笔记..."),n=!1))}),!1),this.filterHoistedBranch(!0)}),6e5)}async entitiesReloadedEvent({loadResults:t}){if(this.activityDetected(),t.isEmptyForTree())return;const e=this.#e(),n={noteIdsToUpdate:new Set,noteIdsToReload:new Set};this.#n(t.getAttributeRows(),n);const{movedActiveNode:o,parentsOfAddedNodes:i}=await this.#o(t.getBranchRows(),n);for(const e of t.getNoteIds())n.noteIdsToUpdate.add(e);await this.#i(n,t),await this.#s(e,o,i),(n.noteIdsToReload.size>0||n.noteIdsToUpdate.size>0)&&this.filterHoistedBranch(!0)}#n(t,e){for(const n of t){const t=["iconClass","cssClass","workspace","workspaceIconClass","color"];if("label"===n.type&&t.includes(n.name))n.isInheritable?e.noteIdsToReload.add(n.noteId):e.noteIdsToUpdate.add(n.noteId);else if("label"===n.type&&"archived"===n.name){const t=g.default.getNoteFromCache(n.noteId);if(t)for(const n of t.getParentNotes())e.noteIdsToReload.add(n.noteId)}else if("relation"!==n.type||"template"!==n.name&&"inherit"!==n.name){if("relation"===n.type&&"imageLink"===n.name){const t=g.default.getNoteFromCache(n.noteId);t&&t.getChildNoteIds().includes(n.value)&&e.noteIdsToReload.add(n.noteId)}}else e.noteIdsToReload.add(n.noteId)}}async#o(t,e){const n=t.every((t=>!!t.isDeleted));let o=null,i=[];for(const s of t)if("_share"===s.parentNoteId?e.noteIdsToReload.add(s.noteId):e.noteIdsToUpdate.add(s.noteId),s.isDeleted)for(const t of this.getNodesByBranch(s)){if(t.isActive())if(n){const e=t.getNextSibling()||t.getPrevSibling()||t.getParent();e&&e.setActive(!0,{noEvents:!0,noFocus:!0})}else o=t;t.getParent()&&t.remove(),e.noteIdsToUpdate.add(s.parentNoteId)}else for(const t of this.getNodesByNoteId(s.parentNoteId)){if(i.push(t),t.isFolder()&&!t.isLoaded())continue;const n=await g.default.getNote(s.noteId),o=g.default.getBranch(s.branchId),a=(t.getChildren()||[]).find((t=>t.data.noteId===s.noteId));a?s.isExpanded!==a.isExpanded()&&e.noteIdsToReload.add(o.noteId):(t.addChildren([this.prepareNode(o,!0)]),o.isExpanded&&n.hasChildren()&&e.noteIdsToReload.add(o.noteId),this.sortChildren(t),e.noteIdsToUpdate.add(s.parentNoteId))}return{movedActiveNode:o,parentsOfAddedNodes:i}}async#i(t,e){await this.batchUpdate((async()=>{for(const e of t.noteIdsToReload)for(const n of this.getNodesByNoteId(e))await n.load(!0),t.noteIdsToUpdate.add(e);for(const t of e.getNoteReorderings())for(const e of this.getNodesByNoteId(t))e.isLoaded()&&this.sortChildren(e)}));for(const e of t.noteIdsToUpdate)for(const t of this.getNodesByNoteId(e))await this.updateNode(t)}#e(){const t={activeNotePath:null,activeNodeFocused:null,nextNotePath:null},e=this.getActiveNode();t.activeNodeFocused=e?.hasFocus(),t.activeNotePath=e?mt.Z.getNotePath(e):null;const n=e?e.getNextSibling()||e.getPrevSibling()||e.getParent():null;return t.nextNotePath=n?mt.Z.getNotePath(n):null,t}async#s(e,n,o){if(n)for(const t of o){const o=(t.getChildren()||[]).find((t=>t.data.noteId===n.data.noteId));if(o){e.activeNotePath=mt.Z.getNotePath(o);break}}if(!e.activeNotePath)return;let i=await this.expandToNote(e.activeNotePath,!1);if(i&&i.data.noteId!==mt.Z.getNoteIdFromUrl(e.activeNotePath)){const t=this.getNodesByNoteId(mt.Z.getNoteIdFromUrl(e.activeNotePath));i=1===t.length?t[0]:null}i?(e.activeNodeFocused&&this.tree.$container.focus(),await i.setActive(!0,{noEvents:!0,noFocus:!e.activeNodeFocused})):(i=await this.expandToNote(e.nextNotePath,!1),i&&t.default.tabManager.getActiveContext().setNote(e.nextNotePath).then((()=>{const t=this.getActiveNode();t&&e.activeNodeFocused&&t.setFocus(!0)})))}sortChildren(t){t.sortChildren(((t,e)=>{const n=g.default.branches[t.data.branchId],o=g.default.branches[e.data.branchId];return n&&o?n.notePosition-o.notePosition:0}))}setExpanded(t,e){b.default.assertArguments(t);const n=g.default.getBranch(t,!0);if(!n)return t&&t.startsWith("virt")?void 0:void logError(`找不到 branch=${t}`);n.isExpanded=e,a.Z.put(`branches/${t}/expanded/${e?1:0}`)}async reloadTreeFromCache(){const t=this.getActiveNode(),e=null!==t?mt.Z.getNotePath(t):null,n=this.prepareRootNode();if(await this.batchUpdate((async()=>{await this.tree.reload([n])})),await this.filterHoistedBranch(!0),e){const t=await this.getNodeFromPath(e,!0);t&&await t.setActive(!0,{noEvents:!0,noFocus:!0})}}async hoistedNoteChangedEvent({ntxId:t}){this.isNoteContext(t)&&await this.filterHoistedBranch(!0)}async filterHoistedBranch(t=!1){if(!this.noteContext)return;const e=await mt.Z.resolveNotePath(this.noteContext.hoistedNoteId);(t||this.lastFilteredHoistedNotePath!==e)&&(this.lastFilteredHoistedNotePath=e,await this.getNodeFromPath(e),"root"===this.noteContext.hoistedNoteId?(this.tree.clearFilter(),this.toggleHiddenNode(!1)):(this.tree.filterBranches((t=>t.data.noteId===this.noteContext.hoistedNoteId&&mt.Z.getNotePath(t)===e)),this.toggleHiddenNode(!0)))}toggleHiddenNode(t){const e=this.getNodesByNoteId("_hidden")[0];$(e.li).toggleClass("hidden-node-is-hidden",!t)}frocaReloadedEvent(){this.reloadTreeFromCache()}async getHotKeys(){const t=await p.default.getActionsForScope("note-tree"),e={};for(const n of t)for(const t of n.effectiveShortcuts)e[l.Z.normalizeShortcut(t)]=t=>{const e=mt.Z.getNotePath(t);return this.triggerCommand(n.actionName,{node:t,notePath:e}),!1};return e}getSelectedOrActiveBranchIds(t){return this.getSelectedOrActiveNodes(t).map((t=>t.data.branchId))}getSelectedOrActiveNoteIds(t){return this.getSelectedOrActiveNodes(t).map((t=>t.data.noteId))}async deleteNotesCommand({node:t}){const e=this.getSelectedOrActiveBranchIds(t).filter((t=>!t.startsWith("virt-")));e.length&&(await d.Z.deleteNotes(e),this.clearSelectedNodes())}canBeMovedUpOrDown(t){if("root"===t.data.noteId)return!1;const e=g.default.getNoteFromCache(t.getParent().data.noteId);return!e?.hasLabel("sorted")}moveNoteUpCommand({node:t}){if(!this.canBeMovedUpOrDown(t))return;const e=t.getPrevSibling();null!==e&&d.Z.moveBeforeBranch([t.data.branchId],e.data.branchId)}moveNoteDownCommand({node:t}){if(!this.canBeMovedUpOrDown(t))return;const e=t.getNextSibling();null!==e&&d.Z.moveAfterBranch([t.data.branchId],e.data.branchId)}moveNoteUpInHierarchyCommand({node:t}){d.Z.moveNodeUpInHierarchy(t)}moveNoteDownInHierarchyCommand({node:t}){const e=t.getPrevSibling();null!==e&&d.Z.moveToParentNote([t.data.branchId],e.data.branchId)}addNoteAboveToSelectionCommand(){const t=this.getFocusedNode();if(!t)return;t.isActive()&&t.setSelected(!0);const e=t.getPrevSibling();e&&(e.setActive(!0,{noEvents:!0}),e.isSelected()&&t.setSelected(!1),e.setSelected(!0))}addNoteBelowToSelectionCommand(){const t=this.getFocusedNode();if(!t)return;t.isActive()&&t.setSelected(!0);const e=t.getNextSibling();e&&(e.setActive(!0,{noEvents:!0}),e.isSelected()&&t.setSelected(!1),e.setSelected(!0))}expandSubtreeCommand({node:t}){this.expandTree(t)}collapseSubtreeCommand({node:t}){this.collapseTree(t)}async recentChangesInSubtreeCommand({node:t}){this.triggerCommand("showRecentChanges",{ancestorNoteId:t.data.noteId})}selectAllNotesInParentCommand({node:t}){for(const e of t.getParent().getChildren())e.setSelected(!0)}copyNotesToClipboardCommand({node:t}){ft.Z.copy(this.getSelectedOrActiveBranchIds(t))}cutNotesToClipboardCommand({node:t}){ft.Z.cut(this.getSelectedOrActiveBranchIds(t))}pasteNotesFromClipboardCommand({node:t}){ft.Z.pasteInto(t.data.branchId)}pasteNotesAfterFromClipboardCommand({node:t}){ft.Z.pasteAfter(t.data.branchId)}async exportNoteCommand({node:t}){const e=mt.Z.getNotePath(t);this.triggerCommand("showExportDialog",{notePath:e,defaultType:"subtree"})}async importIntoNoteCommand({node:t}){this.triggerCommand("showImportDialog",{noteId:t.data.noteId})}editNoteTitleCommand({node:e}){t.default.triggerCommand("focusOnTitle")}protectSubtreeCommand({node:t}){G.Z.protectNote(t.data.noteId,!0,!0)}unprotectSubtreeCommand({node:t}){G.Z.protectNote(t.data.noteId,!1,!0)}duplicateSubtreeCommand({node:t}){const e=this.getSelectedOrActiveNodes(t);for(const t of e){if(g.default.getNoteFromCache(t.data.noteId).isProtected&&!s.Z.isProtectedSessionAvailable())continue;const e=g.default.getBranch(t.data.branchId);u.Z.duplicateSubtree(t.data.noteId,e.parentNoteId)}}moveShortcutToVisibleCommand({node:t,selectedOrActiveBranchIds:e}){d.Z.moveToParentNote(e,"_lbVisibleLaunchers")}moveShortcutToAvailableCommand({node:t,selectedOrActiveBranchIds:e}){d.Z.moveToParentNote(e,"_lbAvailableLaunchers")}addNoteLauncherCommand({node:t}){this.createLauncherNote(t,"note")}addScriptLauncherCommand({node:t}){this.createLauncherNote(t,"script")}addWidgetLauncherCommand({node:t}){this.createLauncherNote(t,"customWidget")}addSpacerLauncherCommand({node:t}){this.createLauncherNote(t,"spacer")}async createLauncherNote(e,n){const o=await a.Z.post(`special-notes/launchers/${e.data.noteId}/${n}`);o.success||B.default.showError(o.message),await dt.Z.waitForMaxKnownEntityChangeId(),t.default.tabManager.getActiveContext().setNote(o.note.noteId)}}class xt extends e.Z{doRender(){this.$widget=$('\n<button type="button" class="action-button d-sm-none d-md-none d-lg-none d-xl-none" aria-label="Close" style="padding-top: 10px;">\n    <span aria-hidden="true">&times;</span>\n</button>'),this.$widget.on("click",(()=>this.triggerCommand("setActiveScreen",{screen:"tree"})))}}const vt=xt;class $t extends e.Z{doRender(){this.$widget=$('<button type="button" class="action-button bx bx-menu" style="padding-top: 10px;"></button>'),this.$widget.on("click",(async e=>{const n=t.default.tabManager.getActiveContextNote();D.Z.show({x:e.pageX,y:e.pageY,items:[{title:"插入子笔记",command:"insertChildNote",uiIcon:"bx bx-plus",enabled:"search"!==n.type},{title:"删除此笔记",command:"delete",uiIcon:"bx bx-trash",enabled:"root"!==n.noteId}],selectMenuItemHandler:async({command:e})=>{if("insertChildNote"===e)u.Z.createNote(t.default.tabManager.getActiveContextNotePath());else{if("delete"!==e)throw new Error(`Unrecognized command ${e}`);{const e=t.default.tabManager.getActiveContextNotePath(),n=await mt.Z.getBranchIdFromUrl(e);if(!n)throw new Error(`Cannot get branchId for notePath '${e}'`);await d.Z.deleteNotes([n])&&this.triggerCommand("setActiveScreen",{screen:"tree"})}}}})}))}}const It=$t;class Ct extends o{constructor(t,e){super(e),this.screenName=t}activeScreenChangedEvent({activeScreen:t}){t===this.screenName?this.$widget.removeClass("d-none"):this.$widget.addClass("d-none")}}class Nt extends n{constructor(){super(),this.class("scrolling-container"),this.css("overflow","auto"),this.css("scroll-behavior","smooth"),this.css("position","relative")}setNoteContextEvent({noteContext:t}){this.noteContext=t}async noteSwitchedEvent({noteContext:t,notePath:e}){this.$widget.scrollTop(0)}async noteSwitchedAndActivatedEvent({noteContext:t,notePath:e}){this.noteContext=t,this.$widget.scrollTop(0)}async activeContextChangedEvent({noteContext:t}){this.noteContext=t}handleEventInChildren(t,e){if("readOnlyTemporarilyDisabled"===t&&this.noteContext&&this.noteContext.ntxId===e.noteContext.ntxId){const n=this.$widget.scrollTop(),o=super.handleEventInChildren(t,e);return o.then((()=>setTimeout((()=>this.$widget.scrollTop(n)),500))),o}return super.handleEventInChildren(t,e)}scrollContainerToCommand({position:t}){this.$widget.scrollTop(t)}}class kt extends e.Z{doRender(){this.$widget=$('\n<div class="protected-session-password-dialog modal mx-auto" data-backdrop="false" tabindex="-1" role="dialog">\n    <div class="modal-dialog modal-md" role="document">\n        <div class="modal-content">\n            <div class="modal-header">\n                <h5 class="modal-title mr-auto">保护会话</h5>\n\n                <button class="help-button" type="button" data-help-page="Protected-notes" title="保护会话帮助文档">?</button>\n\n                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-left: 0;">\n                    <span aria-hidden="true">&times;</span>\n                </button>\n            </div>\n            <form class="protected-session-password-form">\n                <div class="modal-body">\n                    <div class="form-group">\n                        <label style="width: -webkit-fill-available">\n                            输入密码进入保护会话以继续\n                            <input class="form-control protected-session-password" type="password">\n                        </label>\n                    </div>\n                </div>\n                <div class="modal-footer">\n                    <button class="btn btn-primary">开始受保护的会话<kbd>回车</kbd></button>\n                </div>\n            </form>\n        </div>\n    </div>\n</div>'),this.$passwordForm=this.$widget.find(".protected-session-password-form"),this.$passwordInput=this.$widget.find(".protected-session-password"),this.$passwordForm.on("submit",(()=>{const t=this.$passwordInput.val();return this.$passwordInput.val(""),G.Z.setupProtectedSession(t),!1}))}showProtectedSessionPasswordDialogEvent(){b.default.openDialog(this.$widget),this.$passwordInput.trigger("focus")}closeProtectedSessionPasswordDialogEvent(){this.$widget.modal("hide")}}const St="confirm-dialog-delete-note";class Tt extends e.Z{constructor(){super(),this.resolve=null,this.$originallyFocused=null}doRender(){this.$widget=$('\n<div class="confirm-dialog modal mx-auto" tabindex="-1" role="dialog" style="z-index: 2000;">\n    <div class="modal-dialog modal-dialog-scrollable" role="document">\n        <div class="modal-content">\n            <div class="modal-header">\n                <h5 class="modal-title mr-auto">确认</h5>\n\n                <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n                    <span aria-hidden="true">&times;</span>\n                </button>\n            </div>\n            <div class="modal-body">\n                <div class="confirm-dialog-content"></div>\n\n                <div class="confirm-dialog-custom"></div>\n            </div>\n            <div class="modal-footer">\n                <button class="confirm-dialog-cancel-button btn btn-sm">取消</button>\n\n                &nbsp;\n\n                <button class="confirm-dialog-ok-button btn btn-primary btn-sm">好的</button>\n            </div>\n        </div>\n    </div>\n</div>'),this.$confirmContent=this.$widget.find(".confirm-dialog-content"),this.$okButton=this.$widget.find(".confirm-dialog-ok-button"),this.$cancelButton=this.$widget.find(".confirm-dialog-cancel-button"),this.$custom=this.$widget.find(".confirm-dialog-custom"),this.$widget.on("shown.bs.modal",(()=>this.$okButton.trigger("focus"))),this.$widget.on("hidden.bs.modal",(()=>{this.resolve&&this.resolve(!1),this.$originallyFocused&&(this.$originallyFocused.trigger("focus"),this.$originallyFocused=null)})),this.$cancelButton.on("click",(()=>this.doResolve(!1))),this.$okButton.on("click",(()=>this.doResolve(!0)))}showConfirmDialogEvent({message:t,callback:e}){this.$originallyFocused=$(":focus"),this.$custom.hide(),glob.activeDialog=this.$widget,"string"==typeof t&&(t=$("<div>").text(t)),this.$confirmContent.empty().append(t),this.$widget.modal(),this.resolve=e}showConfirmDeleteNoteBoxWithNoteDialogEvent({title:t,callback:e}){glob.activeDialog=this.$widget,this.$confirmContent.text(`Are you sure you want to remove the note "${t}" from relation map?`),this.$custom.empty().append("<br/>").append($("<div>").addClass("form-check").append($("<label>").addClass("form-check-label").attr("style","text-decoration: underline dotted var(--main-text-color)").attr("title","如果不勾选这个, 笔记只会从关系地图里移除.").append($("<input>").attr("type","checkbox").addClass(`form-check-input ${St}`)).append("Also delete the note"))),this.$custom.show(),this.$widget.modal(),this.resolve=e}doResolve(t){this.resolve({confirmed:t,isDeleteNoteChecked:this.$widget.find(`.${St}:checked`).length>0}),this.resolve=null,this.$widget.modal("hide")}}class Et extends i.Z{get name(){return"fileProperties"}get toggleCommand(){return"toggleRibbonTabFileProperties"}isEnabled(){return this.note&&"file"===this.note.type}getTitle(){return{show:this.isEnabled(),activate:!0,title:"文件",icon:"bx bx-file"}}doRender(){this.$widget=$('\n<div class="file-properties-widget">\n    <style> \n        .file-table {\n            width: 100%;\n            margin-top: 10px;\n        }\n        \n        .file-table th, .file-table td {\n            padding: 5px;\n            overflow-wrap: anywhere;\n        }\n        \n        .file-buttons {\n            padding: 10px; \n            display: flex; \n            justify-content: space-evenly;\n        }\n    </style>\n\n    <table class="file-table">\n        <tr>\n            <th>笔记ID:</th>\n            <td class="file-note-id"></td>\n            <th>原始文件名:</th>\n            <td class="file-filename"></td>\n        </tr>\n        <tr>\n            <th>文件类型:</th>\n            <td class="file-filetype"></td>\n            <th>文件大小:</th>\n            <td class="file-filesize"></td>\n        </tr>\n        \n        <tr>\n            <td colspan="4">\n                <div class="file-buttons">\n                    <button class="file-download btn btn-sm btn-primary" type="button">下载</button>\n                    &nbsp;\n                    <button class="file-open btn btn-sm btn-primary" type="button">打开</button>\n                    &nbsp;\n                    <button class="file-upload-new-revision btn btn-sm btn-primary">上传新的修改</button>\n                \n                    <input type="file" class="file-upload-new-revision-input" style="display: none">\n                </div>\n            </td>\n        </tr>\n    </table>\n</div>'),this.contentSized(),this.$fileNoteId=this.$widget.find(".file-note-id"),this.$fileName=this.$widget.find(".file-filename"),this.$fileType=this.$widget.find(".file-filetype"),this.$fileSize=this.$widget.find(".file-filesize"),this.$downloadButton=this.$widget.find(".file-download"),this.$openButton=this.$widget.find(".file-open"),this.$uploadNewRevisionButton=this.$widget.find(".file-upload-new-revision"),this.$uploadNewRevisionInput=this.$widget.find(".file-upload-new-revision-input"),this.$downloadButton.on("click",(()=>L.Z.downloadFileNote(this.noteId))),this.$openButton.on("click",(()=>L.Z.openNoteExternally(this.noteId,this.note.mime))),this.$uploadNewRevisionButton.on("click",(()=>{this.$uploadNewRevisionInput.trigger("click")})),this.$uploadNewRevisionInput.on("change",(async()=>{const t=this.$uploadNewRevisionInput[0].files[0];this.$uploadNewRevisionInput.val(""),(await a.Z.upload(`notes/${this.noteId}/file`,t)).uploaded?(B.default.showMessage("新文件修改已上传."),this.refresh()):B.default.showError("上传新笔记修改是该:")}))}async refreshWithNote(t){this.$widget.show(),this.$fileNoteId.text(t.noteId),this.$fileName.text(t.getLabelValue("originalFileName")||"?"),this.$fileType.text(t.mime);const e=await this.note.getBlob();this.$fileSize.text(b.default.formatSize(e.contentLength)),this.$openButton.toggle(!t.isProtected),this.$downloadButton.toggle(!t.isProtected||s.Z.isProtectedSessionAvailable()),this.$uploadNewRevisionButton.toggle(!t.isProtected||s.Z.isProtectedSessionAvailable())}}class At extends i.Z{doRender(){this.$widget=$('\n<div class="floating-buttons no-print">\n    <style>\n        .floating-buttons {\n            position: relative;\n        }\n        \n        .floating-buttons-children {\n            position: absolute; \n            top: 10px; \n            right: 10px;\n            display: flex;\n            flex-direction: row;\n            z-index: 100;\n        }\n        \n        .type-canvas .floating-buttons-children {\n            top: 70px; \n        }\n        \n        .floating-buttons-children > *:not(.hidden-int):not(.no-content-hidden) {\n            margin-left: 10px;\n        }\n        \n        .floating-buttons-children > button, .floating-buttons-children .floating-button {\n            font-size: 150%;\n            padding: 5px 10px 4px 10px;\n            width: 40px;\n            cursor: pointer;\n            color: var(--button-text-color);\n            background: var(--button-background-color);\n            border-radius: var(--button-border-radius);\n            border: 1px solid transparent;\n            display: flex;\n            justify-content: space-around;\n        }\n        \n        .floating-buttons-children > button:hover, .floating-buttons-children .floating-button:hover {\n            text-decoration: none;\n            border-color: var(--button-border-color);\n        }\n        \n        .floating-buttons.temporarily-hidden {\n            display: none;\n        }\n    </style>\n    \n    <div class="floating-buttons-children"></div>\n</div>'),this.$children=this.$widget.find(".floating-buttons-children");for(const t of this.children)this.$children.append(t.render())}async refreshWithNote(t){this.toggle(!0)}toggle(t){this.$widget.toggleClass("temporarily-hidden",!t)}hideFloatingButtonsCommand(){this.toggle(!1)}}class _t extends i.Z{isEnabled(){return!0}constructor(){super(),this.settings={titlePlacement:"right",title:null,icon:null,onContextMenu:null}}doRender(){this.$widget=$('<button class="button-widget bx"\n      data-toggle="tooltip"\n      title=""></button>'),this.settings.onContextMenu&&this.$widget.on("contextmenu",(t=>(this.$widget.tooltip("hide"),this.settings.onContextMenu(t),!1))),this.$widget.attr("data-placement",this.settings.titlePlacement),this.$widget.tooltip({html:!0,title:()=>this.getTitle(),trigger:"hover"}),super.doRender()}getTitle(){return"function"==typeof this.settings.title?this.settings.title():this.settings.title}refreshIcon(){for(const t of this.$widget[0].classList)t.startsWith("bx-")&&this.$widget.removeClass(t);const t="function"==typeof this.settings.icon?this.settings.icon():this.settings.icon;this.$widget.addClass(t)}initialRenderCompleteEvent(){this.refreshIcon()}icon(t){return this.settings.icon=t,this}title(t){return this.settings.title=t,this}titlePlacement(t){return this.settings.titlePlacement=t,this}onContextMenu(t){return this.settings.onContextMenu=t,this}}class Pt extends _t{doRender(){super.doRender(),this.settings.onClick?this.$widget.on("click",(t=>{t.stopPropagation(),this.$widget.tooltip("hide"),this.settings.onClick(this,t)})):console.warn(`Button widget '${this.componentId}' has no defined click handler`,this.settings),this.settings.onAuxClick&&this.$widget.on("auxclick",(t=>{this.$widget.tooltip("hide"),this.settings.onAuxClick(this,t)}))}onClick(t){return this.settings.onClick=t,this}onAuxClick(t){return this.settings.onAuxClick=t,this}}class Rt extends Pt{isEnabled(){return super.isEnabled()&&this.note&&"default"===this.noteContext.viewScope.viewMode}constructor(){super(),this.icon("bx-edit-alt").title("编辑笔记").titlePlacement("bottom").onClick((e=>{this.noteContext.viewScope.readOnlyTemporarilyDisabled=!0,t.default.triggerEvent("readOnlyTemporarilyDisabled",{noteContext:this.noteContext}),this.refresh()}))}async refreshWithNote(t){if(t.isProtected&&!s.Z.isProtectedSessionAvailable())this.toggleInt(!1);else{this.toggleInt(!1);const t=this.isVisible();this.toggleInt(await this.noteContext.isReadOnly()),this.isVisible()&&!t&&(this.$widget.addClass("bx-tada bx-lg"),setTimeout((()=>{this.$widget.removeClass("bx-tada bx-lg")}),1700))}await super.refreshWithNote(t)}entitiesReloadedEvent({loadResults:t}){t.getAttributeRows().find((t=>"label"===t.type&&t.name.toLowerCase().includes("readonly")&&m.isAffecting(t,this.note)))&&(this.noteContext.viewScope.readOnlyTemporarilyDisabled=!1,this.refresh())}async noteTypeMimeChangedEvent({noteId:t}){this.isNote(t)&&await this.refresh()}}class Mt extends i.Z{isEnabled(){return super.isEnabled()&&"relationMap"===this.note?.type}doRender(){super.doRender(),this.$widget=$('\n<div class="relation-map-buttons">\n    <style>\n        .relation-map-buttons {\n            display: flex;\n            gap: 10px;\n        }\n    </style>\n\n    <button type="button"\n            class="relation-map-create-child-note floating-button btn bx bx-folder-plus"\n            title="创建新的子笔记并将其添加到此关系图中"></button>\n    \n    <button type="button"\n            class="relation-map-reset-pan-zoom floating-button btn bx bx-crop"\n            title="重置放大系数和座标"></button>\n    \n    <div class="btn-group">\n        <button type="button"\n                class="relation-map-zoom-in floating-button btn bx bx-zoom-in"\n                title="放大"></button>\n    \n        <button type="button"\n                class="relation-map-zoom-out floating-button btn bx bx-zoom-out"\n                title="缩小"></button>\n    </div>\n</div>'),this.$createChildNote=this.$widget.find(".relation-map-create-child-note"),this.$zoomInButton=this.$widget.find(".relation-map-zoom-in"),this.$zoomOutButton=this.$widget.find(".relation-map-zoom-out"),this.$resetPanZoomButton=this.$widget.find(".relation-map-reset-pan-zoom"),this.$createChildNote.on("click",(()=>this.triggerEvent("relationMapCreateChildNote",{ntxId:this.ntxId}))),this.$resetPanZoomButton.on("click",(()=>this.triggerEvent("relationMapResetPanZoom",{ntxId:this.ntxId}))),this.$zoomInButton.on("click",(()=>this.triggerEvent("relationMapResetZoomIn",{ntxId:this.ntxId}))),this.$zoomOutButton.on("click",(()=>this.triggerEvent("relationMapResetZoomOut",{ntxId:this.ntxId}))),this.contentSized()}}class Zt extends i.Z{isEnabled(){return super.isEnabled()&&"mermaid"===this.note?.type&&this.note.isContentAvailable()&&"default"===this.noteContext?.viewScope.viewMode}doRender(){super.doRender(),this.$widget=$('\n<button type="button"\n        class="export-mermaid-button"\n        title="将美人鱼图导出为SVG">\n        <span class="bx bx-export"></span>\n</button>\n'),this.$widget.on("click",(()=>this.triggerEvent("exportMermaid",{ntxId:this.ntxId}))),this.contentSized()}}class Lt extends i.Z{doRender(){this.$widget=$('\n<div class="backlinks-widget">\n    <style>\n        .backlinks-widget {\n            position: relative;\n        }\n    \n        .backlinks-ticker {\n            border-radius: 10px;\n            border-color: var(--main-border-color);\n            background-color: var(--more-accented-background-color);\n            padding: 4px 10px 4px 10px;\n            opacity: 90%;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n        \n        .backlinks-count {\n            cursor: pointer;\n        }\n                        \n        .backlinks-items {\n            z-index: 10;\n            position: absolute;\n            top: 50px;\n            right: 10px;\n            width: 400px;\n            border-radius: 10px;\n            background-color: var(--accented-background-color);\n            color: var(--main-text-color);\n            padding: 20px;\n            overflow-y: auto;\n        }\n        \n        .backlink-excerpt {\n            border-left: 2px solid var(--main-border-color);\n            padding-left: 10px;\n            opacity: 80%;\n            font-size: 90%;\n        }\n        \n        .backlink-excerpt .backlink-link { /* the actual backlink */\n            font-weight: bold;\n            background-color: yellow;\n        }\n    </style>\n    \n    <div class="backlinks-ticker">\n        <span class="backlinks-count"></span>\n    </div>   \n    \n    <div class="backlinks-items" style="display: none;"></div>\n</div>\n'),this.$count=this.$widget.find(".backlinks-count"),this.$items=this.$widget.find(".backlinks-items"),this.$ticker=this.$widget.find(".backlinks-ticker"),this.$count.on("click",(()=>{this.$items.toggle(),this.$items.css("max-height",$(window).height()-this.$items.offset().top-10),this.$items.is(":visible")&&this.renderBacklinks()})),this.contentSized()}async refreshWithNote(t){if(this.clearItems(),"default"!==this.noteContext?.viewScope?.viewMode)return void this.toggle(!1);const e=await a.Z.get(`note-map/${this.noteId}/backlink-count`);e&&e.count?(this.toggle(!0),this.$count.text(`${e.count} 个反链`)):this.toggle(!1)}toggle(t){this.$widget.toggleClass("hidden-no-content",!t)}clearItems(){this.$items.empty().hide()}async renderBacklinks(){if(!this.note)return;this.$items.empty();const t=await a.Z.get(`note-map/${this.noteId}/backlinks`);if(t.length){await g.default.getNotes(t.map((t=>t.noteId)));for(const e of t){const t=$("<div>");t.append(await _.Z.createLink(e.noteId,{showNoteIcon:!0,showNotePath:!0,showTooltip:!1})),e.relationName?t.append($("<p>").text(`relation: ${e.relationName}`)):t.append(...e.excerpts),this.$items.append(t)}}}}class Dt extends i.Z{doRender(){super.doRender(),this.$widget=$('\n<div class="close-floating-buttons">\n    <style>\n        .close-floating-buttons {\n            display: none;\n            margin-left: 5px !important;\n        }\n    \n        /* conditionally display close button if there\'s some other button visible */\n        .floating-buttons *:not(.hidden-int):not(.hidden-no-content) ~ .close-floating-buttons {\n            display: block;\n        }\n        \n        .close-floating-buttons-button {\n            border: 1px solid transparent;\n            color: var(--button-text-color);\n            padding: 6px;\n            border-radius: 100px;\n        }\n        \n        .close-floating-buttons-button:hover {\n            border: 1px solid var(--button-border-color);\n        }\n    </style>\n\n    <button type="button"\n            class="close-floating-buttons-button btn bx bx-x"\n            title="隐藏按钮"></button>\n</div>\n'),this.$widget.on("click",(()=>this.triggerCommand("hideFloatingButtons"))),this.contentSized()}}let Bt=1;class Ot extends i.Z{isEnabled(){return super.isEnabled()&&"mermaid"===this.note?.type&&this.note.isContentAvailable()&&"default"===this.noteContext?.viewScope.viewMode}doRender(){this.$widget=$('<div class="mermaid-widget">\n    <style>\n        .mermaid-widget {\n            flex-grow: 2;\n            overflow: auto;\n            min-height: 200px;\n            border-bottom: 1px solid var(--main-border-color);\n            padding: 20px;\n            margin-bottom: 10px;\n            flex-basis: 0;\n        }\n        \n        .mermaid-render {\n            overflow: auto;\n            height: 100%;\n            text-align: center;\n        }\n        \n        .mermaid-render svg {\n            width: 95%; /* https://github.com/zadam/trilium/issues/4340 */\n        }\n    </style>\n\n    <div class="mermaid-error alert alert-warning">\n        <p><strong>图表无法显示. 请看 <a href="https://mermaid-js.github.io/mermaid/#/flowchart?id=graph">帮助和示例</a>.</strong></p>\n        <p class="error-content"></p>\n    </div>\n\n    <div class="mermaid-render"></div>\n</div>'),this.contentSized(),this.$display=this.$widget.find(".mermaid-render"),this.$errorContainer=this.$widget.find(".mermaid-error"),this.$errorMessage=this.$errorContainer.find(".error-content")}async refreshWithNote(t){this.$errorContainer.hide(),await h.Z.requireLibrary(h.Z.MERMAID);const e=window.getComputedStyle(document.documentElement).getPropertyValue("--mermaid-theme");mermaid.mermaidAPI.initialize({startOnLoad:!1,theme:e.trim(),securityLevel:"antiscript",flow:{useMaxWidth:!1},sequence:{useMaxWidth:!1},gantt:{useMaxWidth:!1},class:{useMaxWidth:!1},state:{useMaxWidth:!1},pie:{useMaxWidth:!0},journey:{useMaxWidth:!1},git:{useMaxWidth:!1}}),this.$display.empty();const n=h.Z.requireLibrary(h.Z.WHEEL_ZOOM);this.$errorContainer.hide();try{const t=await this.renderSvg();if(this.dirtyAttachment){const e={role:"image",title:"mermaid-export.svg",mime:"image/svg+xml",content:t,position:0};a.Z.post(`notes/${this.noteId}/attachments?matchBy=title`,e).then((()=>{this.dirtyAttachment=!1}))}this.$display.html(t),await n,this.$display.attr("id",`mermaid-render-${Bt}`),WZoom.create(`#mermaid-render-${Bt}`,{type:"html",maxScale:50,speed:1.3,zoomOnClick:!1})}catch(t){this.$errorMessage.text(t.message),this.$errorContainer.show()}}async renderSvg(){Bt++;const t=(await this.note.getBlob()).content||"",{svg:e}=await mermaid.mermaidAPI.render(`mermaid-graph-${Bt}`,t);return e}async entitiesReloadedEvent({loadResults:t}){t.isNoteContentReloaded(this.noteId)&&(this.dirtyAttachment=!0,await this.refresh())}async exportMermaidEvent({ntxId:t}){if(!this.isNoteContext(t))return;const e=await this.renderSvg();this.download(`${this.note.title}.svg`,e)}download(t,e){const n=document.createElement("a");n.setAttribute("href",`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}class Ft extends i.Z{isEnabled(){return super.isEnabled()&&this.noteContext.hasNoteList()}doRender(){this.$widget=$('\n<div class="note-list-widget">\n    <style>\n    .note-list-widget {\n        min-height: 0;\n        overflow: auto;\n    }\n    \n    .note-list-widget .note-list {\n        padding: 10px;\n    }\n    </style>\n    \n    <div class="note-list-widget-content">\n    </div>\n</div>'),this.contentSized(),this.$content=this.$widget.find(".note-list-widget-content");const t=new IntersectionObserver((t=>{this.isIntersecting=t[0].isIntersecting,this.checkRenderStatus()}),{rootMargin:"50px",threshold:.1});setTimeout((()=>t.observe(this.$widget[0])),10)}checkRenderStatus(){this.isIntersecting&&this.noteIdRefreshed===this.noteId&&this.shownNoteId!==this.noteId&&(this.shownNoteId=this.noteId,this.renderNoteList(this.note))}async renderNoteList(t){const e=new class{constructor(t,e,n,o=!1){this.$noteList=$('\n<div class="note-list">\n    <style>\n    .note-list {\n        overflow: hidden;\n        position: relative;\n        height: 100%;\n    }\n\n    .note-list.grid-view .note-list-container {\n        display: flex;\n        flex-wrap: wrap;\n    }\n\n    .note-list.grid-view .note-book-card {\n        flex-basis: 300px;\n        border: 1px solid transparent;\n    }\n\n    .note-list.grid-view .note-expander {\n        display: none;\n    }\n\n    .note-list.grid-view .note-book-card {\n        max-height: 300px;\n    }\n    \n    .note-list.grid-view .note-book-card img {\n        max-height: 220px;\n        object-fit: contain;\n    }\n\n    .note-list.grid-view .note-book-card:hover {\n        cursor: pointer;\n        border: 1px solid var(--main-border-color);\n        background: var(--more-accented-background-color);\n    }\n\n    .note-book-card {\n        border-radius: 10px;\n        background-color: var(--accented-background-color);\n        padding: 10px 15px 15px 8px;\n        margin: 5px 5px 5px 5px;\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n        flex-shrink: 0;\n        flex-grow: 1;\n    }\n\n    .note-book-card:not(.expanded) .note-book-content {\n        display: none !important;\n        padding: 10px\n    }\n\n    .note-book-card.expanded .note-book-content {\n        display: block;\n        min-height: 0;\n        height: 100%;\n        padding-top: 10px;\n    }\n\n    .note-book-content .rendered-content {\n        height: 100%;\n    }\n\n    .note-book-header {\n        border-bottom: 1px solid var(--main-border-color);\n        margin-bottom: 0;\n        padding-bottom: .5rem;\n        word-break: break-all;\n    }\n\n    /* not-expanded title is limited to one line only */\n    .note-book-card:not(.expanded) .note-book-header {\n        overflow: hidden;\n        white-space: nowrap;\n        text-overflow: ellipsis;\n    }\n\n    .note-book-header .rendered-note-attributes {\n        font-size: medium;\n    }\n\n    .note-book-header .rendered-note-attributes:before {\n        content: "\\00a0\\00a0";\n    }\n\n    .note-book-header .note-icon {\n        font-size: 100%;\n        display: inline-block;\n        padding-right: 7px;\n        position: relative;\n    }\n\n    .note-book-card .note-book-card {\n        border: 1px solid var(--main-border-color);\n    }\n\n    .note-book-content.type-image, .note-book-content.type-file, .note-book-content.type-protectedSession {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        text-align: center;\n        padding: 10px;\n    }\n\n    .note-book-content.type-image img, .note-book-content.type-canvas svg {\n        max-width: 100%;\n        max-height: 100%;\n        object-fit: contain;\n    }\n\n    .note-book-card.type-image .note-book-content img,\n    .note-book-card.type-text .note-book-content img,\n    .note-book-card.type-canvas .note-book-content img {\n        max-width: 100%;\n        max-height: 100%;\n    }\n\n    .note-book-header {\n        flex-grow: 0;\n    }\n\n    .note-list-wrapper {\n        height: 100%;\n        overflow: auto;\n    }\n\n    .note-expander {\n        font-size: x-large;\n        position: relative;\n        top: 3px;\n        cursor: pointer;\n    }\n\n    .note-list-pager {\n        text-align: center;\n    }\n    </style>\n\n    <div class="note-list-wrapper">\n        <div class="note-list-pager"></div>\n\n        <div class="note-list-container"></div>\n\n        <div class="note-list-pager"></div>\n    </div>\n</div>'),t.empty(),this.parentNote=e;const i=this.getIncludedNoteIds();this.noteIds=n.filter((t=>!i.has(t)&&"_hidden"!==t)),0!==this.noteIds.length&&(t.append(this.$noteList),this.page=1,this.pageSize=parseInt(e.getLabelValue("pageSize")),(!this.pageSize||this.pageSize<1)&&(this.pageSize=20),this.viewType=e.getLabelValue("viewType"),["list","grid"].includes(this.viewType)||(this.viewType="search"===e.type?"list":"grid"),this.$noteList.addClass(`${this.viewType}-view`),this.showNotePath=o)}getIncludedNoteIds(){const t=this.parentNote?this.parentNote.getRelations().filter((t=>"imageLink"===t.name||"includeNoteLink"===t.name)):[];return new Set(t.map((t=>t.value)))}async renderList(){if(0===this.noteIds.length)return void this.$noteList.hide();const t=this.parentNote.highlightedTokens||[];t.length>0?(await h.Z.requireLibrary(h.Z.MARKJS),this.highlightRegex=new RegExp(t.join("|"),"gi")):this.highlightRegex=null,this.$noteList.show();const e=this.$noteList.find(".note-list-container").empty(),n=(this.page-1)*this.pageSize,o=n+this.pageSize,i=this.noteIds.slice(n,Math.min(o,this.noteIds.length)),s=await g.default.getNotes(i);for(const t of s){const n=await this.renderNote(t,this.parentNote.isLabelTruthy("expanded"));e.append(n)}return this.renderPager(),this.$noteList}renderPager(){const t=this.$noteList.find(".note-list-pager").empty(),e=Math.ceil(this.noteIds.length/this.pageSize);let n;t.toggle(e>1);for(let o=1;o<=e;o++)if(e<20||o<=5||e-o<=5||Math.abs(this.page-o)<=2){n=!0;const e=(o-1)*this.pageSize+1,i=Math.min(this.noteIds.length,o*this.pageSize);t.append(o===this.page?$("<span>").text(o).css("text-decoration","underline").css("font-weight","bold"):$('<a href="javascript:">').text(o).attr("title",`Page of ${e} - ${i}`).on("click",(()=>{this.page=o,this.renderList()}))," &nbsp; ")}else n&&(t.append("... &nbsp; "),n=!1);t.append(`<span class="note-list-pager-total-count">(${this.noteIds.length} notes)</span>`)}async renderNote(t,e=!1){const n=$('<span class="note-expander bx bx-chevron-right"></span>'),{$renderedAttributes:o}=await f.Z.renderNormalAttributes(t),i="search"===this.parentNote.type?t.noteId:`${this.parentNote.noteId}/${t.noteId}`,s=$('<div class="note-book-card">').attr("data-note-id",t.noteId).append($('<h5 class="note-book-header">').append(n).append($('<span class="note-icon">').addClass(t.getIcon())).append("grid"===this.viewType?$('<span class="note-book-title">').text(await mt.Z.getNoteTitle(t.noteId,this.parentNote.noteId)):(await _.Z.createLink(i,{showTooltip:!1,showNotePath:this.showNotePath})).addClass("note-book-title")).append(o));return"grid"===this.viewType&&s.addClass("block-link").attr("data-href",`#${i}`).on("click",(t=>_.Z.goToLink(t))),n.on("click",(()=>this.toggleContent(s,t,!s.hasClass("expanded")))),this.highlightRegex&&s.find(".note-book-title").markRegExp(this.highlightRegex,{element:"span",className:"ck-find-result",separateWordSearch:!1,caseSensitive:!1}),await this.toggleContent(s,t,e),s}async toggleContent(t,e,n){if("list"===this.viewType&&(n&&t.hasClass("expanded")||!n&&!t.hasClass("expanded")))return;const o=t.find("> .note-book-header .note-expander");n||"grid"===this.viewType?(t.addClass("expanded"),o.addClass("bx-chevron-down").removeClass("bx-chevron-right")):(t.removeClass("expanded"),o.addClass("bx-chevron-right").removeClass("bx-chevron-down")),!n&&"grid"!==this.viewType||0!==t.find(".note-book-content").length||t.append(await this.renderNoteContent(e))}async renderNoteContent(t){const e=$('<div class="note-book-content">');try{const{$renderedContent:n,type:o}=await P.Z.getRenderedContent(t,{trim:"grid"===this.viewType});this.highlightRegex&&n.markRegExp(this.highlightRegex,{element:"span",className:"ck-find-result",separateWordSearch:!1,caseSensitive:!1}),e.append(n),e.addClass(`type-${o}`)}catch(n){console.log(`Caught error while rendering note '${t.noteId}' of type '${t.type}': ${n.message}, stack: ${n.stack}`),e.append("rendering error")}if("list"===this.viewType){const n=t.getRelations("imageLink"),o=(await t.getChildNotes()).filter((t=>!n.find((e=>e.value===t.noteId))));for(const t of o)e.append(await this.renderNote(t))}return e}}(this.$content,t,t.getChildNoteIds());await e.renderList()}async refresh(){this.shownNoteId=null,await super.refresh()}async refreshNoteListEvent({noteId:t}){this.isNote(t)&&await this.renderNoteList(this.note)}noteDetailRefreshedEvent({ntxId:t}){this.isNoteContext(t)&&(this.noteIdRefreshed=this.noteId,setTimeout((()=>this.checkRenderStatus()),100))}notesReloadedEvent({noteIds:t}){t.includes(this.noteId)&&this.refresh()}entitiesReloadedEvent({loadResults:t}){t.getAttributeRows().find((t=>t.noteId===this.noteId&&["viewType","expanded","pageSize"].includes(t.name)))&&(this.shownNoteId=null,this.checkRenderStatus())}}class Wt extends e.Z{doRender(){this.$widget=$('\n<div style="display: none;">\n    <style>\n        .global-menu-button-update-available-button {\n            width: 21px !important;\n            height: 21px !important;\n            padding: 0 !important;\n            \n            border-radius: var(--button-border-radius);\n            transform: scale(0.9);\n            border: none;\n            opacity: 0.8;\n            \n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        \n        .global-menu-button-wrapper:hover .global-menu-button-update-available-button {\n            opacity: 1;\n        }\n    </style>\n    \n    <span class="bx bx-sync global-menu-button-update-available-button" title="有可用的更新"></span>\n</div>\n')}updateVersionStatus(t){this.$widget.toggle(t>glob.triliumVersion)}}const zt=`\n<div class="dropdown global-menu dropright">\n    <style>\n    .global-menu {\n        width: 53px;\n        height: 53px;\n    }\n    \n    .global-menu .dropdown-menu {\n        min-width: 20em;\n    }\n    \n    .global-menu-button {\n        background-image: url("${window.glob.assetPath}/images/icon-black.svg");\n        background-repeat: no-repeat;\n        background-position: 40% 50%;\n        background-size: 45px;\n        width: 100%;\n        height: 100%;\n        position: relative;\n    }\n    \n    .global-menu-button:hover {\n        background-image: url("${window.glob.assetPath}/images/icon-color.svg");\n        border: 0;\n    }\n    \n    .global-menu-button-update-available {\n        position: absolute;\n        right: -30px;\n        bottom: -30px;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n    }\n\n    .update-to-latest-version-button {\n        display: none;\n    }\n    \n    .global-menu .zoom-container {\n        display: flex; \n        flex-direction: row; \n        justify-content: space-between;\n        align-items: baseline;\n    }\n    \n    .global-menu .zoom-buttons a {\n        display: inline-block;\n        border: 1px solid var(--button-border-color);\n        border-radius: var(--button-border-radius);\n        color: var(--button-text-color);\n        background-color: var(--button-background-color);\n        padding: 3px;\n        margin-left: 3px;\n    }\n    \n    .global-menu .zoom-buttons a:hover {\n        text-decoration: none;\n    }\n    \n    .global-menu .zoom-state {\n        margin-left: 5px;\n        margin-right: 5px;\n    }\n    \n    .global-menu .dropdown-item .bx {\n        position: relative;\n        top: 3px;\n        font-size: 120%;\n        margin-right: 5px;\n    }\n    \n    body.mobile .show-help-button, body.mobile .show-about-dialog-button {\n        /* hidden because these dialogs are not available for mobile */\n        display: none;\n    }\n    \n    body.mobile .global-menu .dropdown-submenu .dropdown-menu {\n        display: block;\n        font-size: 90%;\n        position: relative;\n        left: 0;\n        top: 5px;\n    }\n    </style>\n\n    <button type="button" data-toggle="dropdown" data-placement="right"\n            aria-haspopup="true" aria-expanded="false" \n            class="icon-action global-menu-button" title="菜单">\n        <div class="global-menu-button-update-available"></div>\n    </button>\n\n    <ul class="dropdown-menu dropdown-menu-right">\n        <li class="dropdown-item" data-trigger-command="showOptions">\n            <span class="bx bx-slider"></span>\n            选项\n        </li>\n\n        <li class="dropdown-item" data-trigger-command="openNewWindow">\n            <span class="bx bx-window-open"></span>\n            新窗口\n            <kbd data-command="openNewWindow"></kbd>\n        </li>\n\n        <li class="dropdown-item switch-to-mobile-version-button" data-trigger-command="switchToMobileVersion">\n            <span class="bx bx-mobile"></span>\n            切换到移动版\n        </li>\n        \n        <li class="dropdown-item switch-to-desktop-version-button" data-trigger-command="switchToDesktopVersion">\n            <span class="bx bx-desktop"></span>\n            切换到桌面版\n        </li>\n        \n        <span class="zoom-container dropdown-item">\n            <div>\n                <span class="bx bx-empty"></span>\n                缩放\n            </div>\n            \n            <div class="zoom-buttons">\n                <a data-trigger-command="toggleFullscreen" title="切换全屏" class="bx bx-expand-alt"></a>\n                \n                &nbsp;\n                \n                <a data-trigger-command="zoomOut" title="缩小" class="bx bx-minus"></a>\n                \n                <span data-trigger-command="zoomReset" title="Reset Zoom Level" class="zoom-state"></span>\n                \n                <a data-trigger-command="zoomIn" title="放大" class="bx bx-plus"></a>\n            </div>\n        </span>\n\n        <li class="dropdown-item" data-trigger-command="showLaunchBarSubtree">\n            <span class="bx bx-sidebar"></span>\n            配置启动栏\n        </li>\n        \n        <li class="dropdown-item" data-trigger-command="showShareSubtree">\n            <span class="bx bx-share-alt"></span>\n            显示分享的笔记子树\n        </li>\n        \n        <li class="dropdown-item dropdown-submenu">\n            <span class="dropdown-toggle">\n                <span class="bx bx-empty"></span>\n                高级\n            </span>\n            \n            <ul class="dropdown-menu">\n                <li class="dropdown-item open-dev-tools-button" data-trigger-command="openDevTools">\n                    <span class="bx bx-bug-alt"></span>\n                    开发者工具\n                    <kbd data-command="openDevTools"></kbd>\n                </li>\n        \n                <li class="dropdown-item" data-trigger-command="showSQLConsole">\n                    <span class="bx bx-data"></span>\n                    打开SQL控制台\n                    <kbd data-command="showSQLConsole"></kbd>\n                </li>\n                \n                <li class="dropdown-item" data-trigger-command="showSQLConsoleHistory">\n                    <span class="bx bx-empty"></span>\n                    打开SQL控制台历史记录\n                </li>\n                \n                <li class="dropdown-item" data-trigger-command="showSearchHistory">\n                    <span class="bx bx-empty"></span>\n                    打开搜索历史\n                </li>\n        \n                <li class="dropdown-item" data-trigger-command="showBackendLog">\n                    <span class="bx bx-empty"></span>\n                    显示后台日志\n                    <kbd data-command="showBackendLog"></kbd>\n                </li>\n                \n                <li class="dropdown-item" data-trigger-command="reloadFrontendApp" \n                    title="重新加载可以帮助解决一些显示问题, 而无需重新启动整个应用程序.">\n                    <span class="bx bx-empty"></span>\n                    重新加载界面\n                    <kbd data-command="reloadFrontendApp"></kbd>\n                </li>\n                \n                <li class="dropdown-item" data-trigger-command="showHiddenSubtree">\n                    <span class="bx bx-empty"></span>\n                    显示隐藏的子树\n                </li>\n            </ul>\n        </li>\n\n        <li class="dropdown-item show-help-button" data-trigger-command="showHelp">\n            <span class="bx bx-info-circle"></span>\n            显示帮助\n            <kbd data-command="showHelp"></kbd>\n        </li>\n\n        <li class="dropdown-item show-about-dialog-button">\n            <span class="bx bx-empty"></span>\n            关于 Trilium Notes\n        </li>\n\n        <li class="dropdown-item update-to-latest-version-button" data-trigger-command="downloadLatestVersion">\n            <span class="bx bx-sync"></span>\n\n            <span class="version-text"></span>\n        </li>\n\n        <li class="dropdown-item logout-button" data-trigger-command="logout">\n            <span class="bx bx-log-out"></span>\n            登出\n        </li>\n    </ul>\n</div>\n`;class Ht extends e.Z{constructor(){super(),this.updateAvailableWidget=new Wt}doRender(){this.$widget=$(zt),this.$dropdown=this.$widget.find("[data-toggle='dropdown']");const t=this.$widget.find(".global-menu-button");t.tooltip({trigger:"hover"}),t.on("click",(()=>t.tooltip("hide"))),this.$widget.find(".show-about-dialog-button").on("click",(()=>this.triggerCommand("openAboutDialog")));const e=b.default.isElectron();this.$widget.find(".logout-button").toggle(!e),this.$widget.find(".open-dev-tools-button").toggle(e),this.$widget.find(".switch-to-mobile-version-button").toggle(!e&&b.default.isDesktop()),this.$widget.find(".switch-to-desktop-version-button").toggle(!e&&b.default.isMobile()),this.$widget.on("click",".dropdown-item",(t=>{$(t.target).parent(".zoom-buttons")||this.$dropdown.dropdown("toggle")})),this.$widget.find(".global-menu-button-update-available").append(this.updateAvailableWidget.render()),this.$updateToLatestVersionButton=this.$widget.find(".update-to-latest-version-button"),b.default.isElectron()||this.$widget.find(".zoom-container").hide(),this.$zoomState=this.$widget.find(".zoom-state"),this.$widget.on("show.bs.dropdown",(()=>this.updateZoomState())),this.$widget.find(".zoom-buttons").on("click",(()=>setTimeout((()=>this.updateZoomState()),300))),this.updateVersionStatus(),setInterval((()=>this.updateVersionStatus()),288e5)}updateZoomState(){if(!b.default.isElectron())return;const t=b.default.dynamicRequire("electron").webFrame.getZoomFactor(),e=Math.round(100*t);this.$zoomState.text(`${e}%`)}async updateVersionStatus(){if(await k.Z.initializedPromise,"true"!==k.Z.get("checkForUpdates"))return;const t=await this.fetchLatestVersion();this.updateAvailableWidget.updateVersionStatus(t),this.$updateToLatestVersionButton.toggle(t>glob.triliumVersion),this.$updateToLatestVersionButton.find(".version-text").text(`Version ${t} is available, click to download.`)}async fetchLatestVersion(){const t=await fetch("https://api.github.com/repos/zadam/trilium/releases/latest"),e=await t.json();return e?.tag_name?.substring(1)}downloadLatestVersionCommand(){window.open("https://github.com/zadam/trilium/releases/latest")}activeContextChangedEvent(){this.$dropdown.dropdown("hide")}noteSwitchedEvent(){this.$dropdown.dropdown("hide")}}var Ut=__webpack_require__(383);class jt extends e.Z{constructor(t,e,n){super(),this.iconClass=e,this.title=t,this.dropdownTpl=n}doRender(){this.$widget=$('\n<div class="dropdown right-dropdown-widget dropright">\n    <style>\n    .right-dropdown-widget {\n        height: 53px;\n    }\n    </style>\n\n    <button type="button" data-toggle="dropdown" data-placement="right"\n            aria-haspopup="true" aria-expanded="false" \n            class="bx right-dropdown-button launcher-button"></button>\n    \n    <div class="dropdown-menu dropdown-menu-right"></div>\n</div>\n'),this.$dropdownMenu=this.$widget.find(".dropdown-menu");const t=this.$widget.find(".right-dropdown-button").addClass(this.iconClass).attr("title",this.title).tooltip({trigger:"hover"}).on("click",(()=>t.tooltip("hide")));this.$widget.on("show.bs.dropdown",(async()=>{await this.dropdownShown();const t=this.$dropdownMenu[0].getBoundingClientRect(),e=$(window).height()-t.bottom;e<0&&this.$dropdownMenu.css("top",e)})),this.$dropdownContent=$(this.dropdownTpl),this.$widget.find(".dropdown-menu").append(this.$dropdownContent)}async dropdownShow(){}hideDropdown(){this.$widget.dropdown("hide"),this.$dropdownMenu.removeClass("show")}}class qt extends jt{constructor(t,e){super(t,e,'\n<div class="calendar-dropdown-widget">\n  <style>\n  .calendar-dropdown-widget {\n      width: 350px;\n  }\n  </style>\n\n  <div class="calendar-header">\n    <button class="calendar-btn bx bx-left-arrow-alt" data-calendar-toggle="previous"></button>\n\n    <div class="calendar-header-label" data-calendar-label="month"></div>\n\n    <button class="calendar-btn bx bx-right-arrow-alt" data-calendar-toggle="next"></button>\n  </div>\n\n  <div class="calendar-week">\n    <span>一</span> <span>二</span><span>三</span> <span>四</span> <span>五</span> <span>六</span> <span>日</span>\n  </div>\n  <div class="calendar-body" data-calendar-area="month"></div>\n</div>')}doRender(){super.doRender(),this.$month=this.$dropdownContent.find('[data-calendar-area="month"]'),this.$next=this.$dropdownContent.find('[data-calendar-toggle="next"]'),this.$previous=this.$dropdownContent.find('[data-calendar-toggle="previous"]'),this.$label=this.$dropdownContent.find('[data-calendar-label="month"]'),this.$next.on("click",(()=>{this.date.setMonth(this.date.getMonth()+1),this.createMonth()})),this.$previous.on("click",(t=>{this.date.setMonth(this.date.getMonth()-1),this.createMonth()})),this.$dropdownContent.find(".calendar-header").on("click",(t=>t.stopPropagation())),this.$dropdownContent.on("click",".calendar-date",(async e=>{const n=$(e.target).closest(".calendar-date").attr("data-calendar-date"),o=await Ut.Z.getDayNote(n);o?(t.default.tabManager.getActiveContext().setNote(o.noteId),this.hideDropdown()):B.default.showError("Cannot find day note")}))}async dropdownShown(){await h.Z.requireLibrary(h.Z.CALENDAR_WIDGET);const e=t.default.tabManager.getActiveContextNote();this.init(e?.getOwnedLabelValue("dateNote"))}init(t){this.activeDate=t?new Date(`${t}T12:00:00`):null,this.todaysDate=new Date,this.date=new Date((this.activeDate||this.todaysDate).getTime()),this.date.setDate(1),this.createMonth()}createDay(t,e,n){const o=$("<a>").addClass("calendar-date").attr("data-calendar-date",b.default.formatDateISO(this.date)),i=$("<span>").html(e);1===e&&(0===n?o.css("marginLeft",6*14.28+"%"):o.css("marginLeft",14.28*(n-1)+"%"));const s=t[b.default.formatDateISO(this.date)];return s&&(o.addClass("calendar-date-exists"),o.attr("href",`#root/${s}`)),this.isEqual(this.date,this.activeDate)&&o.addClass("calendar-date-active"),this.isEqual(this.date,this.todaysDate)&&o.addClass("calendar-date-today"),o.append(i),o}isEqual(t,e){return!(!t&&e||t&&!e)&&t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}async createMonth(){const t=b.default.formatDateISO(this.date).substr(0,7),e=await a.Z.get(`special-notes/notes-for-month/${t}`);this.$month.empty();const n=this.date.getMonth();for(;this.date.getMonth()===n;){const t=this.createDay(e,this.date.getDate(),this.date.getDay(),this.date.getFullYear());this.$month.append(t),this.date.setDate(this.date.getDate()+1)}this.date.setDate(1),this.date.setMonth(this.date.getMonth()-1),this.$label.html(`${this.monthsAsString(this.date.getMonth())} ${this.date.getFullYear()}`)}monthsAsString(t){return["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"][t]}}class Vt extends e.Z{constructor(t=0,e=1e3){super(),this.baseSize=t,this.growthFactor=e}doRender(){this.$widget=$('<div class="spacer"></div>'),this.$widget.css("flex-basis",this.baseSize),this.$widget.css("flex-grow",this.growthFactor),this.$widget.css("flex-shrink",1e3),this.$widget.on("contextmenu",(e=>(this.$widget.tooltip("hide"),D.Z.show({x:e.pageX,y:e.pageY,items:[{title:"配置启动栏",command:"showLaunchBarSubtree",uiIcon:"bx bx-sidebar"}],selectMenuItemHandler:({command:e})=>{t.default.triggerCommand(e)}}),!1)))}}class Kt extends Pt{constructor(t){super(),this.noteToOpen=t,this.title((()=>this.noteToOpen.title)).icon((()=>this.noteToOpen.getIcon())).onClick(((t,e)=>this.launch(e))).onAuxClick(((t,e)=>this.launch(e))).onContextMenu((t=>Q.Z.openContextMenu(this.noteToOpen.noteId,t)))}async launch(e){if(3===e.which)return;const n=b.default.isCtrlKey(e);1===e.which&&n||2===e.which?await t.default.tabManager.openInNewTab(this.noteToOpen.noteId):await t.default.tabManager.openInSameTab(this.noteToOpen.noteId)}initialRenderCompleteEvent(){}}class Jt extends jt{constructor(t){super(t.title,t.getIcon(),'\n<div class="bookmark-folder-widget">\n    <style>\n        .bookmark-folder-widget {\n            min-width: 400px;\n            max-height: 500px;\n            padding: 7px 15px 0 15px;\n            font-size: 1.2rem;\n            overflow: auto;\n        }\n        \n        .bookmark-folder-widget ul {\n            padding: 0;\n            list-style-type: none;\n        }\n        \n        .bookmark-folder-widget .note-link {\n            display: block;\n            padding: 5px 10px 5px 5px;\n        }\n        \n        .bookmark-folder-widget .note-link:hover {\n            background-color: var(--accented-background-color);\n            text-decoration: none;\n        }\n        \n        .dropdown-menu .bookmark-folder-widget a:hover {\n            text-decoration: none;\n            background: transparent !important;\n        }\n        \n        .bookmark-folder-widget li .note-link {\n            padding-left: 35px;\n        }\n    </style>\n    \n    <div class="parent-note"></div>\n    \n    <ul class="children-notes"></ul>\n</div>'),this.note=t}doRender(){super.doRender(),this.$parentNote=this.$dropdownContent.find(".parent-note"),this.$childrenNotes=this.$dropdownContent.find(".children-notes")}async dropdownShown(){this.$parentNote.empty(),this.$childrenNotes.empty();const t={showTooltip:!1,showNoteIcon:!0};this.$parentNote.append((await _.Z.createLink(this.note.noteId,t)).addClass("note-link"));for(const e of await this.note.getChildNotes())this.$childrenNotes.append($("<li>").append((await _.Z.createLink(e.noteId,t)).addClass("note-link")))}refreshIcon(){}}class Gt extends o{constructor(){super("column"),this.contentSized()}async refresh(){this.$widget.empty(),this.children=[],this.noteIds=[];const t=await g.default.getNote("_lbBookmarks");for(const e of await t.getChildNotes()){this.noteIds.push(e.noteId);const t=e.isLabelTruthy("bookmarkFolder")?new Jt(e):new Kt(e).class("launcher-button");this.child(t),this.$widget.append(t.render()),t.refreshIcon()}}initialRenderCompleteEvent(){this.refresh()}entitiesReloadedEvent({loadResults:t}){t.getBranchRows().find((t=>"_lbBookmarks"===t.parentNoteId))&&this.refresh(),t.getAttributeRows().find((t=>"label"===t.type&&["iconClass","workspaceIconClass","bookmarkFolder"].includes(t.name)&&this.noteIds.includes(t.noteId)))&&this.refresh()}}let Yt;p.default.getActions().then((t=>Yt=t));class Qt extends _t{doRender(){super.doRender(),this.settings.command?this.$widget.on("click",(()=>{this.$widget.tooltip("hide"),this.triggerCommand(this._command)})):console.warn(`Button widget '${this.componentId}' has no defined command`,this.settings)}getTitle(){const t=super.getTitle(),e=Yt.find((t=>t.actionName===this._command));return e&&e.effectiveShortcuts.length>0?`${t} (${e.effectiveShortcuts.join(", ")})`:t}onClick(t){return this.settings.onClick=t,this}command(t){return this.settings.command=t,this}get _command(){return"function"==typeof this.settings.command?this.settings.command():this.settings.command}}class Xt extends Qt{constructor(){super(),this.class("launcher-button"),this.settings.icon=()=>s.Z.isProtectedSessionAvailable()?"bx-check-shield":"bx-shield-quarter",this.settings.title=()=>s.Z.isProtectedSessionAvailable()?"受保护的会话已启动. 点击退出受保护的会话.":"点击进入受保护的会话",this.settings.command=()=>s.Z.isProtectedSessionAvailable()?"leaveProtectedSession":"enterProtectedSession"}protectedSessionStartedEvent(){this.refreshIcon()}}const te=async function(t=!1){const e=await a.Z.post("sync/now");e.success?B.default.showMessage("同步成功."):(e.message.length>200&&(e.message=`${e.message.substr(0,200)}...`),t&&"NOT_CONFIGURED"===e.errorCode||B.default.showError(`Sync failed: ${e.message}`))};class ee extends e.Z{constructor(){super(),this.syncState="unknown",this.allChangesPushed=!1}doRender(){this.$widget=$('\n<div class="sync-status-widget launcher-button">\n    <style>\n    .sync-status-widget {\n    }\n    \n    .sync-status {\n        box-sizing: border-box;\n    }\n    \n    .sync-status .sync-status-icon {\n        display: inline-block;\n        position: relative;\n        top: -5px;\n        font-size: 110%;\n    }\n    \n    .sync-status .sync-status-sub-icon {\n        font-size: 40%; \n        position: absolute; \n        left: 0;\n        top: 16px;\n    }\n    \n    .sync-status .sync-status-icon span {\n        border: none !important;\n    }\n    \n    .sync-status-icon:not(.sync-status-in-progress):hover {\n        background-color: var(--hover-item-background-color);\n        cursor: pointer;\n    }\n    </style>\n\n    <div class="sync-status">\n        <span class="sync-status-icon sync-status-unknown bx bx-time" \n              data-toggle="tooltip" \n              data-placement="right"\n              title="<p>下次同步时可获取同步状态.</p><p>点击开始同步.</p>">\n        </span>\n        <span class="sync-status-icon sync-status-connected-with-changes bx bx-wifi"\n              data-toggle="tooltip" \n              data-placement="right"\n              title="<p>已连接到同步服务器. <br>还有一些修改的数据需要同步.</p><p>点击开始同步.</p>">\n            <span class="bx bxs-star sync-status-sub-icon"></span>\n        </span>\n        <span class="sync-status-icon sync-status-connected-no-changes bx bx-wifi" \n              data-toggle="tooltip" \n              data-placement="right"\n              title="<p>已连接到同步服务器.<br>所有的修改已经同步.</p><p>点击开始同步.</p>">\n        </span>\n        <span class="sync-status-icon sync-status-disconnected-with-changes bx bx-wifi-off"\n              data-toggle="tooltip" \n              data-placement="right"\n              title="<p>连接到同步服务器失败.<br>还有一些修改的数据需要同步.</p><p>点击开始同步.</p>">\n            <span class="bx bxs-star sync-status-sub-icon"></span>\n        </span>\n        <span class="sync-status-icon sync-status-disconnected-no-changes bx bx-wifi-off" \n              data-toggle="tooltip"\n              data-placement="right"\n              title="<p>连接到同步服务器失败.<br>所有的修改已经同步.</p><p>点击开始同步.</p>">\n        </span>\n        <span class="sync-status-icon sync-status-in-progress bx bx-analyse bx-spin" \n              data-toggle="tooltip"\n              data-placement="right"\n              title="同步中.">\n        </span>\n    </div>\n</div>\n'),this.$widget.hide(),this.$widget.find('[data-toggle="tooltip"]').tooltip({html:!0}),this.$widget.find(".sync-status-icon:not(.sync-status-in-progress)").on("click",(()=>te())),dt.Z.subscribeToMessages((t=>this.processMessage(t)))}showIcon(t){k.Z.get("syncServerHost")?(this.$widget.show(),this.$widget.find(".sync-status-icon").hide(),this.$widget.find(`.sync-status-${t}`).show()):this.toggleInt(!1)}processMessage(t){"sync-pull-in-progress"===t.type||"sync-push-in-progress"===t.type?(this.syncState="in-progress",this.lastSyncedPush=t.lastSyncedPush):"sync-finished"===t.type?(this.syncState="connected",this.lastSyncedPush=t.lastSyncedPush):"sync-failed"===t.type?(this.syncState="disconnected",this.lastSyncedPush=t.lastSyncedPush):"frontend-update"===t.type&&(this.lastSyncedPush=t.data.lastSyncedPush),this.allChangesPushed=this.lastSyncedPush===dt.Z.getMaxKnownEntityChangeSyncId(),["unknown","in-progress"].includes(this.syncState)?this.showIcon(this.syncState):this.showIcon(`${this.syncState}-${this.allChangesPushed?"no-changes":"with-changes"}`)}}class ne extends Pt{constructor(t){super(),this.class("launcher-button"),this.launcherNote=t;for(const e of t.getOwnedLabels("keyboardShortcut"))this.bindNoteShortcutHandler(e)}launch(){throw new Error("Abstract implementation")}bindNoteShortcutHandler(t){const e=t.attributeId;t.isDeleted?l.Z.removeGlobalShortcut(e):l.Z.bindGlobalShortcut(t.value,(()=>this.launch()),e)}entitiesReloadedEvent({loadResults:t}){for(const e of t.getAttributeRows())e.noteId===this.launcherNote.noteId&&"label"===e.type&&"keyboardShortcut"===e.name?this.bindNoteShortcutHandler(e):"label"===e.type&&"iconClass"===e.name&&m.isAffecting(e,this.launcherNote)&&this.refreshIcon()}}class oe extends ne{constructor(t){super(t),this.title((()=>this.launcherNote.title)).icon((()=>this.launcherNote.getIcon())).onClick(((t,e)=>this.launch(e))).onAuxClick(((t,e)=>this.launch(e))).onContextMenu((t=>{const e=this.getTargetNoteId();if(!e)return;const n=this.getHoistedNoteId();Q.Z.openContextMenu(e,t,{},n)}))}async launch(e){const n=await this.getTargetNoteId();if(!n||3===e.which)return;const o=await this.getHoistedNoteId();if(e){const i=b.default.isCtrlKey(e);1===e.which&&i||2===e.which?await t.default.tabManager.openInNewTab(n,o):await t.default.tabManager.openInSameTab(n,o)}else await t.default.tabManager.openInSameTab(n,o)}getTargetNoteId(){const t=this.launcherNote.getRelationValue("target");if(t)return t;M.Z.info("This launcher doesn't define target note.")}getHoistedNoteId(){return this.launcherNote.getRelationValue("hoistedNote")||t.default.tabManager.getActiveContext().hoistedNoteId}getTitle(){const t=this.launcherNote.getLabels("keyboardShortcut").map((t=>t.value)).filter((t=>!!t)).join(", ");let e=super.getTitle();return t&&(e+=` (${t})`),e}}class ie extends ne{constructor(t){super(t),this.title((()=>this.launcherNote.title)).icon((()=>this.launcherNote.getIcon())).onClick((()=>this.launch()))}async launch(){if(this.launcherNote.isLabelTruthy("scriptInLauncherContent"))await this.launcherNote.executeScript();else{const t=await this.launcherNote.getRelationTarget("script");await t.executeScript()}}}class se extends oe{async getTargetNoteId(){return(await Ut.Z.getTodayNote()).noteId}getHoistedNoteId(){return t.default.tabManager.getActiveContext().hoistedNoteId}}class ae extends Qt{constructor(){super(),this.settings.buttonNoteIdProvider=null}buttonNoteIdProvider(t){return this.settings.buttonNoteIdProvider=t,this}doRender(){super.doRender(),this.updateIcon()}updateIcon(){const t=this.settings.buttonNoteIdProvider();t?g.default.getNote(t).then((t=>{this.settings.icon=t.getIcon(),this.refreshIcon()})):console.error(`buttonNoteId for '${this.componentId}' is not defined.`)}entitiesReloadedEvent({loadResults:t}){const e=g.default.getNoteFromCache(this.buttonNoteIdProvider());e&&t.getAttributeRows(this.componentId).find((t=>"label"===t.type&&"iconClass"===t.name&&m.isAffecting(t,e)))&&this.updateIcon()}}class re extends ae{constructor(t,e){super(),this.title((()=>t.title)).icon((()=>t.getIcon())).command((()=>e)).titlePlacement("right").buttonNoteIdProvider((()=>t.noteId)).onContextMenu((t=>this.showContextMenu(t))).class("launcher-button")}isEnabled(){return super.isEnabled()&&b.default.isElectron()}doRender(){super.doRender(),b.default.isElectron()&&(this.webContents=b.default.dynamicRequire("@electron/remote").getCurrentWebContents(),this.webContents.clearHistory(),this.refresh())}async showContextMenu(t){t.preventDefault()}refresh(){b.default.isElectron()}activeNoteChangedEvent(){this.refresh()}}class de extends e.Z{constructor(){super(),this.innerWidget=null}isEnabled(){return this.innerWidget.isEnabled()}doRender(){this.$widget=this.innerWidget.render()}async initLauncher(t){if("launcher"!==t.type)throw new Error(`Note '${t.noteId}' '${t.title}' is not a launcher even though it's in the launcher subtree`);if(!b.default.isDesktop()&&t.isLabelTruthy("desktopOnly"))return!1;const e=t.getLabelValue("launcherType");if(glob.TRILIUM_SAFE_MODE&&"customWidget"===e)return!1;if("command"===e)this.innerWidget=this.initCommandLauncherWidget(t).class("launcher-button");else if("note"===e)this.innerWidget=new oe(t).class("launcher-button");else if("script"===e)this.innerWidget=new ie(t).class("launcher-button");else if("customWidget"===e)this.innerWidget=await this.initCustomWidget(t);else{if("builtinWidget"!==e)throw new Error(`Unrecognized launcher type '${e}' for launcher '${t.noteId}' title '${t.title}'`);this.innerWidget=this.initBuiltinWidget(t)}if(!this.innerWidget)throw new Error(`Unknown initialization error for note '${t.noteId}', title '${t.title}'`);return this.child(this.innerWidget),!0}initCommandLauncherWidget(t){return(new Qt).title((()=>t.title)).icon((()=>t.getIcon())).command((()=>t.getLabelValue("command")))}async initCustomWidget(t){const e=await t.getRelationTarget("widget");if(e)return await e.executeScript();throw new Error(`Custom widget of launcher '${t.noteId}' '${t.title}' is not defined.`)}initBuiltinWidget(t){const e=t.getLabelValue("builtinWidget");if("calendar"===e)return new qt(t.title,t.getIcon());if("spacer"===e){const e=parseInt(t.getLabelValue("baseSize")||"40"),n=parseInt(t.getLabelValue("growthFactor")||"100");return new Vt(e,n)}if("bookmarks"===e)return new Gt;if("protectedSession"===e)return new Xt;if("syncStatus"===e)return new ee;if("backInHistoryButton"===e)return new re(t,"backInNoteHistory");if("forwardInHistoryButton"===e)return new re(t,"forwardInNoteHistory");if("todayInJournal"===e)return new se(t);throw new Error(`Unrecognized builtin widget ${e} for launcher ${t.noteId} "${t.title}"`)}}class le extends o{constructor(){super("column"),this.id("launcher-container"),this.css("height","100%"),this.filling(),this.load()}async load(){await g.default.initializedPromise;const e=await g.default.getNote("_lbVisibleLaunchers",!0);if(!e)return void console.log("Visible launchers root note doesn't exist.");const n=[];for(const t of await e.getChildNotes())try{const e=new de;await e.initLauncher(t)&&n.push(e)}catch(t){console.error(t)}this.children=[],this.child(...n),this.$widget.empty(),this.renderChildren(),await this.handleEventInChildren("initialRenderComplete");const o=t.default.tabManager.getActiveContext();o&&(await this.handleEvent("setNoteContext",{noteContext:o}),o.notePath&&await this.handleEvent("noteSwitched",{noteContext:o,notePath:o.notePath}))}entitiesReloadedEvent({loadResults:t}){t.getBranchRows().find((t=>g.default.getNoteFromCache(t.parentNoteId)?.isLaunchBarConfig()))&&this.load()}}class ce extends o{constructor(){super("row"),this.id("root-widget"),this.css("height","100%")}}class he extends i.Z{isEnabled(){return super.isEnabled()&&"_share"!==this.noteId&&this.note.hasAncestor("_share")}doRender(){this.$widget=$('\n<div class="shared-info-widget alert alert-warning">\n    <style>\n        .shared-info-widget {\n            margin: 10px;\n            contain: none;\n            padding: 10px;\n            font-weight: bold;\n        }\n    </style>\n    \n    <span class="shared-text"></span> <a class="shared-link external"></a>. 需要帮助请访问 <a href="https://github.com/zadam/trilium/wiki/Sharing">wiki</a>.\n</div>'),this.$sharedLink=this.$widget.find(".shared-link"),this.$sharedText=this.$widget.find(".shared-text"),this.contentSized()}async refreshWithNote(t){const e=k.Z.get("syncServerHost");let n;const o=this.getShareId(t);if(e)n=`${e}/share/${o}`,this.$sharedText.text("这个笔记分享在公开地址");else{let t=location.host;t.endsWith("/")&&(t=t.substr(0,t.length-1)),n=`${location.protocol}//${t}${location.pathname}share/${o}`,this.$sharedText.text("这个笔记分享在本地地址")}this.$sharedLink.attr("href",n).text(n)}getShareId(t){return t.hasOwnedLabel("shareRoot")?"":t.getOwnedLabelValue("shareAlias")||t.noteId}entitiesReloadedEvent({loadResults:t}){(t.getAttributeRows().find((t=>t.name.startsWith("_share")&&m.isAffecting(t,this.note)))||t.getBranchRows().find((t=>t.noteId===this.noteId)))&&this.refresh()}}class pe extends i.Z{get name(){return"promotedAttributes"}get toggleCommand(){return"toggleRibbonTabPromotedAttributes"}doRender(){this.$widget=$('\n<div class="promoted-attributes-widget">\n    <style>\n    body.mobile .promoted-attributes-widget {\n        /* https://github.com/zadam/trilium/issues/4468 */\n        flex-shrink: 0.4;\n        overflow: auto;\n    }\n    \n    .promoted-attributes-container {\n        margin: auto;\n        display: flex;\n        flex-direction: row;\n        flex-shrink: 0;\n        flex-grow: 0;\n        justify-content: space-evenly;\n        overflow: auto;\n        max-height: 400px;\n        flex-wrap: wrap;\n    }\n    \n    .promoted-attribute-cell {\n        display: flex;\n        align-items: center;\n        margin: 10px;\n    }\n    \n    .promoted-attribute-cell div.input-group {\n        margin-left: 10px;\n    }\n    .promoted-attribute-cell strong {\n        word-break:keep-all;\n        white-space: nowrap;\n    }\n    </style>\n    \n    <div class="promoted-attributes-container"></div>\n</div>'),this.contentSized(),this.$container=this.$widget.find(".promoted-attributes-container")}getTitle(t){return 0===t.getPromotedDefinitionAttributes().length?{show:!1}:{show:!0,activate:k.Z.is("promotedAttributesOpenInRibbon"),title:"升级属性",icon:"bx bx-table"}}async refreshWithNote(t){this.$container.empty();const e=t.getPromotedDefinitionAttributes(),n=t.getOwnedAttributes();if(n.sort(((t,e)=>t.position-e.position)),0===e.length)return void this.toggleInt(!1);const o=[];for(const t of e){const e=t.name.startsWith("label:")?"label":"relation",i=t.name.substr(e.length+1);let s=n.filter((t=>t.name===i&&t.type===e));0===s.length&&s.push({attributeId:"",type:e,name:i,value:""}),"single"===t.getDefinition().multiplicity&&(s=s.slice(0,1));for(const e of s){const n=await this.createPromotedAttributeCell(t,e,i);o.push(n)}}this.$container.empty().append(...o),this.toggleInt(!0)}async createPromotedAttributeCell(t,e,n){const o=t.getDefinition(),i=$("<input>").prop("tabindex",200+t.position).attr("data-attribute-id",e.noteId===this.noteId?e.attributeId:"").attr("data-attribute-type",e.type).attr("data-attribute-name",e.name).prop("value",e.value).addClass("form-control").addClass("promoted-attribute-input").on("change",(t=>this.promotedAttributeChanged(t))),s=$("<div>"),r=$("<td>").addClass("multiplicity").attr("nowrap",!0),d=$('<div class="promoted-attribute-cell" style="white-space: nowrap;">').append($("<strong>").text(o.promotedAlias??n)).append($("<div>").addClass("input-group").append(i)).append(s).append(r);if("label"===e.type)if("text"===o.labelType)i.prop("type","text"),b.default.isDesktop()&&a.Z.get(`attribute-values/${encodeURIComponent(e.name)}`).then((t=>{0!==t.length&&(t=t.map((t=>({value:t}))),i.autocomplete({appendTo:document.querySelector("body"),hint:!1,autoselect:!1,openOnFocus:!0,minLength:0,tabAutocomplete:!1},[{displayKey:"value",source:function(e,n){e=e.toLowerCase(),n(t.filter((t=>t.value.toLowerCase().includes(e))))}}]),i.on("autocomplete:selected",(t=>this.promotedAttributeChanged(t))))}));else if("number"===o.labelType){i.prop("type","number");let t=1;for(let e=0;e<(o.numberPrecision||0)&&e<10;e++)t/=10;i.prop("step",t),i.css("text-align","right").css("width","120")}else if("boolean"===o.labelType)i.prop("type","checkbox"),i.css("width","80px"),"true"===e.value&&i.prop("checked","checked");else if("date"===o.labelType)i.prop("type","date");else if("datetime"===o.labelType)i.prop("type","datetime-local");else if("url"===o.labelType){i.prop("placeholder","http://website...");const t=$("<span>").addClass("input-group-text open-external-link-button bx bx-window-open").prop("title","Open external link").on("click",(()=>window.open(i.val(),"_blank")));i.after($("<div>").addClass("input-group-append").append(t))}else dt.Z.logError(`Unknown labelType '${t.labelType}'`);else{if("relation"!==e.type)return void dt.Z.logError(`Unknown attribute type '${e.type}'`);e.value&&i.val(await mt.Z.getNoteTitle(e.value)),b.default.isDesktop()?(I(i,{allowCreatingNotes:!0}),i.on("autocomplete:noteselected",((t,e,n)=>{this.promotedAttributeChanged(t)})),i.setSelectedNotePath(e.value)):i.attr("readonly","readonly")}if("multi"===o.multiplicity){const o=$("<span>").addClass("bx bx-plus pointer").prop("title","Add new attribute").on("click",(async()=>{const o=await this.createPromotedAttributeCell(t,{attributeId:"",type:e.type,name:n,value:""},n);d.after(o),o.find("input").trigger("focus")})),s=$("<span>").addClass("bx bx-trash pointer").prop("title","Remove this attribute").on("click",(async()=>{const o=i.attr("data-attribute-id");o&&await a.Z.remove(`notes/${this.noteId}/attributes/${o}`,this.componentId);const s=`input[data-attribute-type='${e.type}'][data-attribute-name='${n}']`;if(this.$widget.find(s).length<=1){const o=await this.createPromotedAttributeCell(t,{attributeId:"",type:e.type,name:n,value:""},n);d.after(o)}d.remove()}));r.append(" &nbsp;").append(o).append(" &nbsp;").append(s)}return d}async promotedAttributeChanged(t){const e=$(t.target);let n;if("checkbox"===e.prop("type"))n=e.is(":checked")?"true":"false";else if("relation"===e.attr("data-attribute-type")){const t=e.getSelectedNotePath();n=t?mt.Z.getNoteIdFromUrl(t):""}else n=e.val();const o=await a.Z.put(`notes/${this.noteId}/attribute`,{attributeId:e.attr("data-attribute-id"),type:e.attr("data-attribute-type"),name:e.attr("data-attribute-name"),value:n},this.componentId);e.attr("data-attribute-id",o.attributeId)}focus(){this.$widget.find(".promoted-attribute-input:first").focus()}entitiesReloadedEvent({loadResults:t}){t.getAttributeRows(this.componentId).find((t=>m.isAffecting(t,this.note)))&&this.refresh()}}(function(){window.glob.isDesktop=b.default.isDesktop,window.glob.isMobile=b.default.isMobile,window.glob.getComponentByEl=e=>t.default.getComponentByEl(e),window.glob.getHeaders=a.Z.getHeaders,window.glob.getReferenceLinkTitle=t=>_.Z.getReferenceLinkTitle(t),window.glob.getReferenceLinkTitleSync=t=>_.Z.getReferenceLinkTitleSync(t),window.glob.getActiveContextNote=()=>t.default.tabManager.getActiveContextNote(),window.glob.requireLibrary=h.Z.requireLibrary,window.glob.ESLINT=h.Z.ESLINT,window.glob.appContext=t.default,window.glob.froca=g.default,window.glob.treeCache=g.default,window.glob.importMarkdownInline=async()=>t.default.triggerCommand("importMarkdownInline"),window.glob.SEARCH_HELP_TEXT='\n    <strong>搜索建议</strong> - 参见 <button class="btn btn-sm" type="button" data-help-page="Search">搜索语法完整帮助文档</button>\n    <p>\n    <ul>\n        <li>输入任意文字进行全文搜索</li>\n                <li><code>#abc</code> - 会返回含有abc标签的笔记</li>\n                <li><code>#year = 2019</code> - <code>year</code>并且值是<code>2019</code>的笔记</li>\n                <li><code>#rock #pop</code> - 会匹配同时含有 <code>rock</code> 和  <code>pop</code> 标签的笔记</li>\n                <li><code>#rock or #pop</code> - 含有其中任意一个标签的笔记</li>\n                <li><code>#year &lt;= 2000</code> - 可以用比较符号(比如 &gt;, &gt;=, &lt;).</li>\n                <li><code>note.dateCreated >= MONTH-1</code> - 上个月创建的笔记</li>\n        <li><code>=handler</code> - 会执行<code>=handler</code>关联的代码来获取结果</li>\n    </ul>\n    </p>',window.onerror=function(t,e,n,o,i){let s="未捕获的错误: ";return t.toLowerCase().includes("script error")?s+="没有详细信息":s+=[`信息: ${t}`,`URL: ${e}`,`行数: ${n}`,`列数: ${o}`,`错误对象: ${JSON.stringify(i)}`,`堆栈: ${i&&i.stack}`].join(", "),dt.Z.logError(s),!1};for(const t of glob.appCssNoteIds||[])h.Z.requireCss(`api/notes/download/${t}`,!1);b.default.initHelpButtons($(window)),$("body").on("click","a.external",(function(){return window.open($(this).attr("href"),"_blank"),!1}))})(),t.default.setLayout(new class{getRootWidget(t){return(new ce).setParent(t).cssBlock("\n<style>\nkbd {\n    display: none;\n}\n\n.dropdown-menu {\n    font-size: larger;\n}\n\n.action-button {\n    background: none;\n    border: none;\n    cursor: pointer;\n    font-size: 1.5em;\n    padding-left: 0.5em;\n    padding-right: 0.5em;\n    color: var(--main-text-color);\n}\n.quick-search {\n    margin: 0;\n}\n.quick-search .dropdown-menu {\n    max-width: 350px;\n}\n</style>").child(new o("column").id("launcher-pane").css("width","53px").child(new Ht).child(new le)).child(new o("row").filling().child(new Ct("tree","column").class("d-sm-flex d-md-flex d-lg-flex d-xl-flex col-12 col-sm-5 col-md-4 col-lg-3 col-xl-3").css("max-height","100%").css("padding-left","0").css("padding-right","0").css("contain","content").child(new gt).child((new yt).cssBlock("\n<style>\n.tree-wrapper {\n    max-height: 100%;\n    margin-top: 0px;\n    overflow-y: auto;\n    contain: content;\n    padding-left: 10px;\n}\n\n.fancytree-custom-icon {\n    font-size: 2em;\n}\n\n.fancytree-title {\n    font-size: 1.5em;\n    margin-left: 0.6em !important;\n}\n\n.fancytree-node {\n    padding: 5px;\n}\n\n.fancytree-node .fancytree-expander:before {\n    font-size: 2em !important;\n}\n\nspan.fancytree-expander {\n    width: 24px !important;\n    margin-right: 5px;\n}\n\n.fancytree-loading span.fancytree-expander {\n    width: 24px;\n    height: 32px;\n}\n\n.fancytree-loading  span.fancytree-expander:after {\n    width: 20px;\n    height: 20px;\n    margin-top: 4px;\n    border-width: 2px;\n    border-style: solid;\n}\n\n.tree-wrapper .collapse-tree-button, \n.tree-wrapper .scroll-to-active-note-button, \n.tree-wrapper .tree-settings-button {    \n    position: fixed;\n    margin-right: 16px;\n    display: none;\n}\n\n.tree-wrapper .unhoist-button {\n    font-size: 200%;\n}\n</style>"))).child(new Ct("detail","column").class("d-sm-flex d-md-flex d-lg-flex d-xl-flex col-12 col-sm-7 col-md-8 col-lg-9").css("padding-left","0").css("padding-right","0").css("max-height","100%").child(new o("row").contentSized().css("font-size","larger").css("align-items","center").child((new It).contentSized()).child((new c).contentSized().css("position: relative;").css("top: 5px;")).child((new vt).contentSized())).child(new he).child((new At).child(new Rt).child(new Mt).child(new Zt).child(new Lt).child(new Dt)).child(new Ot).child(new pe).child((new Nt).filling().contentSized().child((new ut).css("padding","5px 20px 10px 0")).child(new Ft).child((new Et).css("font-size","smaller")))).child(new kt).child(new Tt))}}),t.default.start()})()})();
//# sourceMappingURL=mobile.js.map